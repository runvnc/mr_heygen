(function(){"use strict";var define_process_env_default={};function _mergeNamespaces$1(n,t){return t.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(s){if(s!=="default"&&!(s in n)){var a=Object.getOwnPropertyDescriptor(i,s);Object.defineProperty(n,s,a.get?a:{enumerable:!0,get:function(){return i[s]}})}})}),Object.freeze(n)}var e=Object.defineProperty,h=(n,t,i)=>t in n?e(n,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):n[t]=i,o=(n,t,i)=>h(n,typeof t!="symbol"?t+"":t,i);class _{constructor(){o(this,"_locking"),o(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let t;const i=new Promise(a=>t=()=>{this._locks-=1,a()}),s=this._locking.then(()=>t);return this._locking=this._locking.then(()=>i),s}}function assert(n,t){if(!n)throw new Error(t)}const FLOAT32_MAX=34028234663852886e22,FLOAT32_MIN=-34028234663852886e22,UINT32_MAX=4294967295,INT32_MAX=2147483647,INT32_MIN=-2147483648;function assertInt32(n){if(typeof n!="number")throw new Error("invalid int 32: "+typeof n);if(!Number.isInteger(n)||n>INT32_MAX||n<INT32_MIN)throw new Error("invalid int 32: "+n)}function assertUInt32(n){if(typeof n!="number")throw new Error("invalid uint 32: "+typeof n);if(!Number.isInteger(n)||n>UINT32_MAX||n<0)throw new Error("invalid uint 32: "+n)}function assertFloat32(n){if(typeof n!="number")throw new Error("invalid float 32: "+typeof n);if(Number.isFinite(n)&&(n>FLOAT32_MAX||n<FLOAT32_MIN))throw new Error("invalid float 32: "+n)}const enumTypeSymbol=Symbol("@bufbuild/protobuf/enum-type");function getEnumType(n){const t=n[enumTypeSymbol];return assert(t,"missing enum type on enum object"),t}function setEnumType(n,t,i,s){n[enumTypeSymbol]=makeEnumType(t,i.map(a=>({no:a.no,name:a.name,localName:n[a.no]})))}function makeEnumType(n,t,i){const s=Object.create(null),a=Object.create(null),d=[];for(const c of t){const l=normalizeEnumValue(c);d.push(l),s[c.name]=l,a[c.no]=l}return{typeName:n,values:d,findName(c){return s[c]},findNumber(c){return a[c]}}}function makeEnum(n,t,i){const s={};for(const a of t){const d=normalizeEnumValue(a);s[d.localName]=d.no,s[d.no]=d.localName}return setEnumType(s,n,t),s}function normalizeEnumValue(n){return"localName"in n?n:Object.assign(Object.assign({},n),{localName:n.name})}let Message$1=class{equals(t){return this.getType().runtime.util.equals(this.getType(),this,t)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(t,i){const s=this.getType(),a=s.runtime.bin,d=a.makeReadOptions(i);return a.readMessage(this,d.readerFactory(t),t.byteLength,d),this}fromJson(t,i){const s=this.getType(),a=s.runtime.json,d=a.makeReadOptions(i);return a.readMessage(s,t,d,this),this}fromJsonString(t,i){let s;try{s=JSON.parse(t)}catch(a){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(a instanceof Error?a.message:String(a)))}return this.fromJson(s,i)}toBinary(t){const i=this.getType(),s=i.runtime.bin,a=s.makeWriteOptions(t),d=a.writerFactory();return s.writeMessage(this,d,a),d.finish()}toJson(t){const i=this.getType(),s=i.runtime.json,a=s.makeWriteOptions(t);return s.writeMessage(this,a)}toJsonString(t){var i;const s=this.toJson(t);return JSON.stringify(s,null,(i=t==null?void 0:t.prettySpaces)!==null&&i!==void 0?i:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}};function makeMessageType(n,t,i,s){var a;const d=(a=s==null?void 0:s.localName)!==null&&a!==void 0?a:t.substring(t.lastIndexOf(".")+1),c={[d]:function(l){n.util.initFields(this),n.util.initPartial(l,this)}}[d];return Object.setPrototypeOf(c.prototype,new Message$1),Object.assign(c,{runtime:n,typeName:t,fields:n.util.newFieldList(i),fromBinary(l,u){return new c().fromBinary(l,u)},fromJson(l,u){return new c().fromJson(l,u)},fromJsonString(l,u){return new c().fromJsonString(l,u)},equals(l,u){return n.util.equals(c,l,u)}}),c}function varint64read(){let n=0,t=0;for(let s=0;s<28;s+=7){let a=this.buf[this.pos++];if(n|=(a&127)<<s,!(a&128))return this.assertBounds(),[n,t]}let i=this.buf[this.pos++];if(n|=(i&15)<<28,t=(i&112)>>4,!(i&128))return this.assertBounds(),[n,t];for(let s=3;s<=31;s+=7){let a=this.buf[this.pos++];if(t|=(a&127)<<s,!(a&128))return this.assertBounds(),[n,t]}throw new Error("invalid varint")}function varint64write(n,t,i){for(let d=0;d<28;d=d+7){const c=n>>>d,l=!(!(c>>>7)&&t==0),u=(l?c|128:c)&255;if(i.push(u),!l)return}const s=n>>>28&15|(t&7)<<4,a=!!(t>>3);if(i.push((a?s|128:s)&255),!!a){for(let d=3;d<31;d=d+7){const c=t>>>d,l=!!(c>>>7),u=(l?c|128:c)&255;if(i.push(u),!l)return}i.push(t>>>31&1)}}const TWO_PWR_32_DBL=4294967296;function int64FromString(n){const t=n[0]==="-";t&&(n=n.slice(1));const i=1e6;let s=0,a=0;function d(c,l){const u=Number(n.slice(c,l));a*=i,s=s*i+u,s>=TWO_PWR_32_DBL&&(a=a+(s/TWO_PWR_32_DBL|0),s=s%TWO_PWR_32_DBL)}return d(-24,-18),d(-18,-12),d(-12,-6),d(-6),t?negate(s,a):newBits(s,a)}function int64ToString(n,t){let i=newBits(n,t);const s=i.hi&2147483648;s&&(i=negate(i.lo,i.hi));const a=uInt64ToString(i.lo,i.hi);return s?"-"+a:a}function uInt64ToString(n,t){if({lo:n,hi:t}=toUnsigned(n,t),t<=2097151)return String(TWO_PWR_32_DBL*t+n);const i=n&16777215,s=(n>>>24|t<<8)&16777215,a=t>>16&65535;let d=i+s*6777216+a*6710656,c=s+a*8147497,l=a*2;const u=1e7;return d>=u&&(c+=Math.floor(d/u),d%=u),c>=u&&(l+=Math.floor(c/u),c%=u),l.toString()+decimalFrom1e7WithLeadingZeros(c)+decimalFrom1e7WithLeadingZeros(d)}function toUnsigned(n,t){return{lo:n>>>0,hi:t>>>0}}function newBits(n,t){return{lo:n|0,hi:t|0}}function negate(n,t){return t=~t,n?n=~n+1:t+=1,newBits(n,t)}const decimalFrom1e7WithLeadingZeros=n=>{const t=String(n);return"0000000".slice(t.length)+t};function varint32write(n,t){if(n>=0){for(;n>127;)t.push(n&127|128),n=n>>>7;t.push(n)}else{for(let i=0;i<9;i++)t.push(n&127|128),n=n>>7;t.push(1)}}function varint32read(){let n=this.buf[this.pos++],t=n&127;if(!(n&128))return this.assertBounds(),t;if(n=this.buf[this.pos++],t|=(n&127)<<7,!(n&128))return this.assertBounds(),t;if(n=this.buf[this.pos++],t|=(n&127)<<14,!(n&128))return this.assertBounds(),t;if(n=this.buf[this.pos++],t|=(n&127)<<21,!(n&128))return this.assertBounds(),t;n=this.buf[this.pos++],t|=(n&15)<<28;for(let i=5;n&128&&i<10;i++)n=this.buf[this.pos++];if(n&128)throw new Error("invalid varint");return this.assertBounds(),t>>>0}function makeInt64Support(){const n=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof n.getBigInt64=="function"&&typeof n.getBigUint64=="function"&&typeof n.setBigInt64=="function"&&typeof n.setBigUint64=="function"&&(typeof process!="object"||typeof define_process_env_default!="object"||define_process_env_default.BUF_BIGINT_DISABLE!=="1")){const a=BigInt("-9223372036854775808"),d=BigInt("9223372036854775807"),c=BigInt("0"),l=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(u){const p=typeof u=="bigint"?u:BigInt(u);if(p>d||p<a)throw new Error("int64 invalid: ".concat(u));return p},uParse(u){const p=typeof u=="bigint"?u:BigInt(u);if(p>l||p<c)throw new Error("uint64 invalid: ".concat(u));return p},enc(u){return n.setBigInt64(0,this.parse(u),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},uEnc(u){return n.setBigInt64(0,this.uParse(u),!0),{lo:n.getInt32(0,!0),hi:n.getInt32(4,!0)}},dec(u,p){return n.setInt32(0,u,!0),n.setInt32(4,p,!0),n.getBigInt64(0,!0)},uDec(u,p){return n.setInt32(0,u,!0),n.setInt32(4,p,!0),n.getBigUint64(0,!0)}}}const i=a=>assert(/^-?[0-9]+$/.test(a),"int64 invalid: ".concat(a)),s=a=>assert(/^[0-9]+$/.test(a),"uint64 invalid: ".concat(a));return{zero:"0",supported:!1,parse(a){return typeof a!="string"&&(a=a.toString()),i(a),a},uParse(a){return typeof a!="string"&&(a=a.toString()),s(a),a},enc(a){return typeof a!="string"&&(a=a.toString()),i(a),int64FromString(a)},uEnc(a){return typeof a!="string"&&(a=a.toString()),s(a),int64FromString(a)},dec(a,d){return int64ToString(a,d)},uDec(a,d){return uInt64ToString(a,d)}}}const protoInt64=makeInt64Support();var ScalarType;(function(n){n[n.DOUBLE=1]="DOUBLE",n[n.FLOAT=2]="FLOAT",n[n.INT64=3]="INT64",n[n.UINT64=4]="UINT64",n[n.INT32=5]="INT32",n[n.FIXED64=6]="FIXED64",n[n.FIXED32=7]="FIXED32",n[n.BOOL=8]="BOOL",n[n.STRING=9]="STRING",n[n.BYTES=12]="BYTES",n[n.UINT32=13]="UINT32",n[n.SFIXED32=15]="SFIXED32",n[n.SFIXED64=16]="SFIXED64",n[n.SINT32=17]="SINT32",n[n.SINT64=18]="SINT64"})(ScalarType||(ScalarType={}));var LongType;(function(n){n[n.BIGINT=0]="BIGINT",n[n.STRING=1]="STRING"})(LongType||(LongType={}));function scalarEquals(n,t,i){if(t===i)return!0;if(n==ScalarType.BYTES){if(!(t instanceof Uint8Array)||!(i instanceof Uint8Array)||t.length!==i.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!==i[s])return!1;return!0}switch(n){case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return t==i}return!1}function scalarZeroValue(n,t){switch(n){case ScalarType.BOOL:return!1;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return t==0?protoInt64.zero:"0";case ScalarType.DOUBLE:case ScalarType.FLOAT:return 0;case ScalarType.BYTES:return new Uint8Array(0);case ScalarType.STRING:return"";default:return 0}}function isScalarZeroValue(n,t){switch(n){case ScalarType.BOOL:return t===!1;case ScalarType.STRING:return t==="";case ScalarType.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return t==0}}var WireType;(function(n){n[n.Varint=0]="Varint",n[n.Bit64=1]="Bit64",n[n.LengthDelimited=2]="LengthDelimited",n[n.StartGroup=3]="StartGroup",n[n.EndGroup=4]="EndGroup",n[n.Bit32=5]="Bit32"})(WireType||(WireType={}));class BinaryWriter{constructor(t){this.stack=[],this.textEncoder=t??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let t=0;for(let a=0;a<this.chunks.length;a++)t+=this.chunks[a].length;let i=new Uint8Array(t),s=0;for(let a=0;a<this.chunks.length;a++)i.set(this.chunks[a],s),s+=this.chunks[a].length;return this.chunks=[],i}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let t=this.finish(),i=this.stack.pop();if(!i)throw new Error("invalid state, fork stack empty");return this.chunks=i.chunks,this.buf=i.buf,this.uint32(t.byteLength),this.raw(t)}tag(t,i){return this.uint32((t<<3|i)>>>0)}raw(t){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(t),this}uint32(t){for(assertUInt32(t);t>127;)this.buf.push(t&127|128),t=t>>>7;return this.buf.push(t),this}int32(t){return assertInt32(t),varint32write(t,this.buf),this}bool(t){return this.buf.push(t?1:0),this}bytes(t){return this.uint32(t.byteLength),this.raw(t)}string(t){let i=this.textEncoder.encode(t);return this.uint32(i.byteLength),this.raw(i)}float(t){assertFloat32(t);let i=new Uint8Array(4);return new DataView(i.buffer).setFloat32(0,t,!0),this.raw(i)}double(t){let i=new Uint8Array(8);return new DataView(i.buffer).setFloat64(0,t,!0),this.raw(i)}fixed32(t){assertUInt32(t);let i=new Uint8Array(4);return new DataView(i.buffer).setUint32(0,t,!0),this.raw(i)}sfixed32(t){assertInt32(t);let i=new Uint8Array(4);return new DataView(i.buffer).setInt32(0,t,!0),this.raw(i)}sint32(t){return assertInt32(t),t=(t<<1^t>>31)>>>0,varint32write(t,this.buf),this}sfixed64(t){let i=new Uint8Array(8),s=new DataView(i.buffer),a=protoInt64.enc(t);return s.setInt32(0,a.lo,!0),s.setInt32(4,a.hi,!0),this.raw(i)}fixed64(t){let i=new Uint8Array(8),s=new DataView(i.buffer),a=protoInt64.uEnc(t);return s.setInt32(0,a.lo,!0),s.setInt32(4,a.hi,!0),this.raw(i)}int64(t){let i=protoInt64.enc(t);return varint64write(i.lo,i.hi,this.buf),this}sint64(t){let i=protoInt64.enc(t),s=i.hi>>31,a=i.lo<<1^s,d=(i.hi<<1|i.lo>>>31)^s;return varint64write(a,d,this.buf),this}uint64(t){let i=protoInt64.uEnc(t);return varint64write(i.lo,i.hi,this.buf),this}}class BinaryReader{constructor(t,i){this.varint64=varint64read,this.uint32=varint32read,this.buf=t,this.len=t.length,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.textDecoder=i??new TextDecoder}tag(){let t=this.uint32(),i=t>>>3,s=t&7;if(i<=0||s<0||s>5)throw new Error("illegal tag: field no "+i+" wire type "+s);return[i,s]}skip(t,i){let s=this.pos;switch(t){case WireType.Varint:for(;this.buf[this.pos++]&128;);break;case WireType.Bit64:this.pos+=4;case WireType.Bit32:this.pos+=4;break;case WireType.LengthDelimited:let a=this.uint32();this.pos+=a;break;case WireType.StartGroup:for(;;){const[d,c]=this.tag();if(c===WireType.EndGroup){if(i!==void 0&&d!==i)throw new Error("invalid end group tag");break}this.skip(c,d)}break;default:throw new Error("cant skip wire type "+t)}return this.assertBounds(),this.buf.subarray(s,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let t=this.uint32();return t>>>1^-(t&1)}int64(){return protoInt64.dec(...this.varint64())}uint64(){return protoInt64.uDec(...this.varint64())}sint64(){let[t,i]=this.varint64(),s=-(t&1);return t=(t>>>1|(i&1)<<31)^s,i=i>>>1^s,protoInt64.dec(t,i)}bool(){let[t,i]=this.varint64();return t!==0||i!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return protoInt64.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return protoInt64.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let t=this.uint32(),i=this.pos;return this.pos+=t,this.assertBounds(),this.buf.subarray(i,i+t)}string(){return this.textDecoder.decode(this.bytes())}}function makeExtension(n,t,i,s){let a;return{typeName:t,extendee:i,get field(){if(!a){const d=typeof s=="function"?s():s;d.name=t.split(".").pop(),d.jsonName="[".concat(t,"]"),a=n.util.newFieldList([d]).list()[0]}return a},runtime:n}}function createExtensionContainer(n){const t=n.field.localName,i=Object.create(null);return i[t]=initExtensionField(n),[i,()=>i[t]]}function initExtensionField(n){const t=n.field;if(t.repeated)return[];if(t.default!==void 0)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return scalarZeroValue(t.T,t.L);case"message":const i=t.T,s=new i;return i.fieldWrapper?i.fieldWrapper.unwrapField(s):s;case"map":throw"map fields are not allowed to be extensions"}}function filterUnknownFields(n,t){if(!t.repeated&&(t.kind=="enum"||t.kind=="scalar")){for(let i=n.length-1;i>=0;--i)if(n[i].no==t.no)return[n[i]];return[]}return n.filter(i=>i.no===t.no)}let encTable="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),decTable=[];for(let n=0;n<encTable.length;n++)decTable[encTable[n].charCodeAt(0)]=n;decTable[45]=encTable.indexOf("+"),decTable[95]=encTable.indexOf("/");const protoBase64={dec(n){let t=n.length*3/4;n[n.length-2]=="="?t-=2:n[n.length-1]=="="&&(t-=1);let i=new Uint8Array(t),s=0,a=0,d,c=0;for(let l=0;l<n.length;l++){if(d=decTable[n.charCodeAt(l)],d===void 0)switch(n[l]){case"=":a=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(a){case 0:c=d,a=1;break;case 1:i[s++]=c<<2|(d&48)>>4,c=d,a=2;break;case 2:i[s++]=(c&15)<<4|(d&60)>>2,c=d,a=3;break;case 3:i[s++]=(c&3)<<6|d,a=0;break}}if(a==1)throw Error("invalid base64 string.");return i.subarray(0,s)},enc(n){let t="",i=0,s,a=0;for(let d=0;d<n.length;d++)switch(s=n[d],i){case 0:t+=encTable[s>>2],a=(s&3)<<4,i=1;break;case 1:t+=encTable[a|s>>4],a=(s&15)<<2,i=2;break;case 2:t+=encTable[a|s>>6],t+=encTable[s&63],i=0;break}return i&&(t+=encTable[a],t+="=",i==1&&(t+="=")),t}};function getExtension(n,t,i){assertExtendee(t,n);const s=t.runtime.bin.makeReadOptions(i),a=filterUnknownFields(n.getType().runtime.bin.listUnknownFields(n),t.field),[d,c]=createExtensionContainer(t);for(const l of a)t.runtime.bin.readField(d,s.readerFactory(l.data),t.field,l.wireType,s);return c()}function setExtension(n,t,i,s){assertExtendee(t,n);const a=t.runtime.bin.makeReadOptions(s),d=t.runtime.bin.makeWriteOptions(s);if(hasExtension(n,t)){const p=n.getType().runtime.bin.listUnknownFields(n).filter(f=>f.no!=t.field.no);n.getType().runtime.bin.discardUnknownFields(n);for(const f of p)n.getType().runtime.bin.onUnknownField(n,f.no,f.wireType,f.data)}const c=d.writerFactory();let l=t.field;!l.opt&&!l.repeated&&(l.kind=="enum"||l.kind=="scalar")&&(l=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(l,i,c,d);const u=a.readerFactory(c.finish());for(;u.pos<u.len;){const[p,f]=u.tag(),m=u.skip(f,p);n.getType().runtime.bin.onUnknownField(n,p,f,m)}}function hasExtension(n,t){const i=n.getType();return t.extendee.typeName===i.typeName&&!!i.runtime.bin.listUnknownFields(n).find(s=>s.no==t.field.no)}function assertExtendee(n,t){assert(n.extendee.typeName==t.getType().typeName,"extension ".concat(n.typeName," can only be applied to message ").concat(n.extendee.typeName))}function isFieldSet(n,t){const i=n.localName;if(n.repeated)return t[i].length>0;if(n.oneof)return t[n.oneof.localName].case===i;switch(n.kind){case"enum":case"scalar":return n.opt||n.req?t[i]!==void 0:n.kind=="enum"?t[i]!==n.T.values[0].no:!isScalarZeroValue(n.T,t[i]);case"message":return t[i]!==void 0;case"map":return Object.keys(t[i]).length>0}}function clearField(n,t){const i=n.localName,s=!n.opt&&!n.req;if(n.repeated)t[i]=[];else if(n.oneof)t[n.oneof.localName]={case:void 0};else switch(n.kind){case"map":t[i]={};break;case"enum":t[i]=s?n.T.values[0].no:void 0;break;case"scalar":t[i]=s?scalarZeroValue(n.T,n.L):void 0;break;case"message":t[i]=void 0;break}}function isMessage(n,t){if(n===null||typeof n!="object"||!Object.getOwnPropertyNames(Message$1.prototype).every(s=>s in n&&typeof n[s]=="function"))return!1;const i=n.getType();return i===null||typeof i!="function"||!("typeName"in i)||typeof i.typeName!="string"?!1:t===void 0?!0:i.typeName==t.typeName}function wrapField(n,t){return isMessage(t)||!n.fieldWrapper?t:n.fieldWrapper.wrapField(t)}ScalarType.DOUBLE,ScalarType.FLOAT,ScalarType.INT64,ScalarType.UINT64,ScalarType.INT32,ScalarType.UINT32,ScalarType.BOOL,ScalarType.STRING,ScalarType.BYTES;const jsonReadDefaults={ignoreUnknownFields:!1},jsonWriteDefaults={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function makeReadOptions$1(n){return n?Object.assign(Object.assign({},jsonReadDefaults),n):jsonReadDefaults}function makeWriteOptions$1(n){return n?Object.assign(Object.assign({},jsonWriteDefaults),n):jsonWriteDefaults}const tokenNull=Symbol(),tokenIgnoredUnknownEnum=Symbol();function makeJsonFormat(){return{makeReadOptions:makeReadOptions$1,makeWriteOptions:makeWriteOptions$1,readMessage(n,t,i,s){if(t==null||Array.isArray(t)||typeof t!="object")throw new Error("cannot decode message ".concat(n.typeName," from JSON: ").concat(debugJsonValue(t)));s=s??new n;const a=new Map,d=i.typeRegistry;for(const[c,l]of Object.entries(t)){const u=n.fields.findJsonName(c);if(u){if(u.oneof){if(l===null&&u.kind=="scalar")continue;const p=a.get(u.oneof);if(p!==void 0)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: multiple keys for oneof "').concat(u.oneof.name,'" present: "').concat(p,'", "').concat(c,'"'));a.set(u.oneof,c)}readField$1(s,l,u,i,n)}else{let p=!1;if(d!=null&&d.findExtension&&c.startsWith("[")&&c.endsWith("]")){const f=d.findExtension(c.substring(1,c.length-1));if(f&&f.extendee.typeName==n.typeName){p=!0;const[m,g]=createExtensionContainer(f);readField$1(m,l,f.field,i,f),setExtension(s,f,g(),i)}}if(!p&&!i.ignoreUnknownFields)throw new Error("cannot decode message ".concat(n.typeName,' from JSON: key "').concat(c,'" is unknown'))}}return s},writeMessage(n,t){const i=n.getType(),s={};let a;try{for(a of i.fields.byNumber()){if(!isFieldSet(a,n)){if(a.req)throw"required field not set";if(!t.emitDefaultValues||!canEmitFieldDefaultValue(a))continue}const c=a.oneof?n[a.oneof.localName].value:n[a.localName],l=writeField$1(a,c,t);l!==void 0&&(s[t.useProtoFieldName?a.name:a.jsonName]=l)}const d=t.typeRegistry;if(d!=null&&d.findExtensionFor)for(const c of i.runtime.bin.listUnknownFields(n)){const l=d.findExtensionFor(i.typeName,c.no);if(l&&hasExtension(n,l)){const u=getExtension(n,l,t),p=writeField$1(l.field,u,t);p!==void 0&&(s[l.field.jsonName]=p)}}}catch(d){const c=a?"cannot encode field ".concat(i.typeName,".").concat(a.name," to JSON"):"cannot encode message ".concat(i.typeName," to JSON"),l=d instanceof Error?d.message:String(d);throw new Error(c+(l.length>0?": ".concat(l):""))}return s},readScalar(n,t,i){return readScalar$1(n,t,i??LongType.BIGINT,!0)},writeScalar(n,t,i){if(t!==void 0&&(i||isScalarZeroValue(n,t)))return writeScalar$1(n,t)},debug:debugJsonValue}}function debugJsonValue(n){if(n===null)return"null";switch(typeof n){case"object":return Array.isArray(n)?"array":"object";case"string":return n.length>100?"string":'"'.concat(n.split('"').join('\\"'),'"');default:return String(n)}}function readField$1(n,t,i,s,a){let d=i.localName;if(i.repeated){if(assert(i.kind!="map"),t===null)return;if(!Array.isArray(t))throw new Error("cannot decode field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(t)));const c=n[d];for(const l of t){if(l===null)throw new Error("cannot decode field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(l)));switch(i.kind){case"message":c.push(i.T.fromJson(l,s));break;case"enum":const u=readEnum(i.T,l,s.ignoreUnknownFields,!0);u!==tokenIgnoredUnknownEnum&&c.push(u);break;case"scalar":try{c.push(readScalar$1(i.T,l,i.L,!0))}catch(p){let f="cannot decode field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(l));throw p instanceof Error&&p.message.length>0&&(f+=": ".concat(p.message)),new Error(f)}break}}}else if(i.kind=="map"){if(t===null)return;if(typeof t!="object"||Array.isArray(t))throw new Error("cannot decode field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(t)));const c=n[d];for(const[l,u]of Object.entries(t)){if(u===null)throw new Error("cannot decode field ".concat(a.typeName,".").concat(i.name," from JSON: map value null"));let p;try{p=readMapKey(i.K,l)}catch(f){let m="cannot decode map key for field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(t));throw f instanceof Error&&f.message.length>0&&(m+=": ".concat(f.message)),new Error(m)}switch(i.V.kind){case"message":c[p]=i.V.T.fromJson(u,s);break;case"enum":const f=readEnum(i.V.T,u,s.ignoreUnknownFields,!0);f!==tokenIgnoredUnknownEnum&&(c[p]=f);break;case"scalar":try{c[p]=readScalar$1(i.V.T,u,LongType.BIGINT,!0)}catch(m){let g="cannot decode map value for field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(t));throw m instanceof Error&&m.message.length>0&&(g+=": ".concat(m.message)),new Error(g)}break}}}else switch(i.oneof&&(n=n[i.oneof.localName]={case:d},d="value"),i.kind){case"message":const c=i.T;if(t===null&&c.typeName!="google.protobuf.Value")return;let l=n[d];isMessage(l)?l.fromJson(t,s):(n[d]=l=c.fromJson(t,s),c.fieldWrapper&&!i.oneof&&(n[d]=c.fieldWrapper.unwrapField(l)));break;case"enum":const u=readEnum(i.T,t,s.ignoreUnknownFields,!1);switch(u){case tokenNull:clearField(i,n);break;case tokenIgnoredUnknownEnum:break;default:n[d]=u;break}break;case"scalar":try{const p=readScalar$1(i.T,t,i.L,!1);switch(p){case tokenNull:clearField(i,n);break;default:n[d]=p;break}}catch(p){let f="cannot decode field ".concat(a.typeName,".").concat(i.name," from JSON: ").concat(debugJsonValue(t));throw p instanceof Error&&p.message.length>0&&(f+=": ".concat(p.message)),new Error(f)}break}}function readMapKey(n,t){if(n===ScalarType.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1;break}return readScalar$1(n,t,LongType.BIGINT,!0).toString()}function readScalar$1(n,t,i,s){if(t===null)return s?scalarZeroValue(n,i):tokenNull;switch(n){case ScalarType.DOUBLE:case ScalarType.FLOAT:if(t==="NaN")return Number.NaN;if(t==="Infinity")return Number.POSITIVE_INFINITY;if(t==="-Infinity")return Number.NEGATIVE_INFINITY;if(t===""||typeof t=="string"&&t.trim().length!==t.length||typeof t!="string"&&typeof t!="number")break;const a=Number(t);if(Number.isNaN(a)||!Number.isFinite(a))break;return n==ScalarType.FLOAT&&assertFloat32(a),a;case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.UINT32:let d;if(typeof t=="number"?d=t:typeof t=="string"&&t.length>0&&t.trim().length===t.length&&(d=Number(t)),d===void 0)break;return n==ScalarType.UINT32||n==ScalarType.FIXED32?assertUInt32(d):assertInt32(d),d;case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:if(typeof t!="number"&&typeof t!="string")break;const c=protoInt64.parse(t);return i?c.toString():c;case ScalarType.FIXED64:case ScalarType.UINT64:if(typeof t!="number"&&typeof t!="string")break;const l=protoInt64.uParse(t);return i?l.toString():l;case ScalarType.BOOL:if(typeof t!="boolean")break;return t;case ScalarType.STRING:if(typeof t!="string")break;try{encodeURIComponent(t)}catch{throw new Error("invalid UTF8")}return t;case ScalarType.BYTES:if(t==="")return new Uint8Array(0);if(typeof t!="string")break;return protoBase64.dec(t)}throw new Error}function readEnum(n,t,i,s){if(t===null)return n.typeName=="google.protobuf.NullValue"?0:s?n.values[0].no:tokenNull;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const a=n.findName(t);if(a!==void 0)return a.no;if(i)return tokenIgnoredUnknownEnum;break}throw new Error("cannot decode enum ".concat(n.typeName," from JSON: ").concat(debugJsonValue(t)))}function canEmitFieldDefaultValue(n){return n.repeated||n.kind=="map"?!0:!(n.oneof||n.kind=="message"||n.opt||n.req)}function writeField$1(n,t,i){if(n.kind=="map"){assert(typeof t=="object"&&t!=null);const s={},a=Object.entries(t);switch(n.V.kind){case"scalar":for(const[c,l]of a)s[c.toString()]=writeScalar$1(n.V.T,l);break;case"message":for(const[c,l]of a)s[c.toString()]=l.toJson(i);break;case"enum":const d=n.V.T;for(const[c,l]of a)s[c.toString()]=writeEnum(d,l,i.enumAsInteger);break}return i.emitDefaultValues||a.length>0?s:void 0}if(n.repeated){assert(Array.isArray(t));const s=[];switch(n.kind){case"scalar":for(let a=0;a<t.length;a++)s.push(writeScalar$1(n.T,t[a]));break;case"enum":for(let a=0;a<t.length;a++)s.push(writeEnum(n.T,t[a],i.enumAsInteger));break;case"message":for(let a=0;a<t.length;a++)s.push(t[a].toJson(i));break}return i.emitDefaultValues||s.length>0?s:void 0}switch(n.kind){case"scalar":return writeScalar$1(n.T,t);case"enum":return writeEnum(n.T,t,i.enumAsInteger);case"message":return wrapField(n.T,t).toJson(i)}}function writeEnum(n,t,i){var s;if(assert(typeof t=="number"),n.typeName=="google.protobuf.NullValue")return null;if(i)return t;const a=n.findNumber(t);return(s=a==null?void 0:a.name)!==null&&s!==void 0?s:t}function writeScalar$1(n,t){switch(n){case ScalarType.INT32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.FIXED32:case ScalarType.UINT32:return assert(typeof t=="number"),t;case ScalarType.FLOAT:case ScalarType.DOUBLE:return assert(typeof t=="number"),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case ScalarType.STRING:return assert(typeof t=="string"),t;case ScalarType.BOOL:return assert(typeof t=="boolean"),t;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return assert(typeof t=="bigint"||typeof t=="string"||typeof t=="number"),t.toString();case ScalarType.BYTES:return assert(t instanceof Uint8Array),protoBase64.enc(t)}}const unknownFieldsSymbol=Symbol("@bufbuild/protobuf/unknown-fields"),readDefaults={readUnknownFields:!0,readerFactory:n=>new BinaryReader(n)},writeDefaults={writeUnknownFields:!0,writerFactory:()=>new BinaryWriter};function makeReadOptions(n){return n?Object.assign(Object.assign({},readDefaults),n):readDefaults}function makeWriteOptions(n){return n?Object.assign(Object.assign({},writeDefaults),n):writeDefaults}function makeBinaryFormat(){return{makeReadOptions,makeWriteOptions,listUnknownFields(n){var t;return(t=n[unknownFieldsSymbol])!==null&&t!==void 0?t:[]},discardUnknownFields(n){delete n[unknownFieldsSymbol]},writeUnknownFields(n,t){const s=n[unknownFieldsSymbol];if(s)for(const a of s)t.tag(a.no,a.wireType).raw(a.data)},onUnknownField(n,t,i,s){const a=n;Array.isArray(a[unknownFieldsSymbol])||(a[unknownFieldsSymbol]=[]),a[unknownFieldsSymbol].push({no:t,wireType:i,data:s})},readMessage(n,t,i,s,a){const d=n.getType(),c=a?t.len:t.pos+i;let l,u;for(;t.pos<c&&([l,u]=t.tag(),!(a===!0&&u==WireType.EndGroup));){const p=d.fields.find(l);if(!p){const f=t.skip(u,l);s.readUnknownFields&&this.onUnknownField(n,l,u,f);continue}readField(n,t,p,u,s)}if(a&&(u!=WireType.EndGroup||l!==i))throw new Error("invalid end group tag")},readField,writeMessage(n,t,i){const s=n.getType();for(const a of s.fields.byNumber()){if(!isFieldSet(a,n)){if(a.req)throw new Error("cannot encode field ".concat(s.typeName,".").concat(a.name," to binary: required field not set"));continue}const d=a.oneof?n[a.oneof.localName].value:n[a.localName];writeField(a,d,t,i)}return i.writeUnknownFields&&this.writeUnknownFields(n,t),t},writeField(n,t,i,s){t!==void 0&&writeField(n,t,i,s)}}}function readField(n,t,i,s,a){let{repeated:d,localName:c}=i;switch(i.oneof&&(n=n[i.oneof.localName],n.case!=c&&delete n.value,n.case=c,c="value"),i.kind){case"scalar":case"enum":const l=i.kind=="enum"?ScalarType.INT32:i.T;let u=readScalar;if(i.kind=="scalar"&&i.L>0&&(u=readScalarLTString),d){let g=n[c];if(s==WireType.LengthDelimited&&l!=ScalarType.STRING&&l!=ScalarType.BYTES){let y=t.uint32()+t.pos;for(;t.pos<y;)g.push(u(t,l))}else g.push(u(t,l))}else n[c]=u(t,l);break;case"message":const p=i.T;d?n[c].push(readMessageField(t,new p,a,i)):isMessage(n[c])?readMessageField(t,n[c],a,i):(n[c]=readMessageField(t,new p,a,i),p.fieldWrapper&&!i.oneof&&!i.repeated&&(n[c]=p.fieldWrapper.unwrapField(n[c])));break;case"map":let[f,m]=readMapEntry(i,t,a);n[c][f]=m;break}}function readMessageField(n,t,i,s){const a=t.getType().runtime.bin,d=s==null?void 0:s.delimited;return a.readMessage(t,n,d?s.no:n.uint32(),i,d),t}function readMapEntry(n,t,i){const s=t.uint32(),a=t.pos+s;let d,c;for(;t.pos<a;){const[l]=t.tag();switch(l){case 1:d=readScalar(t,n.K);break;case 2:switch(n.V.kind){case"scalar":c=readScalar(t,n.V.T);break;case"enum":c=t.int32();break;case"message":c=readMessageField(t,new n.V.T,i,void 0);break}break}}if(d===void 0&&(d=scalarZeroValue(n.K,LongType.BIGINT)),typeof d!="string"&&typeof d!="number"&&(d=d.toString()),c===void 0)switch(n.V.kind){case"scalar":c=scalarZeroValue(n.V.T,LongType.BIGINT);break;case"enum":c=n.V.T.values[0].no;break;case"message":c=new n.V.T;break}return[d,c]}function readScalarLTString(n,t){const i=readScalar(n,t);return typeof i=="bigint"?i.toString():i}function readScalar(n,t){switch(t){case ScalarType.STRING:return n.string();case ScalarType.BOOL:return n.bool();case ScalarType.DOUBLE:return n.double();case ScalarType.FLOAT:return n.float();case ScalarType.INT32:return n.int32();case ScalarType.INT64:return n.int64();case ScalarType.UINT64:return n.uint64();case ScalarType.FIXED64:return n.fixed64();case ScalarType.BYTES:return n.bytes();case ScalarType.FIXED32:return n.fixed32();case ScalarType.SFIXED32:return n.sfixed32();case ScalarType.SFIXED64:return n.sfixed64();case ScalarType.SINT64:return n.sint64();case ScalarType.UINT32:return n.uint32();case ScalarType.SINT32:return n.sint32()}}function writeField(n,t,i,s){assert(t!==void 0);const a=n.repeated;switch(n.kind){case"scalar":case"enum":let d=n.kind=="enum"?ScalarType.INT32:n.T;if(a)if(assert(Array.isArray(t)),n.packed)writePacked(i,d,n.no,t);else for(const c of t)writeScalar(i,d,n.no,c);else writeScalar(i,d,n.no,t);break;case"message":if(a){assert(Array.isArray(t));for(const c of t)writeMessageField(i,s,n,c)}else writeMessageField(i,s,n,t);break;case"map":assert(typeof t=="object"&&t!=null);for(const[c,l]of Object.entries(t))writeMapEntry(i,s,n,c,l);break}}function writeMapEntry(n,t,i,s,a){n.tag(i.no,WireType.LengthDelimited),n.fork();let d=s;switch(i.K){case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.UINT32:case ScalarType.SFIXED32:case ScalarType.SINT32:d=Number.parseInt(s);break;case ScalarType.BOOL:assert(s=="true"||s=="false"),d=s=="true";break}switch(writeScalar(n,i.K,1,d),i.V.kind){case"scalar":writeScalar(n,i.V.T,2,a);break;case"enum":writeScalar(n,ScalarType.INT32,2,a);break;case"message":assert(a!==void 0),n.tag(2,WireType.LengthDelimited).bytes(a.toBinary(t));break}n.join()}function writeMessageField(n,t,i,s){const a=wrapField(i.T,s);i.delimited?n.tag(i.no,WireType.StartGroup).raw(a.toBinary(t)).tag(i.no,WireType.EndGroup):n.tag(i.no,WireType.LengthDelimited).bytes(a.toBinary(t))}function writeScalar(n,t,i,s){assert(s!==void 0);let[a,d]=scalarTypeInfo(t);n.tag(i,a)[d](s)}function writePacked(n,t,i,s){if(!s.length)return;n.tag(i,WireType.LengthDelimited).fork();let[,a]=scalarTypeInfo(t);for(let d=0;d<s.length;d++)n[a](s[d]);n.join()}function scalarTypeInfo(n){let t=WireType.Varint;switch(n){case ScalarType.BYTES:case ScalarType.STRING:t=WireType.LengthDelimited;break;case ScalarType.DOUBLE:case ScalarType.FIXED64:case ScalarType.SFIXED64:t=WireType.Bit64;break;case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.FLOAT:t=WireType.Bit32;break}const i=ScalarType[n].toLowerCase();return[t,i]}function makeUtilCommon(){return{setEnumType,initPartial(n,t){if(n===void 0)return;const i=t.getType();for(const s of i.fields.byMember()){const a=s.localName,d=t,c=n;if(c[a]!=null)switch(s.kind){case"oneof":const l=c[a].case;if(l===void 0)continue;const u=s.findField(l);let p=c[a].value;u&&u.kind=="message"&&!isMessage(p,u.T)?p=new u.T(p):u&&u.kind==="scalar"&&u.T===ScalarType.BYTES&&(p=toU8Arr(p)),d[a]={case:l,value:p};break;case"scalar":case"enum":let f=c[a];s.T===ScalarType.BYTES&&(f=s.repeated?f.map(toU8Arr):toU8Arr(f)),d[a]=f;break;case"map":switch(s.V.kind){case"scalar":case"enum":if(s.V.T===ScalarType.BYTES)for(const[v,y]of Object.entries(c[a]))d[a][v]=toU8Arr(y);else Object.assign(d[a],c[a]);break;case"message":const g=s.V.T;for(const v of Object.keys(c[a])){let y=c[a][v];g.fieldWrapper||(y=new g(y)),d[a][v]=y}break}break;case"message":const m=s.T;if(s.repeated)d[a]=c[a].map(g=>isMessage(g,m)?g:new m(g));else{const g=c[a];m.fieldWrapper?m.typeName==="google.protobuf.BytesValue"?d[a]=toU8Arr(g):d[a]=g:d[a]=isMessage(g,m)?g:new m(g)}break}}},equals(n,t,i){return t===i?!0:!t||!i?!1:n.fields.byMember().every(s=>{const a=t[s.localName],d=i[s.localName];if(s.repeated){if(a.length!==d.length)return!1;switch(s.kind){case"message":return a.every((c,l)=>s.T.equals(c,d[l]));case"scalar":return a.every((c,l)=>scalarEquals(s.T,c,d[l]));case"enum":return a.every((c,l)=>scalarEquals(ScalarType.INT32,c,d[l]))}throw new Error("repeated cannot contain ".concat(s.kind))}switch(s.kind){case"message":return s.T.equals(a,d);case"enum":return scalarEquals(ScalarType.INT32,a,d);case"scalar":return scalarEquals(s.T,a,d);case"oneof":if(a.case!==d.case)return!1;const c=s.findField(a.case);if(c===void 0)return!0;switch(c.kind){case"message":return c.T.equals(a.value,d.value);case"enum":return scalarEquals(ScalarType.INT32,a.value,d.value);case"scalar":return scalarEquals(c.T,a.value,d.value)}throw new Error("oneof cannot contain ".concat(c.kind));case"map":const l=Object.keys(a).concat(Object.keys(d));switch(s.V.kind){case"message":const u=s.V.T;return l.every(f=>u.equals(a[f],d[f]));case"enum":return l.every(f=>scalarEquals(ScalarType.INT32,a[f],d[f]));case"scalar":const p=s.V.T;return l.every(f=>scalarEquals(p,a[f],d[f]))}break}})},clone(n){const t=n.getType(),i=new t,s=i;for(const a of t.fields.byMember()){const d=n[a.localName];let c;if(a.repeated)c=d.map(cloneSingularField);else if(a.kind=="map"){c=s[a.localName];for(const[l,u]of Object.entries(d))c[l]=cloneSingularField(u)}else a.kind=="oneof"?c=a.findField(d.case)?{case:d.case,value:cloneSingularField(d.value)}:{case:void 0}:c=cloneSingularField(d);s[a.localName]=c}for(const a of t.runtime.bin.listUnknownFields(n))t.runtime.bin.onUnknownField(s,a.no,a.wireType,a.data);return i}}}function cloneSingularField(n){if(n===void 0)return n;if(isMessage(n))return n.clone();if(n instanceof Uint8Array){const t=new Uint8Array(n.byteLength);return t.set(n),t}return n}function toU8Arr(n){return n instanceof Uint8Array?n:new Uint8Array(n)}function makeProtoRuntime(n,t,i){return{syntax:n,json:makeJsonFormat(),bin:makeBinaryFormat(),util:Object.assign(Object.assign({},makeUtilCommon()),{newFieldList:t,initFields:i}),makeMessageType(s,a,d){return makeMessageType(this,s,a,d)},makeEnum,makeEnumType,getEnumType,makeExtension(s,a,d){return makeExtension(this,s,a,d)}}}class InternalFieldList{constructor(t,i){this._fields=t,this._normalizer=i}findJsonName(t){if(!this.jsonNames){const i={};for(const s of this.list())i[s.jsonName]=i[s.name]=s;this.jsonNames=i}return this.jsonNames[t]}find(t){if(!this.numbers){const i={};for(const s of this.list())i[s.no]=s;this.numbers=i}return this.numbers[t]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((t,i)=>t.no-i.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const t=this.members;let i;for(const s of this.list())s.oneof?s.oneof!==i&&(i=s.oneof,t.push(i)):t.push(s)}return this.members}}function localFieldName(n,t){const i=protoCamelCase(n);return t?i:safeObjectProperty(safeMessageProperty(i))}function localOneofName(n){return localFieldName(n,!1)}const fieldJsonName=protoCamelCase;function protoCamelCase(n){let t=!1;const i=[];for(let s=0;s<n.length;s++){let a=n.charAt(s);switch(a){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":i.push(a),t=!1;break;default:t&&(t=!1,a=a.toUpperCase()),i.push(a);break}}return i.join("")}const reservedObjectProperties=new Set(["constructor","toString","toJSON","valueOf"]),reservedMessageProperties=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),fallback=n=>"".concat(n,"$"),safeMessageProperty=n=>reservedMessageProperties.has(n)?fallback(n):n,safeObjectProperty=n=>reservedObjectProperties.has(n)?fallback(n):n;class InternalOneofInfo{constructor(t){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=t,this.localName=localOneofName(t)}addField(t){assert(t.oneof===this,"field ".concat(t.name," not one of ").concat(this.name)),this.fields.push(t)}findField(t){if(!this._lookup){this._lookup=Object.create(null);for(let i=0;i<this.fields.length;i++)this._lookup[this.fields[i].localName]=this.fields[i]}return this._lookup[t]}}function normalizeFieldInfos(n,t){var i,s,a,d,c,l;const u=[];let p;for(const f of typeof n=="function"?n():n){const m=f;if(m.localName=localFieldName(f.name,f.oneof!==void 0),m.jsonName=(i=f.jsonName)!==null&&i!==void 0?i:fieldJsonName(f.name),m.repeated=(s=f.repeated)!==null&&s!==void 0?s:!1,f.kind=="scalar"&&(m.L=(a=f.L)!==null&&a!==void 0?a:LongType.BIGINT),m.delimited=(d=f.delimited)!==null&&d!==void 0?d:!1,m.req=(c=f.req)!==null&&c!==void 0?c:!1,m.opt=(l=f.opt)!==null&&l!==void 0?l:!1,f.packed===void 0&&(m.packed=f.kind=="enum"||f.kind=="scalar"&&f.T!=ScalarType.BYTES&&f.T!=ScalarType.STRING),f.oneof!==void 0){const g=typeof f.oneof=="string"?f.oneof:f.oneof.name;(!p||p.name!=g)&&(p=new InternalOneofInfo(g)),m.oneof=p,p.addField(m)}u.push(m)}return u}const proto3=makeProtoRuntime("proto3",n=>new InternalFieldList(n,t=>normalizeFieldInfos(t)),n=>{for(const t of n.getType().fields.byMember()){if(t.opt)continue;const i=t.localName,s=n;if(t.repeated){s[i]=[];continue}switch(t.kind){case"oneof":s[i]={case:void 0};break;case"enum":s[i]=0;break;case"map":s[i]={};break;case"scalar":s[i]=scalarZeroValue(t.T,t.L);break}}});class Timestamp extends Message$1{constructor(t){super(),this.seconds=protoInt64.zero,this.nanos=0,proto3.util.initPartial(t,this)}fromJson(t,i){if(typeof t!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(proto3.json.debug(t)));const s=t.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!s)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const a=Date.parse(s[1]+"-"+s[2]+"-"+s[3]+"T"+s[4]+":"+s[5]+":"+s[6]+(s[8]?s[8]:"Z"));if(Number.isNaN(a))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(a<Date.parse("0001-01-01T00:00:00Z")||a>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=protoInt64.parse(a/1e3),this.nanos=0,s[7]&&(this.nanos=parseInt("1"+s[7]+"0".repeat(9-s[7].length))-1e9),this}toJson(t){const i=Number(this.seconds)*1e3;if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let s="Z";if(this.nanos>0){const a=(this.nanos+1e9).toString().substring(1);a.substring(3)==="000000"?s="."+a.substring(0,3)+"Z":a.substring(6)==="000"?s="."+a.substring(0,6)+"Z":s="."+a+"Z"}return new Date(i).toISOString().replace(".000Z",s)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Timestamp.fromDate(new Date)}static fromDate(t){const i=t.getTime();return new Timestamp({seconds:protoInt64.parse(Math.floor(i/1e3)),nanos:i%1e3*1e6})}static fromBinary(t,i){return new Timestamp().fromBinary(t,i)}static fromJson(t,i){return new Timestamp().fromJson(t,i)}static fromJsonString(t,i){return new Timestamp().fromJsonString(t,i)}static equals(t,i){return proto3.util.equals(Timestamp,t,i)}}Timestamp.runtime=proto3,Timestamp.typeName="google.protobuf.Timestamp",Timestamp.fields=proto3.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const MetricsBatch=proto3.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:TimeSeriesMetric,repeated:!0},{no:5,name:"events",kind:"message",T:EventMetric,repeated:!0}]),TimeSeriesMetric=proto3.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:MetricSample,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),MetricSample=proto3.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"value",kind:"scalar",T:2}]),EventMetric=proto3.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Timestamp},{no:7,name:"normalized_end_timestamp",kind:"message",T:Timestamp,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),BackupCodecPolicy$1=proto3.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"REGRESSION"},{no:1,name:"SIMULCAST"}]),TrackType=proto3.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),TrackSource=proto3.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),VideoQuality$1=proto3.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),ConnectionQuality$1=proto3.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),ClientConfigSetting=proto3.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),DisconnectReason=proto3.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"}]),ReconnectReason=proto3.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),SubscriptionError=proto3.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),AudioTrackFeature=proto3.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"}]),Room$1=proto3.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Codec,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:TimedVersion}]),Codec=proto3.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),ParticipantPermission=proto3.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:proto3.getEnumType(TrackSource),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ParticipantInfo=proto3.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(ParticipantInfo_State)},{no:4,name:"tracks",kind:"message",T:TrackInfo,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ParticipantPermission},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:proto3.getEnumType(ParticipantInfo_Kind)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)}]),ParticipantInfo_State=proto3.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),ParticipantInfo_Kind=proto3.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),Encryption_Type=proto3.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),SimulcastCodecInfo=proto3.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),TrackInfo=proto3.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:10,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:SimulcastCodecInfo,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:TimedVersion},{no:19,name:"audio_features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:proto3.getEnumType(BackupCodecPolicy$1)}]),VideoLayer=proto3.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]),DataPacket=proto3.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:proto3.getEnumType(DataPacket_Kind)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:UserPacket,oneof:"value"},{no:3,name:"speaker",kind:"message",T:ActiveSpeakerUpdate,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:SipDTMF,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Transcription,oneof:"value"},{no:8,name:"metrics",kind:"message",T:MetricsBatch,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:ChatMessage,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:RpcRequest,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:RpcAck,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:RpcResponse,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:DataStream_Header,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:DataStream_Chunk,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:DataStream_Trailer,oneof:"value"}]),DataPacket_Kind=proto3.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),ActiveSpeakerUpdate=proto3.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),SpeakerInfo=proto3.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),UserPacket=proto3.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),SipDTMF=proto3.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Transcription=proto3.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:TranscriptionSegment,repeated:!0}]),TranscriptionSegment=proto3.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),ChatMessage=proto3.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),RpcRequest=proto3.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),RpcAck=proto3.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),RpcResponse=proto3.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:RpcError$1,oneof:"value"}]),RpcError$1=proto3.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),ParticipantTracks=proto3.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),ServerInfo=proto3.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:proto3.getEnumType(ServerInfo_Edition)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),ServerInfo_Edition=proto3.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),ClientInfo=proto3.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:proto3.getEnumType(ClientInfo_SDK)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),ClientInfo_SDK=proto3.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"}]),ClientConfiguration=proto3.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:VideoConfiguration},{no:2,name:"screen",kind:"message",T:VideoConfiguration},{no:3,name:"resume_connection",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)},{no:4,name:"disabled_codecs",kind:"message",T:DisabledCodecs},{no:5,name:"force_relay",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),VideoConfiguration=proto3.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),DisabledCodecs=proto3.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Codec,repeated:!0},{no:2,name:"publish",kind:"message",T:Codec,repeated:!0}]),TimedVersion=proto3.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),DataStream_OperationType=proto3.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),DataStream_TextHeader=proto3.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:proto3.getEnumType(DataStream_OperationType)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),DataStream_ByteHeader=proto3.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),DataStream_Header=proto3.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:DataStream_TextHeader,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:DataStream_ByteHeader,oneof:"content_header"}],{localName:"DataStream_Header"}),DataStream_Chunk=proto3.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),DataStream_Trailer=proto3.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),SignalTarget=proto3.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),StreamState=proto3.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),CandidateProtocol=proto3.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),SignalRequest=proto3.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:4,name:"add_track",kind:"message",T:AddTrackRequest,oneof:"message"},{no:5,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:6,name:"subscription",kind:"message",T:UpdateSubscription,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:UpdateTrackSettings,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:UpdateVideoLayers,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:SubscriptionPermission,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:SyncState,oneof:"message"},{no:13,name:"simulate",kind:"message",T:SimulateScenario,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:UpdateParticipantMetadata,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Ping,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:UpdateLocalAudioTrack,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:UpdateLocalVideoTrack,oneof:"message"}]),SignalResponse=proto3.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:JoinResponse,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:4,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:5,name:"update",kind:"message",T:ParticipantUpdate,oneof:"message"},{no:6,name:"track_published",kind:"message",T:TrackPublishedResponse,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:9,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:SpeakersChanged,oneof:"message"},{no:11,name:"room_update",kind:"message",T:RoomUpdate,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:ConnectionQualityUpdate,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:StreamStateUpdate,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:SubscribedQualityUpdate,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:SubscriptionPermissionUpdate,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:TrackUnpublishedResponse,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:ReconnectResponse,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Pong,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:SubscriptionResponse,oneof:"message"},{no:22,name:"request_response",kind:"message",T:RequestResponse,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:TrackSubscribed,oneof:"message"}]),SimulcastCodec=proto3.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),AddTrackRequest=proto3.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:9,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:SimulcastCodec,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:proto3.getEnumType(BackupCodecPolicy$1)}]),TrickleRequest=proto3.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)},{no:3,name:"final",kind:"scalar",T:8}]),MuteTrackRequest=proto3.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),JoinResponse=proto3.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1},{no:2,name:"participant",kind:"message",T:ParticipantInfo},{no:3,name:"other_participants",kind:"message",T:ParticipantInfo,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:ClientConfiguration},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:ServerInfo},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Codec,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),ReconnectResponse=proto3.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:ClientConfiguration}]),TrackPublishedResponse=proto3.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:TrackInfo}]),TrackUnpublishedResponse=proto3.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),SessionDescription=proto3.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]),ParticipantUpdate=proto3.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ParticipantInfo,repeated:!0}]),UpdateSubscription=proto3.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:ParticipantTracks,repeated:!0}]),UpdateTrackSettings=proto3.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),UpdateLocalAudioTrack=proto3.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),UpdateLocalVideoTrack=proto3.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),LeaveRequest=proto3.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)},{no:3,name:"action",kind:"enum",T:proto3.getEnumType(LeaveRequest_Action)},{no:4,name:"regions",kind:"message",T:RegionSettings}]),LeaveRequest_Action=proto3.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),UpdateVideoLayers=proto3.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),UpdateParticipantMetadata=proto3.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),ICEServer=proto3.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),SpeakersChanged=proto3.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),RoomUpdate=proto3.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Room$1}]),ConnectionQualityInfo=proto3.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:proto3.getEnumType(ConnectionQuality$1)},{no:3,name:"score",kind:"scalar",T:2}]),ConnectionQualityUpdate=proto3.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:ConnectionQualityInfo,repeated:!0}]),StreamStateInfo=proto3.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(StreamState)}]),StreamStateUpdate=proto3.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:StreamStateInfo,repeated:!0}]),SubscribedQuality=proto3.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"enabled",kind:"scalar",T:8}]),SubscribedCodec=proto3.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:SubscribedQuality,repeated:!0}]),SubscribedQualityUpdate=proto3.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:SubscribedQuality,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:SubscribedCodec,repeated:!0}]),TrackPermission=proto3.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),SubscriptionPermission=proto3.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:TrackPermission,repeated:!0}]),SubscriptionPermissionUpdate=proto3.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),SyncState=proto3.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:SessionDescription},{no:2,name:"subscription",kind:"message",T:UpdateSubscription},{no:3,name:"publish_tracks",kind:"message",T:TrackPublishedResponse,repeated:!0},{no:4,name:"data_channels",kind:"message",T:DataChannelInfo,repeated:!0},{no:5,name:"offer",kind:"message",T:SessionDescription},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0}]),DataChannelInfo=proto3.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)}]),SimulateScenario=proto3.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:proto3.getEnumType(CandidateProtocol),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Ping=proto3.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Pong=proto3.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),RegionSettings=proto3.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:RegionInfo,repeated:!0}]),RegionInfo=proto3.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),SubscriptionResponse=proto3.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:proto3.getEnumType(SubscriptionError)}]),RequestResponse=proto3.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(RequestResponse_Reason)},{no:3,name:"message",kind:"scalar",T:9}]),RequestResponse_Reason=proto3.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),TrackSubscribed=proto3.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function getDefaultExportFromCjs$1(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var loglevel$1={exports:{}},loglevel=loglevel$1.exports,hasRequiredLoglevel;function requireLoglevel(){return hasRequiredLoglevel||(hasRequiredLoglevel=1,function(n){(function(t,i){n.exports?n.exports=i():t.log=i()})(loglevel,function(){var t=function(){},i="undefined",s=typeof window!==i&&typeof window.navigator!==i&&/Trident\/|MSIE /.test(window.navigator.userAgent),a=["trace","debug","info","warn","error"],d={},c=null;function l(k,E){var C=k[E];if(typeof C.bind=="function")return C.bind(k);try{return Function.prototype.bind.call(C,k)}catch{return function(){return Function.prototype.apply.apply(C,[k,arguments])}}}function u(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function p(k){return k==="debug"&&(k="log"),typeof console===i?!1:k==="trace"&&s?u:console[k]!==void 0?l(console,k):console.log!==void 0?l(console,"log"):t}function f(){for(var k=this.getLevel(),E=0;E<a.length;E++){var C=a[E];this[C]=E<k?t:this.methodFactory(C,k,this.name)}if(this.log=this.debug,typeof console===i&&k<this.levels.SILENT)return"No console available for logging"}function m(k){return function(){typeof console!==i&&(f.call(this),this[k].apply(this,arguments))}}function g(k,E,C){return p(k)||m.apply(this,arguments)}function v(k,E){var C=this,T,w,b,S="loglevel";typeof k=="string"?S+=":"+k:typeof k=="symbol"&&(S=void 0);function R(M){var F=(a[M]||"silent").toUpperCase();if(!(typeof window===i||!S)){try{window.localStorage[S]=F;return}catch{}try{window.document.cookie=encodeURIComponent(S)+"="+F+";"}catch{}}}function O(){var M;if(!(typeof window===i||!S)){try{M=window.localStorage[S]}catch{}if(typeof M===i)try{var F=window.document.cookie,V=encodeURIComponent(S),q=F.indexOf(V+"=");q!==-1&&(M=/^([^;]+)/.exec(F.slice(q+V.length+1))[1])}catch{}return C.levels[M]===void 0&&(M=void 0),M}}function L(){if(!(typeof window===i||!S)){try{window.localStorage.removeItem(S)}catch{}try{window.document.cookie=encodeURIComponent(S)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function D(M){var F=M;if(typeof F=="string"&&C.levels[F.toUpperCase()]!==void 0&&(F=C.levels[F.toUpperCase()]),typeof F=="number"&&F>=0&&F<=C.levels.SILENT)return F;throw new TypeError("log.setLevel() called with invalid level: "+M)}C.name=k,C.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},C.methodFactory=E||g,C.getLevel=function(){return b??w??T},C.setLevel=function(M,F){return b=D(M),F!==!1&&R(b),f.call(C)},C.setDefaultLevel=function(M){w=D(M),O()||C.setLevel(M,!1)},C.resetLevel=function(){b=null,L(),f.call(C)},C.enableAll=function(M){C.setLevel(C.levels.TRACE,M)},C.disableAll=function(M){C.setLevel(C.levels.SILENT,M)},C.rebuild=function(){if(c!==C&&(T=D(c.getLevel())),f.call(C),c===C)for(var M in d)d[M].rebuild()},T=D(c?c.getLevel():"WARN");var x=O();x!=null&&(b=D(x)),f.call(C)}c=new v,c.getLogger=function(E){if(typeof E!="symbol"&&typeof E!="string"||E==="")throw new TypeError("You must supply a name when creating a logger.");var C=d[E];return C||(C=d[E]=new v(E,c.methodFactory)),C};var y=typeof window!==i?window.log:void 0;return c.noConflict=function(){return typeof window!==i&&window.log===c&&(window.log=y),c},c.getLoggers=function(){return d},c.default=c,c})}(loglevel$1)),loglevel$1.exports}var loglevelExports=requireLoglevel(),LogLevel;(function(n){n[n.trace=0]="trace",n[n.debug=1]="debug",n[n.info=2]="info",n[n.warn=3]="warn",n[n.error=4]="error",n[n.silent=5]="silent"})(LogLevel||(LogLevel={}));var LoggerNames;(function(n){n.Default="livekit",n.Room="livekit-room",n.Participant="livekit-participant",n.Track="livekit-track",n.Publication="livekit-track-publication",n.Engine="livekit-engine",n.Signal="livekit-signal",n.PCManager="livekit-pc-manager",n.PCTransport="livekit-pc-transport",n.E2EE="lk-e2ee"})(LoggerNames||(LoggerNames={}));let livekitLogger=loglevelExports.getLogger("livekit");Object.values(LoggerNames).map(n=>loglevelExports.getLogger(n)),livekitLogger.setDefaultLevel(LogLevel.info);function getLogger(n){const t=loglevelExports.getLogger(n);return t.setDefaultLevel(livekitLogger.getLevel()),t}const workerLogger=loglevelExports.getLogger("lk-e2ee"),maxRetryDelay=7e3,DEFAULT_RETRY_DELAYS_IN_MS=[0,300,2*2*300,3*3*300,4*4*300,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay];class DefaultReconnectPolicy{constructor(t){this._retryDelays=t!==void 0?[...t]:DEFAULT_RETRY_DELAYS_IN_MS}nextRetryDelayInMs(t){if(t.retryCount>=this._retryDelays.length)return null;const i=this._retryDelays[t.retryCount];return t.retryCount<=1?i:i+Math.random()*1e3}}function __awaiter$1(n,t,i,s){function a(d){return d instanceof i?d:new i(function(c){c(d)})}return new(i||(i=Promise))(function(d,c){function l(f){try{p(s.next(f))}catch(m){c(m)}}function u(f){try{p(s.throw(f))}catch(m){c(m)}}function p(f){f.done?d(f.value):a(f.value).then(l,u)}p((s=s.apply(n,t||[])).next())})}function __values(n){var t=typeof Symbol=="function"&&Symbol.iterator,i=t&&n[t],s=0;if(i)return i.call(n);if(n&&typeof n.length=="number")return{next:function(){return n&&s>=n.length&&(n=void 0),{value:n&&n[s++],done:!n}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function __asyncValues(n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t=n[Symbol.asyncIterator],i;return t?t.call(n):(n=typeof __values=="function"?__values(n):n[Symbol.iterator](),i={},s("next"),s("throw"),s("return"),i[Symbol.asyncIterator]=function(){return this},i);function s(d){i[d]=n[d]&&function(c){return new Promise(function(l,u){c=n[d](c),a(l,u,c.done,c.value)})}}function a(d,c,l,u){Promise.resolve(u).then(function(p){d({value:p,done:l})},c)}}typeof SuppressedError=="function"&&SuppressedError;var events={exports:{}},hasRequiredEvents;function requireEvents(){if(hasRequiredEvents)return events.exports;hasRequiredEvents=1;var n=typeof Reflect=="object"?Reflect:null,t=n&&typeof n.apply=="function"?n.apply:function(S,R,O){return Function.prototype.apply.call(S,R,O)},i;n&&typeof n.ownKeys=="function"?i=n.ownKeys:Object.getOwnPropertySymbols?i=function(S){return Object.getOwnPropertyNames(S).concat(Object.getOwnPropertySymbols(S))}:i=function(S){return Object.getOwnPropertyNames(S)};function s(b){console&&console.warn&&console.warn(b)}var a=Number.isNaN||function(S){return S!==S};function d(){d.init.call(this)}events.exports=d,events.exports.once=C,d.EventEmitter=d,d.prototype._events=void 0,d.prototype._eventsCount=0,d.prototype._maxListeners=void 0;var c=10;function l(b){if(typeof b!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof b)}Object.defineProperty(d,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(b){if(typeof b!="number"||b<0||a(b))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+b+".");c=b}}),d.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},d.prototype.setMaxListeners=function(S){if(typeof S!="number"||S<0||a(S))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+S+".");return this._maxListeners=S,this};function u(b){return b._maxListeners===void 0?d.defaultMaxListeners:b._maxListeners}d.prototype.getMaxListeners=function(){return u(this)},d.prototype.emit=function(S){for(var R=[],O=1;O<arguments.length;O++)R.push(arguments[O]);var L=S==="error",D=this._events;if(D!==void 0)L=L&&D.error===void 0;else if(!L)return!1;if(L){var x;if(R.length>0&&(x=R[0]),x instanceof Error)throw x;var M=new Error("Unhandled error."+(x?" ("+x.message+")":""));throw M.context=x,M}var F=D[S];if(F===void 0)return!1;if(typeof F=="function")t(F,this,R);else for(var V=F.length,q=y(F,V),O=0;O<V;++O)t(q[O],this,R);return!0};function p(b,S,R,O){var L,D,x;if(l(R),D=b._events,D===void 0?(D=b._events=Object.create(null),b._eventsCount=0):(D.newListener!==void 0&&(b.emit("newListener",S,R.listener?R.listener:R),D=b._events),x=D[S]),x===void 0)x=D[S]=R,++b._eventsCount;else if(typeof x=="function"?x=D[S]=O?[R,x]:[x,R]:O?x.unshift(R):x.push(R),L=u(b),L>0&&x.length>L&&!x.warned){x.warned=!0;var M=new Error("Possible EventEmitter memory leak detected. "+x.length+" "+String(S)+" listeners added. Use emitter.setMaxListeners() to increase limit");M.name="MaxListenersExceededWarning",M.emitter=b,M.type=S,M.count=x.length,s(M)}return b}d.prototype.addListener=function(S,R){return p(this,S,R,!1)},d.prototype.on=d.prototype.addListener,d.prototype.prependListener=function(S,R){return p(this,S,R,!0)};function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function m(b,S,R){var O={fired:!1,wrapFn:void 0,target:b,type:S,listener:R},L=f.bind(O);return L.listener=R,O.wrapFn=L,L}d.prototype.once=function(S,R){return l(R),this.on(S,m(this,S,R)),this},d.prototype.prependOnceListener=function(S,R){return l(R),this.prependListener(S,m(this,S,R)),this},d.prototype.removeListener=function(S,R){var O,L,D,x,M;if(l(R),L=this._events,L===void 0)return this;if(O=L[S],O===void 0)return this;if(O===R||O.listener===R)--this._eventsCount===0?this._events=Object.create(null):(delete L[S],L.removeListener&&this.emit("removeListener",S,O.listener||R));else if(typeof O!="function"){for(D=-1,x=O.length-1;x>=0;x--)if(O[x]===R||O[x].listener===R){M=O[x].listener,D=x;break}if(D<0)return this;D===0?O.shift():k(O,D),O.length===1&&(L[S]=O[0]),L.removeListener!==void 0&&this.emit("removeListener",S,M||R)}return this},d.prototype.off=d.prototype.removeListener,d.prototype.removeAllListeners=function(S){var R,O,L;if(O=this._events,O===void 0)return this;if(O.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):O[S]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete O[S]),this;if(arguments.length===0){var D=Object.keys(O),x;for(L=0;L<D.length;++L)x=D[L],x!=="removeListener"&&this.removeAllListeners(x);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(R=O[S],typeof R=="function")this.removeListener(S,R);else if(R!==void 0)for(L=R.length-1;L>=0;L--)this.removeListener(S,R[L]);return this};function g(b,S,R){var O=b._events;if(O===void 0)return[];var L=O[S];return L===void 0?[]:typeof L=="function"?R?[L.listener||L]:[L]:R?E(L):y(L,L.length)}d.prototype.listeners=function(S){return g(this,S,!0)},d.prototype.rawListeners=function(S){return g(this,S,!1)},d.listenerCount=function(b,S){return typeof b.listenerCount=="function"?b.listenerCount(S):v.call(b,S)},d.prototype.listenerCount=v;function v(b){var S=this._events;if(S!==void 0){var R=S[b];if(typeof R=="function")return 1;if(R!==void 0)return R.length}return 0}d.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]};function y(b,S){for(var R=new Array(S),O=0;O<S;++O)R[O]=b[O];return R}function k(b,S){for(;S+1<b.length;S++)b[S]=b[S+1];b.pop()}function E(b){for(var S=new Array(b.length),R=0;R<S.length;++R)S[R]=b[R].listener||b[R];return S}function C(b,S){return new Promise(function(R,O){function L(x){b.removeListener(S,D),O(x)}function D(){typeof b.removeListener=="function"&&b.removeListener("error",L),R([].slice.call(arguments))}w(b,S,D,{once:!0}),S!=="error"&&T(b,L,{once:!0})})}function T(b,S,R){typeof b.on=="function"&&w(b,"error",S,R)}function w(b,S,R,O){if(typeof b.on=="function")O.once?b.once(S,R):b.on(S,R);else if(typeof b.addEventListener=="function")b.addEventListener(S,function L(D){O.once&&b.removeEventListener(S,L),R(D)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof b)}return events.exports}var eventsExports=requireEvents();let logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(n,t,i){const s=n.match(t);return s&&s.length>=i&&parseInt(s[i],10)}function wrapPeerConnectionEvent(n,t,i){if(!n.RTCPeerConnection)return;const s=n.RTCPeerConnection.prototype,a=s.addEventListener;s.addEventListener=function(c,l){if(c!==t)return a.apply(this,arguments);const u=p=>{const f=i(p);f&&(l.handleEvent?l.handleEvent(f):l(f))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(l,u),a.apply(this,[c,u])};const d=s.removeEventListener;s.removeEventListener=function(c,l){if(c!==t||!this._eventMap||!this._eventMap[t])return d.apply(this,arguments);if(!this._eventMap[t].has(l))return d.apply(this,arguments);const u=this._eventMap[t].get(l);return this._eventMap[t].delete(l),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,d.apply(this,[c,u])},Object.defineProperty(s,"on"+t,{get(){return this["_on"+t]},set(c){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),c&&this.addEventListener(t,this["_on"+t]=c)},enumerable:!0,configurable:!0})}function disableLog(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(logDisabled_=n,n?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings(n){return typeof n!="boolean"?new Error("Argument type: "+typeof n+". Please use a boolean."):(deprecationWarnings_=!n,"adapter.js deprecation warnings "+(n?"disabled":"enabled"))}function log(){if(typeof window=="object"){if(logDisabled_)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function deprecated(n,t){deprecationWarnings_&&console.warn(n+" is deprecated, please use "+t+" instead.")}function detectBrowser(n){const t={browser:null,version:null};if(typeof n>"u"||!n.navigator||!n.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:i}=n;if(i.userAgentData&&i.userAgentData.brands){const s=i.userAgentData.brands.find(a=>a.brand==="Chromium");if(s)return{browser:"chrome",version:parseInt(s.version,10)}}if(i.mozGetUserMedia)t.browser="firefox",t.version=extractVersion(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||n.isSecureContext===!1&&n.webkitRTCPeerConnection)t.browser="chrome",t.version=extractVersion(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(n.RTCPeerConnection&&i.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=extractVersion(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=n.RTCRtpTransceiver&&"currentDirection"in n.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function isObject(n){return Object.prototype.toString.call(n)==="[object Object]"}function compactObject(n){return isObject(n)?Object.keys(n).reduce(function(t,i){const s=isObject(n[i]),a=s?compactObject(n[i]):n[i],d=s&&!Object.keys(a).length;return a===void 0||d?t:Object.assign(t,{[i]:a})},{}):n}function walkStats(n,t,i){!t||i.has(t.id)||(i.set(t.id,t),Object.keys(t).forEach(s=>{s.endsWith("Id")?walkStats(n,n.get(t[s]),i):s.endsWith("Ids")&&t[s].forEach(a=>{walkStats(n,n.get(a),i)})}))}function filterStats(n,t,i){const s=i?"outbound-rtp":"inbound-rtp",a=new Map;if(t===null)return a;const d=[];return n.forEach(c=>{c.type==="track"&&c.trackIdentifier===t.id&&d.push(c)}),d.forEach(c=>{n.forEach(l=>{l.type===s&&l.trackId===c.id&&walkStats(n,l,a)})}),a}const logging=log;function shimGetUserMedia$2(n,t){const i=n&&n.navigator;if(!i.mediaDevices)return;const s=function(l){if(typeof l!="object"||l.mandatory||l.optional)return l;const u={};return Object.keys(l).forEach(p=>{if(p==="require"||p==="advanced"||p==="mediaSource")return;const f=typeof l[p]=="object"?l[p]:{ideal:l[p]};f.exact!==void 0&&typeof f.exact=="number"&&(f.min=f.max=f.exact);const m=function(g,v){return g?g+v.charAt(0).toUpperCase()+v.slice(1):v==="deviceId"?"sourceId":v};if(f.ideal!==void 0){u.optional=u.optional||[];let g={};typeof f.ideal=="number"?(g[m("min",p)]=f.ideal,u.optional.push(g),g={},g[m("max",p)]=f.ideal,u.optional.push(g)):(g[m("",p)]=f.ideal,u.optional.push(g))}f.exact!==void 0&&typeof f.exact!="number"?(u.mandatory=u.mandatory||{},u.mandatory[m("",p)]=f.exact):["min","max"].forEach(g=>{f[g]!==void 0&&(u.mandatory=u.mandatory||{},u.mandatory[m(g,p)]=f[g])})}),l.advanced&&(u.optional=(u.optional||[]).concat(l.advanced)),u},a=function(l,u){if(t.version>=61)return u(l);if(l=JSON.parse(JSON.stringify(l)),l&&typeof l.audio=="object"){const p=function(f,m,g){m in f&&!(g in f)&&(f[g]=f[m],delete f[m])};l=JSON.parse(JSON.stringify(l)),p(l.audio,"autoGainControl","googAutoGainControl"),p(l.audio,"noiseSuppression","googNoiseSuppression"),l.audio=s(l.audio)}if(l&&typeof l.video=="object"){let p=l.video.facingMode;p=p&&(typeof p=="object"?p:{ideal:p});const f=t.version<66;if(p&&(p.exact==="user"||p.exact==="environment"||p.ideal==="user"||p.ideal==="environment")&&!(i.mediaDevices.getSupportedConstraints&&i.mediaDevices.getSupportedConstraints().facingMode&&!f)){delete l.video.facingMode;let m;if(p.exact==="environment"||p.ideal==="environment"?m=["back","rear"]:(p.exact==="user"||p.ideal==="user")&&(m=["front"]),m)return i.mediaDevices.enumerateDevices().then(g=>{g=g.filter(y=>y.kind==="videoinput");let v=g.find(y=>m.some(k=>y.label.toLowerCase().includes(k)));return!v&&g.length&&m.includes("back")&&(v=g[g.length-1]),v&&(l.video.deviceId=p.exact?{exact:v.deviceId}:{ideal:v.deviceId}),l.video=s(l.video),logging("chrome: "+JSON.stringify(l)),u(l)})}l.video=s(l.video)}return logging("chrome: "+JSON.stringify(l)),u(l)},d=function(l){return t.version>=64?l:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[l.name]||l.name,message:l.message,constraint:l.constraint||l.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},c=function(l,u,p){a(l,f=>{i.webkitGetUserMedia(f,u,m=>{p&&p(d(m))})})};if(i.getUserMedia=c.bind(i),i.mediaDevices.getUserMedia){const l=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(u){return a(u,p=>l(p).then(f=>{if(p.audio&&!f.getAudioTracks().length||p.video&&!f.getVideoTracks().length)throw f.getTracks().forEach(m=>{m.stop()}),new DOMException("","NotFoundError");return f},f=>Promise.reject(d(f))))}}}function shimMediaStream(n){n.MediaStream=n.MediaStream||n.webkitMediaStream}function shimOnTrack$1(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("ontrack"in n.RTCPeerConnection.prototype)){Object.defineProperty(n.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=s=>{s.stream.addEventListener("addtrack",a=>{let d;n.RTCPeerConnection.prototype.getReceivers?d=this.getReceivers().find(l=>l.track&&l.track.id===a.track.id):d={track:a.track};const c=new Event("track");c.track=a.track,c.receiver=d,c.transceiver={receiver:d},c.streams=[s.stream],this.dispatchEvent(c)}),s.stream.getTracks().forEach(a=>{let d;n.RTCPeerConnection.prototype.getReceivers?d=this.getReceivers().find(l=>l.track&&l.track.id===a.id):d={track:a};const c=new Event("track");c.track=a,c.receiver=d,c.transceiver={receiver:d},c.streams=[s.stream],this.dispatchEvent(c)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else wrapPeerConnectionEvent(n,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function shimGetSendersWithDtmf(n){if(typeof n=="object"&&n.RTCPeerConnection&&!("getSenders"in n.RTCPeerConnection.prototype)&&"createDTMFSender"in n.RTCPeerConnection.prototype){const t=function(a,d){return{track:d,get dtmf(){return this._dtmf===void 0&&(d.kind==="audio"?this._dtmf=a.createDTMFSender(d):this._dtmf=null),this._dtmf},_pc:a}};if(!n.RTCPeerConnection.prototype.getSenders){n.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const a=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(l,u){let p=a.apply(this,arguments);return p||(p=t(this,l),this._senders.push(p)),p};const d=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(l){d.apply(this,arguments);const u=this._senders.indexOf(l);u!==-1&&this._senders.splice(u,1)}}const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(d){this._senders=this._senders||[],i.apply(this,[d]),d.getTracks().forEach(c=>{this._senders.push(t(this,c))})};const s=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(d){this._senders=this._senders||[],s.apply(this,[d]),d.getTracks().forEach(c=>{const l=this._senders.find(u=>u.track===c);l&&this._senders.splice(this._senders.indexOf(l),1)})}}else if(typeof n=="object"&&n.RTCPeerConnection&&"getSenders"in n.RTCPeerConnection.prototype&&"createDTMFSender"in n.RTCPeerConnection.prototype&&n.RTCRtpSender&&!("dtmf"in n.RTCRtpSender.prototype)){const t=n.RTCPeerConnection.prototype.getSenders;n.RTCPeerConnection.prototype.getSenders=function(){const s=t.apply(this,[]);return s.forEach(a=>a._pc=this),s},Object.defineProperty(n.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimSenderReceiverGetStats(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender&&n.RTCRtpReceiver))return;if(!("getStats"in n.RTCRtpSender.prototype)){const i=n.RTCPeerConnection.prototype.getSenders;i&&(n.RTCPeerConnection.prototype.getSenders=function(){const d=i.apply(this,[]);return d.forEach(c=>c._pc=this),d});const s=n.RTCPeerConnection.prototype.addTrack;s&&(n.RTCPeerConnection.prototype.addTrack=function(){const d=s.apply(this,arguments);return d._pc=this,d}),n.RTCRtpSender.prototype.getStats=function(){const d=this;return this._pc.getStats().then(c=>filterStats(c,d.track,!0))}}if(!("getStats"in n.RTCRtpReceiver.prototype)){const i=n.RTCPeerConnection.prototype.getReceivers;i&&(n.RTCPeerConnection.prototype.getReceivers=function(){const a=i.apply(this,[]);return a.forEach(d=>d._pc=this),a}),wrapPeerConnectionEvent(n,"track",s=>(s.receiver._pc=s.srcElement,s)),n.RTCRtpReceiver.prototype.getStats=function(){const a=this;return this._pc.getStats().then(d=>filterStats(d,a.track,!1))}}if(!("getStats"in n.RTCRtpSender.prototype&&"getStats"in n.RTCRtpReceiver.prototype))return;const t=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof n.MediaStreamTrack){const s=arguments[0];let a,d,c;return this.getSenders().forEach(l=>{l.track===s&&(a?c=!0:a=l)}),this.getReceivers().forEach(l=>(l.track===s&&(d?c=!0:d=l),l.track===s)),c||a&&d?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):a?a.getStats():d?d.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(n){n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(c=>this._shimmedLocalStreams[c][0])};const t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addTrack=function(c,l){if(!l)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const u=t.apply(this,arguments);return this._shimmedLocalStreams[l.id]?this._shimmedLocalStreams[l.id].indexOf(u)===-1&&this._shimmedLocalStreams[l.id].push(u):this._shimmedLocalStreams[l.id]=[l,u],u};const i=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(c){this._shimmedLocalStreams=this._shimmedLocalStreams||{},c.getTracks().forEach(p=>{if(this.getSenders().find(m=>m.track===p))throw new DOMException("Track already exists.","InvalidAccessError")});const l=this.getSenders();i.apply(this,arguments);const u=this.getSenders().filter(p=>l.indexOf(p)===-1);this._shimmedLocalStreams[c.id]=[c].concat(u)};const s=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(c){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[c.id],s.apply(this,arguments)};const a=n.RTCPeerConnection.prototype.removeTrack;n.RTCPeerConnection.prototype.removeTrack=function(c){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},c&&Object.keys(this._shimmedLocalStreams).forEach(l=>{const u=this._shimmedLocalStreams[l].indexOf(c);u!==-1&&this._shimmedLocalStreams[l].splice(u,1),this._shimmedLocalStreams[l].length===1&&delete this._shimmedLocalStreams[l]}),a.apply(this,arguments)}}function shimAddTrackRemoveTrack(n,t){if(!n.RTCPeerConnection)return;if(n.RTCPeerConnection.prototype.addTrack&&t.version>=65)return shimAddTrackRemoveTrackWithNative(n);const i=n.RTCPeerConnection.prototype.getLocalStreams;n.RTCPeerConnection.prototype.getLocalStreams=function(){const f=i.apply(this);return this._reverseStreams=this._reverseStreams||{},f.map(m=>this._reverseStreams[m.id])};const s=n.RTCPeerConnection.prototype.addStream;n.RTCPeerConnection.prototype.addStream=function(f){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},f.getTracks().forEach(m=>{if(this.getSenders().find(v=>v.track===m))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[f.id]){const m=new n.MediaStream(f.getTracks());this._streams[f.id]=m,this._reverseStreams[m.id]=f,f=m}s.apply(this,[f])};const a=n.RTCPeerConnection.prototype.removeStream;n.RTCPeerConnection.prototype.removeStream=function(f){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},a.apply(this,[this._streams[f.id]||f]),delete this._reverseStreams[this._streams[f.id]?this._streams[f.id].id:f.id],delete this._streams[f.id]},n.RTCPeerConnection.prototype.addTrack=function(f,m){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const g=[].slice.call(arguments,1);if(g.length!==1||!g[0].getTracks().find(k=>k===f))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(k=>k.track===f))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const y=this._streams[m.id];if(y)y.addTrack(f),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const k=new n.MediaStream([f]);this._streams[m.id]=k,this._reverseStreams[k.id]=m,this.addStream(k)}return this.getSenders().find(k=>k.track===f)};function d(p,f){let m=f.sdp;return Object.keys(p._reverseStreams||[]).forEach(g=>{const v=p._reverseStreams[g],y=p._streams[v.id];m=m.replace(new RegExp(y.id,"g"),v.id)}),new RTCSessionDescription({type:f.type,sdp:m})}function c(p,f){let m=f.sdp;return Object.keys(p._reverseStreams||[]).forEach(g=>{const v=p._reverseStreams[g],y=p._streams[v.id];m=m.replace(new RegExp(v.id,"g"),y.id)}),new RTCSessionDescription({type:f.type,sdp:m})}["createOffer","createAnswer"].forEach(function(p){const f=n.RTCPeerConnection.prototype[p],m={[p](){const g=arguments;return arguments.length&&typeof arguments[0]=="function"?f.apply(this,[y=>{const k=d(this,y);g[0].apply(null,[k])},y=>{g[1]&&g[1].apply(null,y)},arguments[2]]):f.apply(this,arguments).then(y=>d(this,y))}};n.RTCPeerConnection.prototype[p]=m[p]});const l=n.RTCPeerConnection.prototype.setLocalDescription;n.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?l.apply(this,arguments):(arguments[0]=c(this,arguments[0]),l.apply(this,arguments))};const u=Object.getOwnPropertyDescriptor(n.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(n.RTCPeerConnection.prototype,"localDescription",{get(){const p=u.get.apply(this);return p.type===""?p:d(this,p)}}),n.RTCPeerConnection.prototype.removeTrack=function(f){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!f._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(f._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let g;Object.keys(this._streams).forEach(v=>{this._streams[v].getTracks().find(k=>f.track===k)&&(g=this._streams[v])}),g&&(g.getTracks().length===1?this.removeStream(this._reverseStreams[g.id]):g.removeTrack(f.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection$1(n,t){!n.RTCPeerConnection&&n.webkitRTCPeerConnection&&(n.RTCPeerConnection=n.webkitRTCPeerConnection),n.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const s=n.RTCPeerConnection.prototype[i],a={[i](){return arguments[0]=new(i==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};n.RTCPeerConnection.prototype[i]=a[i]})}function fixNegotiationNeeded(n,t){wrapPeerConnectionEvent(n,"negotiationneeded",i=>{const s=i.target;if(!((t.version<72||s.getConfiguration&&s.getConfiguration().sdpSemantics==="plan-b")&&s.signalingState!=="stable"))return i})}var chromeShim=Object.freeze({__proto__:null,fixNegotiationNeeded,shimAddTrackRemoveTrack,shimAddTrackRemoveTrackWithNative,shimGetSendersWithDtmf,shimGetUserMedia:shimGetUserMedia$2,shimMediaStream,shimOnTrack:shimOnTrack$1,shimPeerConnection:shimPeerConnection$1,shimSenderReceiverGetStats});function shimGetUserMedia$1(n,t){const i=n&&n.navigator,s=n&&n.MediaStreamTrack;if(i.getUserMedia=function(a,d,c){deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(a).then(d,c)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const a=function(c,l,u){l in c&&!(u in c)&&(c[u]=c[l],delete c[l])},d=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(c){return typeof c=="object"&&typeof c.audio=="object"&&(c=JSON.parse(JSON.stringify(c)),a(c.audio,"autoGainControl","mozAutoGainControl"),a(c.audio,"noiseSuppression","mozNoiseSuppression")),d(c)},s&&s.prototype.getSettings){const c=s.prototype.getSettings;s.prototype.getSettings=function(){const l=c.apply(this,arguments);return a(l,"mozAutoGainControl","autoGainControl"),a(l,"mozNoiseSuppression","noiseSuppression"),l}}if(s&&s.prototype.applyConstraints){const c=s.prototype.applyConstraints;s.prototype.applyConstraints=function(l){return this.kind==="audio"&&typeof l=="object"&&(l=JSON.parse(JSON.stringify(l)),a(l,"autoGainControl","mozAutoGainControl"),a(l,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[l])}}}}function shimGetDisplayMedia(n,t){n.navigator.mediaDevices&&"getDisplayMedia"in n.navigator.mediaDevices||n.navigator.mediaDevices&&(n.navigator.mediaDevices.getDisplayMedia=function(s){if(!(s&&s.video)){const a=new DOMException("getDisplayMedia without video constraints is undefined");return a.name="NotFoundError",a.code=8,Promise.reject(a)}return s.video===!0?s.video={mediaSource:t}:s.video.mediaSource=t,n.navigator.mediaDevices.getUserMedia(s)})}function shimOnTrack(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimPeerConnection(n,t){if(typeof n!="object"||!(n.RTCPeerConnection||n.mozRTCPeerConnection))return;!n.RTCPeerConnection&&n.mozRTCPeerConnection&&(n.RTCPeerConnection=n.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){const d=n.RTCPeerConnection.prototype[a],c={[a](){return arguments[0]=new(a==="addIceCandidate"?n.RTCIceCandidate:n.RTCSessionDescription)(arguments[0]),d.apply(this,arguments)}};n.RTCPeerConnection.prototype[a]=c[a]});const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=n.RTCPeerConnection.prototype.getStats;n.RTCPeerConnection.prototype.getStats=function(){const[d,c,l]=arguments;return s.apply(this,[d||null]).then(u=>{if(t.version<53&&!c)try{u.forEach(p=>{p.type=i[p.type]||p.type})}catch(p){if(p.name!=="TypeError")throw p;u.forEach((f,m)=>{u.set(m,Object.assign({},f,{type:i[f.type]||f.type}))})}return u}).then(c,l)}}function shimSenderGetStats(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpSender.prototype)return;const t=n.RTCPeerConnection.prototype.getSenders;t&&(n.RTCPeerConnection.prototype.getSenders=function(){const a=t.apply(this,[]);return a.forEach(d=>d._pc=this),a});const i=n.RTCPeerConnection.prototype.addTrack;i&&(n.RTCPeerConnection.prototype.addTrack=function(){const a=i.apply(this,arguments);return a._pc=this,a}),n.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(n){if(!(typeof n=="object"&&n.RTCPeerConnection&&n.RTCRtpSender)||n.RTCRtpSender&&"getStats"in n.RTCRtpReceiver.prototype)return;const t=n.RTCPeerConnection.prototype.getReceivers;t&&(n.RTCPeerConnection.prototype.getReceivers=function(){const s=t.apply(this,[]);return s.forEach(a=>a._pc=this),s}),wrapPeerConnectionEvent(n,"track",i=>(i.receiver._pc=i.srcElement,i)),n.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream(n){!n.RTCPeerConnection||"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(i){deprecated("removeStream","removeTrack"),this.getSenders().forEach(s=>{s.track&&i.getTracks().includes(s.track)&&this.removeTrack(s)})})}function shimRTCDataChannel(n){n.DataChannel&&!n.RTCDataChannel&&(n.RTCDataChannel=n.DataChannel)}function shimAddTransceiver(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const t=n.RTCPeerConnection.prototype.addTransceiver;t&&(n.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let s=arguments[1]&&arguments[1].sendEncodings;s===void 0&&(s=[]),s=[...s];const a=s.length>0;a&&s.forEach(c=>{if("rid"in c&&!/^[a-z0-9]{0,16}$/i.test(c.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in c&&!(parseFloat(c.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in c&&!(parseFloat(c.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const d=t.apply(this,arguments);if(a){const{sender:c}=d,l=c.getParameters();(!("encodings"in l)||l.encodings.length===1&&Object.keys(l.encodings[0]).length===0)&&(l.encodings=s,c.sendEncodings=s,this.setParametersPromises.push(c.setParameters(l).then(()=>{delete c.sendEncodings}).catch(()=>{delete c.sendEncodings})))}return d})}function shimGetParameters(n){if(!(typeof n=="object"&&n.RTCRtpSender))return;const t=n.RTCRtpSender.prototype.getParameters;t&&(n.RTCRtpSender.prototype.getParameters=function(){const s=t.apply(this,arguments);return"encodings"in s||(s.encodings=[].concat(this.sendEncodings||[{}])),s})}function shimCreateOffer(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function shimCreateAnswer(n){if(!(typeof n=="object"&&n.RTCPeerConnection))return;const t=n.RTCPeerConnection.prototype.createAnswer;n.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var firefoxShim=Object.freeze({__proto__:null,shimAddTransceiver,shimCreateAnswer,shimCreateOffer,shimGetDisplayMedia,shimGetParameters,shimGetUserMedia:shimGetUserMedia$1,shimOnTrack,shimPeerConnection,shimRTCDataChannel,shimReceiverGetStats,shimRemoveStream,shimSenderGetStats});function shimLocalStreamsAPI(n){if(!(typeof n!="object"||!n.RTCPeerConnection)){if("getLocalStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in n.RTCPeerConnection.prototype)){const t=n.RTCPeerConnection.prototype.addTrack;n.RTCPeerConnection.prototype.addStream=function(s){this._localStreams||(this._localStreams=[]),this._localStreams.includes(s)||this._localStreams.push(s),s.getAudioTracks().forEach(a=>t.call(this,a,s)),s.getVideoTracks().forEach(a=>t.call(this,a,s))},n.RTCPeerConnection.prototype.addTrack=function(s){for(var a=arguments.length,d=new Array(a>1?a-1:0),c=1;c<a;c++)d[c-1]=arguments[c];return d&&d.forEach(l=>{this._localStreams?this._localStreams.includes(l)||this._localStreams.push(l):this._localStreams=[l]}),t.apply(this,arguments)}}"removeStream"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.removeStream=function(i){this._localStreams||(this._localStreams=[]);const s=this._localStreams.indexOf(i);if(s===-1)return;this._localStreams.splice(s,1);const a=i.getTracks();this.getSenders().forEach(d=>{a.includes(d.track)&&this.removeTrack(d)})})}}function shimRemoteStreamsAPI(n){if(!(typeof n!="object"||!n.RTCPeerConnection)&&("getRemoteStreams"in n.RTCPeerConnection.prototype||(n.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in n.RTCPeerConnection.prototype))){Object.defineProperty(n.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=s=>{s.streams.forEach(a=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(a))return;this._remoteStreams.push(a);const d=new Event("addstream");d.stream=a,this.dispatchEvent(d)})})}});const t=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){const s=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(a){a.streams.forEach(d=>{if(s._remoteStreams||(s._remoteStreams=[]),s._remoteStreams.indexOf(d)>=0)return;s._remoteStreams.push(d);const c=new Event("addstream");c.stream=d,s.dispatchEvent(c)})}),t.apply(s,arguments)}}}function shimCallbacksAPI(n){if(typeof n!="object"||!n.RTCPeerConnection)return;const t=n.RTCPeerConnection.prototype,i=t.createOffer,s=t.createAnswer,a=t.setLocalDescription,d=t.setRemoteDescription,c=t.addIceCandidate;t.createOffer=function(p,f){const m=arguments.length>=2?arguments[2]:arguments[0],g=i.apply(this,[m]);return f?(g.then(p,f),Promise.resolve()):g},t.createAnswer=function(p,f){const m=arguments.length>=2?arguments[2]:arguments[0],g=s.apply(this,[m]);return f?(g.then(p,f),Promise.resolve()):g};let l=function(u,p,f){const m=a.apply(this,[u]);return f?(m.then(p,f),Promise.resolve()):m};t.setLocalDescription=l,l=function(u,p,f){const m=d.apply(this,[u]);return f?(m.then(p,f),Promise.resolve()):m},t.setRemoteDescription=l,l=function(u,p,f){const m=c.apply(this,[u]);return f?(m.then(p,f),Promise.resolve()):m},t.addIceCandidate=l}function shimGetUserMedia(n){const t=n&&n.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const i=t.mediaDevices,s=i.getUserMedia.bind(i);t.mediaDevices.getUserMedia=a=>s(shimConstraints(a))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(s,a,d){t.mediaDevices.getUserMedia(s).then(a,d)}).bind(t))}function shimConstraints(n){return n&&n.video!==void 0?Object.assign({},n,{video:compactObject(n.video)}):n}function shimRTCIceServerUrls(n){if(!n.RTCPeerConnection)return;const t=n.RTCPeerConnection;n.RTCPeerConnection=function(s,a){if(s&&s.iceServers){const d=[];for(let c=0;c<s.iceServers.length;c++){let l=s.iceServers[c];l.urls===void 0&&l.url?(deprecated("RTCIceServer.url","RTCIceServer.urls"),l=JSON.parse(JSON.stringify(l)),l.urls=l.url,delete l.url,d.push(l)):d.push(s.iceServers[c])}s.iceServers=d}return new t(s,a)},n.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(n.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function shimTrackEventTransceiver(n){typeof n=="object"&&n.RTCTrackEvent&&"receiver"in n.RTCTrackEvent.prototype&&!("transceiver"in n.RTCTrackEvent.prototype)&&Object.defineProperty(n.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy(n){const t=n.RTCPeerConnection.prototype.createOffer;n.RTCPeerConnection.prototype.createOffer=function(s){if(s){typeof s.offerToReceiveAudio<"u"&&(s.offerToReceiveAudio=!!s.offerToReceiveAudio);const a=this.getTransceivers().find(c=>c.receiver.track.kind==="audio");s.offerToReceiveAudio===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):s.offerToReceiveAudio===!0&&!a&&this.addTransceiver("audio",{direction:"recvonly"}),typeof s.offerToReceiveVideo<"u"&&(s.offerToReceiveVideo=!!s.offerToReceiveVideo);const d=this.getTransceivers().find(c=>c.receiver.track.kind==="video");s.offerToReceiveVideo===!1&&d?d.direction==="sendrecv"?d.setDirection?d.setDirection("sendonly"):d.direction="sendonly":d.direction==="recvonly"&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive"):s.offerToReceiveVideo===!0&&!d&&this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function shimAudioContext(n){typeof n!="object"||n.AudioContext||(n.AudioContext=n.webkitAudioContext)}var safariShim=Object.freeze({__proto__:null,shimAudioContext,shimCallbacksAPI,shimConstraints,shimCreateOfferLegacy,shimGetUserMedia,shimLocalStreamsAPI,shimRTCIceServerUrls,shimRemoteStreamsAPI,shimTrackEventTransceiver}),sdp$1={exports:{}},hasRequiredSdp;function requireSdp(){return hasRequiredSdp||(hasRequiredSdp=1,function(n){const t={};t.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},t.localCName=t.generateIdentifier(),t.splitLines=function(i){return i.trim().split(`
`).map(s=>s.trim())},t.splitSections=function(i){return i.split(`
m=`).map((a,d)=>(d>0?"m="+a:a).trim()+`\r
`)},t.getDescription=function(i){const s=t.splitSections(i);return s&&s[0]},t.getMediaSections=function(i){const s=t.splitSections(i);return s.shift(),s},t.matchPrefix=function(i,s){return t.splitLines(i).filter(a=>a.indexOf(s)===0)},t.parseCandidate=function(i){let s;i.indexOf("a=candidate:")===0?s=i.substring(12).split(" "):s=i.substring(10).split(" ");const a={foundation:s[0],component:{1:"rtp",2:"rtcp"}[s[1]]||s[1],protocol:s[2].toLowerCase(),priority:parseInt(s[3],10),ip:s[4],address:s[4],port:parseInt(s[5],10),type:s[7]};for(let d=8;d<s.length;d+=2)switch(s[d]){case"raddr":a.relatedAddress=s[d+1];break;case"rport":a.relatedPort=parseInt(s[d+1],10);break;case"tcptype":a.tcpType=s[d+1];break;case"ufrag":a.ufrag=s[d+1],a.usernameFragment=s[d+1];break;default:a[s[d]]===void 0&&(a[s[d]]=s[d+1]);break}return a},t.writeCandidate=function(i){const s=[];s.push(i.foundation);const a=i.component;a==="rtp"?s.push(1):a==="rtcp"?s.push(2):s.push(a),s.push(i.protocol.toUpperCase()),s.push(i.priority),s.push(i.address||i.ip),s.push(i.port);const d=i.type;return s.push("typ"),s.push(d),d!=="host"&&i.relatedAddress&&i.relatedPort&&(s.push("raddr"),s.push(i.relatedAddress),s.push("rport"),s.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(s.push("tcptype"),s.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(s.push("ufrag"),s.push(i.usernameFragment||i.ufrag)),"candidate:"+s.join(" ")},t.parseIceOptions=function(i){return i.substring(14).split(" ")},t.parseRtpMap=function(i){let s=i.substring(9).split(" ");const a={payloadType:parseInt(s.shift(),10)};return s=s[0].split("/"),a.name=s[0],a.clockRate=parseInt(s[1],10),a.channels=s.length===3?parseInt(s[2],10):1,a.numChannels=a.channels,a},t.writeRtpMap=function(i){let s=i.payloadType;i.preferredPayloadType!==void 0&&(s=i.preferredPayloadType);const a=i.channels||i.numChannels||1;return"a=rtpmap:"+s+" "+i.name+"/"+i.clockRate+(a!==1?"/"+a:"")+`\r
`},t.parseExtmap=function(i){const s=i.substring(9).split(" ");return{id:parseInt(s[0],10),direction:s[0].indexOf("/")>0?s[0].split("/")[1]:"sendrecv",uri:s[1],attributes:s.slice(2).join(" ")}},t.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},t.parseFmtp=function(i){const s={};let a;const d=i.substring(i.indexOf(" ")+1).split(";");for(let c=0;c<d.length;c++)a=d[c].trim().split("="),s[a[0].trim()]=a[1];return s},t.writeFmtp=function(i){let s="",a=i.payloadType;if(i.preferredPayloadType!==void 0&&(a=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){const d=[];Object.keys(i.parameters).forEach(c=>{i.parameters[c]!==void 0?d.push(c+"="+i.parameters[c]):d.push(c)}),s+="a=fmtp:"+a+" "+d.join(";")+`\r
`}return s},t.parseRtcpFb=function(i){const s=i.substring(i.indexOf(" ")+1).split(" ");return{type:s.shift(),parameter:s.join(" ")}},t.writeRtcpFb=function(i){let s="",a=i.payloadType;return i.preferredPayloadType!==void 0&&(a=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(d=>{s+="a=rtcp-fb:"+a+" "+d.type+(d.parameter&&d.parameter.length?" "+d.parameter:"")+`\r
`}),s},t.parseSsrcMedia=function(i){const s=i.indexOf(" "),a={ssrc:parseInt(i.substring(7,s),10)},d=i.indexOf(":",s);return d>-1?(a.attribute=i.substring(s+1,d),a.value=i.substring(d+1)):a.attribute=i.substring(s+1),a},t.parseSsrcGroup=function(i){const s=i.substring(13).split(" ");return{semantics:s.shift(),ssrcs:s.map(a=>parseInt(a,10))}},t.getMid=function(i){const s=t.matchPrefix(i,"a=mid:")[0];if(s)return s.substring(6)},t.parseFingerprint=function(i){const s=i.substring(14).split(" ");return{algorithm:s[0].toLowerCase(),value:s[1].toUpperCase()}},t.getDtlsParameters=function(i,s){return{role:"auto",fingerprints:t.matchPrefix(i+s,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(i,s){let a="a=setup:"+s+`\r
`;return i.fingerprints.forEach(d=>{a+="a=fingerprint:"+d.algorithm+" "+d.value+`\r
`}),a},t.parseCryptoLine=function(i){const s=i.substring(9).split(" ");return{tag:parseInt(s[0],10),cryptoSuite:s[1],keyParams:s[2],sessionParams:s.slice(3)}},t.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?t.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;const s=i.substring(7).split("|");return{keyMethod:"inline",keySalt:s[0],lifeTime:s[1],mkiValue:s[2]?s[2].split(":")[0]:void 0,mkiLength:s[2]?s[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},t.getCryptoParameters=function(i,s){return t.matchPrefix(i+s,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(i,s){const a=t.matchPrefix(i+s,"a=ice-ufrag:")[0],d=t.matchPrefix(i+s,"a=ice-pwd:")[0];return a&&d?{usernameFragment:a.substring(12),password:d.substring(10)}:null},t.writeIceParameters=function(i){let s="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(s+=`a=ice-lite\r
`),s},t.parseRtpParameters=function(i){const s={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},d=t.splitLines(i)[0].split(" ");s.profile=d[2];for(let l=3;l<d.length;l++){const u=d[l],p=t.matchPrefix(i,"a=rtpmap:"+u+" ")[0];if(p){const f=t.parseRtpMap(p),m=t.matchPrefix(i,"a=fmtp:"+u+" ");switch(f.parameters=m.length?t.parseFmtp(m[0]):{},f.rtcpFeedback=t.matchPrefix(i,"a=rtcp-fb:"+u+" ").map(t.parseRtcpFb),s.codecs.push(f),f.name.toUpperCase()){case"RED":case"ULPFEC":s.fecMechanisms.push(f.name.toUpperCase());break}}}t.matchPrefix(i,"a=extmap:").forEach(l=>{s.headerExtensions.push(t.parseExtmap(l))});const c=t.matchPrefix(i,"a=rtcp-fb:* ").map(t.parseRtcpFb);return s.codecs.forEach(l=>{c.forEach(u=>{l.rtcpFeedback.find(f=>f.type===u.type&&f.parameter===u.parameter)||l.rtcpFeedback.push(u)})}),s},t.writeRtpDescription=function(i,s){let a="";a+="m="+i+" ",a+=s.codecs.length>0?"9":"0",a+=" "+(s.profile||"UDP/TLS/RTP/SAVPF")+" ",a+=s.codecs.map(c=>c.preferredPayloadType!==void 0?c.preferredPayloadType:c.payloadType).join(" ")+`\r
`,a+=`c=IN IP4 0.0.0.0\r
`,a+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,s.codecs.forEach(c=>{a+=t.writeRtpMap(c),a+=t.writeFmtp(c),a+=t.writeRtcpFb(c)});let d=0;return s.codecs.forEach(c=>{c.maxptime>d&&(d=c.maxptime)}),d>0&&(a+="a=maxptime:"+d+`\r
`),s.headerExtensions&&s.headerExtensions.forEach(c=>{a+=t.writeExtmap(c)}),a},t.parseRtpEncodingParameters=function(i){const s=[],a=t.parseRtpParameters(i),d=a.fecMechanisms.indexOf("RED")!==-1,c=a.fecMechanisms.indexOf("ULPFEC")!==-1,l=t.matchPrefix(i,"a=ssrc:").map(g=>t.parseSsrcMedia(g)).filter(g=>g.attribute==="cname"),u=l.length>0&&l[0].ssrc;let p;const f=t.matchPrefix(i,"a=ssrc-group:FID").map(g=>g.substring(17).split(" ").map(y=>parseInt(y,10)));f.length>0&&f[0].length>1&&f[0][0]===u&&(p=f[0][1]),a.codecs.forEach(g=>{if(g.name.toUpperCase()==="RTX"&&g.parameters.apt){let v={ssrc:u,codecPayloadType:parseInt(g.parameters.apt,10)};u&&p&&(v.rtx={ssrc:p}),s.push(v),d&&(v=JSON.parse(JSON.stringify(v)),v.fec={ssrc:u,mechanism:c?"red+ulpfec":"red"},s.push(v))}}),s.length===0&&u&&s.push({ssrc:u});let m=t.matchPrefix(i,"b=");return m.length&&(m[0].indexOf("b=TIAS:")===0?m=parseInt(m[0].substring(7),10):m[0].indexOf("b=AS:")===0?m=parseInt(m[0].substring(5),10)*1e3*.95-50*40*8:m=void 0,s.forEach(g=>{g.maxBitrate=m})),s},t.parseRtcpParameters=function(i){const s={},a=t.matchPrefix(i,"a=ssrc:").map(l=>t.parseSsrcMedia(l)).filter(l=>l.attribute==="cname")[0];a&&(s.cname=a.value,s.ssrc=a.ssrc);const d=t.matchPrefix(i,"a=rtcp-rsize");s.reducedSize=d.length>0,s.compound=d.length===0;const c=t.matchPrefix(i,"a=rtcp-mux");return s.mux=c.length>0,s},t.writeRtcpParameters=function(i){let s="";return i.reducedSize&&(s+=`a=rtcp-rsize\r
`),i.mux&&(s+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(s+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),s},t.parseMsid=function(i){let s;const a=t.matchPrefix(i,"a=msid:");if(a.length===1)return s=a[0].substring(7).split(" "),{stream:s[0],track:s[1]};const d=t.matchPrefix(i,"a=ssrc:").map(c=>t.parseSsrcMedia(c)).filter(c=>c.attribute==="msid");if(d.length>0)return s=d[0].value.split(" "),{stream:s[0],track:s[1]}},t.parseSctpDescription=function(i){const s=t.parseMLine(i),a=t.matchPrefix(i,"a=max-message-size:");let d;a.length>0&&(d=parseInt(a[0].substring(19),10)),isNaN(d)&&(d=65536);const c=t.matchPrefix(i,"a=sctp-port:");if(c.length>0)return{port:parseInt(c[0].substring(12),10),protocol:s.fmt,maxMessageSize:d};const l=t.matchPrefix(i,"a=sctpmap:");if(l.length>0){const u=l[0].substring(10).split(" ");return{port:parseInt(u[0],10),protocol:u[1],maxMessageSize:d}}},t.writeSctpDescription=function(i,s){let a=[];return i.protocol!=="DTLS/SCTP"?a=["m="+i.kind+" 9 "+i.protocol+" "+s.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+s.port+`\r
`]:a=["m="+i.kind+" 9 "+i.protocol+" "+s.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+s.port+" "+s.protocol+` 65535\r
`],s.maxMessageSize!==void 0&&a.push("a=max-message-size:"+s.maxMessageSize+`\r
`),a.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(i,s,a){let d;const c=s!==void 0?s:2;return i?d=i:d=t.generateSessionId(),`v=0\r
o=`+(a||"thisisadapterortc")+" "+d+" "+c+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(i,s){const a=t.splitLines(i);for(let d=0;d<a.length;d++)switch(a[d]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return a[d].substring(2)}return s?t.getDirection(s):"sendrecv"},t.getKind=function(i){return t.splitLines(i)[0].split(" ")[0].substring(2)},t.isRejected=function(i){return i.split(" ",2)[1]==="0"},t.parseMLine=function(i){const a=t.splitLines(i)[0].substring(2).split(" ");return{kind:a[0],port:parseInt(a[1],10),protocol:a[2],fmt:a.slice(3).join(" ")}},t.parseOLine=function(i){const a=t.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:a[0],sessionId:a[1],sessionVersion:parseInt(a[2],10),netType:a[3],addressType:a[4],address:a[5]}},t.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;const s=t.splitLines(i);for(let a=0;a<s.length;a++)if(s[a].length<2||s[a].charAt(1)!=="=")return!1;return!0},n.exports=t}(sdp$1)),sdp$1.exports}var sdpExports=requireSdp(),SDPUtils=getDefaultExportFromCjs$1(sdpExports),sdp=_mergeNamespaces$1({__proto__:null,default:SDPUtils},[sdpExports]);function shimRTCIceCandidate(n){if(!n.RTCIceCandidate||n.RTCIceCandidate&&"foundation"in n.RTCIceCandidate.prototype)return;const t=n.RTCIceCandidate;n.RTCIceCandidate=function(s){if(typeof s=="object"&&s.candidate&&s.candidate.indexOf("a=")===0&&(s=JSON.parse(JSON.stringify(s)),s.candidate=s.candidate.substring(2)),s.candidate&&s.candidate.length){const a=new t(s),d=SDPUtils.parseCandidate(s.candidate);for(const c in d)c in a||Object.defineProperty(a,c,{value:d[c]});return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(s)},n.RTCIceCandidate.prototype=t.prototype,wrapPeerConnectionEvent(n,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new n.RTCIceCandidate(i.candidate),writable:"false"}),i))}function shimRTCIceCandidateRelayProtocol(n){!n.RTCIceCandidate||n.RTCIceCandidate&&"relayProtocol"in n.RTCIceCandidate.prototype||wrapPeerConnectionEvent(n,"icecandidate",t=>{if(t.candidate){const i=SDPUtils.parseCandidate(t.candidate.candidate);i.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return t})}function shimMaxMessageSize(n,t){if(!n.RTCPeerConnection)return;"sctp"in n.RTCPeerConnection.prototype||Object.defineProperty(n.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const i=function(l){if(!l||!l.sdp)return!1;const u=SDPUtils.splitSections(l.sdp);return u.shift(),u.some(p=>{const f=SDPUtils.parseMLine(p);return f&&f.kind==="application"&&f.protocol.indexOf("SCTP")!==-1})},s=function(l){const u=l.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(u===null||u.length<2)return-1;const p=parseInt(u[1],10);return p!==p?-1:p},a=function(l){let u=65536;return t.browser==="firefox"&&(t.version<57?l===-1?u=16384:u=2147483637:t.version<60?u=t.version===57?65535:65536:u=2147483637),u},d=function(l,u){let p=65536;t.browser==="firefox"&&t.version===57&&(p=65535);const f=SDPUtils.matchPrefix(l.sdp,"a=max-message-size:");return f.length>0?p=parseInt(f[0].substring(19),10):t.browser==="firefox"&&u!==-1&&(p=2147483637),p},c=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:u}=this.getConfiguration();u==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const u=s(arguments[0]),p=a(u),f=d(arguments[0],u);let m;p===0&&f===0?m=Number.POSITIVE_INFINITY:p===0||f===0?m=Math.max(p,f):m=Math.min(p,f);const g={};Object.defineProperty(g,"maxMessageSize",{get(){return m}}),this._sctp=g}return c.apply(this,arguments)}}function shimSendThrowTypeError(n){if(!(n.RTCPeerConnection&&"createDataChannel"in n.RTCPeerConnection.prototype))return;function t(s,a){const d=s.send;s.send=function(){const l=arguments[0],u=l.length||l.size||l.byteLength;if(s.readyState==="open"&&a.sctp&&u>a.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+a.sctp.maxMessageSize+" bytes)");return d.apply(s,arguments)}}const i=n.RTCPeerConnection.prototype.createDataChannel;n.RTCPeerConnection.prototype.createDataChannel=function(){const a=i.apply(this,arguments);return t(a,this),a},wrapPeerConnectionEvent(n,"datachannel",s=>(t(s.channel,s.target),s))}function shimConnectionState(n){if(!n.RTCPeerConnection||"connectionState"in n.RTCPeerConnection.prototype)return;const t=n.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{const s=t[i];t[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=a=>{const d=a.target;if(d._lastConnectionState!==d.connectionState){d._lastConnectionState=d.connectionState;const c=new Event("connectionstatechange",a);d.dispatchEvent(c)}return a},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),s.apply(this,arguments)}})}function removeExtmapAllowMixed(n,t){if(!n.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const i=n.RTCPeerConnection.prototype.setRemoteDescription;n.RTCPeerConnection.prototype.setRemoteDescription=function(a){if(a&&a.sdp&&a.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const d=a.sdp.split(`
`).filter(c=>c.trim()!=="a=extmap-allow-mixed").join(`
`);n.RTCSessionDescription&&a instanceof n.RTCSessionDescription?arguments[0]=new n.RTCSessionDescription({type:a.type,sdp:d}):a.sdp=d}return i.apply(this,arguments)}}function shimAddIceCandidateNullOrEmpty(n,t){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const i=n.RTCPeerConnection.prototype.addIceCandidate;!i||i.length===0||(n.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function shimParameterlessSetLocalDescription(n,t){if(!(n.RTCPeerConnection&&n.RTCPeerConnection.prototype))return;const i=n.RTCPeerConnection.prototype.setLocalDescription;!i||i.length===0||(n.RTCPeerConnection.prototype.setLocalDescription=function(){let a=arguments[0]||{};if(typeof a!="object"||a.type&&a.sdp)return i.apply(this,arguments);if(a={type:a.type,sdp:a.sdp},!a.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":a.type="offer";break;default:a.type="answer";break}return a.sdp||a.type!=="offer"&&a.type!=="answer"?i.apply(this,[a]):(a.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(c=>i.apply(this,[c]))})}var commonShim=Object.freeze({__proto__:null,removeExtmapAllowMixed,shimAddIceCandidateNullOrEmpty,shimConnectionState,shimMaxMessageSize,shimParameterlessSetLocalDescription,shimRTCIceCandidate,shimRTCIceCandidateRelayProtocol,shimSendThrowTypeError});function adapterFactory(){let{window:n}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const i=log,s=detectBrowser(n),a={browserDetails:s,commonShim,extractVersion,disableLog,disableWarnings,sdp};switch(s.browser){case"chrome":if(!chromeShim||!shimPeerConnection$1||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),a;if(s.version===null)return i("Chrome shim can not determine version, not shimming."),a;i("adapter.js shimming chrome."),a.browserShim=chromeShim,shimAddIceCandidateNullOrEmpty(n,s),shimParameterlessSetLocalDescription(n),shimGetUserMedia$2(n,s),shimMediaStream(n),shimPeerConnection$1(n,s),shimOnTrack$1(n),shimAddTrackRemoveTrack(n,s),shimGetSendersWithDtmf(n),shimSenderReceiverGetStats(n),fixNegotiationNeeded(n,s),shimRTCIceCandidate(n),shimRTCIceCandidateRelayProtocol(n),shimConnectionState(n),shimMaxMessageSize(n,s),shimSendThrowTypeError(n),removeExtmapAllowMixed(n,s);break;case"firefox":if(!firefoxShim||!shimPeerConnection||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),a;i("adapter.js shimming firefox."),a.browserShim=firefoxShim,shimAddIceCandidateNullOrEmpty(n,s),shimParameterlessSetLocalDescription(n),shimGetUserMedia$1(n,s),shimPeerConnection(n,s),shimOnTrack(n),shimRemoveStream(n),shimSenderGetStats(n),shimReceiverGetStats(n),shimRTCDataChannel(n),shimAddTransceiver(n),shimGetParameters(n),shimCreateOffer(n),shimCreateAnswer(n),shimRTCIceCandidate(n),shimConnectionState(n),shimMaxMessageSize(n,s),shimSendThrowTypeError(n);break;case"safari":if(!safariShim||!t.shimSafari)return i("Safari shim is not included in this adapter release."),a;i("adapter.js shimming safari."),a.browserShim=safariShim,shimAddIceCandidateNullOrEmpty(n,s),shimParameterlessSetLocalDescription(n),shimRTCIceServerUrls(n),shimCreateOfferLegacy(n),shimCallbacksAPI(n),shimLocalStreamsAPI(n),shimRemoteStreamsAPI(n),shimTrackEventTransceiver(n),shimGetUserMedia(n),shimAudioContext(n),shimRTCIceCandidate(n),shimRTCIceCandidateRelayProtocol(n),shimMaxMessageSize(n,s),shimSendThrowTypeError(n),removeExtmapAllowMixed(n,s);break;default:i("Unsupported browser!");break}return a}adapterFactory({window:typeof window>"u"?void 0:window});const DECRYPTION_FAILURE_TOLERANCE=10,E2EE_FLAG="lk_e2ee",SALT="LKFrameEncryptionKey",KEY_PROVIDER_DEFAULTS={sharedKey:!1,ratchetSalt:SALT,ratchetWindowSize:8,failureTolerance:DECRYPTION_FAILURE_TOLERANCE,keyringSize:16};var KeyProviderEvent;(function(n){n.SetKey="setKey",n.RatchetRequest="ratchetRequest",n.KeyRatcheted="keyRatcheted"})(KeyProviderEvent||(KeyProviderEvent={}));var KeyHandlerEvent;(function(n){n.KeyRatcheted="keyRatcheted"})(KeyHandlerEvent||(KeyHandlerEvent={}));var EncryptionEvent;(function(n){n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError"})(EncryptionEvent||(EncryptionEvent={}));var CryptorEvent;(function(n){n.Error="cryptorError"})(CryptorEvent||(CryptorEvent={}));function isE2EESupported(){return isInsertableStreamSupported()||isScriptTransformSupported()}function isScriptTransformSupported(){return typeof window.RTCRtpScriptTransform<"u"}function isInsertableStreamSupported(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}class BaseKeyProvider extends eventsExports.EventEmitter{constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(i,s)=>{livekitLogger.debug("key ratcheted event received",{material:i,keyIndex:s})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},KEY_PROVIDER_DEFAULTS),t),this.on(KeyProviderEvent.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(t,i,s){const a={key:t,participantIdentity:i,keyIndex:s};if(!this.options.sharedKey&&!i)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(i??"shared","-").concat(s??0),a),this.emit(KeyProviderEvent.SetKey,a)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(t,i){this.emit(KeyProviderEvent.RatchetRequest,t,i)}}class LivekitError extends Error{constructor(t,i){super(i||"an error has occured"),this.name="LiveKitError",this.code=t}}var ConnectionErrorReason;(function(n){n[n.NotAllowed=0]="NotAllowed",n[n.ServerUnreachable=1]="ServerUnreachable",n[n.InternalError=2]="InternalError",n[n.Cancelled=3]="Cancelled",n[n.LeaveRequest=4]="LeaveRequest"})(ConnectionErrorReason||(ConnectionErrorReason={}));class ConnectionError extends LivekitError{constructor(t,i,s,a){super(1,t),this.name="ConnectionError",this.status=s,this.reason=i,this.context=a,this.reasonName=ConnectionErrorReason[i]}}class DeviceUnsupportedError extends LivekitError{constructor(t){super(21,t??"device is unsupported"),this.name="DeviceUnsupportedError"}}class TrackInvalidError extends LivekitError{constructor(t){super(20,t??"track is invalid"),this.name="TrackInvalidError"}}class UnsupportedServer extends LivekitError{constructor(t){super(10,t??"unsupported server"),this.name="UnsupportedServer"}}class UnexpectedConnectionState extends LivekitError{constructor(t){super(12,t??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class NegotiationError extends LivekitError{constructor(t){super(13,t??"unable to negotiate"),this.name="NegotiationError"}}class SignalRequestError extends LivekitError{constructor(t,i){super(15,t),this.reason=i,this.reasonName=typeof i=="string"?i:RequestResponse_Reason[i]}}var MediaDeviceFailure;(function(n){n.PermissionDenied="PermissionDenied",n.NotFound="NotFound",n.DeviceInUse="DeviceInUse",n.Other="Other"})(MediaDeviceFailure||(MediaDeviceFailure={})),function(n){function t(i){if(i&&"name"in i)return i.name==="NotFoundError"||i.name==="DevicesNotFoundError"?n.NotFound:i.name==="NotAllowedError"||i.name==="PermissionDeniedError"?n.PermissionDenied:i.name==="NotReadableError"||i.name==="TrackStartError"?n.DeviceInUse:n.Other}n.getFailure=t}(MediaDeviceFailure||(MediaDeviceFailure={}));var CryptorErrorReason;(function(n){n[n.InvalidKey=0]="InvalidKey",n[n.MissingKey=1]="MissingKey",n[n.InternalError=2]="InternalError"})(CryptorErrorReason||(CryptorErrorReason={}));var RoomEvent;(function(n){n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting",n.Reconnected="reconnected",n.Disconnected="disconnected",n.ConnectionStateChanged="connectionStateChanged",n.MediaDevicesChanged="mediaDevicesChanged",n.ParticipantConnected="participantConnected",n.ParticipantDisconnected="participantDisconnected",n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalAudioSilenceDetected="localAudioSilenceDetected",n.ActiveSpeakersChanged="activeSpeakersChanged",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.ParticipantAttributesChanged="participantAttributesChanged",n.RoomMetadataChanged="roomMetadataChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.AudioPlaybackStatusChanged="audioPlaybackChanged",n.VideoPlaybackStatusChanged="videoPlaybackChanged",n.MediaDevicesError="mediaDevicesError",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.SignalConnected="signalConnected",n.RecordingStatusChanged="recordingStatusChanged",n.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",n.EncryptionError="encryptionError",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ActiveDeviceChanged="activeDeviceChanged",n.ChatMessage="chatMessage",n.LocalTrackSubscribed="localTrackSubscribed",n.MetricsReceived="metricsReceived"})(RoomEvent||(RoomEvent={}));var ParticipantEvent;(function(n){n.TrackPublished="trackPublished",n.TrackSubscribed="trackSubscribed",n.TrackSubscriptionFailed="trackSubscriptionFailed",n.TrackUnpublished="trackUnpublished",n.TrackUnsubscribed="trackUnsubscribed",n.TrackMuted="trackMuted",n.TrackUnmuted="trackUnmuted",n.LocalTrackPublished="localTrackPublished",n.LocalTrackUnpublished="localTrackUnpublished",n.ParticipantMetadataChanged="participantMetadataChanged",n.ParticipantNameChanged="participantNameChanged",n.DataReceived="dataReceived",n.SipDTMFReceived="sipDTMFReceived",n.TranscriptionReceived="transcriptionReceived",n.IsSpeakingChanged="isSpeakingChanged",n.ConnectionQualityChanged="connectionQualityChanged",n.TrackStreamStateChanged="trackStreamStateChanged",n.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",n.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",n.MediaDevicesError="mediaDevicesError",n.AudioStreamAcquired="audioStreamAcquired",n.ParticipantPermissionsChanged="participantPermissionsChanged",n.PCTrackAdded="pcTrackAdded",n.AttributesChanged="attributesChanged",n.LocalTrackSubscribed="localTrackSubscribed",n.ChatMessage="chatMessage"})(ParticipantEvent||(ParticipantEvent={}));var EngineEvent;(function(n){n.TransportsCreated="transportsCreated",n.Connected="connected",n.Disconnected="disconnected",n.Resuming="resuming",n.Resumed="resumed",n.Restarting="restarting",n.Restarted="restarted",n.SignalResumed="signalResumed",n.SignalRestarted="signalRestarted",n.Closing="closing",n.MediaTrackAdded="mediaTrackAdded",n.ActiveSpeakersUpdate="activeSpeakersUpdate",n.DataPacketReceived="dataPacketReceived",n.RTPVideoMapUpdate="rtpVideoMapUpdate",n.DCBufferStatusChanged="dcBufferStatusChanged",n.ParticipantUpdate="participantUpdate",n.RoomUpdate="roomUpdate",n.SpeakersChanged="speakersChanged",n.StreamStateChanged="streamStateChanged",n.ConnectionQualityUpdate="connectionQualityUpdate",n.SubscriptionError="subscriptionError",n.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",n.RemoteMute="remoteMute",n.SubscribedQualityUpdate="subscribedQualityUpdate",n.LocalTrackUnpublished="localTrackUnpublished",n.LocalTrackSubscribed="localTrackSubscribed",n.Offline="offline",n.SignalRequestResponse="signalRequestResponse"})(EngineEvent||(EngineEvent={}));var TrackEvent;(function(n){n.Message="message",n.Muted="muted",n.Unmuted="unmuted",n.Restarted="restarted",n.Ended="ended",n.Subscribed="subscribed",n.Unsubscribed="unsubscribed",n.UpdateSettings="updateSettings",n.UpdateSubscription="updateSubscription",n.AudioPlaybackStarted="audioPlaybackStarted",n.AudioPlaybackFailed="audioPlaybackFailed",n.AudioSilenceDetected="audioSilenceDetected",n.VisibilityChanged="visibilityChanged",n.VideoDimensionsChanged="videoDimensionsChanged",n.VideoPlaybackStarted="videoPlaybackStarted",n.VideoPlaybackFailed="videoPlaybackFailed",n.ElementAttached="elementAttached",n.ElementDetached="elementDetached",n.UpstreamPaused="upstreamPaused",n.UpstreamResumed="upstreamResumed",n.SubscriptionPermissionChanged="subscriptionPermissionChanged",n.SubscriptionStatusChanged="subscriptionStatusChanged",n.SubscriptionFailed="subscriptionFailed",n.TrackProcessorUpdate="trackProcessorUpdate",n.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",n.TranscriptionReceived="transcriptionReceived",n.TimeSyncUpdate="timeSyncUpdate"})(TrackEvent||(TrackEvent={}));function cloneDeep(n){if(!(typeof n>"u"))return typeof structuredClone=="function"?structuredClone(n):JSON.parse(JSON.stringify(n))}const commonVersionIdentifier=/version\/(\d+(\.?_?\d+)+)/i;let browserDetails;function getBrowser(n){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const i=navigator.userAgent.toLowerCase();if(browserDetails===void 0||t){const s=browsersList.find(a=>{let{test:d}=a;return d.test(i)});browserDetails=s==null?void 0:s.describe(i)}return browserDetails}const browsersList=[{test:/firefox|iceweasel|fxios/i,describe(n){return{name:"Firefox",version:getMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:getOSVersion(n)}}},{test:/chrom|crios|crmo/i,describe(n){return{name:"Chrome",version:getMatch(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,n),os:n.toLowerCase().includes("crios")?"iOS":void 0,osVersion:getOSVersion(n)}}},{test:/safari|applewebkit/i,describe(n){return{name:"Safari",version:getMatch(commonVersionIdentifier,n),os:n.includes("mobile/")?"iOS":"macOS",osVersion:getOSVersion(n)}}}];function getMatch(n,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const s=t.match(n);return s&&s.length>=i&&s[i]||""}function getOSVersion(n){return n.includes("mac os")?getMatch(/\(.+?(\d+_\d+(:?_\d+)?)/,n,1).replace(/_/g,"."):void 0}var version$1="2.9.1";const version=version$1,protocolVersion=15;class CriticalTimers{}CriticalTimers.setTimeout=function(){return setTimeout(...arguments)},CriticalTimers.setInterval=function(){return setInterval(...arguments)},CriticalTimers.clearTimeout=function(){return clearTimeout(...arguments)},CriticalTimers.clearInterval=function(){return clearInterval(...arguments)};const BACKGROUND_REACTION_DELAY=5e3,recycledElements=[];var VideoQuality;(function(n){n[n.LOW=0]="LOW",n[n.MEDIUM=1]="MEDIUM",n[n.HIGH=2]="HIGH"})(VideoQuality||(VideoQuality={}));class Track extends eventsExports.EventEmitter{constructor(t,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var a;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=Track.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=livekitLogger,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),BACKGROUND_REACTION_DELAY):this.handleAppVisibilityChanged()},this.log=getLogger((a=s.loggerName)!==null&&a!==void 0?a:LoggerNames.Track),this.loggerContextCb=s.loggerContextCb,this.setMaxListeners(100),this.kind=i,this._mediaStreamTrack=t,this._mediaStreamID=t.id,this.source=Track.Source.Unknown}get logContext(){var t;return Object.assign(Object.assign({},(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this)),getLogContextFromTrack(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(t){let i="audio";this.kind===Track.Kind.Video&&(i="video"),this.attachedElements.length===0&&this.kind===Track.Kind.Video&&this.addAppVisibilityListener(),t||(i==="audio"&&(recycledElements.forEach(d=>{d.parentElement===null&&!t&&(t=d)}),t&&recycledElements.splice(recycledElements.indexOf(t),1)),t||(t=document.createElement(i))),this.attachedElements.includes(t)||this.attachedElements.push(t),attachToElement(this.mediaStreamTrack,t);const s=t.srcObject.getTracks(),a=s.some(d=>d.kind==="audio");return t.play().then(()=>{this.emit(a?TrackEvent.AudioPlaybackStarted:TrackEvent.VideoPlaybackStarted)}).catch(d=>{d.name==="NotAllowedError"?this.emit(a?TrackEvent.AudioPlaybackFailed:TrackEvent.VideoPlaybackFailed,d):d.name==="AbortError"?livekitLogger.debug("".concat(a?"audio":"video"," playback aborted, likely due to new play request")):livekitLogger.warn("could not playback ".concat(a?"audio":"video"),d),a&&t&&s.some(c=>c.kind==="video")&&d.name==="NotAllowedError"&&(t.muted=!0,t.play().catch(()=>{}))}),this.emit(TrackEvent.ElementAttached,t),t}detach(t){try{if(t){detachTrack(this.mediaStreamTrack,t);const s=this.attachedElements.indexOf(t);return s>=0&&(this.attachedElements.splice(s,1),this.recycleElement(t),this.emit(TrackEvent.ElementDetached,t)),t}const i=[];return this.attachedElements.forEach(s=>{detachTrack(this.mediaStreamTrack,s),i.push(s),this.recycleElement(s),this.emit(TrackEvent.ElementDetached,s)}),this.attachedElements=[],i}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(t){t.loggerName&&(this.log=getLogger(t.loggerName)),t.loggerContextCb&&(this.loggerContextCb=t.loggerContextCb)}recycleElement(t){if(t instanceof HTMLAudioElement){let i=!0;t.pause(),recycledElements.forEach(s=>{s.parentElement||(i=!1)}),i&&recycledElements.push(t)}}handleAppVisibilityChanged(){return __awaiter$1(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===Track.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(t=>t.play().catch(()=>{})),0)})}addAppVisibilityListener(){isWeb()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){isWeb()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function attachToElement(n,t){let i;t.srcObject instanceof MediaStream?i=t.srcObject:i=new MediaStream;let s;n.kind==="audio"?s=i.getAudioTracks():s=i.getVideoTracks(),s.includes(n)||(s.forEach(a=>{i.removeTrack(a)}),i.addTrack(n)),(!isSafari()||!(t instanceof HTMLVideoElement))&&(t.autoplay=!0),t.muted=i.getAudioTracks().length===0,t instanceof HTMLVideoElement&&(t.playsInline=!0),t.srcObject!==i&&(t.srcObject=i,(isSafari()||isFireFox())&&t instanceof HTMLVideoElement&&setTimeout(()=>{t.srcObject=i,t.play().catch(()=>{})},0))}function detachTrack(n,t){if(t.srcObject instanceof MediaStream){const i=t.srcObject;i.removeTrack(n),i.getTracks().length>0?t.srcObject=i:t.srcObject=null}}(function(n){let t;(function(p){p.Audio="audio",p.Video="video",p.Unknown="unknown"})(t=n.Kind||(n.Kind={}));let i;(function(p){p.Camera="camera",p.Microphone="microphone",p.ScreenShare="screen_share",p.ScreenShareAudio="screen_share_audio",p.Unknown="unknown"})(i=n.Source||(n.Source={}));let s;(function(p){p.Active="active",p.Paused="paused",p.Unknown="unknown"})(s=n.StreamState||(n.StreamState={}));function a(p){switch(p){case t.Audio:return TrackType.AUDIO;case t.Video:return TrackType.VIDEO;default:return TrackType.DATA}}n.kindToProto=a;function d(p){switch(p){case TrackType.AUDIO:return t.Audio;case TrackType.VIDEO:return t.Video;default:return t.Unknown}}n.kindFromProto=d;function c(p){switch(p){case i.Camera:return TrackSource.CAMERA;case i.Microphone:return TrackSource.MICROPHONE;case i.ScreenShare:return TrackSource.SCREEN_SHARE;case i.ScreenShareAudio:return TrackSource.SCREEN_SHARE_AUDIO;default:return TrackSource.UNKNOWN}}n.sourceToProto=c;function l(p){switch(p){case TrackSource.CAMERA:return i.Camera;case TrackSource.MICROPHONE:return i.Microphone;case TrackSource.SCREEN_SHARE:return i.ScreenShare;case TrackSource.SCREEN_SHARE_AUDIO:return i.ScreenShareAudio;default:return i.Unknown}}n.sourceFromProto=l;function u(p){switch(p){case StreamState.ACTIVE:return s.Active;case StreamState.PAUSED:return s.Paused;default:return s.Unknown}}n.streamStateFromProto=u})(Track);class VideoPreset{constructor(t,i,s,a,d){if(typeof t=="object")this.width=t.width,this.height=t.height,this.aspectRatio=t.aspectRatio,this.encoding={maxBitrate:t.maxBitrate,maxFramerate:t.maxFramerate,priority:t.priority};else if(i!==void 0&&s!==void 0)this.width=t,this.height=i,this.aspectRatio=t/i,this.encoding={maxBitrate:s,maxFramerate:a,priority:d};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const backupCodecs=["vp8","h264"],videoCodecs=["vp8","h264","vp9","av1"];function isBackupCodec(n){return!!backupCodecs.find(t=>t===n)}var BackupCodecPolicy;(function(n){n[n.REGRESSION=0]="REGRESSION",n[n.SIMULCAST=1]="SIMULCAST"})(BackupCodecPolicy||(BackupCodecPolicy={}));var AudioPresets;(function(n){n.telephone={maxBitrate:12e3},n.speech={maxBitrate:24e3},n.music={maxBitrate:48e3},n.musicStereo={maxBitrate:64e3},n.musicHighQuality={maxBitrate:96e3},n.musicHighQualityStereo={maxBitrate:128e3}})(AudioPresets||(AudioPresets={}));const VideoPresets={h90:new VideoPreset(160,90,9e4,20),h180:new VideoPreset(320,180,16e4,20),h216:new VideoPreset(384,216,18e4,20),h360:new VideoPreset(640,360,45e4,20),h540:new VideoPreset(960,540,8e5,25),h720:new VideoPreset(1280,720,17e5,30),h1080:new VideoPreset(1920,1080,3e6,30),h1440:new VideoPreset(2560,1440,5e6,30),h2160:new VideoPreset(3840,2160,8e6,30)},VideoPresets43={h120:new VideoPreset(160,120,7e4,20),h180:new VideoPreset(240,180,125e3,20),h240:new VideoPreset(320,240,14e4,20),h360:new VideoPreset(480,360,33e4,20),h480:new VideoPreset(640,480,5e5,20),h540:new VideoPreset(720,540,6e5,25),h720:new VideoPreset(960,720,13e5,30),h1080:new VideoPreset(1440,1080,23e5,30),h1440:new VideoPreset(1920,1440,38e5,30)},ScreenSharePresets={h360fps3:new VideoPreset(640,360,2e5,3,"medium"),h360fps15:new VideoPreset(640,360,4e5,15,"medium"),h720fps5:new VideoPreset(1280,720,8e5,5,"medium"),h720fps15:new VideoPreset(1280,720,15e5,15,"medium"),h720fps30:new VideoPreset(1280,720,2e6,30,"medium"),h1080fps15:new VideoPreset(1920,1080,25e5,15,"medium"),h1080fps30:new VideoPreset(1920,1080,5e6,30,"medium"),original:new VideoPreset(0,0,7e6,30,"medium")},separator="|",ddExtensionURI="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function unpackStreamId(n){const t=n.split(separator);return t.length>1?[t[0],n.substr(t[0].length+1)]:[n,""]}function sleep$1(n){return __awaiter$1(this,void 0,void 0,function*(){return new Promise(t=>CriticalTimers.setTimeout(t,n))})}function supportsTransceiver(){return"addTransceiver"in RTCPeerConnection.prototype}function supportsAddTrack(){return"addTrack"in RTCPeerConnection.prototype}function supportsAV1(){if(!("getCapabilities"in RTCRtpSender)||isSafari())return!1;const n=RTCRtpSender.getCapabilities("video");let t=!1;if(n){for(const i of n.codecs)if(i.mimeType==="video/AV1"){t=!0;break}}return t}function supportsVP9(){if(!("getCapabilities"in RTCRtpSender)||isFireFox())return!1;if(isSafari()){const i=getBrowser();if(i!=null&&i.version&&compareVersions(i.version,"16")<0)return!1}const n=RTCRtpSender.getCapabilities("video");let t=!1;if(n){for(const i of n.codecs)if(i.mimeType==="video/VP9"){t=!0;break}}return t}function isSVCCodec(n){return n==="av1"||n==="vp9"}function supportsSetSinkId(n){return document?(n||(n=document.createElement("audio")),"setSinkId"in n):!1}function isBrowserSupported(){return typeof RTCPeerConnection>"u"?!1:supportsTransceiver()||supportsAddTrack()}function isFireFox(){var n;return((n=getBrowser())===null||n===void 0?void 0:n.name)==="Firefox"}function isSafari(){var n;return((n=getBrowser())===null||n===void 0?void 0:n.name)==="Safari"}function isSafari17(){const n=getBrowser();return(n==null?void 0:n.name)==="Safari"&&n.version.startsWith("17.")}function isMobile(){var n,t;return isWeb()?(t=(n=navigator.userAgentData)===null||n===void 0?void 0:n.mobile)!==null&&t!==void 0?t:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function isE2EESimulcastSupported(){const n=getBrowser(),t="17.2";if(n)return n.name!=="Safari"&&n.os!=="iOS"||n.os==="iOS"&&n.osVersion&&compareVersions(t,n.osVersion)>=0?!0:n.name==="Safari"&&compareVersions(t,n.version)>=0}function isWeb(){return typeof document<"u"}function isReactNative(){return navigator.product=="ReactNative"}function isCloud(n){return n.hostname.endsWith(".livekit.cloud")||n.hostname.endsWith(".livekit.run")}function getLKReactNativeInfo(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function getReactNativeOs(){if(!isReactNative())return;let n=getLKReactNativeInfo();if(n)return n.platform}function getDevicePixelRatio(){if(isWeb())return window.devicePixelRatio;if(isReactNative()){let n=getLKReactNativeInfo();if(n)return n.devicePixelRatio}return 1}function compareVersions(n,t){const i=n.split("."),s=t.split("."),a=Math.min(i.length,s.length);for(let d=0;d<a;++d){const c=parseInt(i[d],10),l=parseInt(s[d],10);if(c>l)return 1;if(c<l)return-1;if(d===a-1&&c===l)return 0}return n===""&&t!==""?-1:t===""?1:i.length==s.length?0:i.length<s.length?-1:1}function roDispatchCallback(n){for(const t of n)t.target.handleResize(t)}function ioDispatchCallback(n){for(const t of n)t.target.handleVisibilityChanged(t)}let resizeObserver=null;const getResizeObserver=()=>(resizeObserver||(resizeObserver=new ResizeObserver(roDispatchCallback)),resizeObserver);let intersectionObserver=null;const getIntersectionObserver=()=>(intersectionObserver||(intersectionObserver=new IntersectionObserver(ioDispatchCallback,{root:null,rootMargin:"0px"})),intersectionObserver);function getClientInfo(){var n;const t=new ClientInfo({sdk:ClientInfo_SDK.JS,protocol:protocolVersion,version});return isReactNative()&&(t.os=(n=getReactNativeOs())!==null&&n!==void 0?n:""),t}function createDummyVideoStreamTrack(){let n=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const a=document.createElement("canvas");a.width=n,a.height=t;const d=a.getContext("2d");d==null||d.fillRect(0,0,a.width,a.height),s&&d&&(d.beginPath(),d.arc(n/2,t/2,50,0,Math.PI*2,!0),d.closePath(),d.fillStyle="grey",d.fill());const c=a.captureStream(),[l]=c.getTracks();if(!l)throw Error("Could not get empty media stream video track");return l.enabled=i,l}let emptyAudioStreamTrack;function getEmptyAudioStreamTrack(){if(!emptyAudioStreamTrack){const n=new AudioContext,t=n.createOscillator(),i=n.createGain();i.gain.setValueAtTime(0,0);const s=n.createMediaStreamDestination();if(t.connect(i),i.connect(s),t.start(),[emptyAudioStreamTrack]=s.stream.getAudioTracks(),!emptyAudioStreamTrack)throw Error("Could not get empty media stream audio track");emptyAudioStreamTrack.enabled=!1}return emptyAudioStreamTrack.clone()}class Future{constructor(t,i){this.onFinally=i,this.promise=new Promise((s,a)=>__awaiter$1(this,void 0,void 0,function*(){this.resolve=s,this.reject=a,t&&(yield t(s,a))})).finally(()=>{var s;return(s=this.onFinally)===null||s===void 0?void 0:s.call(this)})}}function isVideoCodec(n){return videoCodecs.includes(n)}function unwrapConstraint(n){if(typeof n=="string"||typeof n=="number")return n;if(Array.isArray(n))return n[0];if(n.exact)return Array.isArray(n.exact)?n.exact[0]:n.exact;if(n.ideal)return Array.isArray(n.ideal)?n.ideal[0]:n.ideal;throw Error("could not unwrap constraint")}function toWebsocketUrl(n){return n.startsWith("http")?n.replace(/^(http)/,"ws"):n}function toHttpUrl(n){return n.startsWith("ws")?n.replace(/^(ws)/,"http"):n}function extractTranscriptionSegments(n,t){return n.segments.map(i=>{let{id:s,text:a,language:d,startTime:c,endTime:l,final:u}=i;var p;const f=(p=t.get(s))!==null&&p!==void 0?p:Date.now(),m=Date.now();return u?t.delete(s):t.set(s,f),{id:s,text:a,startTime:Number.parseInt(c.toString()),endTime:Number.parseInt(l.toString()),final:u,language:d,firstReceivedTime:f,lastReceivedTime:m}})}function extractChatMessage(n){const{id:t,timestamp:i,message:s,editTimestamp:a}=n;return{id:t,timestamp:Number.parseInt(i.toString()),editTimestamp:a?Number.parseInt(a.toString()):void 0,message:s}}function getDisconnectReasonFromConnectionError(n){switch(n.reason){case ConnectionErrorReason.LeaveRequest:return n.context;case ConnectionErrorReason.Cancelled:return DisconnectReason.CLIENT_INITIATED;case ConnectionErrorReason.NotAllowed:return DisconnectReason.USER_REJECTED;case ConnectionErrorReason.ServerUnreachable:return DisconnectReason.JOIN_FAILURE;default:return DisconnectReason.UNKNOWN_REASON}}function bigIntToNumber(n){return n!==void 0?Number(n):void 0}function numberToBigInt(n){return n!==void 0?BigInt(n):void 0}function isLocalTrack(n){return!!n&&!(n instanceof MediaStreamTrack)&&n.isLocal}function isAudioTrack(n){return!!n&&n.kind==Track.Kind.Audio}function isVideoTrack(n){return!!n&&n.kind==Track.Kind.Video}function isLocalVideoTrack(n){return isLocalTrack(n)&&isVideoTrack(n)}function isLocalAudioTrack(n){return isLocalTrack(n)&&isAudioTrack(n)}function isRemoteTrack(n){return!!n&&!n.isLocal}function isRemotePub(n){return!!n&&!n.isLocal}function isRemoteVideoTrack(n){return isRemoteTrack(n)&&isVideoTrack(n)}function isLocalParticipant(n){return n.isLocal}function mergeDefaultOptions(n,t,i){var s,a,d,c,l;const{optionsWithoutProcessor:u,audioProcessor:p,videoProcessor:f}=extractProcessorsFromOptions(n??{}),m=(s=cloneDeep(u))!==null&&s!==void 0?s:{};return m.audio===!0&&(m.audio={}),m.video===!0&&(m.video={}),m.audio&&(mergeObjectWithoutOverwriting(m.audio,t),(a=(c=m.audio).deviceId)!==null&&a!==void 0||(c.deviceId="default"),p&&(m.audio.processor=p)),m.video&&(mergeObjectWithoutOverwriting(m.video,i),(d=(l=m.video).deviceId)!==null&&d!==void 0||(l.deviceId="default"),f&&(m.video.processor=f)),m}function mergeObjectWithoutOverwriting(n,t){return Object.keys(t).forEach(i=>{n[i]===void 0&&(n[i]=t[i])}),n}function constraintsForOptions(n){var t,i,s,a;const d={};if(n.video)if(typeof n.video=="object"){const c={},l=c,u=n.video;Object.keys(u).forEach(p=>{switch(p){case"resolution":mergeObjectWithoutOverwriting(l,u.resolution);break;default:l[p]=u[p]}}),d.video=c,(t=(s=d.video).deviceId)!==null&&t!==void 0||(s.deviceId="default")}else d.video=n.video?{deviceId:"default"}:!1;else d.video=!1;return n.audio?typeof n.audio=="object"?(d.audio=n.audio,(i=(a=d.audio).deviceId)!==null&&i!==void 0||(a.deviceId="default")):d.audio={deviceId:"default"}:d.audio=!1,d}function detectSilence(n){return __awaiter$1(this,arguments,void 0,function(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return function*(){const s=getNewAudioContext();if(s){const a=s.createAnalyser();a.fftSize=2048;const d=a.frequencyBinCount,c=new Uint8Array(d);s.createMediaStreamSource(new MediaStream([t.mediaStreamTrack])).connect(a),yield sleep$1(i),a.getByteTimeDomainData(c);const u=c.some(p=>p!==128&&p!==0);return s.close(),!u}return!1}()})}function getNewAudioContext(){const n=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(n)return new n({latencyHint:"interactive"})}function sourceToKind(n){return n===Track.Source.Microphone?"audioinput":n===Track.Source.Camera?"videoinput":void 0}function screenCaptureToDisplayMediaStreamOptions(n){var t,i;let s=(t=n.video)!==null&&t!==void 0?t:!0;return n.resolution&&n.resolution.width>0&&n.resolution.height>0&&(s=typeof s=="boolean"?{}:s,isSafari()?s=Object.assign(Object.assign({},s),{width:{max:n.resolution.width},height:{max:n.resolution.height},frameRate:n.resolution.frameRate}):s=Object.assign(Object.assign({},s),{width:{ideal:n.resolution.width},height:{ideal:n.resolution.height},frameRate:n.resolution.frameRate})),{audio:(i=n.audio)!==null&&i!==void 0?i:!1,video:s,controller:n.controller,selfBrowserSurface:n.selfBrowserSurface,surfaceSwitching:n.surfaceSwitching,systemAudio:n.systemAudio,preferCurrentTab:n.preferCurrentTab}}function mimeTypeToVideoCodecString(n){return n.split("/")[1].toLowerCase()}function getTrackPublicationInfo(n){const t=[];return n.forEach(i=>{i.track!==void 0&&t.push(new TrackPublishedResponse({cid:i.track.mediaStreamID,track:i.trackInfo}))}),t}function getLogContextFromTrack(n){return"mediaStreamTrack"in n?{trackID:n.sid,source:n.source,muted:n.isMuted,enabled:n.mediaStreamTrack.enabled,kind:n.kind,streamID:n.mediaStreamID,streamTrackID:n.mediaStreamTrack.id}:{trackID:n.trackSid,enabled:n.isEnabled,muted:n.isMuted,trackInfo:Object.assign({mimeType:n.mimeType,name:n.trackName,encrypted:n.isEncrypted,kind:n.kind,source:n.source},n.track?getLogContextFromTrack(n.track):{})}}function supportsSynchronizationSources(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function diffAttributes(n,t){var i;n===void 0&&(n={}),t===void 0&&(t={});const s=[...Object.keys(t),...Object.keys(n)],a={};for(const d of s)n[d]!==t[d]&&(a[d]=(i=t[d])!==null&&i!==void 0?i:"");return a}function extractProcessorsFromOptions(n){const t=Object.assign({},n);let i,s;return typeof t.audio=="object"&&t.audio.processor&&(i=t.audio.processor,t.audio=Object.assign(Object.assign({},t.audio),{processor:void 0})),typeof t.video=="object"&&t.video.processor&&(s=t.video.processor,t.video=Object.assign(Object.assign({},t.video),{processor:void 0})),{audioProcessor:i,videoProcessor:s,optionsWithoutProcessor:t}}class E2EEManager extends eventsExports.EventEmitter{constructor(t){super(),this.onWorkerMessage=i=>{var s,a;const{kind:d,data:c}=i.data;switch(d){case"error":livekitLogger.error(c.error.message),this.emit(EncryptionEvent.EncryptionError,c.error);break;case"initAck":c.enabled&&this.keyProvider.getKeys().forEach(l=>{this.postKey(l)});break;case"enable":if(c.enabled&&this.keyProvider.getKeys().forEach(l=>{this.postKey(l)}),this.encryptionEnabled!==c.enabled&&c.participantIdentity===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity))this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,c.enabled,this.room.localParticipant),this.encryptionEnabled=c.enabled;else if(c.participantIdentity){const l=(a=this.room)===null||a===void 0?void 0:a.getParticipantByIdentity(c.participantIdentity);if(!l)throw TypeError("couldn't set encryption status, participant not found".concat(c.participantIdentity));this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,c.enabled,l)}break;case"ratchetKey":this.keyProvider.emit(KeyProviderEvent.KeyRatcheted,c.material,c.keyIndex);break}},this.onWorkerError=i=>{livekitLogger.error("e2ee worker encountered an error:",{error:i.error}),this.emit(EncryptionEvent.EncryptionError,i.error)},this.keyProvider=t.keyProvider,this.worker=t.worker,this.encryptionEnabled=!1}setup(t){if(!isE2EESupported())throw new DeviceUnsupportedError("tried to setup end-to-end encryption on an unsupported browser");if(livekitLogger.info("setting up e2ee"),t!==this.room){this.room=t,this.setupEventListeners(t,this.keyProvider);const i={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:workerLogger.getLevel()}};this.worker&&(livekitLogger.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(i))}}setParticipantCryptorEnabled(t,i){livekitLogger.debug("set e2ee to ".concat(t," for participant ").concat(i)),this.postEnable(t,i)}setSifTrailer(t){!t||t.length===0?livekitLogger.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(t)}setupEngine(t){t.on(EngineEvent.RTPVideoMapUpdate,i=>{this.postRTPMap(i)})}setupEventListeners(t,i){t.on(RoomEvent.TrackPublished,(s,a)=>this.setParticipantCryptorEnabled(s.trackInfo.encryption!==Encryption_Type.NONE,a.identity)),t.on(RoomEvent.ConnectionStateChanged,s=>{s===ConnectionState.Connected&&t.remoteParticipants.forEach(a=>{a.trackPublications.forEach(d=>{this.setParticipantCryptorEnabled(d.trackInfo.encryption!==Encryption_Type.NONE,a.identity)})})}).on(RoomEvent.TrackUnsubscribed,(s,a,d)=>{var c;const l={kind:"removeTransform",data:{participantIdentity:d.identity,trackId:s.mediaStreamID}};(c=this.worker)===null||c===void 0||c.postMessage(l)}).on(RoomEvent.TrackSubscribed,(s,a,d)=>{this.setupE2EEReceiver(s,d.identity,a.trackInfo)}).on(RoomEvent.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");i.getKeys().forEach(s=>{this.postKey(s)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),t.localParticipant.on(ParticipantEvent.LocalTrackPublished,s=>__awaiter$1(this,void 0,void 0,function*(){this.setupE2EESender(s.track,s.track.sender)})),i.on(KeyProviderEvent.SetKey,s=>this.postKey(s)).on(KeyProviderEvent.RatchetRequest,(s,a)=>this.postRatchetRequest(s,a))}postRatchetRequest(t,i){if(!this.worker)throw Error("could not ratchet key, worker is missing");const s={kind:"ratchetRequest",data:{participantIdentity:t,keyIndex:i}};this.worker.postMessage(s)}postKey(t){let{key:i,participantIdentity:s,keyIndex:a}=t;var d;if(!this.worker)throw Error("could not set key, worker is missing");const c={kind:"setKey",data:{participantIdentity:s,isPublisher:s===((d=this.room)===null||d===void 0?void 0:d.localParticipant.identity),key:i,keyIndex:a}};this.worker.postMessage(c)}postEnable(t,i){if(this.worker){const s={kind:"enable",data:{enabled:t,participantIdentity:i}};this.worker.postMessage(s)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(t){var i;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((i=this.room)===null||i===void 0)&&i.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const s={kind:"setRTPMap",data:{map:t,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(s)}postSifTrailer(t){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const i={kind:"setSifTrailer",data:{trailer:t}};this.worker.postMessage(i)}setupE2EEReceiver(t,i,s){if(t.receiver){if(!(s!=null&&s.mimeType)||s.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(t.receiver,t.mediaStreamID,i,t.kind==="video"?mimeTypeToVideoCodecString(s.mimeType):void 0)}}setupE2EESender(t,i){if(!isLocalTrack(t)||!i){i||livekitLogger.warn("early return because sender is not ready");return}this.handleSender(i,t.mediaStreamID,void 0)}handleReceiver(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){if(this.worker){if(isScriptTransformSupported()){const d={kind:"decode",participantIdentity:s,trackId:i,codec:a};t.transform=new RTCRtpScriptTransform(this.worker,d)}else{if(E2EE_FLAG in t&&a){const u={kind:"updateCodec",data:{trackId:i,codec:a,participantIdentity:s}};this.worker.postMessage(u);return}let d=t.writableStream,c=t.readableStream;if(!d||!c){const u=t.createEncodedStreams();t.writableStream=u.writable,d=u.writable,t.readableStream=u.readable,c=u.readable}const l={kind:"decode",data:{readableStream:c,writableStream:d,trackId:i,codec:a,participantIdentity:s}};this.worker.postMessage(l,[c,d])}t[E2EE_FLAG]=!0}})}handleSender(t,i,s){var a;if(!(E2EE_FLAG in t||!this.worker)){if(!(!((a=this.room)===null||a===void 0)&&a.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(isScriptTransformSupported()){livekitLogger.info("initialize script transform");const d={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:i,codec:s};t.transform=new RTCRtpScriptTransform(this.worker,d)}else{livekitLogger.info("initialize encoded streams");const d=t.createEncodedStreams(),c={kind:"encode",data:{readableStream:d.readable,writableStream:d.writable,codec:s,trackId:i,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(c,[d.readable,d.writable])}t[E2EE_FLAG]=!0}}}const defaultId="default";class DeviceManager{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new DeviceManager),this.instance}get previousDevices(){return this._previousDevices}getDevices(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var d;if(((d=DeviceManager.userMediaPromiseMap)===null||d===void 0?void 0:d.size)>0){livekitLogger.debug("awaiting getUserMedia promise");try{i?yield DeviceManager.userMediaPromiseMap.get(i):yield Promise.all(DeviceManager.userMediaPromiseMap.values())}catch{livekitLogger.warn("error waiting for media permissons")}}let c=yield navigator.mediaDevices.enumerateDevices();if(a&&!(isSafari()&&s.hasDeviceInUse(i))&&(c.filter(u=>u.kind===i).length===0||c.some(u=>{const p=u.label==="",f=i?u.kind===i:!0;return p&&f}))){const u={video:i!=="audioinput"&&i!=="audiooutput",audio:i!=="videoinput"&&{deviceId:"default"}},p=yield navigator.mediaDevices.getUserMedia(u);c=yield navigator.mediaDevices.enumerateDevices(),p.getTracks().forEach(f=>{f.stop()})}return s._previousDevices=c,i&&(c=c.filter(l=>l.kind===i)),c}()})}normalizeDeviceId(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){if(i!==defaultId)return i;const a=yield this.getDevices(t),d=a.find(l=>l.deviceId===defaultId);if(!d){livekitLogger.warn("could not reliably determine default device");return}const c=a.find(l=>l.deviceId!==defaultId&&l.groupId===(s??d.groupId));if(!c){livekitLogger.warn("could not reliably determine default device");return}return c==null?void 0:c.deviceId})}hasDeviceInUse(t){return t?DeviceManager.userMediaPromiseMap.has(t):DeviceManager.userMediaPromiseMap.size>0}}DeviceManager.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],DeviceManager.userMediaPromiseMap=new Map;var QueueTaskStatus;(function(n){n[n.WAITING=0]="WAITING",n[n.RUNNING=1]="RUNNING",n[n.COMPLETED=2]="COMPLETED"})(QueueTaskStatus||(QueueTaskStatus={}));class AsyncQueue{constructor(){this.pendingTasks=new Map,this.taskMutex=new _,this.nextTaskIndex=0}run(t){return __awaiter$1(this,void 0,void 0,function*(){const i={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:QueueTaskStatus.WAITING};this.pendingTasks.set(i.id,i);const s=yield this.taskMutex.lock();try{return i.executedAt=Date.now(),i.status=QueueTaskStatus.RUNNING,yield t()}finally{i.status=QueueTaskStatus.COMPLETED,this.pendingTasks.delete(i.id),s()}})}flush(){return __awaiter$1(this,void 0,void 0,function*(){return this.run(()=>__awaiter$1(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const passThroughQueueSignals=["syncState","trickle","offer","answer","simulate","leave"];function canPassThroughQueue(n){const t=passThroughQueueSignals.indexOf(n.case)>=0;return livekitLogger.trace("request allowed to bypass queue:",{canPass:t,req:n}),t}var SignalConnectionState;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.CONNECTED=1]="CONNECTED",n[n.RECONNECTING=2]="RECONNECTING",n[n.DISCONNECTING=3]="DISCONNECTING",n[n.DISCONNECTED=4]="DISCONNECTED"})(SignalConnectionState||(SignalConnectionState={}));class SignalClient{get currentState(){return this.state}get isDisconnected(){return this.state===SignalConnectionState.DISCONNECTING||this.state===SignalConnectionState.DISCONNECTED}get isEstablishingConnection(){return this.state===SignalConnectionState.CONNECTING||this.state===SignalConnectionState.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var s;this.rtt=0,this.state=SignalConnectionState.DISCONNECTED,this.log=livekitLogger,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=getLogger((s=i.loggerName)!==null&&s!==void 0?s:LoggerNames.Signal),this.loggerContextCb=i.loggerContextCb,this.useJSON=t,this.requestQueue=new AsyncQueue,this.queuedRequests=[],this.closingLock=new _,this.connectionLock=new _,this.state=SignalConnectionState.DISCONNECTED}get logContext(){var t,i;return(i=(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this))!==null&&i!==void 0?i:{}}join(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){return this.state=SignalConnectionState.CONNECTING,this.options=s,yield this.connect(t,i,s,a)})}reconnect(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=SignalConnectionState.RECONNECTING,this.clearPingInterval(),yield this.connect(t,i,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:s,reconnectReason:a}))})}connect(t,i,s,a){this.connectOptions=s,t=toWebsocketUrl(t),t=t.replace(/\/$/,""),t+="/rtc";const d=getClientInfo(),c=createConnectionParams(i,d,s);return new Promise((l,u)=>__awaiter$1(this,void 0,void 0,function*(){const p=yield this.connectionLock.lock();try{const f=()=>__awaiter$1(this,void 0,void 0,function*(){this.close(),clearTimeout(m),u(new ConnectionError("room connection has been cancelled (signal)",ConnectionErrorReason.Cancelled))}),m=setTimeout(()=>{this.close(),u(new ConnectionError("room connection has timed out (signal)",ConnectionErrorReason.ServerUnreachable))},s.websocketTimeout);a!=null&&a.aborted&&f(),a==null||a.addEventListener("abort",f),this.log.debug("connecting to ".concat(t+c.replace(/access_token=([^&#$]*)/,"access_token=<redacted>")),this.logContext),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(t+c),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(m)},this.ws.onerror=g=>__awaiter$1(this,void 0,void 0,function*(){if(this.state!==SignalConnectionState.CONNECTED){this.state=SignalConnectionState.DISCONNECTED,clearTimeout(m);try{const v=yield fetch("http".concat(t.substring(2),"/validate").concat(c));if(v.status.toFixed(0).startsWith("4")){const y=yield v.text();u(new ConnectionError(y,ConnectionErrorReason.NotAllowed,v.status))}else u(new ConnectionError("Internal error",ConnectionErrorReason.InternalError,v.status))}catch(v){u(new ConnectionError(v instanceof Error?v.message:"server was not reachable",ConnectionErrorReason.ServerUnreachable))}return}this.handleWSError(g)}),this.ws.onmessage=g=>__awaiter$1(this,void 0,void 0,function*(){var v,y,k;let E;if(typeof g.data=="string"){const C=JSON.parse(g.data);E=SignalResponse.fromJson(C,{ignoreUnknownFields:!0})}else if(g.data instanceof ArrayBuffer)E=SignalResponse.fromBinary(new Uint8Array(g.data));else{this.log.error("could not decode websocket message: ".concat(typeof g.data),this.logContext);return}if(this.state!==SignalConnectionState.CONNECTED){let C=!1;if(((v=E.message)===null||v===void 0?void 0:v.case)==="join"?(this.state=SignalConnectionState.CONNECTED,a==null||a.removeEventListener("abort",f),this.pingTimeoutDuration=E.message.value.pingTimeout,this.pingIntervalDuration=E.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),l(E.message.value)):this.state===SignalConnectionState.RECONNECTING&&E.message.case!=="leave"?(this.state=SignalConnectionState.CONNECTED,a==null||a.removeEventListener("abort",f),this.startPingInterval(),((y=E.message)===null||y===void 0?void 0:y.case)==="reconnect"?l(E.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),l(void 0),C=!0)):this.isEstablishingConnection&&E.message.case==="leave"?u(new ConnectionError("Received leave request while trying to (re)connect",ConnectionErrorReason.LeaveRequest,void 0,E.message.value.reason)):s.reconnect||u(new ConnectionError("did not receive join response, got ".concat((k=E.message)===null||k===void 0?void 0:k.case," instead"),ConnectionErrorReason.InternalError)),!C)return}this.signalLatency&&(yield sleep$1(this.signalLatency)),this.handleSignalResponse(E)}),this.ws.onclose=g=>{this.isEstablishingConnection&&u(new ConnectionError("Websocket got closed during a (re)connection attempt",ConnectionErrorReason.InternalError)),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:g.reason,code:g.code,wasClean:g.wasClean,state:this.state})),this.handleOnClose(g.reason)}}finally{p()}}))}close(){return __awaiter$1(this,arguments,void 0,function(){var t=this;let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){const s=yield t.closingLock.lock();try{if(t.clearPingInterval(),i&&(t.state=SignalConnectionState.DISCONNECTING),t.ws){t.ws.onmessage=null,t.ws.onopen=null,t.ws.onclose=null;const a=new Promise(d=>{t.ws?t.ws.onclose=()=>{d()}:d()});t.ws.readyState<t.ws.CLOSING&&(t.ws.close(),yield Promise.race([a,sleep$1(250)])),t.ws=void 0}}finally{i&&(t.state=SignalConnectionState.DISCONNECTED),s()}}()})}sendOffer(t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:t.sdp})),this.sendRequest({case:"offer",value:toProtoSessionDescription(t)})}sendAnswer(t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:t.sdp})),this.sendRequest({case:"answer",value:toProtoSessionDescription(t)})}sendIceCandidate(t,i){return this.log.trace("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:t})),this.sendRequest({case:"trickle",value:new TrickleRequest({candidateInit:JSON.stringify(t),target:i})})}sendMuteTrack(t,i){return this.sendRequest({case:"mute",value:new MuteTrackRequest({sid:t,muted:i})})}sendAddTrack(t){return this.sendRequest({case:"addTrack",value:t})}sendUpdateLocalMetadata(t,i){return __awaiter$1(this,arguments,void 0,function(s,a){var d=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return function*(){const l=d.getNextRequestId();return yield d.sendRequest({case:"updateMetadata",value:new UpdateParticipantMetadata({requestId:l,metadata:s,name:a,attributes:c})}),l}()})}sendUpdateTrackSettings(t){this.sendRequest({case:"trackSetting",value:t})}sendUpdateSubscription(t){return this.sendRequest({case:"subscription",value:t})}sendSyncState(t){return this.sendRequest({case:"syncState",value:t})}sendUpdateVideoLayers(t,i){return this.sendRequest({case:"updateLayers",value:new UpdateVideoLayers({trackSid:t,layers:i})})}sendUpdateSubscriptionPermissions(t,i){return this.sendRequest({case:"subscriptionPermission",value:new SubscriptionPermission({allParticipants:t,trackPermissions:i})})}sendSimulateScenario(t){return this.sendRequest({case:"simulate",value:t})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:protoInt64.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Ping({timestamp:protoInt64.parse(Date.now()),rtt:protoInt64.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(t,i){return this.sendRequest({case:"updateAudioTrack",value:new UpdateLocalAudioTrack({trackSid:t,features:i})})}sendLeave(){return this.sendRequest({case:"leave",value:new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.DISCONNECT})})}sendRequest(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return function*(){if(!a&&!canPassThroughQueue(i)&&s.state===SignalConnectionState.RECONNECTING){s.queuedRequests.push(()=>__awaiter$1(s,void 0,void 0,function*(){yield this.sendRequest(i,!0)}));return}if(a||(yield s.requestQueue.flush()),s.signalLatency&&(yield sleep$1(s.signalLatency)),!s.ws||s.ws.readyState!==s.ws.OPEN){s.log.error("cannot send signal request before connected, type: ".concat(i==null?void 0:i.case),s.logContext);return}const c=new SignalRequest({message:i});try{s.useJSON?s.ws.send(c.toJsonString()):s.ws.send(c.toBinary())}catch(l){s.log.error("error sending signal message",Object.assign(Object.assign({},s.logContext),{error:l}))}}()})}handleSignalResponse(t){var i,s;const a=t.message;if(a==null){this.log.debug("received unsupported message",this.logContext);return}let d=!1;if(a.case==="answer"){const c=fromProtoSessionDescription(a.value);this.onAnswer&&this.onAnswer(c)}else if(a.case==="offer"){const c=fromProtoSessionDescription(a.value);this.onOffer&&this.onOffer(c)}else if(a.case==="trickle"){const c=JSON.parse(a.value.candidateInit);this.onTrickle&&this.onTrickle(c,a.value.target)}else a.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((i=a.value.participants)!==null&&i!==void 0?i:[]):a.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(a.value):a.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((s=a.value.speakers)!==null&&s!==void 0?s:[]):a.case==="leave"?this.onLeave&&this.onLeave(a.value):a.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(a.value.sid,a.value.muted):a.case==="roomUpdate"?this.onRoomUpdate&&a.value.room&&this.onRoomUpdate(a.value.room):a.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(a.value):a.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(a.value):a.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(a.value):a.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(a.value):a.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(a.value):a.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(a.value):a.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(a.value):a.case==="pong"||(a.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(a.value.lastPingTimestamp.toString()),this.resetPingTimeout(),d=!0):a.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(a.value):a.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(a.value.trackSid):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:a.case})));d||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const t=this.queuedRequests.shift();t&&this.requestQueue.run(t)}}handleOnClose(t){return __awaiter$1(this,void 0,void 0,function*(){if(this.state===SignalConnectionState.DISCONNECTED)return;const i=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat(t),Object.assign(Object.assign({},this.logContext),{reason:t})),i&&i(t)})}handleWSError(t){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:t}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=CriticalTimers.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&CriticalTimers.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=CriticalTimers.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&CriticalTimers.clearInterval(this.pingInterval)}}function fromProtoSessionDescription(n){const t={type:"offer",sdp:n.sdp};switch(n.type){case"answer":case"offer":case"pranswer":case"rollback":t.type=n.type;break}return t}function toProtoSessionDescription(n){return new SessionDescription({sdp:n.sdp,type:n.type})}function createConnectionParams(n,t,i){var s;const a=new URLSearchParams;return a.set("access_token",n),i.reconnect&&(a.set("reconnect","1"),i.sid&&a.set("sid",i.sid)),a.set("auto_subscribe",i.autoSubscribe?"1":"0"),a.set("sdk",isReactNative()?"reactnative":"js"),a.set("version",t.version),a.set("protocol",t.protocol.toString()),t.deviceModel&&a.set("device_model",t.deviceModel),t.os&&a.set("os",t.os),t.osVersion&&a.set("os_version",t.osVersion),t.browser&&a.set("browser",t.browser),t.browserVersion&&a.set("browser_version",t.browserVersion),i.adaptiveStream&&a.set("adaptive_stream","1"),i.reconnectReason&&a.set("reconnect_reason",i.reconnectReason.toString()),!((s=navigator.connection)===null||s===void 0)&&s.type&&a.set("network",navigator.connection.type),"?".concat(a.toString())}var lib={},parser={},grammar={exports:{}},hasRequiredGrammar;function requireGrammar(){if(hasRequiredGrammar)return grammar.exports;hasRequiredGrammar=1;var n=grammar.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(t){return t.encoding?"rtpmap:%d %s/%s/%s":t.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(t){return t.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(t){return t.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(t){return"extmap:%d"+(t.direction?"/%s":"%v")+(t["encrypt-uri"]?" %s":"%v")+" %s"+(t.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(t){return t.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(t){var i="candidate:%s %d %s %d %s %d typ %s";return i+=t.raddr!=null?" raddr %s rport %d":"%v%v",i+=t.tcptype!=null?" tcptype %s":"%v",t.generation!=null&&(i+=" generation %d"),i+=t["network-id"]!=null?" network-id %d":"%v",i+=t["network-cost"]!=null?" network-cost %d":"%v",i}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(t){var i="ssrc:%d";return t.attribute!=null&&(i+=" %s",t.value!=null&&(i+=":%s")),i}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(t){return t.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(t){return t.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(t){return"imageattr:%s %s %s"+(t.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(t){return"simulcast:%s %s"+(t.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(t){return"ts-refclk:%s"+(t.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(t){var i="mediaclk:";return i+=t.id!=null?"id=%s %s":"%v%s",i+=t.mediaClockValue!=null?"=%s":"",i+=t.rateNumerator!=null?" rate=%s":"",i+=t.rateDenominator!=null?"/%s":"",i}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(n).forEach(function(t){var i=n[t];i.forEach(function(s){s.reg||(s.reg=/(.*)/),s.format||(s.format="%s")})}),grammar.exports}var hasRequiredParser;function requireParser(){return hasRequiredParser||(hasRequiredParser=1,function(n){var t=function(l){return String(Number(l))===l?Number(l):l},i=function(l,u,p,f){if(f&&!p)u[f]=t(l[1]);else for(var m=0;m<p.length;m+=1)l[m+1]!=null&&(u[p[m]]=t(l[m+1]))},s=function(l,u,p){var f=l.name&&l.names;l.push&&!u[l.push]?u[l.push]=[]:f&&!u[l.name]&&(u[l.name]={});var m=l.push?{}:f?u[l.name]:u;i(p.match(l.reg),m,l.names,l.name),l.push&&u[l.push].push(m)},a=requireGrammar(),d=RegExp.prototype.test.bind(/^([a-z])=(.*)/);n.parse=function(l){var u={},p=[],f=u;return l.split(/(\r\n|\r|\n)/).filter(d).forEach(function(m){var g=m[0],v=m.slice(2);g==="m"&&(p.push({rtp:[],fmtp:[]}),f=p[p.length-1]);for(var y=0;y<(a[g]||[]).length;y+=1){var k=a[g][y];if(k.reg.test(v))return s(k,f,v)}}),u.media=p,u};var c=function(l,u){var p=u.split(/=(.+)/,2);return p.length===2?l[p[0]]=t(p[1]):p.length===1&&u.length>1&&(l[p[0]]=void 0),l};n.parseParams=function(l){return l.split(/;\s?/).reduce(c,{})},n.parseFmtpConfig=n.parseParams,n.parsePayloads=function(l){return l.toString().split(" ").map(Number)},n.parseRemoteCandidates=function(l){for(var u=[],p=l.split(" ").map(t),f=0;f<p.length;f+=3)u.push({component:p[f],ip:p[f+1],port:p[f+2]});return u},n.parseImageAttributes=function(l){return l.split(" ").map(function(u){return u.substring(1,u.length-1).split(",").reduce(c,{})})},n.parseSimulcastStreamList=function(l){return l.split(";").map(function(u){return u.split(",").map(function(p){var f,m=!1;return p[0]!=="~"?f=t(p):(f=t(p.substring(1,p.length)),m=!0),{scid:f,paused:m}})})}}(parser)),parser}var writer$1,hasRequiredWriter;function requireWriter(){if(hasRequiredWriter)return writer$1;hasRequiredWriter=1;var n=requireGrammar(),t=/%[sdv%]/g,i=function(c){var l=1,u=arguments,p=u.length;return c.replace(t,function(f){if(l>=p)return f;var m=u[l];switch(l+=1,f){case"%%":return"%";case"%s":return String(m);case"%d":return Number(m);case"%v":return""}})},s=function(c,l,u){var p=l.format instanceof Function?l.format(l.push?u:u[l.name]):l.format,f=[c+"="+p];if(l.names)for(var m=0;m<l.names.length;m+=1){var g=l.names[m];l.name?f.push(u[l.name][g]):f.push(u[l.names[m]])}else f.push(u[l.name]);return i.apply(null,f)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],d=["i","c","b","a"];return writer$1=function(c,l){l=l||{},c.version==null&&(c.version=0),c.name==null&&(c.name=" "),c.media.forEach(function(m){m.payloads==null&&(m.payloads="")});var u=l.outerOrder||a,p=l.innerOrder||d,f=[];return u.forEach(function(m){n[m].forEach(function(g){g.name in c&&c[g.name]!=null?f.push(s(m,g,c)):g.push in c&&c[g.push]!=null&&c[g.push].forEach(function(v){f.push(s(m,g,v))})})}),c.media.forEach(function(m){f.push(s("m",n.m[0],m)),p.forEach(function(g){n[g].forEach(function(v){v.name in m&&m[v.name]!=null?f.push(s(g,v,m)):v.push in m&&m[v.push]!=null&&m[v.push].forEach(function(y){f.push(s(g,v,y))})})})}),f.join(`\r
`)+`\r
`},writer$1}var hasRequiredLib;function requireLib(){if(hasRequiredLib)return lib;hasRequiredLib=1;var n=requireParser(),t=requireWriter(),i=requireGrammar();return lib.grammar=i,lib.write=t,lib.parse=n.parse,lib.parseParams=n.parseParams,lib.parseFmtpConfig=n.parseFmtpConfig,lib.parsePayloads=n.parsePayloads,lib.parseRemoteCandidates=n.parseRemoteCandidates,lib.parseImageAttributes=n.parseImageAttributes,lib.parseSimulcastStreamList=n.parseSimulcastStreamList,lib}var libExports=requireLib();function r(n,t,i){var s,a,d;t===void 0&&(t=50),i===void 0&&(i={});var c=(s=i.isImmediate)!=null&&s,l=(a=i.callback)!=null&&a,u=i.maxWait,p=Date.now(),f=[];function m(){if(u!==void 0){var v=Date.now()-p;if(v+t>=u)return u-v}return t}var g=function(){var v=[].slice.call(arguments),y=this;return new Promise(function(k,E){var C=c&&d===void 0;if(d!==void 0&&clearTimeout(d),d=setTimeout(function(){if(d=void 0,p=Date.now(),!c){var w=n.apply(y,v);l&&l(w),f.forEach(function(b){return(0,b.resolve)(w)}),f=[]}},m()),C){var T=n.apply(y,v);return l&&l(T),k(T)}f.push({resolve:k,reject:E})})};return g.cancel=function(v){d!==void 0&&clearTimeout(d),f.forEach(function(y){return(0,y.reject)(v)}),f=[]},g}const startBitrateForSVC=.7,debounceInterval=20,PCEvents={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class PCTransport extends eventsExports.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var s;super(),this.log=livekitLogger,this.ddExtID=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=r(a=>__awaiter$1(this,void 0,void 0,function*(){this.emit(PCEvents.NegotiationStarted);try{yield this.createAndSendOffer()}catch(d){if(a)a(d);else throw d}}),debounceInterval),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=getLogger((s=i.loggerName)!==null&&s!==void 0?s:LoggerNames.PCTransport),this.loggerOptions=i,this.config=t,this._pc=this.createPC()}createPC(){const t=new RTCPeerConnection(this.config);return t.onicecandidate=i=>{var s;i.candidate&&((s=this.onIceCandidate)===null||s===void 0||s.call(this,i.candidate))},t.onicecandidateerror=i=>{var s;(s=this.onIceCandidateError)===null||s===void 0||s.call(this,i)},t.oniceconnectionstatechange=()=>{var i;(i=this.onIceConnectionStateChange)===null||i===void 0||i.call(this,t.iceConnectionState)},t.onsignalingstatechange=()=>{var i;(i=this.onSignalingStatechange)===null||i===void 0||i.call(this,t.signalingState)},t.onconnectionstatechange=()=>{var i;(i=this.onConnectionStateChange)===null||i===void 0||i.call(this,t.connectionState)},t.ondatachannel=i=>{var s;(s=this.onDataChannel)===null||s===void 0||s.call(this,i)},t.ontrack=i=>{var s;(s=this.onTrack)===null||s===void 0||s.call(this,i)},t}get logContext(){var t,i;return Object.assign({},(i=(t=this.loggerOptions).loggerContextCb)===null||i===void 0?void 0:i.call(t))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(t){return __awaiter$1(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(t);this.pendingCandidates.push(t)})}setRemoteDescription(t){return __awaiter$1(this,void 0,void 0,function*(){var i;let s;if(t.type==="offer"){let{stereoMids:a,nackMids:d}=extractStereoAndNackAudioFromOffer(t);this.remoteStereoMids=a,this.remoteNackMids=d}else if(t.type==="answer"){const a=libExports.parse((i=t.sdp)!==null&&i!==void 0?i:"");a.media.forEach(d=>{d.type==="audio"&&this.trackBitrates.some(c=>{if(!c.transceiver||d.mid!=c.transceiver.mid)return!1;let l=0;if(d.rtp.some(p=>p.codec.toUpperCase()===c.codec.toUpperCase()?(l=p.payload,!0):!1),l===0)return!0;let u=!1;for(const p of d.fmtp)if(p.payload===l){p.config=p.config.split(";").filter(f=>!f.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(p.config+=";maxaveragebitrate=".concat(c.maxbr*1e3)),u=!0;break}return u||c.maxbr>0&&d.fmtp.push({payload:l,config:"maxaveragebitrate=".concat(c.maxbr*1e3)}),!0})}),s=libExports.write(a)}yield this.setMungedSDP(t,s,!0),this.pendingCandidates.forEach(a=>{this.pc.addIceCandidate(a)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):t.type==="answer"&&(this.emit(PCEvents.NegotiationComplete),t.sdp&&libExports.parse(t.sdp).media.forEach(d=>{d.type==="video"&&this.emit(PCEvents.RTPVideoPayloadTypes,d.rtp)}))})}createAndSendOffer(t){return __awaiter$1(this,void 0,void 0,function*(){var i;if(this.onOffer===void 0)return;if(t!=null&&t.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const d=this._pc.remoteDescription;if(t!=null&&t.iceRestart&&d)yield this._pc.setRemoteDescription(d);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const s=yield this.pc.createOffer(t);this.log.debug("original offer",Object.assign({sdp:s.sdp},this.logContext));const a=libExports.parse((i=s.sdp)!==null&&i!==void 0?i:"");a.media.forEach(d=>{ensureIPAddrMatchVersion(d),d.type==="audio"?ensureAudioNackAndStereo(d,[],[]):d.type==="video"&&this.trackBitrates.some(c=>{if(!d.msid||!c.cid||!d.msid.includes(c.cid))return!1;let l=0;if(d.rtp.some(p=>p.codec.toUpperCase()===c.codec.toUpperCase()?(l=p.payload,!0):!1),l===0||(isSVCCodec(c.codec)&&this.ensureVideoDDExtensionForSVC(d,a),c.codec!=="av1"))return!0;const u=Math.round(c.maxbr*startBitrateForSVC);for(const p of d.fmtp)if(p.payload===l){p.config.includes("x-google-start-bitrate")||(p.config+=";x-google-start-bitrate=".concat(u));break}return!0})}),yield this.setMungedSDP(s,libExports.write(a)),this.onOffer(s)})}createAndSetAnswer(){return __awaiter$1(this,void 0,void 0,function*(){var t;const i=yield this.pc.createAnswer(),s=libExports.parse((t=i.sdp)!==null&&t!==void 0?t:"");return s.media.forEach(a=>{ensureIPAddrMatchVersion(a),a.type==="audio"&&ensureAudioNackAndStereo(a,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(i,libExports.write(s)),i})}createDataChannel(t,i){return this.pc.createDataChannel(t,i)}addTransceiver(t,i){return this.pc.addTransceiver(t,i)}addTrack(t){if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot add track");return this._pc.addTrack(t)}setTrackCodecBitrate(t){this.trackBitrates.push(t)}setConfiguration(t){var i;if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot configure");return(i=this._pc)===null||i===void 0?void 0:i.setConfiguration(t)}canRemoveTrack(){var t;return!!(!((t=this._pc)===null||t===void 0)&&t.removeTrack)}removeTrack(t){var i;return(i=this._pc)===null||i===void 0?void 0:i.removeTrack(t)}getConnectionState(){var t,i;return(i=(t=this._pc)===null||t===void 0?void 0:t.connectionState)!==null&&i!==void 0?i:"closed"}getICEConnectionState(){var t,i;return(i=(t=this._pc)===null||t===void 0?void 0:t.iceConnectionState)!==null&&i!==void 0?i:"closed"}getSignallingState(){var t,i;return(i=(t=this._pc)===null||t===void 0?void 0:t.signalingState)!==null&&i!==void 0?i:"closed"}getTransceivers(){var t,i;return(i=(t=this._pc)===null||t===void 0?void 0:t.getTransceivers())!==null&&i!==void 0?i:[]}getSenders(){var t,i;return(i=(t=this._pc)===null||t===void 0?void 0:t.getSenders())!==null&&i!==void 0?i:[]}getLocalDescription(){var t;return(t=this._pc)===null||t===void 0?void 0:t.localDescription}getRemoteDescription(){var t;return(t=this.pc)===null||t===void 0?void 0:t.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return __awaiter$1(this,void 0,void 0,function*(){var t;if(!this._pc)return;let i="";const s=new Map,a=new Map;if((yield this._pc.getStats()).forEach(l=>{switch(l.type){case"transport":i=l.selectedCandidatePairId;break;case"candidate-pair":i===""&&l.selected&&(i=l.id),s.set(l.id,l);break;case"remote-candidate":a.set(l.id,"".concat(l.address,":").concat(l.port));break}}),i==="")return;const c=(t=s.get(i))===null||t===void 0?void 0:t.remoteCandidateId;if(c!==void 0)return a.get(c)})}setMungedSDP(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){if(i){const a=t.sdp;t.sdp=i;try{this.log.debug("setting munged ".concat(s?"remote":"local"," description"),this.logContext),s?yield this.pc.setRemoteDescription(t):yield this.pc.setLocalDescription(t);return}catch(d){this.log.warn("not able to set ".concat(t.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:d,sdp:i})),t.sdp=a}}try{s?yield this.pc.setRemoteDescription(t):yield this.pc.setLocalDescription(t)}catch(a){let d="unknown error";a instanceof Error?d=a.message:typeof a=="string"&&(d=a);const c={error:d,sdp:t.sdp};throw!s&&this.pc.remoteDescription&&(c.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(t.type),Object.assign(Object.assign({},this.logContext),{fields:c})),new NegotiationError(d)}})}ensureVideoDDExtensionForSVC(t,i){var s,a;if(!((s=t.ext)===null||s===void 0?void 0:s.some(c=>c.uri===ddExtensionURI))){if(this.ddExtID===0){let c=0;i.media.forEach(l=>{var u;l.type==="video"&&((u=l.ext)===null||u===void 0||u.forEach(p=>{p.value>c&&(c=p.value)}))}),this.ddExtID=c+1}(a=t.ext)===null||a===void 0||a.push({value:this.ddExtID,uri:ddExtensionURI})}}}function ensureAudioNackAndStereo(n,t,i){let s=0;n.rtp.some(a=>a.codec==="opus"?(s=a.payload,!0):!1),s>0&&(n.rtcpFb||(n.rtcpFb=[]),i.includes(n.mid)&&!n.rtcpFb.some(a=>a.payload===s&&a.type==="nack")&&n.rtcpFb.push({payload:s,type:"nack"}),t.includes(n.mid)&&n.fmtp.some(a=>a.payload===s?(a.config.includes("stereo=1")||(a.config+=";stereo=1"),!0):!1))}function extractStereoAndNackAudioFromOffer(n){var t;const i=[],s=[],a=libExports.parse((t=n.sdp)!==null&&t!==void 0?t:"");let d=0;return a.media.forEach(c=>{var l;c.type==="audio"&&(c.rtp.some(u=>u.codec==="opus"?(d=u.payload,!0):!1),!((l=c.rtcpFb)===null||l===void 0)&&l.some(u=>u.payload===d&&u.type==="nack")&&s.push(c.mid),c.fmtp.some(u=>u.payload===d?(u.config.includes("sprop-stereo=1")&&i.push(c.mid),!0):!1))}),{stereoMids:i,nackMids:s}}function ensureIPAddrMatchVersion(n){if(n.connection){const t=n.connection.ip.indexOf(":")>=0;(n.connection.version===4&&t||n.connection.version===6&&!t)&&(n.connection.ip="0.0.0.0",n.connection.version=4)}}const defaultVideoCodec="vp8",publishDefaults={audioPreset:AudioPresets.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ScreenSharePresets.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:defaultVideoCodec,backupCodec:!0},audioDefaults={deviceId:"default",autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},videoDefaults={deviceId:"default",resolution:VideoPresets.h720.resolution},roomOptionDefaults={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new DefaultReconnectPolicy,disconnectOnPageLeave:!0,webAudioMix:!1},roomConnectOptionDefaults={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var PCTransportState;(function(n){n[n.NEW=0]="NEW",n[n.CONNECTING=1]="CONNECTING",n[n.CONNECTED=2]="CONNECTED",n[n.FAILED=3]="FAILED",n[n.CLOSING=4]="CLOSING",n[n.CLOSED=5]="CLOSED"})(PCTransportState||(PCTransportState={}));class PCTransportManager{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(t,i,s){var a;this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.log=livekitLogger,this.updateState=()=>{var d;const c=this.state,l=this.requiredTransports.map(u=>u.getConnectionState());l.every(u=>u==="connected")?this.state=PCTransportState.CONNECTED:l.some(u=>u==="failed")?this.state=PCTransportState.FAILED:l.some(u=>u==="connecting")?this.state=PCTransportState.CONNECTING:l.every(u=>u==="closed")?this.state=PCTransportState.CLOSED:l.some(u=>u==="closed")?this.state=PCTransportState.CLOSING:l.every(u=>u==="new")&&(this.state=PCTransportState.NEW),c!==this.state&&(this.log.debug("pc state change: from ".concat(PCTransportState[c]," to ").concat(PCTransportState[this.state]),this.logContext),(d=this.onStateChange)===null||d===void 0||d.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=getLogger((a=s.loggerName)!==null&&a!==void 0?a:LoggerNames.PCManager),this.loggerOptions=s,this.isPublisherConnectionRequired=!i,this.isSubscriberConnectionRequired=i,this.publisher=new PCTransport(t,s),this.subscriber=new PCTransport(t,s),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=d=>{var c;(c=this.onIceCandidate)===null||c===void 0||c.call(this,d,SignalTarget.PUBLISHER)},this.subscriber.onIceCandidate=d=>{var c;(c=this.onIceCandidate)===null||c===void 0||c.call(this,d,SignalTarget.SUBSCRIBER)},this.subscriber.onDataChannel=d=>{var c;(c=this.onDataChannel)===null||c===void 0||c.call(this,d)},this.subscriber.onTrack=d=>{var c;(c=this.onTrack)===null||c===void 0||c.call(this,d)},this.publisher.onOffer=d=>{var c;(c=this.onPublisherOffer)===null||c===void 0||c.call(this,d)},this.state=PCTransportState.NEW,this.connectionLock=new _,this.remoteOfferLock=new _}get logContext(){var t,i;return Object.assign({},(i=(t=this.loggerOptions).loggerContextCb)===null||i===void 0?void 0:i.call(t))}requirePublisher(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=t,this.updateState()}requireSubscriber(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=t,this.updateState()}createAndSendPublisherOffer(t){return this.publisher.createAndSendOffer(t)}setPublisherAnswer(t){return this.publisher.setRemoteDescription(t)}removeTrack(t){return this.publisher.removeTrack(t)}close(){return __awaiter$1(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const t=this.publisher;for(const i of t.getSenders())try{t.canRemoveTrack()&&t.removeTrack(i)}catch(s){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:s}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return __awaiter$1(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(t,i){return __awaiter$1(this,void 0,void 0,function*(){i===SignalTarget.PUBLISHER?yield this.publisher.addIceCandidate(t):yield this.subscriber.addIceCandidate(t)})}createSubscriberAnswerFromOffer(t){return __awaiter$1(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:t.type,sdp:t.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const i=yield this.remoteOfferLock.lock();try{return yield this.subscriber.setRemoteDescription(t),yield this.subscriber.createAndSetAnswer()}finally{i()}})}updateConfiguration(t,i){this.publisher.setConfiguration(t),this.subscriber.setConfiguration(t),i&&this.triggerIceRestart()}ensurePCTransportConnection(t,i){return __awaiter$1(this,void 0,void 0,function*(){var s;const a=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((s=this.requiredTransports)===null||s===void 0?void 0:s.map(d=>this.ensureTransportConnected(d,t,i)))}finally{a()}})}negotiate(t){return __awaiter$1(this,void 0,void 0,function*(){return new Promise((i,s)=>__awaiter$1(this,void 0,void 0,function*(){const a=setTimeout(()=>{s("negotiation timed out")},this.peerConnectionTimeout),d=()=>{clearTimeout(a),s("negotiation aborted")};t.signal.addEventListener("abort",d),this.publisher.once(PCEvents.NegotiationStarted,()=>{t.signal.aborted||this.publisher.once(PCEvents.NegotiationComplete,()=>{clearTimeout(a),i()})}),yield this.publisher.negotiate(c=>{clearTimeout(a),s(c)})}))})}addPublisherTransceiver(t,i){return this.publisher.addTransceiver(t,i)}addPublisherTrack(t){return this.publisher.addTrack(t)}createPublisherDataChannel(t,i){return this.publisher.createDataChannel(t,i)}getConnectedAddress(t){return t===SignalTarget.PUBLISHER?this.publisher.getConnectedAddress():t===SignalTarget.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const t=[];return this.isPublisherConnectionRequired&&t.push(this.publisher),this.isSubscriberConnectionRequired&&t.push(this.subscriber),t}ensureTransportConnected(t,i){return __awaiter$1(this,arguments,void 0,function(s,a){var d=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return function*(){if(s.getConnectionState()!=="connected")return new Promise((u,p)=>__awaiter$1(d,void 0,void 0,function*(){const f=()=>{this.log.warn("abort transport connection",this.logContext),CriticalTimers.clearTimeout(m),p(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled))};a!=null&&a.signal.aborted&&f(),a==null||a.signal.addEventListener("abort",f);const m=CriticalTimers.setTimeout(()=>{a==null||a.signal.removeEventListener("abort",f),p(new ConnectionError("could not establish pc connection",ConnectionErrorReason.InternalError))},c);for(;this.state!==PCTransportState.CONNECTED;)if(yield sleep$1(50),a!=null&&a.signal.aborted){p(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled));return}CriticalTimers.clearTimeout(m),a==null||a.signal.removeEventListener("abort",f),u()}))}()})}}class RpcError extends Error{constructor(t,i,s){super(i),this.code=t,this.message=truncateBytes(i,RpcError.MAX_MESSAGE_BYTES),this.data=s?truncateBytes(s,RpcError.MAX_DATA_BYTES):void 0}static fromProto(t){return new RpcError(t.code,t.message,t.data)}toProto(){return new RpcError$1({code:this.code,message:this.message,data:this.data})}static builtIn(t,i){return new RpcError(RpcError.ErrorCode[t],RpcError.ErrorMessage[t],i)}}RpcError.MAX_MESSAGE_BYTES=256,RpcError.MAX_DATA_BYTES=15360,RpcError.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},RpcError.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const MAX_PAYLOAD_BYTES=15360;function byteLength(n){return new TextEncoder().encode(n).length}function truncateBytes(n,t){if(byteLength(n)<=t)return n;let i=0,s=n.length;const a=new TextEncoder;for(;i<s;){const d=Math.floor((i+s+1)/2);a.encode(n.slice(0,d)).length<=t?i=d:s=d-1}return n.slice(0,i)}const monitorFrequency=2e3;function computeBitrate(n,t){if(!t)return 0;let i,s;return"bytesReceived"in n?(i=n.bytesReceived,s=t.bytesReceived):"bytesSent"in n&&(i=n.bytesSent,s=t.bytesSent),i===void 0||s===void 0||n.timestamp===void 0||t.timestamp===void 0?0:(i-s)*8*1e3/(n.timestamp-t.timestamp)}const defaultDimensionsTimeout=1e3;class LocalTrack extends Track{get sender(){return this._sender}set sender(t){this._sender=t}get constraints(){return this._constraints}constructor(t,i,s){let a=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,d=arguments.length>4?arguments[4]:void 0;super(t,i,d),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=r(()=>__awaiter$1(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>__awaiter$1(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(TrackEvent.Ended,this)},this.reacquireTrack=!1,this.providedByUser=a,this.muteLock=new _,this.pauseUpstreamLock=new _,this.processorLock=new _,this.restartLock=new _,this.setMediaStreamTrack(t,!0),this._constraints=t.getConstraints(),s&&(this._constraints=s)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Track.Kind.Video)return;const{width:t,height:i}=this._mediaStreamTrack.getSettings();if(t&&i)return{width:t,height:i}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var t,i;return(i=(t=this.processor)===null||t===void 0?void 0:t.processedTrack)!==null&&i!==void 0?i:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(t,i){return __awaiter$1(this,void 0,void 0,function*(){var s;if(t===this._mediaStreamTrack&&!i)return;this._mediaStreamTrack&&(this.attachedElements.forEach(d=>{detachTrack(this._mediaStreamTrack,d)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([t]),t&&(t.addEventListener("ended",this.handleEnded),t.addEventListener("mute",this.handleTrackMuteEvent),t.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=t.getConstraints());let a;if(this.processor&&t){const d=yield this.processorLock.lock();try{if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(attachToElement(t,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:t,kind:this.kind,element:this.processorElement}),a=this.processor.processedTrack}finally{d()}}this.sender&&((s=this.sender.transport)===null||s===void 0?void 0:s.state)!=="closed"&&(yield this.sender.replaceTrack(a??t)),!this.providedByUser&&this._mediaStreamTrack!==t&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=t,t&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(d=>{attachToElement(a??t,d)}))})}waitForDimensions(){return __awaiter$1(this,arguments,void 0,function(){var t=this;let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:defaultDimensionsTimeout;return function*(){var s;if(t.kind===Track.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((s=getBrowser())===null||s===void 0?void 0:s.os)==="iOS"&&(yield sleep$1(10));const a=Date.now();for(;Date.now()-a<i;){const d=t.dimensions;if(d)return d;yield sleep$1(50)}throw new TrackInvalidError("unable to get track dimensions after timeout")}()})}setDeviceId(t){return __awaiter$1(this,void 0,void 0,function*(){return this._constraints.deviceId===t&&this._mediaStreamTrack.getSettings().deviceId===unwrapConstraint(t)||(this._constraints.deviceId=t,this.isMuted)?!0:(yield this.restartTrack(),unwrapConstraint(t)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return __awaiter$1(this,arguments,void 0,function(){var t=this;let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){if(t.source===Track.Source.ScreenShare)return;const{deviceId:s,groupId:a}=t._mediaStreamTrack.getSettings(),d=t.kind===Track.Kind.Audio?"audioinput":"videoinput";return i?DeviceManager.getInstance().normalizeDeviceId(d,s,a):s}()})}mute(){return __awaiter$1(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return __awaiter$1(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(t,i){return __awaiter$1(this,void 0,void 0,function*(){if(!this.sender)throw new TrackInvalidError("unable to replace an unpublished track");let s,a;return typeof i=="boolean"?s=i:i!==void 0&&(s=i.userProvidedTrack,a=i.stopProcessor),this.providedByUser=s??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(t),a&&this.processor&&(yield this.stopProcessor()),this})}restart(t){return __awaiter$1(this,void 0,void 0,function*(){this.manuallyStopped=!1;const i=yield this.restartLock.lock();try{t||(t=this._constraints),this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:t}));const s={audio:!1,video:!1};this.kind===Track.Kind.Video?s.video=t:s.audio=t,this.attachedElements.forEach(c=>{detachTrack(this.mediaStreamTrack,c)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const d=(yield navigator.mediaDevices.getUserMedia(s)).getTracks()[0];return d.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(d),this._constraints=t,this.emit(TrackEvent.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{i()}})}setTrackMuted(t){this.log.debug("setting ".concat(this.kind," track ").concat(t?"muted":"unmuted"),this.logContext),!(this.isMuted===t&&this._mediaStreamTrack.enabled!==t)&&(this.isMuted=t,this._mediaStreamTrack.enabled=!t,this.emit(t?TrackEvent.Muted:TrackEvent.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield t.handleAppVisibilityChanged.call(this),isMobile()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var t;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(t=this.processor)===null||t===void 0||t.destroy(),this.processor=void 0}pauseUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var t;const i=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(TrackEvent.UpstreamPaused,this);const s=getBrowser();if((s==null?void 0:s.name)==="Safari"&&compareVersions(s.version,"12.0")<0)throw new DeviceUnsupportedError("pauseUpstream is not supported on Safari < 12.");((t=this.sender.transport)===null||t===void 0?void 0:t.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{i()}})}resumeUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var t;const i=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(TrackEvent.UpstreamResumed,this),((t=this.sender.transport)===null||t===void 0?void 0:t.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{i()}})}getRTCStatsReport(){return __awaiter$1(this,void 0,void 0,function*(){var t;return!((t=this.sender)===null||t===void 0)&&t.getStats?yield this.sender.getStats():void 0})}setProcessor(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var d;const c=yield s.processorLock.lock();try{s.log.debug("setting up processor",s.logContext);const l=document.createElement(s.kind),u={kind:s.kind,track:s._mediaStreamTrack,element:l,audioContext:s.audioContext};if(yield i.init(u),s.log.debug("processor initialized",s.logContext),s.processor&&(yield s.stopProcessor()),s.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(attachToElement(s._mediaStreamTrack,l),l.muted=!0,l.play().catch(p=>s.log.error("failed to play processor element",Object.assign(Object.assign({},s.logContext),{error:p}))),s.processor=i,s.processorElement=l,s.processor.processedTrack){for(const p of s.attachedElements)p!==s.processorElement&&a&&(detachTrack(s._mediaStreamTrack,p),attachToElement(s.processor.processedTrack,p));yield(d=s.sender)===null||d===void 0?void 0:d.replaceTrack(s.processor.processedTrack)}s.emit(TrackEvent.TrackProcessorUpdate,s.processor)}finally{c()}}()})}getProcessor(){return this.processor}stopProcessor(){return __awaiter$1(this,arguments,void 0,function(){var t=this;let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var s,a;t.processor&&(t.log.debug("stopping processor",t.logContext),(s=t.processor.processedTrack)===null||s===void 0||s.stop(),yield t.processor.destroy(),t.processor=void 0,i||((a=t.processorElement)===null||a===void 0||a.remove(),t.processorElement=void 0),yield t._mediaStreamTrack.applyConstraints(t._constraints),yield t.setMediaStreamTrack(t._mediaStreamTrack,!0),t.emit(TrackEvent.TrackProcessorUpdate))}()})}}class LocalAudioTrack extends LocalTrack{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(t,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,a=arguments.length>3?arguments[3]:void 0,d=arguments.length>4?arguments[4]:void 0;super(t,Track.Kind.Audio,i,s,d),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let c;try{c=yield this.getSenderStats()}catch(l){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:l}));return}c&&this.prevStats&&(this._currentBitrate=computeBitrate(c,this.prevStats)),this.prevStats=c}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=a,this.checkForSilence()}mute(){const t=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$1(this,void 0,void 0,function*(){const i=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield t.mute.call(this),this)}finally{i()}})}unmute(){const t=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$1(this,void 0,void 0,function*(){const i=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const s=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==unwrapConstraint(this._constraints.deviceId);return this.source===Track.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||s)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield t.unmute.call(this),this}finally{i()}})}restartTrack(t){return __awaiter$1(this,void 0,void 0,function*(){let i;if(t){const s=constraintsForOptions({audio:t});typeof s.audio!="boolean"&&(i=s.audio)}yield this.restart(i)})}restart(t){const i=Object.create(null,{restart:{get:()=>super.restart}});return __awaiter$1(this,void 0,void 0,function*(){const s=yield i.restart.call(this,t);return this.checkForSilence(),s})}startMonitor(){isWeb()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency)))}setProcessor(t){return __awaiter$1(this,void 0,void 0,function*(){var i;const s=yield this.processorLock.lock();try{if(!isReactNative()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.stopProcessor());const a={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(t.name),this.logContext),yield t.init(a),this.processor=t,this.processor.processedTrack&&(yield(i=this.sender)===null||i===void 0?void 0:i.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(TrackEvent.TrackProcessorUpdate,this.processor)}finally{s()}})}setAudioContext(t){this.audioContext=t}getSenderStats(){return __awaiter$1(this,void 0,void 0,function*(){var t;if(!(!((t=this.sender)===null||t===void 0)&&t.getStats))return;const i=yield this.sender.getStats();let s;return i.forEach(a=>{a.type==="outbound-rtp"&&(s={type:"audio",streamId:a.id,packetsSent:a.packetsSent,packetsLost:a.packetsLost,bytesSent:a.bytesSent,timestamp:a.timestamp,roundTripTime:a.roundTripTime,jitter:a.jitter})}),s})}checkForSilence(){return __awaiter$1(this,void 0,void 0,function*(){const t=yield detectSilence(this);return t&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(TrackEvent.AudioSilenceDetected)),t})}}function mediaTrackToLocalTrack(n,t,i){switch(n.kind){case"audio":return new LocalAudioTrack(n,t,!1,void 0,i);case"video":return new LocalVideoTrack(n,t,!1,i);default:throw new TrackInvalidError("unsupported track type: ".concat(n.kind))}}const presets169=Object.values(VideoPresets),presets43=Object.values(VideoPresets43),presetsScreenShare=Object.values(ScreenSharePresets),defaultSimulcastPresets169=[VideoPresets.h180,VideoPresets.h360],defaultSimulcastPresets43=[VideoPresets43.h180,VideoPresets43.h360],computeDefaultScreenShareSimulcastPresets=n=>[{scaleResolutionDownBy:2,fps:n.encoding.maxFramerate}].map(i=>{var s,a;return new VideoPreset(Math.floor(n.width/i.scaleResolutionDownBy),Math.floor(n.height/i.scaleResolutionDownBy),Math.max(15e4,Math.floor(n.encoding.maxBitrate/(Math.pow(i.scaleResolutionDownBy,2)*(((s=n.encoding.maxFramerate)!==null&&s!==void 0?s:30)/((a=i.fps)!==null&&a!==void 0?a:30))))),i.fps,n.encoding.priority)}),videoRids=["q","h","f"];function computeVideoEncodings(n,t,i,s){var a,d;let c=s==null?void 0:s.videoEncoding;n&&(c=s==null?void 0:s.screenShareEncoding);const l=s==null?void 0:s.simulcast,u=s==null?void 0:s.scalabilityMode,p=s==null?void 0:s.videoCodec;if(!c&&!l&&!u||!t||!i)return[{}];c||(c=determineAppropriateEncoding(n,t,i,p),livekitLogger.debug("using video encoding",c));const f=c.maxFramerate,m=new VideoPreset(t,i,c.maxBitrate,c.maxFramerate,c.priority);if(u&&isSVCCodec(p)){const y=new ScalabilityMode(u),k=[];if(y.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(u));const E=getBrowser();if(isSafari()||isReactNative()||(E==null?void 0:E.name)==="Chrome"&&compareVersions(E==null?void 0:E.version,"113")<0){const C=y.suffix=="h"?2:3;for(let T=0;T<y.spatial;T+=1)k.push({rid:videoRids[2-T],maxBitrate:c.maxBitrate/Math.pow(C,T),maxFramerate:m.encoding.maxFramerate});k[0].scalabilityMode=u}else k.push({maxBitrate:c.maxBitrate,maxFramerate:m.encoding.maxFramerate,scalabilityMode:u});return m.encoding.priority&&(k[0].priority=m.encoding.priority,k[0].networkPriority=m.encoding.priority),livekitLogger.debug("using svc encoding",{encodings:k}),k}if(!l)return[c];let g=[];n?g=(a=sortPresets(s==null?void 0:s.screenShareSimulcastLayers))!==null&&a!==void 0?a:defaultSimulcastLayers(n,m):g=(d=sortPresets(s==null?void 0:s.videoSimulcastLayers))!==null&&d!==void 0?d:defaultSimulcastLayers(n,m);let v;if(g.length>0){const y=g[0];g.length>1&&([,v]=g);const k=Math.max(t,i);if(k>=960&&v)return encodingsFromPresets(t,i,[y,v,m],f);if(k>=480)return encodingsFromPresets(t,i,[y,m],f)}return encodingsFromPresets(t,i,[m])}function computeTrackBackupEncodings(n,t,i){var s,a,d,c;if(!i.backupCodec||i.backupCodec===!0||i.backupCodec.codec===i.videoCodec)return;t!==i.backupCodec.codec&&livekitLogger.warn("requested a different codec than specified as backup",{serverRequested:t,backup:i.backupCodec.codec}),i.videoCodec=t,i.videoEncoding=i.backupCodec.encoding;const l=n.mediaStreamTrack.getSettings(),u=(s=l.width)!==null&&s!==void 0?s:(a=n.dimensions)===null||a===void 0?void 0:a.width,p=(d=l.height)!==null&&d!==void 0?d:(c=n.dimensions)===null||c===void 0?void 0:c.height;return computeVideoEncodings(n.source===Track.Source.ScreenShare,u,p,i)}function determineAppropriateEncoding(n,t,i,s){const a=presetsForResolution(n,t,i);let{encoding:d}=a[0];const c=Math.max(t,i);for(let l=0;l<a.length;l+=1){const u=a[l];if(d=u.encoding,u.width>=c)break}if(s)switch(s){case"av1":d=Object.assign({},d),d.maxBitrate=d.maxBitrate*.7;break;case"vp9":d=Object.assign({},d),d.maxBitrate=d.maxBitrate*.85;break}return d}function presetsForResolution(n,t,i){if(n)return presetsScreenShare;const s=t>i?t/i:i/t;return Math.abs(s-16/9)<Math.abs(s-4/3)?presets169:presets43}function defaultSimulcastLayers(n,t){if(n)return computeDefaultScreenShareSimulcastPresets(t);const{width:i,height:s}=t,a=i>s?i/s:s/i;return Math.abs(a-16/9)<Math.abs(a-4/3)?defaultSimulcastPresets169:defaultSimulcastPresets43}function encodingsFromPresets(n,t,i,s){const a=[];if(i.forEach((d,c)=>{if(c>=videoRids.length)return;const l=Math.min(n,t),p={rid:videoRids[c],scaleResolutionDownBy:Math.max(1,l/Math.min(d.width,d.height)),maxBitrate:d.encoding.maxBitrate},f=s&&d.encoding.maxFramerate?Math.min(s,d.encoding.maxFramerate):d.encoding.maxFramerate;f&&(p.maxFramerate=f);const m=isFireFox()||c===0;d.encoding.priority&&m&&(p.priority=d.encoding.priority,p.networkPriority=d.encoding.priority),a.push(p)}),isReactNative()&&getReactNativeOs()==="ios"){let d;a.forEach(l=>{d?l.maxFramerate&&l.maxFramerate>d&&(d=l.maxFramerate):d=l.maxFramerate});let c=!0;a.forEach(l=>{var u;l.maxFramerate!=d&&(c&&(c=!1,livekitLogger.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),livekitLogger.info('Setting framerate of encoding "'.concat((u=l.rid)!==null&&u!==void 0?u:"",'" to ').concat(d)),l.maxFramerate=d)})}return a}function sortPresets(n){if(n)return n.sort((t,i)=>{const{encoding:s}=t,{encoding:a}=i;return s.maxBitrate>a.maxBitrate?1:s.maxBitrate<a.maxBitrate?-1:s.maxBitrate===a.maxBitrate&&s.maxFramerate&&a.maxFramerate?s.maxFramerate>a.maxFramerate?1:-1:0})}class ScalabilityMode{constructor(t){const i=t.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!i)throw new Error("invalid scalability mode");if(this.spatial=parseInt(i[1]),this.temporal=parseInt(i[2]),i.length>3)switch(i[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=i[3]}}toString(){var t;return"L".concat(this.spatial,"T").concat(this.temporal).concat((t=this.suffix)!==null&&t!==void 0?t:"")}}function getDefaultDegradationPreference(n){return n.source===Track.Source.ScreenShare||n.constraints.height&&unwrapConstraint(n.constraints.height)>=1080?"maintain-resolution":"balanced"}const refreshSubscribedCodecAfterNewCodec=5e3;class LocalVideoTrack extends LocalTrack{get sender(){return this._sender}set sender(t){this._sender=t,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(t,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,a=arguments.length>3?arguments[3]:void 0;super(t,Track.Kind.Video,i,s,a),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.monitorSender=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let d;try{d=yield this.getSenderStats()}catch(l){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:l}));return}const c=new Map(d.map(l=>[l.rid,l]));if(this.prevStats){let l=0;c.forEach((u,p)=>{var f;const m=(f=this.prevStats)===null||f===void 0?void 0:f.get(p);l+=computeBitrate(u,m)}),this._currentBitrate=l}this.prevStats=c}),this.senderLock=new _}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(t){var i;if(this.signalClient=t,!isWeb())return;const s=(i=this.sender)===null||i===void 0?void 0:i.getParameters();s&&(this.encodings=s.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(t=>{t.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const t=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return __awaiter$1(this,void 0,void 0,function*(){var i,s,a,d,c;yield t.pauseUpstream.call(this);try{for(var l=!0,u=__asyncValues(this.simulcastCodecs.values()),p;p=yield u.next(),i=p.done,!i;l=!0)d=p.value,l=!1,yield(c=d.sender)===null||c===void 0?void 0:c.replaceTrack(null)}catch(f){s={error:f}}finally{try{!l&&!i&&(a=u.return)&&(yield a.call(u))}finally{if(s)throw s.error}}})}resumeUpstream(){const t=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return __awaiter$1(this,void 0,void 0,function*(){var i,s,a,d,c;yield t.resumeUpstream.call(this);try{for(var l=!0,u=__asyncValues(this.simulcastCodecs.values()),p;p=yield u.next(),i=p.done,!i;l=!0){d=p.value,l=!1;const f=d;yield(c=f.sender)===null||c===void 0?void 0:c.replaceTrack(f.mediaStreamTrack)}}catch(f){s={error:f}}finally{try{!l&&!i&&(a=u.return)&&(yield a.call(u))}finally{if(s)throw s.error}}})}mute(){const t=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$1(this,void 0,void 0,function*(){const i=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield t.mute.call(this),this)}finally{i()}})}unmute(){const t=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$1(this,void 0,void 0,function*(){const i=yield this.muteLock.lock();try{return this.isMuted?(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield t.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{i()}})}setTrackMuted(t){super.setTrackMuted(t);for(const i of this.simulcastCodecs.values())i.mediaStreamTrack.enabled=!t}getSenderStats(){return __awaiter$1(this,void 0,void 0,function*(){var t;if(!(!((t=this.sender)===null||t===void 0)&&t.getStats))return[];const i=[],s=yield this.sender.getStats();return s.forEach(a=>{var d;if(a.type==="outbound-rtp"){const c={type:"video",streamId:a.id,frameHeight:a.frameHeight,frameWidth:a.frameWidth,framesPerSecond:a.framesPerSecond,framesSent:a.framesSent,firCount:a.firCount,pliCount:a.pliCount,nackCount:a.nackCount,packetsSent:a.packetsSent,bytesSent:a.bytesSent,qualityLimitationReason:a.qualityLimitationReason,qualityLimitationDurations:a.qualityLimitationDurations,qualityLimitationResolutionChanges:a.qualityLimitationResolutionChanges,rid:(d=a.rid)!==null&&d!==void 0?d:a.id,retransmittedPacketsSent:a.retransmittedPacketsSent,targetBitrate:a.targetBitrate,timestamp:a.timestamp},l=s.get(a.remoteId);l&&(c.jitter=l.jitter,c.packetsLost=l.packetsLost,c.roundTripTime=l.roundTripTime),i.push(c)}}),i.sort((a,d)=>{var c,l;return((c=d.frameWidth)!==null&&c!==void 0?c:0)-((l=a.frameWidth)!==null&&l!==void 0?l:0)}),i})}setPublishingQuality(t){const i=[];for(let s=VideoQuality.LOW;s<=VideoQuality.HIGH;s+=1)i.push(new SubscribedQuality({quality:s,enabled:s<=t}));this.log.debug("setting publishing quality. max quality ".concat(t),this.logContext),this.setPublishingLayers(i)}restartTrack(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s,a,d,c;let l;if(t){const m=constraintsForOptions({video:t});typeof m.video!="boolean"&&(l=m.video)}yield this.restart(l);try{for(var u=!0,p=__asyncValues(this.simulcastCodecs.values()),f;f=yield p.next(),i=f.done,!i;u=!0){d=f.value,u=!1;const m=d;m.sender&&((c=m.sender.transport)===null||c===void 0?void 0:c.state)!=="closed"&&(m.mediaStreamTrack=this.mediaStreamTrack.clone(),yield m.sender.replaceTrack(m.mediaStreamTrack))}}catch(m){s={error:m}}finally{try{!u&&!i&&(a=p.return)&&(yield a.call(p))}finally{if(s)throw s.error}}})}setProcessor(t){const i=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return __awaiter$1(this,arguments,void 0,function(s){var a=this;let d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var c,l,u,p,f,m;if(yield i.setProcessor.call(a,s,d),!((f=a.processor)===null||f===void 0)&&f.processedTrack)try{for(var g=!0,v=__asyncValues(a.simulcastCodecs.values()),y;y=yield v.next(),c=y.done,!c;g=!0)p=y.value,g=!1,yield(m=p.sender)===null||m===void 0?void 0:m.replaceTrack(a.processor.processedTrack)}catch(k){l={error:k}}finally{try{!g&&!c&&(u=v.return)&&(yield u.call(v))}finally{if(l)throw l.error}}}()})}setDegradationPreference(t){return __awaiter$1(this,void 0,void 0,function*(){if(this.degradationPreference=t,this.sender)try{this.log.debug("setting degradationPreference to ".concat(t),this.logContext);const i=this.sender.getParameters();i.degradationPreference=t,this.sender.setParameters(i)}catch(i){this.log.warn("failed to set degradationPreference",Object.assign({error:i},this.logContext))}})}addSimulcastTrack(t,i){if(this.simulcastCodecs.has(t)){this.log.error("".concat(t," already added, skipping adding simulcast codec"),this.logContext);return}const s={codec:t,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:i};return this.simulcastCodecs.set(t,s),s}setSimulcastTrackSender(t,i){const s=this.simulcastCodecs.get(t);s&&(s.sender=i,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},refreshSubscribedCodecAfterNewCodec))}setPublishingCodecs(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s,a,d,c,l,u;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:t,currentCodec:this.codec})),!this.codec&&t.length>0)return yield this.setPublishingLayers(t[0].qualities),[];this.subscribedCodecs=t;const p=[];try{for(i=!0,s=__asyncValues(t);a=yield s.next(),d=a.done,!d;i=!0){u=a.value,i=!1;const f=u;if(!this.codec||this.codec===f.codec)yield this.setPublishingLayers(f.qualities);else{const m=this.simulcastCodecs.get(f.codec);if(this.log.debug("try setPublishingCodec for ".concat(f.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:m})),!m||!m.sender){for(const g of f.qualities)if(g.enabled){p.push(f.codec);break}}else m.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(f.codec),this.logContext),yield setPublishingLayersForSender(m.sender,m.encodings,f.qualities,this.senderLock,this.log,this.logContext))}}}catch(f){c={error:f}}finally{try{!i&&!d&&(l=s.return)&&(yield l.call(s))}finally{if(c)throw c.error}}return p})}setPublishingLayers(t){return __awaiter$1(this,void 0,void 0,function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),!(!this.sender||!this.encodings)&&(yield setPublishingLayersForSender(this.sender,this.encodings,t,this.senderLock,this.log,this.logContext))})}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield t.handleAppVisibilityChanged.call(this),isMobile()&&this.isInBackground&&this.source===Track.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function setPublishingLayersForSender(n,t,i,s,a,d){return __awaiter$1(this,void 0,void 0,function*(){const c=yield s.lock();a.debug("setPublishingLayersForSender",Object.assign(Object.assign({},d),{sender:n,qualities:i,senderEncodings:t}));try{const l=n.getParameters(),{encodings:u}=l;if(!u)return;if(u.length!==t.length){a.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},d),{encodings:u,senderEncodings:t}));return}let p=!1;!1&&u[0].scalabilityMode||u.forEach((m,g)=>{var v;let y=(v=m.rid)!==null&&v!==void 0?v:"";y===""&&(y="q");const k=videoQualityForRid(y),E=i.find(C=>C.quality===k);E&&m.active!==E.enabled&&(p=!0,m.active=E.enabled,a.debug("setting layer ".concat(E.quality," to ").concat(m.active?"enabled":"disabled"),d),isFireFox()&&(E.enabled?(m.scaleResolutionDownBy=t[g].scaleResolutionDownBy,m.maxBitrate=t[g].maxBitrate,m.maxFrameRate=t[g].maxFrameRate):(m.scaleResolutionDownBy=4,m.maxBitrate=10,m.maxFrameRate=2)))}),p&&(l.encodings=u,a.debug("setting encodings",Object.assign(Object.assign({},d),{encodings:l.encodings})),yield n.setParameters(l))}finally{c()}})}function videoQualityForRid(n){switch(n){case"f":return VideoQuality.HIGH;case"h":return VideoQuality.MEDIUM;case"q":return VideoQuality.LOW;default:return VideoQuality.HIGH}}function videoLayersFromEncodings(n,t,i,s){if(!i)return[new VideoLayer({quality:VideoQuality.HIGH,width:n,height:t,bitrate:0,ssrc:0})];if(s){const a=i[0].scalabilityMode,d=new ScalabilityMode(a),c=[],l=d.suffix=="h"?1.5:2,u=d.suffix=="h"?2:3;for(let p=0;p<d.spatial;p+=1)c.push(new VideoLayer({quality:Math.min(VideoQuality.HIGH,d.spatial-1)-p,width:Math.ceil(n/Math.pow(l,p)),height:Math.ceil(t/Math.pow(l,p)),bitrate:i[0].maxBitrate?Math.ceil(i[0].maxBitrate/Math.pow(u,p)):0,ssrc:0}));return c}return i.map(a=>{var d,c,l;const u=(d=a.scaleResolutionDownBy)!==null&&d!==void 0?d:1;let p=videoQualityForRid((c=a.rid)!==null&&c!==void 0?c:"");return new VideoLayer({quality:p,width:Math.ceil(n/u),height:Math.ceil(t/u),bitrate:(l=a.maxBitrate)!==null&&l!==void 0?l:0,ssrc:0})})}const lossyDataChannel="_lossy",reliableDataChannel="_reliable",minReconnectWait=2*1e3,leaveReconnect="leave-reconnect";var PCState;(function(n){n[n.New=0]="New",n[n.Connected=1]="Connected",n[n.Disconnected=2]="Disconnected",n[n.Reconnecting=3]="Reconnecting",n[n.Closed=4]="Closed"})(PCState||(PCState={}));class RTCEngine extends eventsExports.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(t){var i;super(),this.options=t,this.rtcConfig={},this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=PCState.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=livekitLogger,this.handleDataChannel=s=>__awaiter$1(this,[s],void 0,function(a){var d=this;let{channel:c}=a;return function*(){if(c){if(c.label===reliableDataChannel)d.reliableDCSub=c;else if(c.label===lossyDataChannel)d.lossyDCSub=c;else return;d.log.debug("on data channel ".concat(c.id,", ").concat(c.label),d.logContext),c.onmessage=d.handleDataMessage}}()}),this.handleDataMessage=s=>__awaiter$1(this,void 0,void 0,function*(){var a,d;const c=yield this.dataProcessLock.lock();try{let l;if(s.data instanceof ArrayBuffer)l=s.data;else if(s.data instanceof Blob)l=yield s.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:s.data}));return}const u=DataPacket.fromBinary(new Uint8Array(l));((a=u.value)===null||a===void 0?void 0:a.case)==="speaker"?this.emit(EngineEvent.ActiveSpeakersUpdate,u.value.value.speakers):(((d=u.value)===null||d===void 0?void 0:d.case)==="user"&&applyUserDataCompat(u,u.value.value),this.emit(EngineEvent.DataPacketReceived,u))}finally{c()}}),this.handleDataError=s=>{const d=s.currentTarget.maxRetransmits===0?"lossy":"reliable";if(s instanceof ErrorEvent&&s.error){const{error:c}=s.error;this.log.error("DataChannel error on ".concat(d,": ").concat(s.message),Object.assign(Object.assign({},this.logContext),{error:c}))}else this.log.error("Unknown DataChannel error on ".concat(d),Object.assign(Object.assign({},this.logContext),{event:s}))},this.handleBufferedAmountLow=s=>{const d=s.currentTarget.maxRetransmits===0?DataPacket_Kind.LOSSY:DataPacket_Kind.RELIABLE;this.updateAndEmitDCBufferStatus(d)},this.handleDisconnect=(s,a)=>{if(this._isClosed)return;this.log.warn("".concat(s," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const d=u=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(u,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),this.close()},c=Date.now()-this.reconnectStart;let l=this.getNextRetryDelay({elapsedMs:c,retryCount:this.reconnectAttempts});if(l===null){d(c);return}s===leaveReconnect&&(l=0),this.log.debug("reconnecting in ".concat(l,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=CriticalTimers.setTimeout(()=>this.attemptReconnect(a).finally(()=>this.reconnectTimeout=void 0),l)},this.waitForRestarted=()=>new Promise((s,a)=>{this.pcState===PCState.Connected&&s();const d=()=>{this.off(EngineEvent.Disconnected,c),s()},c=()=>{this.off(EngineEvent.Restarted,d),a()};this.once(EngineEvent.Restarted,d),this.once(EngineEvent.Disconnected,c)}),this.updateAndEmitDCBufferStatus=s=>{const a=this.isBufferStatusLow(s);typeof a<"u"&&a!==this.dcBufferStatus.get(s)&&(this.dcBufferStatus.set(s,a),this.emit(EngineEvent.DCBufferStatusChanged,a,s))},this.isBufferStatusLow=s=>{const a=this.dataChannelForKind(s);if(a)return a.bufferedAmount<=a.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===SignalConnectionState.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(ReconnectReason.RR_SIGNAL_DISCONNECTED))},this.log=getLogger((i=t.loggerName)!==null&&i!==void 0?i:LoggerNames.Engine),this.loggerOptions={loggerName:t.loggerName,loggerContextCb:()=>this.logContext},this.client=new SignalClient(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new _,this.dataProcessLock=new _,this.dcBufferStatus=new Map([[DataPacket_Kind.LOSSY,!0],[DataPacket_Kind.RELIABLE,!0]]),this.client.onParticipantUpdate=s=>this.emit(EngineEvent.ParticipantUpdate,s),this.client.onConnectionQuality=s=>this.emit(EngineEvent.ConnectionQualityUpdate,s),this.client.onRoomUpdate=s=>this.emit(EngineEvent.RoomUpdate,s),this.client.onSubscriptionError=s=>this.emit(EngineEvent.SubscriptionError,s),this.client.onSubscriptionPermissionUpdate=s=>this.emit(EngineEvent.SubscriptionPermissionUpdate,s),this.client.onSpeakersChanged=s=>this.emit(EngineEvent.SpeakersChanged,s),this.client.onStreamStateUpdate=s=>this.emit(EngineEvent.StreamStateChanged,s),this.client.onRequestResponse=s=>this.emit(EngineEvent.SignalRequestResponse,s)}get logContext(){var t,i,s,a,d,c,l,u;return{room:(i=(t=this.latestJoinResponse)===null||t===void 0?void 0:t.room)===null||i===void 0?void 0:i.name,roomID:(a=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.room)===null||a===void 0?void 0:a.sid,participant:(c=(d=this.latestJoinResponse)===null||d===void 0?void 0:d.participant)===null||c===void 0?void 0:c.identity,pID:(u=(l=this.latestJoinResponse)===null||l===void 0?void 0:l.participant)===null||u===void 0?void 0:u.sid}}join(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){this.url=t,this.token=i,this.signalOpts=s,this.maxJoinAttempts=s.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const d=yield this.client.join(t,i,s,a);return this._isClosed=!1,this.latestJoinResponse=d,this.subscriberPrimary=d.subscriberPrimary,this.pcManager||(yield this.configure(d)),(!this.subscriberPrimary||d.fastPublish)&&this.negotiate(),this.clientConfiguration=d.clientConfiguration,d}catch(d){if(d instanceof ConnectionError&&d.reason===ConnectionErrorReason.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(t,i,s,a);throw d}})}close(){return __awaiter$1(this,void 0,void 0,function*(){const t=yield this.closingLock.lock();if(this.isClosed){t();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(EngineEvent.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{t()}})}cleanupPeerConnections(){return __awaiter$1(this,void 0,void 0,function*(){var t;yield(t=this.pcManager)===null||t===void 0?void 0:t.close(),this.pcManager=void 0;const i=s=>{s&&(s.close(),s.onbufferedamountlow=null,s.onclose=null,s.onclosing=null,s.onerror=null,s.onmessage=null,s.onopen=null)};i(this.lossyDC),i(this.lossyDCSub),i(this.reliableDC),i(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0})}cleanupClient(){return __awaiter$1(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(t){if(this.pendingTrackResolvers[t.cid])throw new TrackInvalidError("a track with the same ID has already been published");return new Promise((i,s)=>{const a=setTimeout(()=>{delete this.pendingTrackResolvers[t.cid],s(new ConnectionError("publication of local track timed out, no response from server",ConnectionErrorReason.InternalError))},1e4);this.pendingTrackResolvers[t.cid]={resolve:d=>{clearTimeout(a),i(d)},reject:()=>{clearTimeout(a),s(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(t)})}removeTrack(t){if(t.track&&this.pendingTrackResolvers[t.track.id]){const{reject:i}=this.pendingTrackResolvers[t.track.id];i&&i(),delete this.pendingTrackResolvers[t.track.id]}try{return this.pcManager.removeTrack(t),!0}catch(i){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:i}))}return!1}updateMuteStatus(t,i){this.client.sendMuteTrack(t,i)}get dataSubscriberReadyState(){var t;return(t=this.reliableDCSub)===null||t===void 0?void 0:t.readyState}getConnectedServerAddress(){return __awaiter$1(this,void 0,void 0,function*(){var t;return(t=this.pcManager)===null||t===void 0?void 0:t.getConnectedAddress()})}setRegionUrlProvider(t){this.regionUrlProvider=t}configure(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s;if(this.pcManager&&this.pcManager.currentState!==PCTransportState.NEW)return;this.participantSid=(i=t.participant)===null||i===void 0?void 0:i.sid;const a=this.makeRTCConfiguration(t);this.pcManager=new PCTransportManager(a,t.subscriberPrimary,this.loggerOptions),this.emit(EngineEvent.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(d,c)=>{this.client.sendIceCandidate(d,c)},this.pcManager.onPublisherOffer=d=>{this.client.sendOffer(d)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(d,c,l)=>__awaiter$1(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(d),this.logContext),["closed","disconnected","failed"].includes(c)&&(this.publisherConnectionPromise=void 0),d===PCTransportState.CONNECTED){const f=this.pcState===PCState.New;this.pcState=PCState.Connected,f&&this.emit(EngineEvent.Connected,t)}else d===PCTransportState.FAILED&&this.pcState===PCState.Connected&&(this.pcState=PCState.Disconnected,this.handleDisconnect("peerconnection failed",l==="failed"?ReconnectReason.RR_SUBSCRIBER_FAILED:ReconnectReason.RR_PUBLISHER_FAILED));const u=this.client.isDisconnected||this.client.currentState===SignalConnectionState.RECONNECTING,p=[PCTransportState.FAILED,PCTransportState.CLOSING,PCTransportState.CLOSED].includes(d);u&&p&&!this._isClosed&&this.emit(EngineEvent.Offline)}),this.pcManager.onTrack=d=>{this.emit(EngineEvent.MediaTrackAdded,d.track,d.streams[0],d.receiver)},supportOptionalDatachannel((s=t.serverInfo)===null||s===void 0?void 0:s.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=t=>__awaiter$1(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:t.type})),yield this.pcManager.setPublisherAnswer(t))}),this.client.onTrickle=(t,i)=>{this.pcManager&&(this.log.trace("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:t,target:i})),this.pcManager.addIceCandidate(t,i))},this.client.onOffer=t=>__awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)return;const i=yield this.pcManager.createSubscriberAnswerFromOffer(t);this.client.sendAnswer(i)}),this.client.onLocalTrackPublished=t=>{var i;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:t.cid,track:(i=t.track)===null||i===void 0?void 0:i.sid})),!this.pendingTrackResolvers[t.cid]){this.log.error("missing track resolver for ".concat(t.cid),Object.assign(Object.assign({},this.logContext),{cid:t.cid}));return}const{resolve:s}=this.pendingTrackResolvers[t.cid];delete this.pendingTrackResolvers[t.cid],s(t.track)},this.client.onLocalTrackUnpublished=t=>{this.emit(EngineEvent.LocalTrackUnpublished,t)},this.client.onLocalTrackSubscribed=t=>{this.emit(EngineEvent.LocalTrackSubscribed,t)},this.client.onTokenRefresh=t=>{this.token=t},this.client.onRemoteMuteChanged=(t,i)=>{this.emit(EngineEvent.RemoteMute,t,i)},this.client.onSubscribedQualityUpdate=t=>{this.emit(EngineEvent.SubscribedQualityUpdate,t)},this.client.onClose=()=>{this.handleDisconnect("signal",ReconnectReason.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=t=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:t==null?void 0:t.reason})),t.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(t.regions)),t.action){case LeaveRequest_Action.DISCONNECT:this.emit(EngineEvent.Disconnected,t==null?void 0:t.reason),this.close();break;case LeaveRequest_Action.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(leaveReconnect);break;case LeaveRequest_Action.RESUME:this.handleDisconnect(leaveReconnect)}}}makeRTCConfiguration(t){var i;const s=Object.assign({},this.rtcConfig);if(!((i=this.signalOpts)===null||i===void 0)&&i.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),s.encodedInsertableStreams=!0),t.iceServers&&!s.iceServers){const a=[];t.iceServers.forEach(d=>{const c={urls:d.urls};d.username&&(c.username=d.username),d.credential&&(c.credential=d.credential),a.push(c)}),s.iceServers=a}return t.clientConfiguration&&t.clientConfiguration.forceRelay===ClientConfigSetting.ENABLED&&(s.iceTransportPolicy="relay"),s.sdpSemantics="unified-plan",s.continualGatheringPolicy="gather_continually",s}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(lossyDataChannel,{ordered:!0,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(reliableDataChannel,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){if(supportsTransceiver())return yield this.createTransceiverRTCRtpSender(t,i,s);if(supportsAddTrack())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(t.mediaStreamTrack);throw new UnexpectedConnectionState("Required webRTC APIs not supported on this device")})}createSimulcastSender(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){if(supportsTransceiver())return this.createSimulcastTransceiverSender(t,i,s,a);if(supportsAddTrack())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(t.mediaStreamTrack);throw new UnexpectedConnectionState("Cannot stream on this device")})}createTransceiverRTCRtpSender(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const a=[];t.mediaStream&&a.push(t.mediaStream),isVideoTrack(t)&&(t.codec=i.videoCodec);const d={direction:"sendonly",streams:a};return s&&(d.sendEncodings=s),(yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,d)).sender})}createSimulcastTransceiverSender(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const d={direction:"sendonly"};a&&(d.sendEncodings=a);const c=yield this.pcManager.addPublisherTransceiver(i.mediaStreamTrack,d);if(s.videoCodec)return t.setSimulcastTrackSender(s.videoCodec,c.sender),c.sender})}createRTCRtpSender(t){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");return this.pcManager.addPublisherTrack(t)})}attemptReconnect(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s,a;if(!this._isClosed){if(this.attemptingReconnect){livekitLogger.warn("already attempting reconnect, returning early",this.logContext);return}(((i=this.clientConfiguration)===null||i===void 0?void 0:i.resumeConnection)===ClientConfigSetting.DISABLED||((a=(s=this.pcManager)===null||s===void 0?void 0:s.currentState)!==null&&a!==void 0?a:PCTransportState.NEW)===PCTransportState.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(t),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(d){this.reconnectAttempts+=1;let c=!0;d instanceof UnexpectedConnectionState?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:d})),c=!1):d instanceof SignalReconnectError||(this.fullReconnectOnNext=!0),c?this.handleDisconnect("reconnect",ReconnectReason.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(t){try{return this.reconnectPolicy.nextRetryDelayInMs(t)}catch(i){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:i}))}return null}restartConnection(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s,a;try{if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let d;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new SignalReconnectError;d=yield this.join(t??this.url,this.token,this.signalOpts)}catch(c){throw c instanceof ConnectionError&&c.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):new SignalReconnectError}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(EngineEvent.SignalRestarted,d),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");(i=this.regionUrlProvider)===null||i===void 0||i.resetAttempts(),this.emit(EngineEvent.Restarted)}catch(d){const c=yield(s=this.regionUrlProvider)===null||s===void 0?void 0:s.getNextBestRegionUrl();if(c){yield this.restartConnection(c);return}else throw(a=this.regionUrlProvider)===null||a===void 0||a.resetAttempts(),d}})}resumeConnection(t){return __awaiter$1(this,void 0,void 0,function*(){var i;if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");if(!this.pcManager)throw new UnexpectedConnectionState("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Resuming);let s;try{this.setupSignalClientCallbacks(),s=yield this.client.reconnect(this.url,this.token,this.participantSid,t)}catch(a){let d="";throw a instanceof Error&&(d=a.message,this.log.error(a.message,Object.assign(Object.assign({},this.logContext),{error:a}))),a instanceof ConnectionError&&a.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):a instanceof ConnectionError&&a.reason===ConnectionErrorReason.LeaveRequest?a:new SignalReconnectError(d)}if(this.emit(EngineEvent.SignalResumed),s){const a=this.makeRTCConfiguration(s);this.pcManager.updateConfiguration(a)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");this.client.setReconnected(),((i=this.reliableDC)===null||i===void 0?void 0:i.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),this.emit(EngineEvent.Resumed)})}waitForPCInitialConnection(t,i){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(i,t)})}waitForPCReconnected(){return __awaiter$1(this,void 0,void 0,function*(){this.pcState=PCState.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield sleep$1(minReconnectWait),!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=PCState.Connected}catch(t){throw this.pcState=PCState.Disconnected,new ConnectionError("could not establish PC connection, ".concat(t.message),ConnectionErrorReason.InternalError)}})}publishRpcResponse(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){const d=new DataPacket({destinationIdentities:[t],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcResponse",value:new RpcResponse({requestId:i,value:a?{case:"error",value:a.toProto()}:{case:"payload",value:s??""}})}});yield this.sendDataPacket(d,DataPacket_Kind.RELIABLE)})}publishRpcAck(t,i){return __awaiter$1(this,void 0,void 0,function*(){const s=new DataPacket({destinationIdentities:[t],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcAck",value:new RpcAck({requestId:i})}});yield this.sendDataPacket(s,DataPacket_Kind.RELIABLE)})}sendDataPacket(t,i){return __awaiter$1(this,void 0,void 0,function*(){const s=t.toBinary();yield this.ensurePublisherConnected(i);const a=this.dataChannelForKind(i);a&&a.send(s),this.updateAndEmitDCBufferStatus(i)})}waitForBufferStatusLow(t){return new Promise((i,s)=>__awaiter$1(this,void 0,void 0,function*(){if(this.isBufferStatusLow(t))i();else{const a=()=>s("Engine closed");for(this.once(EngineEvent.Closing,a);!this.dcBufferStatus.get(t);)yield sleep$1(10);this.off(EngineEvent.Closing,a),i()}}))}ensureDataTransportConnected(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return function*(){var d;if(!s.pcManager)throw new UnexpectedConnectionState("PC manager is closed");const c=a?s.pcManager.subscriber:s.pcManager.publisher,l=a?"Subscriber":"Publisher";if(!c)throw new ConnectionError("".concat(l," connection not set"),ConnectionErrorReason.InternalError);let u=!1;!a&&!s.dataChannelForKind(i,a)&&(s.createDataChannels(),u=!0),!u&&!a&&!s.pcManager.publisher.isICEConnected&&s.pcManager.publisher.getICEConnectionState()!=="checking"&&(u=!0),u&&s.negotiate();const p=s.dataChannelForKind(i,a);if((p==null?void 0:p.readyState)==="open")return;const f=new Date().getTime()+s.peerConnectionTimeout;for(;new Date().getTime()<f;){if(c.isICEConnected&&((d=s.dataChannelForKind(i,a))===null||d===void 0?void 0:d.readyState)==="open")return;yield sleep$1(50)}throw new ConnectionError("could not establish ".concat(l," connection, state: ").concat(c.getICEConnectionState()),ConnectionErrorReason.InternalError)}()})}ensurePublisherConnected(t){return __awaiter$1(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(t,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==PCTransportState.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return __awaiter$1(this,void 0,void 0,function*(){return new Promise((t,i)=>__awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager){i(new NegotiationError("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const s=new AbortController,a=()=>{s.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),t()};this.isClosed&&i("cannot negotiate on closed engine"),this.on(EngineEvent.Closing,a),this.pcManager.publisher.once(PCEvents.RTPVideoPayloadTypes,d=>{const c=new Map;d.forEach(l=>{const u=l.codec.toLowerCase();isVideoCodec(u)&&c.set(l.payload,u)}),this.emit(EngineEvent.RTPVideoMapUpdate,c)});try{yield this.pcManager.negotiate(s),t()}catch(d){d instanceof NegotiationError&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",ReconnectReason.RR_UNKNOWN),i(d)}finally{this.off(EngineEvent.Closing,a)}}))})}dataChannelForKind(t,i){if(i){if(t===DataPacket_Kind.LOSSY)return this.lossyDCSub;if(t===DataPacket_Kind.RELIABLE)return this.reliableDCSub}else{if(t===DataPacket_Kind.LOSSY)return this.lossyDC;if(t===DataPacket_Kind.RELIABLE)return this.reliableDC}}sendSyncState(t,i){var s,a;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const d=this.pcManager.subscriber.getLocalDescription(),c=this.pcManager.subscriber.getRemoteDescription(),l=(a=(s=this.signalOpts)===null||s===void 0?void 0:s.autoSubscribe)!==null&&a!==void 0?a:!0,u=new Array,p=new Array;t.forEach(f=>{f.isDesired!==l&&u.push(f.trackSid),f.isEnabled||p.push(f.trackSid)}),this.client.sendSyncState(new SyncState({answer:d?toProtoSessionDescription({sdp:d.sdp,type:d.type}):void 0,offer:c?toProtoSessionDescription({sdp:c.sdp,type:c.type}):void 0,subscription:new UpdateSubscription({trackSids:u,subscribe:!l,participantTracks:[]}),publishTracks:getTrackPublicationInfo(i),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:p}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const t=[],i=(s,a)=>{(s==null?void 0:s.id)!==void 0&&s.id!==null&&t.push(new DataChannelInfo({label:s.label,id:s.id,target:a}))};return i(this.dataChannelForKind(DataPacket_Kind.LOSSY),SignalTarget.PUBLISHER),i(this.dataChannelForKind(DataPacket_Kind.RELIABLE),SignalTarget.PUBLISHER),i(this.dataChannelForKind(DataPacket_Kind.LOSSY,!0),SignalTarget.SUBSCRIBER),i(this.dataChannelForKind(DataPacket_Kind.RELIABLE,!0),SignalTarget.SUBSCRIBER),t}clearReconnectTimeout(){this.reconnectTimeout&&CriticalTimers.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){isWeb()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){isWeb()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class SignalReconnectError extends Error{}function supportOptionalDatachannel(n){return n!==void 0&&n>13}function applyUserDataCompat(n,t){const i=n.participantIdentity?n.participantIdentity:t.participantIdentity;n.participantIdentity=i,t.participantIdentity=i;const s=n.destinationIdentities.length!==0?n.destinationIdentities:t.destinationIdentities;n.destinationIdentities=s,t.destinationIdentities=s}class RegionUrlProvider{constructor(t,i){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(t),this.token=i}updateToken(t){this.token=t}isCloud(){return isCloud(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(t){return __awaiter$1(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(t));const i=this.regionSettings.regions.filter(s=>!this.attemptedRegions.find(a=>a.url===s.url));if(i.length>0){const s=i[0];return this.attemptedRegions.push(s),livekitLogger.debug("next region: ".concat(s.region)),s.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(t){return __awaiter$1(this,void 0,void 0,function*(){const i=yield fetch("".concat(getCloudConfigUrl(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:t});if(i.ok){const s=yield i.json();return this.lastUpdateAt=Date.now(),s}else throw new ConnectionError("Could not fetch region settings: ".concat(i.statusText),i.status===401?ConnectionErrorReason.NotAllowed:ConnectionErrorReason.InternalError,i.status)})}setServerReportedRegions(t){this.regionSettings=t,this.lastUpdateAt=Date.now()}}function getCloudConfigUrl(n){return"".concat(n.protocol.replace("ws","http"),"//").concat(n.host,"/settings")}class BaseStreamReader{get info(){return this._info}constructor(t,i,s){this.reader=i,this.totalByteSize=s,this._info=t,this.bytesReceived=0}}class ByteStreamReader extends BaseStreamReader{handleChunkReceived(t){var i;this.bytesReceived+=t.content.byteLength;const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(i=this.onProgress)===null||i===void 0||i.call(this,s)}[Symbol.asyncIterator](){const t=this.reader.getReader();return{next:()=>__awaiter$1(this,void 0,void 0,function*(){try{const{done:i,value:s}=yield t.read();return i?{done:!0,value:void 0}:(this.handleChunkReceived(s),{done:!1,value:s.content})}catch{return{done:!0,value:void 0}}}),return(){return __awaiter$1(this,void 0,void 0,function*(){return t.releaseLock(),{done:!0,value:void 0}})}}}readAll(){return __awaiter$1(this,void 0,void 0,function*(){var t,i,s,a;let d=new Set;try{for(var c=!0,l=__asyncValues(this),u;u=yield l.next(),t=u.done,!t;c=!0){a=u.value,c=!1;const p=a;d.add(p)}}catch(p){i={error:p}}finally{try{!c&&!t&&(s=l.return)&&(yield s.call(l))}finally{if(i)throw i.error}}return Array.from(d)})}}class TextStreamReader extends BaseStreamReader{constructor(t,i,s){super(t,i,s),this.receivedChunks=new Map}handleChunkReceived(t){var i;const s=bigIntToNumber(t.chunkIndex),a=this.receivedChunks.get(s);if(a&&a.version>t.version)return;this.receivedChunks.set(s,t),this.bytesReceived+=t.content.byteLength;const d=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(i=this.onProgress)===null||i===void 0||i.call(this,d)}[Symbol.asyncIterator](){const t=this.reader.getReader(),i=new TextDecoder;return{next:()=>__awaiter$1(this,void 0,void 0,function*(){try{const{done:s,value:a}=yield t.read();return s?{done:!0,value:void 0}:(this.handleChunkReceived(a),{done:!1,value:{index:bigIntToNumber(a.chunkIndex),current:i.decode(a.content),collected:Array.from(this.receivedChunks.values()).sort((d,c)=>bigIntToNumber(d.chunkIndex)-bigIntToNumber(c.chunkIndex)).map(d=>i.decode(d.content)).join("")}})}catch{return{done:!0,value:void 0}}}),return(){return __awaiter$1(this,void 0,void 0,function*(){return t.releaseLock(),{done:!0,value:void 0}})}}}readAll(){return __awaiter$1(this,void 0,void 0,function*(){var t,i,s,a;let d="";try{for(var c=!0,l=__asyncValues(this),u;u=yield l.next(),t=u.done,!t;c=!0){a=u.value,c=!1;const{collected:p}=a;d=p}}catch(p){i={error:p}}finally{try{!c&&!t&&(s=l.return)&&(yield s.call(l))}finally{if(i)throw i.error}}return d})}}class BaseStreamWriter{constructor(t,i,s){this.writableStream=t,this.defaultWriter=t.getWriter(),this.onClose=s,this.info=i}write(t){return this.defaultWriter.write([t])}close(){return __awaiter$1(this,void 0,void 0,function*(){var t;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),(t=this.onClose)===null||t===void 0||t.call(this)})}}class TextStreamWriter extends BaseStreamWriter{}class RemoteTrack extends Track{constructor(t,i,s,a,d){super(t,s,d),this.sid=i,this.receiver=a}get isLocal(){return!1}setMuted(t){this.isMuted!==t&&(this.isMuted=t,this._mediaStreamTrack.enabled=!t,this.emit(t?TrackEvent.Muted:TrackEvent.Unmuted,this))}setMediaStream(t){this.mediaStream=t;const i=s=>{s.track===this._mediaStreamTrack&&(t.removeEventListener("removetrack",i),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(TrackEvent.Ended,this))};t.addEventListener("removetrack",i)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return __awaiter$1(this,void 0,void 0,function*(){var t;return!((t=this.receiver)===null||t===void 0)&&t.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(t){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=t:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),monitorFrequency)),supportsSynchronizationSources()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const t=()=>{var i;this.timeSyncHandle=requestAnimationFrame(()=>t());const s=(i=this.receiver)===null||i===void 0?void 0:i.getSynchronizationSources()[0];if(s){const{timestamp:a,rtpTimestamp:d}=s;d&&this.rtpTimestamp!==d&&(this.emit(TrackEvent.TimeSyncUpdate,{timestamp:a,rtpTimestamp:d}),this.rtpTimestamp=d)}};t()}}class RemoteAudioTrack extends RemoteTrack{constructor(t,i,s,a,d,c){super(t,i,Track.Kind.Audio,s,c),this.monitorReceiver=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const l=yield this.getReceiverStats();l&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(l,this.prevStats)),this.prevStats=l}),this.audioContext=a,this.webAudioPluginNodes=[],d&&(this.sinkId=d.deviceId)}setVolume(t){var i;for(const s of this.attachedElements)this.audioContext?(i=this.gainNode)===null||i===void 0||i.gain.setTargetAtTime(t,0,.1):s.volume=t;isReactNative()&&this._mediaStreamTrack._setVolume(t),this.elementVolume=t}getVolume(){if(this.elementVolume)return this.elementVolume;if(isReactNative())return 1;let t=0;return this.attachedElements.forEach(i=>{i.volume>t&&(t=i.volume)}),t}setSinkId(t){return __awaiter$1(this,void 0,void 0,function*(){this.sinkId=t,yield Promise.all(this.attachedElements.map(i=>{if(supportsSetSinkId(i))return i.setSinkId(t)}))})}attach(t){const i=this.attachedElements.length===0;return t?super.attach(t):t=super.attach(),this.sinkId&&supportsSetSinkId(t)&&t.setSinkId(this.sinkId),this.audioContext&&i&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,t),t.volume=0,t.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),t}detach(t){let i;return t?(i=super.detach(t),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(i=super.detach(),this.disconnectWebAudio()),i}setAudioContext(t){this.audioContext=t,t&&this.attachedElements.length>0?this.connectWebAudio(t,this.attachedElements[0]):t||this.disconnectWebAudio()}setWebAudioPlugins(t){this.webAudioPluginNodes=t,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(t,i){this.disconnectWebAudio(),this.sourceNode=t.createMediaStreamSource(i.srcObject);let s=this.sourceNode;this.webAudioPluginNodes.forEach(a=>{s.connect(a),s=a}),this.gainNode=t.createGain(),s.connect(this.gainNode),this.gainNode.connect(t.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),t.state!=="running"&&t.resume().then(()=>{t.state!=="running"&&this.emit(TrackEvent.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(a=>{this.emit(TrackEvent.AudioPlaybackFailed,a)})}disconnectWebAudio(){var t,i;(t=this.gainNode)===null||t===void 0||t.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return __awaiter$1(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const t=yield this.receiver.getStats();let i;return t.forEach(s=>{s.type==="inbound-rtp"&&(i={type:"audio",streamId:s.id,timestamp:s.timestamp,jitter:s.jitter,bytesReceived:s.bytesReceived,concealedSamples:s.concealedSamples,concealmentEvents:s.concealmentEvents,silentConcealedSamples:s.silentConcealedSamples,silentConcealmentEvents:s.silentConcealmentEvents,totalAudioEnergy:s.totalAudioEnergy,totalSamplesDuration:s.totalSamplesDuration})}),i})}}const REACTION_DELAY=100;class RemoteVideoTrack extends RemoteTrack{constructor(t,i,s,a,d){super(t,i,Track.Kind.Video,s,d),this.elementInfos=[],this.monitorReceiver=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const c=yield this.getReceiverStats();c&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(c,this.prevStats)),this.prevStats=c}),this.debouncedHandleResize=r(()=>{this.updateDimensions()},REACTION_DELAY),this.adaptiveStreamSettings=a}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(t){super.setMuted(t),this.attachedElements.forEach(i=>{t?detachTrack(this._mediaStreamTrack,i):attachToElement(this._mediaStreamTrack,i)})}attach(t){if(t?super.attach(t):t=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(i=>i.element===t)===void 0){const i=new HTMLElementInfo(t);this.observeElementInfo(i)}return t}observeElementInfo(t){this.adaptiveStreamSettings&&this.elementInfos.find(i=>i===t)===void 0?(t.handleResize=()=>{this.debouncedHandleResize()},t.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(t),t.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(t){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const i=this.elementInfos.filter(s=>s===t);for(const s of i)s.stopObserving();this.elementInfos=this.elementInfos.filter(s=>s!==t),this.updateVisibility(),this.debouncedHandleResize()}detach(t){let i=[];if(t)return this.stopObservingElement(t),super.detach(t);i=super.detach();for(const s of i)this.stopObservingElement(s);return i}getDecoderImplementation(){var t;return(t=this.prevStats)===null||t===void 0?void 0:t.decoderImplementation}getReceiverStats(){return __awaiter$1(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const t=yield this.receiver.getStats();let i,s="",a=new Map;return t.forEach(d=>{d.type==="inbound-rtp"?(s=d.codecId,i={type:"video",streamId:d.id,framesDecoded:d.framesDecoded,framesDropped:d.framesDropped,framesReceived:d.framesReceived,packetsReceived:d.packetsReceived,packetsLost:d.packetsLost,frameWidth:d.frameWidth,frameHeight:d.frameHeight,pliCount:d.pliCount,firCount:d.firCount,nackCount:d.nackCount,jitter:d.jitter,timestamp:d.timestamp,bytesReceived:d.bytesReceived,decoderImplementation:d.decoderImplementation}):d.type==="codec"&&a.set(d.id,d)}),i&&s!==""&&a.get(s)&&(i.mimeType=a.get(s).mimeType),i})}stopObservingElement(t){const i=this.elementInfos.filter(s=>s.element===t);for(const s of i)this.stopObservingElementInfo(s)}handleAppVisibilityChanged(){const t=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield t.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(){var t,i;const s=this.elementInfos.reduce((l,u)=>Math.max(l,u.visibilityChangedAt||0),0),a=!((i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pauseVideoInBackground)!==null&&i!==void 0)||i?this.isInBackground:!1,d=this.elementInfos.some(l=>l.pictureInPicture),c=this.elementInfos.some(l=>l.visible)&&!a||d;if(this.lastVisible!==c){if(!c&&Date.now()-s<REACTION_DELAY){CriticalTimers.setTimeout(()=>{this.updateVisibility()},REACTION_DELAY);return}this.lastVisible=c,this.emit(TrackEvent.VisibilityChanged,c,this)}}updateDimensions(){var t,i;let s=0,a=0;const d=this.getPixelDensity();for(const c of this.elementInfos){const l=c.width()*d,u=c.height()*d;l+u>s+a&&(s=l,a=u)}((t=this.lastDimensions)===null||t===void 0?void 0:t.width)===s&&((i=this.lastDimensions)===null||i===void 0?void 0:i.height)===a||(this.lastDimensions={width:s,height:a},this.emit(TrackEvent.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var t;const i=(t=this.adaptiveStreamSettings)===null||t===void 0?void 0:t.pixelDensity;return i==="screen"?getDevicePixelRatio():i||(getDevicePixelRatio()>2?2:1)}}class HTMLElementInfo{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(t,i){this.onVisibilityChanged=s=>{var a;const{target:d,isIntersecting:c}=s;d===this.element&&(this.isIntersecting=c,this.isPiP=isElementInPiP(this.element),this.visibilityChangedAt=Date.now(),(a=this.handleVisibilityChanged)===null||a===void 0||a.call(this))},this.onEnterPiP=()=>{var s,a,d;(a=(s=window.documentPictureInPicture)===null||s===void 0?void 0:s.window)===null||a===void 0||a.addEventListener("pagehide",this.onLeavePiP),this.isPiP=isElementInPiP(this.element),(d=this.handleVisibilityChanged)===null||d===void 0||d.call(this)},this.onLeavePiP=()=>{var s;this.isPiP=isElementInPiP(this.element),(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.element=t,this.isIntersecting=i??isElementInViewport(t),this.isPiP=isWeb()&&isElementInPiP(t),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var t,i,s;this.isIntersecting=isElementInViewport(this.element),this.isPiP=isElementInPiP(this.element),this.element.handleResize=()=>{var a;(a=this.handleResize)===null||a===void 0||a.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,getIntersectionObserver().observe(this.element),getResizeObserver().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),(t=window.documentPictureInPicture)===null||t===void 0||t.addEventListener("enter",this.onEnterPiP),(s=(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window)===null||s===void 0||s.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var t,i,s,a,d;(t=getIntersectionObserver())===null||t===void 0||t.unobserve(this.element),(i=getResizeObserver())===null||i===void 0||i.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(s=window.documentPictureInPicture)===null||s===void 0||s.removeEventListener("enter",this.onEnterPiP),(d=(a=window.documentPictureInPicture)===null||a===void 0?void 0:a.window)===null||d===void 0||d.removeEventListener("pagehide",this.onLeavePiP)}}function isElementInPiP(n){var t,i;return document.pictureInPictureElement===n?!0:!((t=window.documentPictureInPicture)===null||t===void 0)&&t.window?isElementInViewport(n,(i=window.documentPictureInPicture)===null||i===void 0?void 0:i.window):!1}function isElementInViewport(n,t){const i=t||window;let s=n.offsetTop,a=n.offsetLeft;const d=n.offsetWidth,c=n.offsetHeight,{hidden:l}=n,{display:u}=getComputedStyle(n);for(;n.offsetParent;)n=n.offsetParent,s+=n.offsetTop,a+=n.offsetLeft;return s<i.pageYOffset+i.innerHeight&&a<i.pageXOffset+i.innerWidth&&s+c>i.pageYOffset&&a+d>i.pageXOffset&&!l&&u!=="none"}class TrackPublication extends eventsExports.EventEmitter{constructor(t,i,s,a){var d;super(),this.metadataMuted=!1,this.encryption=Encryption_Type.NONE,this.log=livekitLogger,this.handleMuted=()=>{this.emit(TrackEvent.Muted)},this.handleUnmuted=()=>{this.emit(TrackEvent.Unmuted)},this.log=getLogger((d=a==null?void 0:a.loggerName)!==null&&d!==void 0?d:LoggerNames.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=t,this.trackSid=i,this.trackName=s,this.source=Track.Source.Unknown}setTrack(t){this.track&&(this.track.off(TrackEvent.Muted,this.handleMuted),this.track.off(TrackEvent.Unmuted,this.handleUnmuted)),this.track=t,t&&(t.on(TrackEvent.Muted,this.handleMuted),t.on(TrackEvent.Unmuted,this.handleUnmuted))}get logContext(){var t;return Object.assign(Object.assign({},(t=this.loggerContextCb)===null||t===void 0?void 0:t.call(this)),getLogContextFromTrack(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==Encryption_Type.NONE}get audioTrack(){if(isAudioTrack(this.track))return this.track}get videoTrack(){if(isVideoTrack(this.track))return this.track}updateInfo(t){this.trackSid=t.sid,this.trackName=t.name,this.source=Track.sourceFromProto(t.source),this.mimeType=t.mimeType,this.kind===Track.Kind.Video&&t.width>0&&(this.dimensions={width:t.width,height:t.height},this.simulcasted=t.simulcast),this.encryption=t.encryption,this.trackInfo=t,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:t}))}}(function(n){(function(t){t.Desired="desired",t.Subscribed="subscribed",t.Unsubscribed="unsubscribed"})(n.SubscriptionStatus||(n.SubscriptionStatus={})),function(t){t.Allowed="allowed",t.NotAllowed="not_allowed"}(n.PermissionStatus||(n.PermissionStatus={}))})(TrackPublication);class LocalTrackPublication extends TrackPublication{get isUpstreamPaused(){var t;return(t=this.track)===null||t===void 0?void 0:t.isUpstreamPaused}constructor(t,i,s,a){super(t,i.sid,i.name,a),this.track=void 0,this.handleTrackEnded=()=>{this.emit(TrackEvent.Ended)},this.updateInfo(i),this.setTrack(s)}setTrack(t){this.track&&this.track.off(TrackEvent.Ended,this.handleTrackEnded),super.setTrack(t),t&&t.on(TrackEvent.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return __awaiter$1(this,void 0,void 0,function*(){var t;return(t=this.track)===null||t===void 0?void 0:t.mute()})}unmute(){return __awaiter$1(this,void 0,void 0,function*(){var t;return(t=this.track)===null||t===void 0?void 0:t.unmute()})}pauseUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var t;yield(t=this.track)===null||t===void 0?void 0:t.pauseUpstream()})}resumeUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var t;yield(t=this.track)===null||t===void 0?void 0:t.resumeUpstream()})}getTrackFeatures(){var t;if(isAudioTrack(this.track)){const i=this.track.getSourceTrackSettings(),s=new Set;return i.autoGainControl&&s.add(AudioTrackFeature.TF_AUTO_GAIN_CONTROL),i.echoCancellation&&s.add(AudioTrackFeature.TF_ECHO_CANCELLATION),i.noiseSuppression&&s.add(AudioTrackFeature.TF_NOISE_SUPPRESSION),i.channelCount&&i.channelCount>1&&s.add(AudioTrackFeature.TF_STEREO),!((t=this.options)===null||t===void 0)&&t.dtx||s.add(AudioTrackFeature.TF_NO_DTX),this.track.enhancedNoiseCancellation&&s.add(AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION),Array.from(s.values())}else return[]}}var ConnectionQuality;(function(n){n.Excellent="excellent",n.Good="good",n.Poor="poor",n.Lost="lost",n.Unknown="unknown"})(ConnectionQuality||(ConnectionQuality={}));function qualityFromProto(n){switch(n){case ConnectionQuality$1.EXCELLENT:return ConnectionQuality.Excellent;case ConnectionQuality$1.GOOD:return ConnectionQuality.Good;case ConnectionQuality$1.POOR:return ConnectionQuality.Poor;case ConnectionQuality$1.LOST:return ConnectionQuality.Lost;default:return ConnectionQuality.Unknown}}class Participant extends eventsExports.EventEmitter{get logContext(){var t,i;return Object.assign({},(i=(t=this.loggerOptions)===null||t===void 0?void 0:t.loggerContextCb)===null||i===void 0?void 0:i.call(t))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(t=>t.isEncrypted)}get isAgent(){var t;return((t=this.permissions)===null||t===void 0?void 0:t.agent)||this.kind===ParticipantInfo_Kind.AGENT}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(t,i,s,a,d,c){let l=arguments.length>6&&arguments[6]!==void 0?arguments[6]:ParticipantInfo_Kind.STANDARD;var u;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=ConnectionQuality.Unknown,this.log=livekitLogger,this.log=getLogger((u=c==null?void 0:c.loggerName)!==null&&u!==void 0?u:LoggerNames.Participant),this.loggerOptions=c,this.setMaxListeners(100),this.sid=t,this.identity=i,this.name=s,this.metadata=a,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=l,this._attributes=d??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(t){for(const[,i]of this.trackPublications)if(i.source===t)return i}getTrackPublicationByName(t){for(const[,i]of this.trackPublications)if(i.trackName===t)return i}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var t;const i=this.getTrackPublication(Track.Source.Camera);return!(!((t=i==null?void 0:i.isMuted)!==null&&t!==void 0)||t)}get isMicrophoneEnabled(){var t;const i=this.getTrackPublication(Track.Source.Microphone);return!(!((t=i==null?void 0:i.isMuted)!==null&&t!==void 0)||t)}get isScreenShareEnabled(){return!!this.getTrackPublication(Track.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(t){return this.participantInfo&&this.participantInfo.sid===t.sid&&this.participantInfo.version>t.version?!1:(this.identity=t.identity,this.sid=t.sid,this._setName(t.name),this._setMetadata(t.metadata),this._setAttributes(t.attributes),t.permission&&this.setPermissions(t.permission),this.participantInfo=t,this.log.trace("update participant info",Object.assign(Object.assign({},this.logContext),{info:t})),!0)}_setMetadata(t){const i=this.metadata!==t,s=this.metadata;this.metadata=t,i&&this.emit(ParticipantEvent.ParticipantMetadataChanged,s)}_setName(t){const i=this.name!==t;this.name=t,i&&this.emit(ParticipantEvent.ParticipantNameChanged,t)}_setAttributes(t){const i=diffAttributes(this.attributes,t);this._attributes=t,Object.keys(i).length>0&&this.emit(ParticipantEvent.AttributesChanged,i)}setPermissions(t){var i,s,a,d,c,l;const u=this.permissions,p=t.canPublish!==((i=this.permissions)===null||i===void 0?void 0:i.canPublish)||t.canSubscribe!==((s=this.permissions)===null||s===void 0?void 0:s.canSubscribe)||t.canPublishData!==((a=this.permissions)===null||a===void 0?void 0:a.canPublishData)||t.hidden!==((d=this.permissions)===null||d===void 0?void 0:d.hidden)||t.recorder!==((c=this.permissions)===null||c===void 0?void 0:c.recorder)||t.canPublishSources.length!==this.permissions.canPublishSources.length||t.canPublishSources.some((f,m)=>{var g;return f!==((g=this.permissions)===null||g===void 0?void 0:g.canPublishSources[m])})||t.canSubscribeMetrics!==((l=this.permissions)===null||l===void 0?void 0:l.canSubscribeMetrics);return this.permissions=t,p&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,u),p}setIsSpeaking(t){t!==this.isSpeaking&&(this.isSpeaking=t,t&&(this.lastSpokeAt=new Date),this.emit(ParticipantEvent.IsSpeakingChanged,t))}setConnectionQuality(t){const i=this._connectionQuality;this._connectionQuality=qualityFromProto(t),i!==this._connectionQuality&&this.emit(ParticipantEvent.ConnectionQualityChanged,this._connectionQuality)}setAudioContext(t){this.audioContext=t,this.audioTrackPublications.forEach(i=>isAudioTrack(i.track)&&i.track.setAudioContext(t))}addTrackPublication(t){t.on(TrackEvent.Muted,()=>{this.emit(ParticipantEvent.TrackMuted,t)}),t.on(TrackEvent.Unmuted,()=>{this.emit(ParticipantEvent.TrackUnmuted,t)});const i=t;switch(i.track&&(i.track.sid=t.trackSid),this.trackPublications.set(t.trackSid,t),t.kind){case Track.Kind.Audio:this.audioTrackPublications.set(t.trackSid,t);break;case Track.Kind.Video:this.videoTrackPublications.set(t.trackSid,t);break}}}function trackPermissionToProto(n){var t,i,s;if(!n.participantSid&&!n.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new TrackPermission({participantIdentity:(t=n.participantIdentity)!==null&&t!==void 0?t:"",participantSid:(i=n.participantSid)!==null&&i!==void 0?i:"",allTracks:(s=n.allowAll)!==null&&s!==void 0?s:!1,trackSids:n.allowedTrackSids||[]})}const STREAM_CHUNK_SIZE=15e3;class LocalParticipant extends Participant{constructor(t,i,s,a,d){super(t,i,void 0,void 0,void 0,{loggerName:a.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=Encryption_Type.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Future)},this.handleReconnected=()=>{var c,l;(l=(c=this.reconnectFuture)===null||c===void 0?void 0:c.resolve)===null||l===void 0||l.call(c),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var c,l;this.reconnectFuture&&(this.reconnectFuture.promise.catch(u=>this.log.warn(u.message,this.logContext)),(l=(c=this.reconnectFuture)===null||c===void 0?void 0:c.reject)===null||l===void 0||l.call(c,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0)},this.handleSignalRequestResponse=c=>{const{requestId:l,reason:u,message:p}=c,f=this.pendingSignalRequests.get(l);f&&(u!==RequestResponse_Reason.OK&&f.reject(new SignalRequestError(p,u)),this.pendingSignalRequests.delete(l))},this.handleDataPacket=c=>{switch(c.value.case){case"rpcResponse":let l=c.value.value,u=null,p=null;l.value.case==="payload"?u=l.value.value:l.value.case==="error"&&(p=RpcError.fromProto(l.value.value)),this.handleIncomingRpcResponse(l.requestId,u,p);break;case"rpcAck":let f=c.value.value;this.handleIncomingRpcAck(f.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(c=>trackPermissionToProto(c)))},this.onTrackUnmuted=c=>{this.onTrackMuted(c,c.isUpstreamPaused)},this.onTrackMuted=(c,l)=>{if(l===void 0&&(l=!0),!c.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c)));return}this.engine.updateMuteStatus(c.sid,l)},this.onTrackUpstreamPaused=c=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c))),this.onTrackMuted(c,!0)},this.onTrackUpstreamResumed=c=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c))),this.onTrackMuted(c,c.isMuted)},this.onTrackFeatureUpdate=c=>{const l=this.audioTrackPublications.get(c.sid);if(!l){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(c.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(l.trackSid,l.getTrackFeatures())},this.handleSubscribedQualityUpdate=c=>__awaiter$1(this,void 0,void 0,function*(){var l,u,p,f,m,g;if(!(!((m=this.roomOptions)===null||m===void 0)&&m.dynacast))return;const v=this.videoTrackPublications.get(c.trackSid);if(!v){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:c.trackSid}));return}if(c.subscribedCodecs.length>0){if(!v.videoTrack)return;const C=yield v.videoTrack.setPublishingCodecs(c.subscribedCodecs);try{for(var y=!0,k=__asyncValues(C),E;E=yield k.next(),l=E.done,!l;y=!0){f=E.value,y=!1;const T=f;isBackupCodec(T)&&(this.log.debug("publish ".concat(T," for ").concat(v.videoTrack.sid),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(v))),yield this.publishAdditionalCodecForTrack(v.videoTrack,T,v.options))}}catch(T){u={error:T}}finally{try{!y&&!l&&(p=k.return)&&(yield p.call(k))}finally{if(u)throw u.error}}}else c.subscribedQualities.length>0&&(yield(g=v.videoTrack)===null||g===void 0?void 0:g.setPublishingLayers(c.subscribedQualities))}),this.handleLocalTrackUnpublished=c=>{const l=this.trackPublications.get(c.trackSid);if(!l){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:c.trackSid}));return}this.unpublishTrack(l.track)},this.handleTrackEnded=c=>__awaiter$1(this,void 0,void 0,function*(){if(c.source===Track.Source.ScreenShare||c.source===Track.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c))),this.unpublishTrack(c);else if(c.isUserProvided)yield c.mute();else if(isLocalAudioTrack(c)||isLocalVideoTrack(c))try{if(isWeb())try{const l=yield navigator==null?void 0:navigator.permissions.query({name:c.source===Track.Source.Camera?"camera":"microphone"});if(l&&l.state==="denied")throw this.log.warn("user has revoked access to ".concat(c.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c))),l.onchange=()=>{l.state!=="denied"&&(c.isMuted||c.restartTrack(),l.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}c.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c))),isLocalAudioTrack(c)?yield c.restartTrack({deviceId:"default"}):yield c.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(c))),yield c.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=s,this.roomOptions=a,this.setupEngine(s),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=d}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Encryption_Type.NONE}getTrackPublication(t){const i=super.getTrackPublication(t);if(i)return i}getTrackPublicationByName(t){const i=super.getTrackPublicationByName(t);if(i)return i}setupEngine(t){this.engine=t,this.engine.on(EngineEvent.RemoteMute,(i,s)=>{const a=this.trackPublications.get(i);!a||!a.track||(s?a.mute():a.unmute())}),this.engine.on(EngineEvent.Connected,this.handleReconnected).on(EngineEvent.SignalRestarted,this.handleReconnected).on(EngineEvent.SignalResumed,this.handleReconnected).on(EngineEvent.Restarting,this.handleReconnecting).on(EngineEvent.Resuming,this.handleReconnecting).on(EngineEvent.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(EngineEvent.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(EngineEvent.Disconnected,this.handleDisconnected).on(EngineEvent.SignalRequestResponse,this.handleSignalRequestResponse).on(EngineEvent.DataPacketReceived,this.handleDataPacket)}setMetadata(t){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:t})})}setName(t){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:t})})}setAttributes(t){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:t})})}requestMetadataUpdate(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let{metadata:a,name:d,attributes:c}=i;return function*(){return new Promise((l,u)=>__awaiter$1(s,void 0,void 0,function*(){var p,f;try{let m=!1;const g=yield this.engine.client.sendUpdateLocalMetadata((p=a??this.metadata)!==null&&p!==void 0?p:"",(f=d??this.name)!==null&&f!==void 0?f:"",c),v=performance.now();for(this.pendingSignalRequests.set(g,{resolve:l,reject:y=>{u(y),m=!0},values:{name:d,metadata:a,attributes:c}});performance.now()-v<5e3&&!m;){if((!d||this.name===d)&&(!a||this.metadata===a)&&(!c||Object.entries(c).every(y=>{let[k,E]=y;return this.attributes[k]===E||E===""&&!this.attributes[k]}))){this.pendingSignalRequests.delete(g),l();return}yield sleep$1(50)}u(new SignalRequestError("Request to update local metadata timed out","TimeoutError"))}catch(m){m instanceof Error&&u(m)}}))}()})}setCameraEnabled(t,i,s){return this.setTrackEnabled(Track.Source.Camera,t,i,s)}setMicrophoneEnabled(t,i,s){return this.setTrackEnabled(Track.Source.Microphone,t,i,s)}setScreenShareEnabled(t,i,s){return this.setTrackEnabled(Track.Source.ScreenShare,t,i,s)}setPermissions(t){const i=this.permissions,s=super.setPermissions(t);return s&&i&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,i),s}setE2EEEnabled(t){return __awaiter$1(this,void 0,void 0,function*(){this.encryptionType=t?Encryption_Type.GCM:Encryption_Type.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(t,i,s,a){return __awaiter$1(this,void 0,void 0,function*(){var d,c;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:t,enabled:i})),this.republishPromise&&(yield this.republishPromise);let l=this.getTrackPublication(t);if(i)if(l)yield l.unmute();else{let u;if(this.pendingPublishing.has(t)){const p=yield this.waitForPendingPublicationOfSource(t);return p||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:t})),yield p==null?void 0:p.unmute(),p}this.pendingPublishing.add(t);try{switch(t){case Track.Source.Camera:u=yield this.createTracks({video:(d=s)!==null&&d!==void 0?d:!0});break;case Track.Source.Microphone:u=yield this.createTracks({audio:(c=s)!==null&&c!==void 0?c:!0});break;case Track.Source.ScreenShare:u=yield this.createScreenTracks(Object.assign({},s));break;default:throw new TrackInvalidError(t)}}catch(p){throw u==null||u.forEach(f=>{f.stop()}),p instanceof Error&&this.emit(ParticipantEvent.MediaDevicesError,p),this.pendingPublishing.delete(t),p}try{const p=[];for(const m of u)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(m))),p.push(this.publishTrack(m,a));[l]=yield Promise.all(p)}catch(p){throw u==null||u.forEach(f=>{f.stop()}),p}finally{this.pendingPublishing.delete(t)}}else if(!(l!=null&&l.track)&&this.pendingPublishing.has(t)&&(l=yield this.waitForPendingPublicationOfSource(t),l||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:t}))),l&&l.track)if(t===Track.Source.ScreenShare){l=yield this.unpublishTrack(l.track);const u=this.getTrackPublication(Track.Source.ScreenShareAudio);u&&u.track&&this.unpublishTrack(u.track)}else yield l.mute();return l})}enableCameraAndMicrophone(){return __awaiter$1(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(Track.Source.Camera)||this.pendingPublishing.has(Track.Source.Microphone))){this.pendingPublishing.add(Track.Source.Camera),this.pendingPublishing.add(Track.Source.Microphone);try{const t=yield this.createTracks({audio:!0,video:!0});yield Promise.all(t.map(i=>this.publishTrack(i)))}finally{this.pendingPublishing.delete(Track.Source.Camera),this.pendingPublishing.delete(Track.Source.Microphone)}}})}createTracks(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s;t??(t={});const{audioProcessor:a,videoProcessor:d,optionsWithoutProcessor:c}=extractProcessorsFromOptions(t),l=mergeDefaultOptions(c,(i=this.roomOptions)===null||i===void 0?void 0:i.audioCaptureDefaults,(s=this.roomOptions)===null||s===void 0?void 0:s.videoCaptureDefaults),u=constraintsForOptions(l);let p;try{p=yield navigator.mediaDevices.getUserMedia(u)}catch(f){throw f instanceof Error&&(u.audio&&(this.microphoneError=f),u.video&&(this.cameraError=f)),f}return u.audio&&(this.microphoneError=void 0,this.emit(ParticipantEvent.AudioStreamAcquired)),u.video&&(this.cameraError=void 0),Promise.all(p.getTracks().map(f=>__awaiter$1(this,void 0,void 0,function*(){const m=f.kind==="audio";m?l.audio:l.video;let g;const v=m?u.audio:u.video;typeof v!="boolean"&&(g=v);const y=mediaTrackToLocalTrack(f,g,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return y.kind===Track.Kind.Video?y.source=Track.Source.Camera:y.kind===Track.Kind.Audio&&(y.source=Track.Source.Microphone,y.setAudioContext(this.audioContext)),y.mediaStream=p,isAudioTrack(y)&&a?yield y.setProcessor(a):isVideoTrack(y)&&d&&(yield y.setProcessor(d)),y})))})}createScreenTracks(t){return __awaiter$1(this,void 0,void 0,function*(){if(t===void 0&&(t={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError("getDisplayMedia not supported");t.resolution===void 0&&!isSafari17()&&(t.resolution=ScreenSharePresets.h1080fps30.resolution);const i=screenCaptureToDisplayMediaStreamOptions(t),s=yield navigator.mediaDevices.getDisplayMedia(i),a=s.getVideoTracks();if(a.length===0)throw new TrackInvalidError("no video track found");const d=new LocalVideoTrack(a[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});d.source=Track.Source.ScreenShare,t.contentHint&&(d.mediaStreamTrack.contentHint=t.contentHint);const c=[d];if(s.getAudioTracks().length>0){this.emit(ParticipantEvent.AudioStreamAcquired);const l=new LocalAudioTrack(s.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});l.source=Track.Source.ScreenShareAudio,c.push(l)}return c})}publishTrack(t,i){return __awaiter$1(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(t,i)})}publishOrRepublishTrack(t,i){return __awaiter$1(this,arguments,void 0,function(s,a){var d=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var l,u,p,f;isLocalAudioTrack(s)&&s.setAudioContext(d.audioContext),yield(l=d.reconnectFuture)===null||l===void 0?void 0:l.promise,d.republishPromise&&!c&&(yield d.republishPromise),isLocalTrack(s)&&d.pendingPublishPromises.has(s)&&(yield d.pendingPublishPromises.get(s));let m;if(s instanceof MediaStreamTrack)m=s.getConstraints();else{m=s.constraints;let C;switch(s.source){case Track.Source.Microphone:C="audioinput";break;case Track.Source.Camera:C="videoinput"}C&&d.activeDeviceMap.has(C)&&(m=Object.assign(Object.assign({},m),{deviceId:d.activeDeviceMap.get(C)}))}if(s instanceof MediaStreamTrack)switch(s.kind){case"audio":s=new LocalAudioTrack(s,m,!0,d.audioContext,{loggerName:d.roomOptions.loggerName,loggerContextCb:()=>d.logContext});break;case"video":s=new LocalVideoTrack(s,m,!0,{loggerName:d.roomOptions.loggerName,loggerContextCb:()=>d.logContext});break;default:throw new TrackInvalidError("unsupported MediaStreamTrack kind ".concat(s.kind))}else s.updateLoggerOptions({loggerName:d.roomOptions.loggerName,loggerContextCb:()=>d.logContext});let g;if(d.trackPublications.forEach(C=>{C.track&&C.track===s&&(g=C)}),g)return d.log.warn("track has already been published, skipping",Object.assign(Object.assign({},d.logContext),getLogContextFromTrack(g))),g;const v="channelCount"in s.mediaStreamTrack.getSettings()&&s.mediaStreamTrack.getSettings().channelCount===2||s.mediaStreamTrack.getConstraints().channelCount===2,y=(u=a==null?void 0:a.forceStereo)!==null&&u!==void 0?u:v;y&&(a||(a={}),a.dtx===void 0&&d.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},d.logContext),getLogContextFromTrack(s))),a.red===void 0&&d.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(p=a.dtx)!==null&&p!==void 0||(a.dtx=!1),(f=a.red)!==null&&f!==void 0||(a.red=!1));const k=Object.assign(Object.assign({},d.roomOptions.publishDefaults),a);!isE2EESimulcastSupported()&&d.roomOptions.e2ee&&(d.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},d.logContext)),k.simulcast=!1),k.source&&(s.source=k.source);const E=d.publish(s,k,y);d.pendingPublishPromises.set(s,E);try{return yield E}catch(C){throw C}finally{d.pendingPublishPromises.delete(s)}}()})}publish(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){var a,d,c,l,u,p,f,m,g,v;Array.from(this.trackPublications.values()).find(S=>isLocalTrack(t)&&S.source===t.source)&&t.source!==Track.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(t.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t))),i.stopMicTrackOnMute&&isAudioTrack(t)&&(t.stopOnMute=!0),t.source===Track.Source.ScreenShare&&isFireFox()&&(i.simulcast=!1),i.videoCodec==="av1"&&!supportsAV1()&&(i.videoCodec=void 0),i.videoCodec==="vp9"&&!supportsVP9()&&(i.videoCodec=void 0),i.videoCodec===void 0&&(i.videoCodec=defaultVideoCodec),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(S=>i.videoCodec===mimeTypeToVideoCodecString(S.mime))||(i.videoCodec=mimeTypeToVideoCodecString(this.enabledPublishVideoCodecs[0].mime)));const k=i.videoCodec;t.on(TrackEvent.Muted,this.onTrackMuted),t.on(TrackEvent.Unmuted,this.onTrackUnmuted),t.on(TrackEvent.Ended,this.handleTrackEnded),t.on(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),t.on(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),t.on(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const E=new AddTrackRequest({cid:t.mediaStreamTrack.id,name:i.name,type:Track.kindToProto(t.kind),muted:t.isMuted,source:Track.sourceToProto(t.source),disableDtx:!(!((a=i.dtx)!==null&&a!==void 0)||a),encryption:this.encryptionType,stereo:s,disableRed:this.isE2EEEnabled||!(!((d=i.red)!==null&&d!==void 0)||d),stream:i==null?void 0:i.stream,backupCodecPolicy:i==null?void 0:i.backupCodecPolicy});let C;if(t.kind===Track.Kind.Video){let S={width:0,height:0};try{S=yield t.waitForDimensions()}catch{const O=(l=(c=this.roomOptions.videoCaptureDefaults)===null||c===void 0?void 0:c.resolution)!==null&&l!==void 0?l:VideoPresets.h720.resolution;S={width:O.width,height:O.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t)),{dims:S}))}E.width=S.width,E.height=S.height,isLocalVideoTrack(t)&&(isSVCCodec(k)&&(t.source===Track.Source.ScreenShare&&(i.scalabilityMode="L1T3","contentHint"in t.mediaStreamTrack&&(t.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t))))),i.scalabilityMode=(u=i.scalabilityMode)!==null&&u!==void 0?u:"L3T3_KEY"),E.simulcastCodecs=[new SimulcastCodec({codec:k,cid:t.mediaStreamTrack.id})],i.backupCodec===!0&&(i.backupCodec={codec:defaultVideoCodec}),i.backupCodec&&k!==i.backupCodec.codec&&E.encryption===Encryption_Type.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),E.simulcastCodecs.push(new SimulcastCodec({codec:i.backupCodec.codec,cid:""})))),C=computeVideoEncodings(t.source===Track.Source.ScreenShare,E.width,E.height,i),E.layers=videoLayersFromEncodings(E.width,E.height,C,isSVCCodec(i.videoCodec))}else t.kind===Track.Kind.Audio&&(C=[{maxBitrate:(p=i.audioPreset)===null||p===void 0?void 0:p.maxBitrate,priority:(m=(f=i.audioPreset)===null||f===void 0?void 0:f.priority)!==null&&m!==void 0?m:"high",networkPriority:(v=(g=i.audioPreset)===null||g===void 0?void 0:g.priority)!==null&&v!==void 0?v:"high"}]);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const T=()=>__awaiter$1(this,void 0,void 0,function*(){var S,R,O;if(!this.engine.pcManager)throw new UnexpectedConnectionState("pcManager is not ready");if(t.sender=yield this.engine.createSender(t,i,C),isLocalVideoTrack(t)&&((S=i.degradationPreference)!==null&&S!==void 0||(i.degradationPreference=getDefaultDegradationPreference(t)),t.setDegradationPreference(i.degradationPreference)),C)if(isFireFox()&&t.kind===Track.Kind.Audio){let L;for(const D of this.engine.pcManager.publisher.getTransceivers())if(D.sender===t.sender){L=D;break}L&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:L,codec:"opus",maxbr:!((R=C[0])===null||R===void 0)&&R.maxBitrate?C[0].maxBitrate/1e3:0})}else t.codec&&isSVCCodec(t.codec)&&(!((O=C[0])===null||O===void 0)&&O.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:E.cid,codec:t.codec,maxbr:C[0].maxBitrate/1e3});yield this.engine.negotiate()});let w;if(this.enabledPublishVideoCodecs.length>0)w=(yield Promise.all([this.engine.addTrack(E),T()]))[0];else{w=yield this.engine.addTrack(E);let S;if(w.codecs.forEach(R=>{S===void 0&&(S=R.mimeType)}),S&&t.kind===Track.Kind.Video){const R=mimeTypeToVideoCodecString(S);R!==k&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t)),{codec:R})),i.videoCodec=R,C=computeVideoEncodings(t.source===Track.Source.ScreenShare,E.width,E.height,i))}yield T()}const b=new LocalTrackPublication(t.kind,w,t,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return b.options=i,t.sid=w.sid,this.log.debug("publishing ".concat(t.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:C,trackInfo:w})),isLocalVideoTrack(t)?t.startMonitor(this.engine.client):isLocalAudioTrack(t)&&t.startMonitor(),this.addTrackPublication(b),this.emit(ParticipantEvent.LocalTrackPublished,b),b})}get isLocal(){return!0}publishAdditionalCodecForTrack(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){var a;if(this.encryptionType!==Encryption_Type.NONE)return;let d;if(this.trackPublications.forEach(v=>{v.track&&v.track===t&&(d=v)}),!d)throw new TrackInvalidError("track is not published");if(!isLocalVideoTrack(t))throw new TrackInvalidError("track is not a video track");const c=Object.assign(Object.assign({},(a=this.roomOptions)===null||a===void 0?void 0:a.publishDefaults),s),l=computeTrackBackupEncodings(t,i,c);if(!l){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t)));return}const u=t.addSimulcastTrack(i,l);if(!u)return;const p=new AddTrackRequest({cid:u.mediaStreamTrack.id,type:Track.kindToProto(t.kind),muted:t.isMuted,source:Track.sourceToProto(t.source),sid:t.sid,simulcastCodecs:[{codec:c.videoCodec,cid:u.mediaStreamTrack.id}]});if(p.layers=videoLayersFromEncodings(p.width,p.height,l),!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const f=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(t,u,c,l),yield this.engine.negotiate()}),g=(yield Promise.all([this.engine.addTrack(p),f()]))[0];this.log.debug("published ".concat(i," for track ").concat(t.sid),Object.assign(Object.assign({},this.logContext),{encodings:l,trackInfo:g}))})}unpublishTrack(t,i){return __awaiter$1(this,void 0,void 0,function*(){var s,a;if(isLocalTrack(t)){const p=this.pendingPublishPromises.get(t);p&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t))),yield p)}const d=this.getPublicationForTrack(t),c=d?getLogContextFromTrack(d):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),c)),!d||!d.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),c));return}t=d.track,t.off(TrackEvent.Muted,this.onTrackMuted),t.off(TrackEvent.Unmuted,this.onTrackUnmuted),t.off(TrackEvent.Ended,this.handleTrackEnded),t.off(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),t.off(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),t.off(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),i===void 0&&(i=(a=(s=this.roomOptions)===null||s===void 0?void 0:s.stopLocalTrackOnUnpublish)!==null&&a!==void 0?a:!0),i?t.stop():t.stopMonitor();let l=!1;const u=t.sender;if(t.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<PCTransportState.FAILED&&u)try{for(const p of this.engine.pcManager.publisher.getTransceivers())p.sender===u&&(p.direction="inactive",l=!0);if(this.engine.removeTrack(u)&&(l=!0),isLocalVideoTrack(t)){for(const[,p]of t.simulcastCodecs)p.sender&&(this.engine.removeTrack(p.sender)&&(l=!0),p.sender=void 0);t.simulcastCodecs.clear()}}catch(p){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),c),{error:p}))}switch(this.trackPublications.delete(d.trackSid),d.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(d.trackSid);break;case Track.Kind.Video:this.videoTrackPublications.delete(d.trackSid);break}return this.emit(ParticipantEvent.LocalTrackUnpublished,d),d.setTrack(void 0),l&&(yield this.engine.negotiate()),d})}unpublishTracks(t){return __awaiter$1(this,void 0,void 0,function*(){return(yield Promise.all(t.map(s=>this.unpublishTrack(s)))).filter(s=>!!s)})}republishAllTracks(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){s.republishPromise&&(yield s.republishPromise),s.republishPromise=new Promise((d,c)=>__awaiter$1(s,void 0,void 0,function*(){try{const l=[];this.trackPublications.forEach(u=>{u.track&&(i&&(u.options=Object.assign(Object.assign({},u.options),i)),l.push(u))}),yield Promise.all(l.map(u=>__awaiter$1(this,void 0,void 0,function*(){const p=u.track;yield this.unpublishTrack(p,!1),a&&!p.isMuted&&p.source!==Track.Source.ScreenShare&&p.source!==Track.Source.ScreenShareAudio&&(isLocalAudioTrack(p)||isLocalVideoTrack(p))&&!p.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:u.trackSid})),yield p.restartTrack()),yield this.publishOrRepublishTrack(p,u.options,!0)}))),d()}catch(l){c(l)}finally{this.republishPromise=void 0}})),yield s.republishPromise}()})}publishData(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function*(){const d=a.reliable?DataPacket_Kind.RELIABLE:DataPacket_Kind.LOSSY,c=a.destinationIdentities,l=a.topic,u=new DataPacket({kind:d,value:{case:"user",value:new UserPacket({participantIdentity:s.identity,payload:i,destinationIdentities:c,topic:l})}});yield s.engine.sendDataPacket(u,d)}()})}publishDtmf(t,i){return __awaiter$1(this,void 0,void 0,function*(){const s=new DataPacket({kind:DataPacket_Kind.RELIABLE,value:{case:"sipDtmf",value:new SipDTMF({code:t,digit:i})}});yield this.engine.sendDataPacket(s,DataPacket_Kind.RELIABLE)})}sendChatMessage(t,i){return __awaiter$1(this,void 0,void 0,function*(){const s={id:crypto.randomUUID(),message:t,timestamp:Date.now(),attachedFiles:i==null?void 0:i.attachments},a=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},s),{timestamp:protoInt64.parse(s.timestamp)}))}});return yield this.engine.sendDataPacket(a,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,s),s})}editChatMessage(t,i){return __awaiter$1(this,void 0,void 0,function*(){const s=Object.assign(Object.assign({},i),{message:t,editTimestamp:Date.now()}),a=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},s),{timestamp:protoInt64.parse(s.timestamp),editTimestamp:protoInt64.parse(s.editTimestamp)}))}});return yield this.engine.sendDataPacket(a,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,s),s})}sendText(t,i){return __awaiter$1(this,void 0,void 0,function*(){var s;const a=crypto.randomUUID(),c=new TextEncoder().encode(t).byteLength,l=(s=i==null?void 0:i.attachments)===null||s===void 0?void 0:s.map(()=>crypto.randomUUID()),u=new Array(l?l.length+1:1).fill(0),p=(v,y)=>{var k;u[y]=v;const E=u.reduce((C,T)=>C+T,0);(k=i==null?void 0:i.onProgress)===null||k===void 0||k.call(i,E)},f=yield this.streamText({streamId:a,totalSize:c,destinationIdentities:i==null?void 0:i.destinationIdentities,topic:i==null?void 0:i.topic,attachedStreamIds:l}),m=Math.floor(STREAM_CHUNK_SIZE/4),g=Math.ceil(c/m);for(let v=0;v<g;v++){const y=t.slice(v*m,Math.min((v+1)*m,c));yield this.engine.waitForBufferStatusLow(DataPacket_Kind.RELIABLE),yield f.write(y),p(Math.ceil((v+1)/g),0)}return yield f.close(),i!=null&&i.attachments&&l&&(yield Promise.all(i.attachments.map((v,y)=>__awaiter$1(this,void 0,void 0,function*(){return this._sendFile(l[y],v,{topic:i.topic,mimeType:v.type,onProgress:k=>{p(k,y+1)}})})))),f.info})}streamText(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s;const a=(i=t==null?void 0:t.streamId)!==null&&i!==void 0?i:crypto.randomUUID(),d={id:a,mimeType:"text/plain",timestamp:Date.now(),topic:(s=t==null?void 0:t.topic)!==null&&s!==void 0?s:"",size:t==null?void 0:t.totalSize},c=new DataStream_Header({streamId:a,mimeType:d.mimeType,topic:d.topic,timestamp:numberToBigInt(d.timestamp),totalLength:numberToBigInt(t==null?void 0:t.totalSize),contentHeader:{case:"textHeader",value:new DataStream_TextHeader({version:t==null?void 0:t.version,attachedStreamIds:t==null?void 0:t.attachedStreamIds,replyToStreamId:t==null?void 0:t.replyToStreamId,operationType:(t==null?void 0:t.type)==="update"?DataStream_OperationType.UPDATE:DataStream_OperationType.CREATE})}}),l=t==null?void 0:t.destinationIdentities,u=new DataPacket({destinationIdentities:l,value:{case:"streamHeader",value:c}});yield this.engine.sendDataPacket(u,DataPacket_Kind.RELIABLE);let p=0;const f=this,m=new WritableStream({write(y){let[k]=y;var E;const C=new TextEncoder().encode(k);if(C.byteLength>STREAM_CHUNK_SIZE)throw(E=this.abort)===null||E===void 0||E.call(this),new Error("chunk size too large");return new Promise(T=>__awaiter$1(this,void 0,void 0,function*(){yield f.engine.waitForBufferStatusLow(DataPacket_Kind.RELIABLE);const w=new DataStream_Chunk({content:C,streamId:a,chunkIndex:numberToBigInt(p)}),b=new DataPacket({destinationIdentities:l,value:{case:"streamChunk",value:w}});yield f.engine.sendDataPacket(b,DataPacket_Kind.RELIABLE),p+=1,T()}))},close(){return __awaiter$1(this,void 0,void 0,function*(){const y=new DataStream_Trailer({streamId:a}),k=new DataPacket({destinationIdentities:l,value:{case:"streamTrailer",value:y}});yield f.engine.sendDataPacket(k,DataPacket_Kind.RELIABLE)})},abort(y){console.log("Sink error:",y)}});let g=()=>__awaiter$1(this,void 0,void 0,function*(){yield v.close()});f.engine.once(EngineEvent.Closing,g);const v=new TextStreamWriter(m,d,()=>this.engine.off(EngineEvent.Closing,g));return v})}sendFile(t,i){return __awaiter$1(this,void 0,void 0,function*(){const s=crypto.randomUUID();return yield this._sendFile(s,t,i),{id:s}})}_sendFile(t,i,s){return __awaiter$1(this,void 0,void 0,function*(){var a,d;const c=i.size,l=new DataStream_Header({totalLength:numberToBigInt(c),mimeType:(a=s==null?void 0:s.mimeType)!==null&&a!==void 0?a:i.type,streamId:t,topic:s==null?void 0:s.topic,encryptionType:s==null?void 0:s.encryptionType,timestamp:numberToBigInt(Date.now()),contentHeader:{case:"byteHeader",value:new DataStream_ByteHeader({name:i.name})}}),u=s==null?void 0:s.destinationIdentities,p=new DataPacket({destinationIdentities:u,value:{case:"streamHeader",value:l}});yield this.engine.sendDataPacket(p,DataPacket_Kind.RELIABLE);function f(y){return new Promise(k=>{const E=new FileReader;E.onload=()=>{k(new Uint8Array(E.result))},E.readAsArrayBuffer(y)})}const m=Math.ceil(c/STREAM_CHUNK_SIZE);for(let y=0;y<m;y++){const k=yield f(i.slice(y*STREAM_CHUNK_SIZE,Math.min((y+1)*STREAM_CHUNK_SIZE,c)));yield this.engine.waitForBufferStatusLow(DataPacket_Kind.RELIABLE);const E=new DataStream_Chunk({content:k,streamId:t,chunkIndex:numberToBigInt(y)}),C=new DataPacket({destinationIdentities:u,value:{case:"streamChunk",value:E}});yield this.engine.sendDataPacket(C,DataPacket_Kind.RELIABLE),(d=s==null?void 0:s.onProgress)===null||d===void 0||d.call(s,(y+1)/m)}const g=new DataStream_Trailer({streamId:t}),v=new DataPacket({destinationIdentities:u,value:{case:"streamTrailer",value:g}});yield this.engine.sendDataPacket(v,DataPacket_Kind.RELIABLE)})}performRpc(t){return __awaiter$1(this,arguments,void 0,function(i){var s=this;let{destinationIdentity:a,method:d,payload:c,responseTimeout:l=1e4}=i;return function*(){return new Promise((p,f)=>__awaiter$1(s,void 0,void 0,function*(){var m,g,v,y;if(byteLength(c)>MAX_PAYLOAD_BYTES){f(RpcError.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((g=(m=this.engine.latestJoinResponse)===null||m===void 0?void 0:m.serverInfo)===null||g===void 0)&&g.version&&compareVersions((y=(v=this.engine.latestJoinResponse)===null||v===void 0?void 0:v.serverInfo)===null||y===void 0?void 0:y.version,"1.8.0")<0){f(RpcError.builtIn("UNSUPPORTED_SERVER"));return}const k=crypto.randomUUID();yield this.publishRpcRequest(a,k,d,c,l-2e3);const E=setTimeout(()=>{this.pendingAcks.delete(k),f(RpcError.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(k),clearTimeout(C)},2e3);this.pendingAcks.set(k,{resolve:()=>{clearTimeout(E)},participantIdentity:a});const C=setTimeout(()=>{this.pendingResponses.delete(k),f(RpcError.builtIn("RESPONSE_TIMEOUT"))},l);this.pendingResponses.set(k,{resolve:(T,w)=>{clearTimeout(C),this.pendingAcks.has(k)&&(console.warn("RPC response received before ack",k),this.pendingAcks.delete(k),clearTimeout(E)),w?f(w):p(T??"")},participantIdentity:a})}))}()})}registerRpcMethod(t,i){this.rpcHandlers.has(t)&&this.log.warn("you're overriding the RPC handler for method ".concat(t,", in the future this will throw an error")),this.rpcHandlers.set(t,i)}unregisterRpcMethod(t){this.rpcHandlers.delete(t)}setTrackSubscriptionPermissions(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=i,this.allParticipantsAllowedToSubscribe=t,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(t){const i=this.pendingAcks.get(t);i?(i.resolve(),this.pendingAcks.delete(t)):console.error("Ack received for unexpected RPC request",t)}handleIncomingRpcResponse(t,i,s){const a=this.pendingResponses.get(t);a?(a.resolve(i,s),this.pendingResponses.delete(t)):console.error("Response received for unexpected RPC request",t)}publishRpcRequest(t,i,s,a,d){return __awaiter$1(this,void 0,void 0,function*(){const c=new DataPacket({destinationIdentities:[t],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcRequest",value:new RpcRequest({id:i,method:s,payload:a,responseTimeoutMs:d,version:1})}});yield this.engine.sendDataPacket(c,DataPacket_Kind.RELIABLE)})}handleParticipantDisconnected(t){for(const[i,{participantIdentity:s}]of this.pendingAcks)s===t&&this.pendingAcks.delete(i);for(const[i,{participantIdentity:s,resolve:a}]of this.pendingResponses)s===t&&(a(null,RpcError.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(i))}setEnabledPublishCodecs(t){this.enabledPublishVideoCodecs=t.filter(i=>i.mime.split("/")[0].toLowerCase()==="video")}updateInfo(t){return t.sid!==this.sid||!super.updateInfo(t)?!1:(t.tracks.forEach(i=>{var s,a;const d=this.trackPublications.get(i.sid);if(d){const c=d.isMuted||((a=(s=d.track)===null||s===void 0?void 0:s.isUpstreamPaused)!==null&&a!==void 0?a:!1);c!==i.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(d)),{mutedOnServer:c})),this.engine.client.sendMuteTrack(i.sid,c))}}),!0)}getPublicationForTrack(t){let i;return this.trackPublications.forEach(s=>{const a=s.track;a&&(t instanceof MediaStreamTrack?(isLocalAudioTrack(a)||isLocalVideoTrack(a))&&a.mediaStreamTrack===t&&(i=s):t===a&&(i=s))}),i}waitForPendingPublicationOfSource(t){return __awaiter$1(this,void 0,void 0,function*(){const s=Date.now();for(;Date.now()<s+1e4;){const a=Array.from(this.pendingPublishPromises.entries()).find(d=>{let[c]=d;return c.source===t});if(a)return a[1];yield sleep$1(20)}})}}class RemoteTrackPublication extends TrackPublication{constructor(t,i,s,a){super(t,i.sid,i.name,a),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=VideoQuality.HIGH,this.handleEnded=d=>{this.setTrack(void 0),this.emit(TrackEvent.Ended,d)},this.handleVisibilityChange=d=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(d),this.logContext),this.disabled=!d,this.emitTrackUpdate()},this.handleVideoDimensionsChange=d=>{this.log.debug("adaptivestream video dimensions ".concat(d.width,"x").concat(d.height),this.logContext),this.videoDimensions=d,this.emitTrackUpdate()},this.subscribed=s,this.updateInfo(i)}setSubscribed(t){const i=this.subscriptionStatus,s=this.permissionStatus;this.subscribed=t,t&&(this.allowed=!0);const a=new UpdateSubscription({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new ParticipantTracks({participantSid:"",trackSids:[this.trackSid]})]});this.emit(TrackEvent.UpdateSubscription,a),this.emitSubscriptionUpdateIfChanged(i),this.emitPermissionUpdateIfChanged(s)}get subscriptionStatus(){return this.subscribed===!1?TrackPublication.SubscriptionStatus.Unsubscribed:super.isSubscribed?TrackPublication.SubscriptionStatus.Subscribed:TrackPublication.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?TrackPublication.PermissionStatus.Allowed:TrackPublication.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return!this.disabled}get isLocal(){return!1}setEnabled(t){!this.isManualOperationAllowed()||this.disabled===!t||(this.disabled=!t,this.emitTrackUpdate())}setVideoQuality(t){!this.isManualOperationAllowed()||this.currentVideoQuality===t||(this.currentVideoQuality=t,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(t){var i,s;this.isManualOperationAllowed()&&(((i=this.videoDimensions)===null||i===void 0?void 0:i.width)===t.width&&((s=this.videoDimensions)===null||s===void 0?void 0:s.height)===t.height||(isRemoteVideoTrack(this.track)&&(this.videoDimensions=t),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(t){this.isManualOperationAllowed()&&isRemoteVideoTrack(this.track)&&this.fps!==t&&(this.fps=t,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack(t){const i=this.subscriptionStatus,s=this.permissionStatus,a=this.track;a!==t&&(a&&(a.off(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),a.off(TrackEvent.VisibilityChanged,this.handleVisibilityChange),a.off(TrackEvent.Ended,this.handleEnded),a.detach(),a.stopMonitor(),this.emit(TrackEvent.Unsubscribed,a)),super.setTrack(t),t&&(t.sid=this.trackSid,t.on(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),t.on(TrackEvent.VisibilityChanged,this.handleVisibilityChange),t.on(TrackEvent.Ended,this.handleEnded),this.emit(TrackEvent.Subscribed,t)),this.emitPermissionUpdateIfChanged(s),this.emitSubscriptionUpdateIfChanged(i))}setAllowed(t){const i=this.subscriptionStatus,s=this.permissionStatus;this.allowed=t,this.emitPermissionUpdateIfChanged(s),this.emitSubscriptionUpdateIfChanged(i)}setSubscriptionError(t){this.emit(TrackEvent.SubscriptionFailed,t)}updateInfo(t){super.updateInfo(t);const i=this.metadataMuted;this.metadataMuted=t.muted,this.track?this.track.setMuted(t.muted):i!==t.muted&&this.emit(t.muted?TrackEvent.Muted:TrackEvent.Unmuted)}emitSubscriptionUpdateIfChanged(t){const i=this.subscriptionStatus;t!==i&&this.emit(TrackEvent.SubscriptionStatusChanged,i,t)}emitPermissionUpdateIfChanged(t){this.permissionStatus!==t&&this.emit(TrackEvent.SubscriptionPermissionChanged,this.permissionStatus,t)}isManualOperationAllowed(){return this.kind===Track.Kind.Video&&this.isAdaptiveStream?(this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext),!1):this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return isRemoteVideoTrack(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const t=new UpdateTrackSettings({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?(t.width=Math.ceil(this.videoDimensions.width),t.height=Math.ceil(this.videoDimensions.height)):this.currentVideoQuality!==void 0?t.quality=this.currentVideoQuality:t.quality=VideoQuality.HIGH,this.emit(TrackEvent.UpdateSettings,t)}}class RemoteParticipant extends Participant{static fromParticipantInfo(t,i,s){return new RemoteParticipant(t,i.sid,i.identity,i.name,i.metadata,i.attributes,s,i.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(t,i,s,a,d,c,l){let u=arguments.length>7&&arguments[7]!==void 0?arguments[7]:ParticipantInfo_Kind.STANDARD;super(i,s||"",a,d,c,l,u),this.signalClient=t,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(t){super.addTrackPublication(t),t.on(TrackEvent.UpdateSettings,i=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(t))),this.signalClient.sendUpdateTrackSettings(i)}),t.on(TrackEvent.UpdateSubscription,i=>{i.participantTracks.forEach(s=>{s.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(i)}),t.on(TrackEvent.SubscriptionPermissionChanged,i=>{this.emit(ParticipantEvent.TrackSubscriptionPermissionChanged,t,i)}),t.on(TrackEvent.SubscriptionStatusChanged,i=>{this.emit(ParticipantEvent.TrackSubscriptionStatusChanged,t,i)}),t.on(TrackEvent.Subscribed,i=>{this.emit(ParticipantEvent.TrackSubscribed,i,t)}),t.on(TrackEvent.Unsubscribed,i=>{this.emit(ParticipantEvent.TrackUnsubscribed,i,t)}),t.on(TrackEvent.SubscriptionFailed,i=>{this.emit(ParticipantEvent.TrackSubscriptionFailed,t.trackSid,i)})}getTrackPublication(t){const i=super.getTrackPublication(t);if(i)return i}getTrackPublicationByName(t){const i=super.getTrackPublicationByName(t);if(i)return i}setVolume(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Track.Source.Microphone;this.volumeMap.set(i,t);const s=this.getTrackPublication(i);s&&s.track&&s.track.setVolume(t)}getVolume(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Track.Source.Microphone;const i=this.getTrackPublication(t);return i&&i.track?i.track.getVolume():this.volumeMap.get(t)}addSubscribedMediaTrack(t,i,s,a,d,c){let l=this.getTrackPublicationBySid(i);if(l||i.startsWith("TR")||this.trackPublications.forEach(f=>{!l&&t.kind===f.kind.toString()&&(l=f)}),!l){if(c===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:i})),this.emit(ParticipantEvent.TrackSubscriptionFailed,i);return}c===void 0&&(c=20),setTimeout(()=>{this.addSubscribedMediaTrack(t,i,s,a,d,c-1)},150);return}if(t.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(l))),this.emit(ParticipantEvent.TrackSubscriptionFailed,i);return}const u=t.kind==="video";let p;return u?p=new RemoteVideoTrack(t,i,a,d):p=new RemoteAudioTrack(t,i,a,this.audioContext,this.audioOutput),p.source=l.source,p.isMuted=l.isMuted,p.setMediaStream(s),p.start(),l.setTrack(p),this.volumeMap.has(l.source)&&isRemoteTrack(p)&&isAudioTrack(p)&&p.setVolume(this.volumeMap.get(l.source)),l}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(t){return this.trackPublications.get(t)}updateInfo(t){if(!super.updateInfo(t))return!1;const i=new Map,s=new Map;return t.tracks.forEach(a=>{var d,c;let l=this.getTrackPublicationBySid(a.sid);if(l)l.updateInfo(a);else{const u=Track.kindFromProto(a.type);if(!u)return;l=new RemoteTrackPublication(u,a,(d=this.signalClient.connectOptions)===null||d===void 0?void 0:d.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(c=this.loggerOptions)===null||c===void 0?void 0:c.loggerName}),l.updateInfo(a),s.set(a.sid,l);const p=Array.from(this.trackPublications.values()).find(f=>f.source===(l==null?void 0:l.source));p&&l.source!==Track.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(l.source),Object.assign(Object.assign({},this.logContext),{oldTrack:getLogContextFromTrack(p),newTrack:getLogContextFromTrack(l)})),this.addTrackPublication(l)}i.set(a.sid,l)}),this.trackPublications.forEach(a=>{i.has(a.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),this.unpublishTrack(a.trackSid,!0))}),s.forEach(a=>{this.emit(ParticipantEvent.TrackPublished,a)}),!0}unpublishTrack(t,i){const s=this.trackPublications.get(t);if(!s)return;const{track:a}=s;switch(a&&(a.stop(),s.setTrack(void 0)),this.trackPublications.delete(t),s.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(t);break;case Track.Kind.Video:this.videoTrackPublications.delete(t);break}i&&this.emit(ParticipantEvent.TrackUnpublished,s)}setAudioOutput(t){return __awaiter$1(this,void 0,void 0,function*(){this.audioOutput=t;const i=[];this.audioTrackPublications.forEach(s=>{var a;isAudioTrack(s.track)&&isRemoteTrack(s.track)&&i.push(s.track.setSinkId((a=t.deviceId)!==null&&a!==void 0?a:"default"))}),yield Promise.all(i)})}emit(t){for(var i=arguments.length,s=new Array(i>1?i-1:0),a=1;a<i;a++)s[a-1]=arguments[a];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:t,args:s})),super.emit(t,...s)}}var ConnectionState;(function(n){n.Disconnected="disconnected",n.Connecting="connecting",n.Connected="connected",n.Reconnecting="reconnecting",n.SignalReconnecting="signalReconnecting"})(ConnectionState||(ConnectionState={}));const connectionReconcileFrequency=4*1e3;class Room extends eventsExports.EventEmitter{constructor(t){var i,s,a,d;if(super(),i=this,this.state=ConnectionState.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=livekitLogger,this.bufferedEvents=[],this.isResuming=!1,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map,this.rpcHandlers=new Map,this.connect=(c,l,u)=>__awaiter$1(this,void 0,void 0,function*(){var p;if(!isBrowserSupported())throw isReactNative()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const f=yield this.disconnectLock.lock();if(this.state===ConnectionState.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),f(),Promise.resolve();if(this.connectFuture)return f(),this.connectFuture.promise;this.setAndEmitConnectionState(ConnectionState.Connecting),((p=this.regionUrlProvider)===null||p===void 0?void 0:p.getServerUrl().toString())!==c&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),isCloud(new URL(c))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new RegionUrlProvider(c,l):this.regionUrlProvider.updateToken(l),this.regionUrlProvider.fetchRegionSettings().then(v=>{var y;(y=this.regionUrlProvider)===null||y===void 0||y.setServerReportedRegions(v)}).catch(v=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:v}))}));const m=(v,y,k)=>__awaiter$1(this,void 0,void 0,function*(){var E,C;this.abortController&&this.abortController.abort();const T=new AbortController;this.abortController=T,f==null||f();try{yield this.attemptConnection(k??c,l,u,T),this.abortController=void 0,v()}catch(w){if(this.regionUrlProvider&&w instanceof ConnectionError&&w.reason!==ConnectionErrorReason.Cancelled&&w.reason!==ConnectionErrorReason.NotAllowed){let b=null;try{b=yield this.regionUrlProvider.getNextBestRegionUrl((E=this.abortController)===null||E===void 0?void 0:E.signal)}catch(S){if(S instanceof ConnectionError&&(S.status===401||S.reason===ConnectionErrorReason.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),y(S);return}}b&&!(!((C=this.abortController)===null||C===void 0)&&C.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(w.message,". Retrying with another region: ").concat(b),this.logContext),this.recreateEngine(),yield m(v,y,b)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,getDisconnectReasonFromConnectionError(w)),y(w))}else{let b=DisconnectReason.UNKNOWN_REASON;w instanceof ConnectionError&&(b=getDisconnectReasonFromConnectionError(w)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,b),y(w)}}}),g=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Future((v,y)=>{m(v,y,g)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(c,l,u,p,f,m)=>__awaiter$1(this,void 0,void 0,function*(){var g,v,y;const k=yield u.join(c,l,{autoSubscribe:p.autoSubscribe,adaptiveStream:typeof f.adaptiveStream=="object"?!0:f.adaptiveStream,maxRetries:p.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:p.websocketTimeout},m.signal);let E=k.serverInfo;if(E||(E={version:k.serverVersion,region:k.serverRegion}),this.serverInfo=E,this.log.debug("connected to Livekit Server ".concat(Object.entries(E).map(C=>{let[T,w]=C;return"".concat(T,": ").concat(w)}).join(", ")),{room:(g=k.room)===null||g===void 0?void 0:g.name,roomSid:(v=k.room)===null||v===void 0?void 0:v.sid,identity:(y=k.participant)===null||y===void 0?void 0:y.identity}),!E.version)throw new UnsupportedServer("unknown server version");return E.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),f.dynacast=!1),k}),this.applyJoinResponse=c=>{const l=c.participant;if(this.localParticipant.sid=l.sid,this.localParticipant.identity=l.identity,this.localParticipant.setEnabledPublishCodecs(c.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(c.sifTrailer)}catch(u){this.log.error(u instanceof Error?u.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:u}))}this.handleParticipantUpdates([l,...c.otherParticipants]),c.room&&this.handleRoomUpdate(c.room)},this.attemptConnection=(c,l,u,p)=>__awaiter$1(this,void 0,void 0,function*(){var f,m;this.state===ConnectionState.Reconnecting||this.isResuming||!((f=this.engine)===null||f===void 0)&&f.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((m=this.regionUrlProvider)===null||m===void 0)&&m.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},roomConnectOptionDefaults),u),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const g=yield this.connectSignal(c,l,this.engine,this.connOptions,this.options,p);this.applyJoinResponse(g),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected)}catch(g){yield this.engine.close(),this.recreateEngine();const v=new ConnectionError("could not establish signal connection",ConnectionErrorReason.ServerUnreachable);throw g instanceof Error&&(v.message="".concat(v.message,": ").concat(g.message)),g instanceof ConnectionError&&(v.reason=g.reason,v.status=g.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:g})),v}if(p.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new ConnectionError("Connection attempt aborted",ConnectionErrorReason.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,p)}catch(g){throw yield this.engine.close(),this.recreateEngine(),g}isWeb()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),isWeb()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];return __awaiter$1(i,[...l],void 0,function(){var p=this;let f=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var m,g,v,y;const k=yield p.disconnectLock.lock();try{if(p.state===ConnectionState.Disconnected){p.log.debug("already disconnected",p.logContext);return}p.log.info("disconnect from room",Object.assign({},p.logContext)),(p.state===ConnectionState.Connecting||p.state===ConnectionState.Reconnecting||p.isResuming)&&(p.log.warn("abort connection attempt",p.logContext),(m=p.abortController)===null||m===void 0||m.abort(),(v=(g=p.connectFuture)===null||g===void 0?void 0:g.reject)===null||v===void 0||v.call(g,new ConnectionError("Client initiated disconnect",ConnectionErrorReason.Cancelled)),p.connectFuture=void 0),!((y=p.engine)===null||y===void 0)&&y.client.isDisconnected||(yield p.engine.client.sendLeave()),p.engine&&(yield p.engine.close()),p.handleDisconnect(f,DisconnectReason.CLIENT_INITIATED),p.engine=void 0}finally{k()}}()})},this.onPageLeave=()=>__awaiter$1(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>__awaiter$1(this,void 0,void 0,function*(){const c=[],l=getBrowser();if(l&&l.os==="iOS"){const u="livekit-dummy-audio-el";let p=document.getElementById(u);if(!p){p=document.createElement("audio"),p.id=u,p.autoplay=!0,p.hidden=!0;const f=getEmptyAudioStreamTrack();f.enabled=!0;const m=new MediaStream([f]);p.srcObject=m,document.addEventListener("visibilitychange",()=>{p&&(p.srcObject=document.hidden?null:m,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(p),this.once(RoomEvent.Disconnected,()=>{p==null||p.remove(),p=null})}c.push(p)}this.remoteParticipants.forEach(u=>{u.audioTrackPublications.forEach(p=>{p.track&&p.track.attachedElements.forEach(f=>{c.push(f)})})});try{yield Promise.all([this.acquireAudioContext(),...c.map(u=>(u.muted=!1,u.play()))]),this.handleAudioPlaybackStarted()}catch(u){throw this.handleAudioPlaybackFailed(u),u}}),this.startVideo=()=>__awaiter$1(this,void 0,void 0,function*(){const c=[];for(const l of this.remoteParticipants.values())l.videoTrackPublications.forEach(u=>{var p;(p=u.track)===null||p===void 0||p.attachedElements.forEach(f=>{c.includes(f)||c.push(f)})});yield Promise.all(c.map(l=>l.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(l=>{l.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const c of this.remoteParticipants.values())this.handleParticipantDisconnected(c.identity,c);this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)},this.handleSignalRestarted=c=>__awaiter$1(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(c.serverRegion),Object.assign(Object.assign({},this.logContext),{region:c.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(c);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(l){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:l}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:c.serverRegion}))}catch{return}this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=c=>{c.forEach(l=>{var u;if(l.identity===this.localParticipant.identity){this.localParticipant.updateInfo(l);return}l.identity===""&&(l.identity=(u=this.sidToIdentity.get(l.sid))!==null&&u!==void 0?u:"");let p=this.remoteParticipants.get(l.identity);l.state===ParticipantInfo_State.DISCONNECTED?this.handleParticipantDisconnected(l.identity,p):p=this.getOrCreateParticipant(l.identity,l)})},this.handleActiveSpeakersUpdate=c=>{const l=[],u={};c.forEach(p=>{if(u[p.sid]=!0,p.sid===this.localParticipant.sid)this.localParticipant.audioLevel=p.level,this.localParticipant.setIsSpeaking(!0),l.push(this.localParticipant);else{const f=this.getRemoteParticipantBySid(p.sid);f&&(f.audioLevel=p.level,f.setIsSpeaking(!0),l.push(f))}}),u[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(p=>{u[p.sid]||(p.audioLevel=0,p.setIsSpeaking(!1))}),this.activeSpeakers=l,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,l)},this.handleSpeakersChanged=c=>{const l=new Map;this.activeSpeakers.forEach(p=>{const f=this.remoteParticipants.get(p.identity);f&&f.sid!==p.sid||l.set(p.sid,p)}),c.forEach(p=>{let f=this.getRemoteParticipantBySid(p.sid);p.sid===this.localParticipant.sid&&(f=this.localParticipant),f&&(f.audioLevel=p.level,f.setIsSpeaking(p.active),p.active?l.set(p.sid,f):l.delete(p.sid))});const u=Array.from(l.values());u.sort((p,f)=>f.audioLevel-p.audioLevel),this.activeSpeakers=u,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,u)},this.handleStreamStateUpdate=c=>{c.streamStates.forEach(l=>{const u=this.getRemoteParticipantBySid(l.participantSid);if(!u)return;const p=u.getTrackPublicationBySid(l.trackSid);if(!p||!p.track)return;const f=Track.streamStateFromProto(l.state);f!==p.track.streamState&&(p.track.streamState=f,u.emit(ParticipantEvent.TrackStreamStateChanged,p,p.track.streamState),this.emitWhenConnected(RoomEvent.TrackStreamStateChanged,p,p.track.streamState,u))})},this.handleSubscriptionPermissionUpdate=c=>{const l=this.getRemoteParticipantBySid(c.participantSid);if(!l)return;const u=l.getTrackPublicationBySid(c.trackSid);u&&u.setAllowed(c.allowed)},this.handleSubscriptionError=c=>{const l=Array.from(this.remoteParticipants.values()).find(p=>p.trackPublications.has(c.trackSid));if(!l)return;const u=l.getTrackPublicationBySid(c.trackSid);u&&u.setSubscriptionError(c.err)},this.handleDataPacket=c=>{const l=this.remoteParticipants.get(c.participantIdentity);if(c.value.case==="user")this.handleUserPacket(l,c.value.value,c.kind);else if(c.value.case==="transcription")this.handleTranscription(l,c.value.value);else if(c.value.case==="sipDtmf")this.handleSipDtmf(l,c.value.value);else if(c.value.case==="chatMessage")this.handleChatMessage(l,c.value.value);else if(c.value.case==="metrics")this.handleMetrics(c.value.value,l);else if(c.value.case==="streamHeader")this.handleStreamHeader(c.value.value,c.participantIdentity);else if(c.value.case==="streamChunk")this.handleStreamChunk(c.value.value);else if(c.value.case==="streamTrailer")this.handleStreamTrailer(c.value.value);else if(c.value.case==="rpcRequest"){const u=c.value.value;this.handleIncomingRpcRequest(c.participantIdentity,u.id,u.method,u.payload,u.responseTimeoutMs,u.version)}},this.handleUserPacket=(c,l,u)=>{this.emit(RoomEvent.DataReceived,l.payload,c,u,l.topic),c==null||c.emit(ParticipantEvent.DataReceived,l.payload,u)},this.handleSipDtmf=(c,l)=>{this.emit(RoomEvent.SipDTMFReceived,l,c),c==null||c.emit(ParticipantEvent.SipDTMFReceived,l)},this.bufferedSegments=new Map,this.handleTranscription=(c,l)=>{const u=l.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(l.transcribedParticipantIdentity),p=u==null?void 0:u.trackPublications.get(l.trackId),f=extractTranscriptionSegments(l,this.transcriptionReceivedTimes);p==null||p.emit(TrackEvent.TranscriptionReceived,f),u==null||u.emit(ParticipantEvent.TranscriptionReceived,f,p),this.emit(RoomEvent.TranscriptionReceived,f,u,p)},this.handleChatMessage=(c,l)=>{const u=extractChatMessage(l);this.emit(RoomEvent.ChatMessage,u,c)},this.handleMetrics=(c,l)=>{this.emit(RoomEvent.MetricsReceived,c,l)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(RoomEvent.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=c=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:c})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(RoomEvent.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(RoomEvent.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(RoomEvent.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>__awaiter$1(this,void 0,void 0,function*(){var c,l;const u=DeviceManager.getInstance().previousDevices,p=yield DeviceManager.getInstance().getDevices(void 0,!1),f=getBrowser();if((f==null?void 0:f.name)==="Chrome"&&f.os!=="iOS")for(let g of p){const v=u.find(y=>y.deviceId===g.deviceId);v&&v.label!==""&&v.kind===g.kind&&v.label!==g.label&&this.getActiveDevice(g.kind)==="default"&&this.emit(RoomEvent.ActiveDeviceChanged,g.kind,g.deviceId)}const m=["audiooutput","audioinput","videoinput"];for(let g of m){const v=p.filter(k=>k.kind===g),y=this.getActiveDevice(g);if(y===((c=u.filter(k=>k.kind===g)[0])===null||c===void 0?void 0:c.deviceId)&&v.length>0&&((l=v[0])===null||l===void 0?void 0:l.deviceId)!==y){yield this.switchActiveDevice(g,v[0].deviceId);continue}g==="audioinput"&&!isSafari()||g==="videoinput"||v.length>0&&!v.find(k=>k.deviceId===this.getActiveDevice(g))&&(yield this.switchActiveDevice(g,v[0].deviceId))}this.emit(RoomEvent.MediaDevicesChanged)}),this.handleRoomUpdate=c=>{const l=this.roomInfo;this.roomInfo=c,l&&l.metadata!==c.metadata&&this.emitWhenConnected(RoomEvent.RoomMetadataChanged,c.metadata),(l==null?void 0:l.activeRecording)!==c.activeRecording&&this.emitWhenConnected(RoomEvent.RecordingStatusChanged,c.activeRecording)},this.handleConnectionQualityUpdate=c=>{c.updates.forEach(l=>{if(l.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(l.quality);return}const u=this.getRemoteParticipantBySid(l.participantSid);u&&u.setConnectionQuality(l.quality)})},this.onLocalParticipantMetadataChanged=c=>{this.emit(RoomEvent.ParticipantMetadataChanged,c,this.localParticipant)},this.onLocalParticipantNameChanged=c=>{this.emit(RoomEvent.ParticipantNameChanged,c,this.localParticipant)},this.onLocalAttributesChanged=c=>{this.emit(RoomEvent.ParticipantAttributesChanged,c,this.localParticipant)},this.onLocalTrackMuted=c=>{this.emit(RoomEvent.TrackMuted,c,this.localParticipant)},this.onLocalTrackUnmuted=c=>{this.emit(RoomEvent.TrackUnmuted,c,this.localParticipant)},this.onTrackProcessorUpdate=c=>{var l;(l=c==null?void 0:c.onPublish)===null||l===void 0||l.call(c,this)},this.onLocalTrackPublished=c=>__awaiter$1(this,void 0,void 0,function*(){var l,u,p,f,m,g;(l=c.track)===null||l===void 0||l.on(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(u=c.track)===null||u===void 0||u.on(TrackEvent.Restarted,this.onLocalTrackRestarted),(m=(f=(p=c.track)===null||p===void 0?void 0:p.getProcessor())===null||f===void 0?void 0:f.onPublish)===null||m===void 0||m.call(f,this),this.emit(RoomEvent.LocalTrackPublished,c,this.localParticipant),isLocalAudioTrack(c.track)&&(yield c.track.checkForSilence())&&this.emit(RoomEvent.LocalAudioSilenceDetected,c);const v=yield(g=c.track)===null||g===void 0?void 0:g.getDeviceId(!1),y=sourceToKind(c.source);y&&v&&v!==this.localParticipant.activeDeviceMap.get(y)&&(this.localParticipant.activeDeviceMap.set(y,v),this.emit(RoomEvent.ActiveDeviceChanged,y,v))}),this.onLocalTrackUnpublished=c=>{var l,u;(l=c.track)===null||l===void 0||l.off(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(u=c.track)===null||u===void 0||u.off(TrackEvent.Restarted,this.onLocalTrackRestarted),this.emit(RoomEvent.LocalTrackUnpublished,c,this.localParticipant)},this.onLocalTrackRestarted=c=>__awaiter$1(this,void 0,void 0,function*(){const l=yield c.getDeviceId(!1),u=sourceToKind(c.source);u&&l&&l!==this.localParticipant.activeDeviceMap.get(u)&&(this.log.debug("local track restarted, setting ".concat(u," ").concat(l," active"),this.logContext),this.localParticipant.activeDeviceMap.set(u,l),this.emit(RoomEvent.ActiveDeviceChanged,u,l))}),this.onLocalConnectionQualityChanged=c=>{this.emit(RoomEvent.ConnectionQualityChanged,c,this.localParticipant)},this.onMediaDevicesError=c=>{this.emit(RoomEvent.MediaDevicesError,c)},this.onLocalParticipantPermissionsChanged=c=>{this.emit(RoomEvent.ParticipantPermissionsChanged,c,this.localParticipant)},this.onLocalChatMessageSent=c=>{this.emit(RoomEvent.ChatMessage,c,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},roomOptionDefaults),t),this.log=getLogger((s=this.options.loggerName)!==null&&s!==void 0?s:LoggerNames.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},audioDefaults),t==null?void 0:t.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},videoDefaults),t==null?void 0:t.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},publishDefaults),t==null?void 0:t.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new _,this.localParticipant=new LocalParticipant("","",this.engine,this.options,this.rpcHandlers),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",unwrapConstraint(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",unwrapConstraint(this.options.audioCaptureDefaults.deviceId)),!((a=this.options.audioOutput)===null||a===void 0)&&a.deviceId&&this.switchActiveDevice("audiooutput",unwrapConstraint(this.options.audioOutput.deviceId)).catch(c=>this.log.warn("Could not set audio output: ".concat(c.message),this.logContext)),this.options.e2ee&&this.setupE2EE(),isWeb()){const c=new AbortController;(d=navigator.mediaDevices)===null||d===void 0||d.addEventListener("devicechange",this.handleDeviceChange,{signal:c.signal}),Room.cleanupRegistry&&Room.cleanupRegistry.register(this,()=>{c.abort()})}}registerTextStreamHandler(t,i){if(this.textStreamHandlers.has(t))throw new TypeError('A text stream handler for topic "'.concat(t,'" has already been set.'));this.textStreamHandlers.set(t,i)}unregisterTextStreamHandler(t){this.textStreamHandlers.delete(t)}registerByteStreamHandler(t,i){if(this.byteStreamHandlers.has(t))throw new TypeError('A byte stream handler for topic "'.concat(t,'" has already been set.'));this.byteStreamHandlers.set(t,i)}unregisterByteStreamHandler(t){this.byteStreamHandlers.delete(t)}registerRpcMethod(t,i){if(this.rpcHandlers.has(t))throw Error("RPC handler already registered for method ".concat(t,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(t,i)}unregisterRpcMethod(t){this.rpcHandlers.delete(t)}handleIncomingRpcRequest(t,i,s,a,d,c){return __awaiter$1(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(t,i),c!==1){yield this.engine.publishRpcResponse(t,i,null,RpcError.builtIn("UNSUPPORTED_VERSION"));return}const l=this.rpcHandlers.get(s);if(!l){yield this.engine.publishRpcResponse(t,i,null,RpcError.builtIn("UNSUPPORTED_METHOD"));return}let u=null,p=null;try{const f=yield l({requestId:i,callerIdentity:t,payload:a,responseTimeout:d});byteLength(f)>MAX_PAYLOAD_BYTES?(u=RpcError.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(s))):p=f}catch(f){f instanceof RpcError?u=f:(console.warn("Uncaught error returned by RPC handler for ".concat(s,". Returning APPLICATION_ERROR instead."),f),u=RpcError.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse(t,i,p,u)})}setE2EEEnabled(t){return __awaiter$1(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(t)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(t,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var t;this.options.e2ee&&("e2eeManager"in this.options.e2ee?this.e2eeManager=this.options.e2ee.e2eeManager:this.e2eeManager=new E2EEManager(this.options.e2ee),this.e2eeManager.on(EncryptionEvent.ParticipantEncryptionStatusChanged,(i,s)=>{isLocalParticipant(s)&&(this.isE2EEEnabled=i),this.emit(RoomEvent.ParticipantEncryptionStatusChanged,i,s)}),this.e2eeManager.on(EncryptionEvent.EncryptionError,i=>this.emit(RoomEvent.EncryptionError,i)),(t=this.e2eeManager)===null||t===void 0||t.setup(this))}get logContext(){var t;return{room:this.name,roomID:(t=this.roomInfo)===null||t===void 0?void 0:t.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var t,i;return(i=(t=this.roomInfo)===null||t===void 0?void 0:t.activeRecording)!==null&&i!==void 0?i:!1}getSid(){return __awaiter$1(this,void 0,void 0,function*(){return this.state===ConnectionState.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((t,i)=>{const s=a=>{a.sid!==""&&(this.engine.off(EngineEvent.RoomUpdate,s),t(a.sid))};this.engine.on(EngineEvent.RoomUpdate,s),this.once(RoomEvent.Disconnected,()=>{this.engine.off(EngineEvent.RoomUpdate,s),i("Room disconnected before room server id was available")})})})}get name(){var t,i;return(i=(t=this.roomInfo)===null||t===void 0?void 0:t.name)!==null&&i!==void 0?i:""}get metadata(){var t;return(t=this.roomInfo)===null||t===void 0?void 0:t.metadata}get numParticipants(){var t,i;return(i=(t=this.roomInfo)===null||t===void 0?void 0:t.numParticipants)!==null&&i!==void 0?i:0}get numPublishers(){var t,i;return(i=(t=this.roomInfo)===null||t===void 0?void 0:t.numPublishers)!==null&&i!==void 0?i:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new RTCEngine(this.options),this.engine.on(EngineEvent.ParticipantUpdate,this.handleParticipantUpdates).on(EngineEvent.RoomUpdate,this.handleRoomUpdate).on(EngineEvent.SpeakersChanged,this.handleSpeakersChanged).on(EngineEvent.StreamStateChanged,this.handleStreamStateUpdate).on(EngineEvent.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(EngineEvent.SubscriptionError,this.handleSubscriptionError).on(EngineEvent.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(EngineEvent.MediaTrackAdded,(t,i,s)=>{this.onTrackAdded(t,i,s)}).on(EngineEvent.Disconnected,t=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t)}).on(EngineEvent.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(EngineEvent.DataPacketReceived,this.handleDataPacket).on(EngineEvent.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(ConnectionState.SignalReconnecting)&&this.emit(RoomEvent.SignalReconnecting)}).on(EngineEvent.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(ConnectionState.Connected)&&this.emit(RoomEvent.Reconnected)}).on(EngineEvent.SignalResumed,()=>{this.bufferedEvents=[],(this.state===ConnectionState.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(EngineEvent.Restarting,this.handleRestarting).on(EngineEvent.SignalRestarted,this.handleSignalRestarted).on(EngineEvent.Offline,()=>{this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)}).on(EngineEvent.DCBufferStatusChanged,(t,i)=>{this.emit(RoomEvent.DCBufferStatusChanged,t,i)}).on(EngineEvent.LocalTrackSubscribed,t=>{const i=this.localParticipant.getTrackPublications().find(s=>{let{trackSid:a}=s;return a===t});if(!i){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(ParticipantEvent.LocalTrackSubscribed,i),this.emitWhenConnected(RoomEvent.LocalTrackSubscribed,i,this.localParticipant)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return DeviceManager.getInstance().getDevices(t,i)}prepareConnection(t,i){return __awaiter$1(this,void 0,void 0,function*(){if(this.state===ConnectionState.Disconnected){this.log.debug("prepareConnection to ".concat(t),this.logContext);try{if(isCloud(new URL(t))&&i){this.regionUrlProvider=new RegionUrlProvider(t,i);const s=yield this.regionUrlProvider.getNextBestRegionUrl();s&&this.state===ConnectionState.Disconnected&&(this.regionUrl=s,yield fetch(toHttpUrl(s),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(s),this.logContext))}else yield fetch(toHttpUrl(t),{method:"HEAD"})}catch(s){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:s}))}}})}getParticipantByIdentity(t){return this.localParticipant.identity===t?this.localParticipant:this.remoteParticipants.get(t)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(t,i){return __awaiter$1(this,void 0,void 0,function*(){let s=()=>{},a;switch(t){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":a=new SimulateScenario({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":a=new SimulateScenario({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":a=new SimulateScenario({scenario:{case:"serverLeave",value:!0}});break;case"migration":a=new SimulateScenario({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":s=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),a=new SimulateScenario({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":s=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),a=new SimulateScenario({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":a=new SimulateScenario({scenario:{case:"switchCandidateProtocol",value:t==="force-tls"?2:1}}),s=()=>__awaiter$1(this,void 0,void 0,function*(){const d=this.engine.client.onLeave;d&&d(new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.RECONNECT}))});break;case"subscriber-bandwidth":if(i===void 0||typeof i!="number")throw new Error("subscriber-bandwidth requires a number as argument");a=new SimulateScenario({scenario:{case:"subscriberBandwidth",value:numberToBigInt(i)}});break;case"leave-full-reconnect":a=new SimulateScenario({scenario:{case:"leaveRequestFullReconnect",value:!0}})}a&&(yield this.engine.client.sendSimulateScenario(a),yield s())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(t){return this.localParticipant.activeDeviceMap.get(t)}switchActiveDevice(t,i){return __awaiter$1(this,arguments,void 0,function(s,a){var d=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var l,u,p,f,m,g,v,y;let k=!0,E=!1;const C=c?{exact:a}:a;if(s==="audioinput"){E=d.localParticipant.audioTrackPublications.size===0;const T=(l=d.getActiveDevice(s))!==null&&l!==void 0?l:d.options.audioCaptureDefaults.deviceId;d.options.audioCaptureDefaults.deviceId=C;const w=Array.from(d.localParticipant.audioTrackPublications.values()).filter(b=>b.source===Track.Source.Microphone);try{k=(yield Promise.all(w.map(b=>{var S;return(S=b.audioTrack)===null||S===void 0?void 0:S.setDeviceId(C)}))).every(b=>b===!0)}catch(b){throw d.options.audioCaptureDefaults.deviceId=T,b}}else if(s==="videoinput"){E=d.localParticipant.videoTrackPublications.size===0;const T=(u=d.getActiveDevice(s))!==null&&u!==void 0?u:d.options.videoCaptureDefaults.deviceId;d.options.videoCaptureDefaults.deviceId=C;const w=Array.from(d.localParticipant.videoTrackPublications.values()).filter(b=>b.source===Track.Source.Camera);try{k=(yield Promise.all(w.map(b=>{var S;return(S=b.videoTrack)===null||S===void 0?void 0:S.setDeviceId(C)}))).every(b=>b===!0)}catch(b){throw d.options.videoCaptureDefaults.deviceId=T,b}}else if(s==="audiooutput"){if(!supportsSetSinkId()&&!d.options.webAudioMix||d.options.webAudioMix&&d.audioContext&&!("setSinkId"in d.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");d.options.webAudioMix&&(a=(p=yield DeviceManager.getInstance().normalizeDeviceId("audiooutput",a))!==null&&p!==void 0?p:""),(f=(y=d.options).audioOutput)!==null&&f!==void 0||(y.audioOutput={});const T=(m=d.getActiveDevice(s))!==null&&m!==void 0?m:d.options.audioOutput.deviceId;d.options.audioOutput.deviceId=a;try{d.options.webAudioMix&&((g=d.audioContext)===null||g===void 0||g.setSinkId(a)),yield Promise.all(Array.from(d.remoteParticipants.values()).map(w=>w.setAudioOutput({deviceId:a})))}catch(w){throw d.options.audioOutput.deviceId=T,w}}return(E||s==="audiooutput")&&(d.localParticipant.activeDeviceMap.set(s,s==="audiooutput"&&((v=d.options.audioOutput)===null||v===void 0?void 0:v.deviceId)||a),d.emit(RoomEvent.ActiveDeviceChanged,s,a)),k}()})}setupLocalParticipantEvents(){this.localParticipant.on(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).on(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).on(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).on(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).on(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).on(ParticipantEvent.AudioStreamAcquired,this.startAudio).on(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).on(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var t;(t=this.engine)===null||t===void 0||t.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(t,i,s){if(this.state===ConnectionState.Connecting||this.state===ConnectionState.Reconnecting){const f=()=>{this.onTrackAdded(t,i,s),m()},m=()=>{this.off(RoomEvent.Reconnected,f),this.off(RoomEvent.Connected,f),this.off(RoomEvent.Disconnected,m)};this.once(RoomEvent.Reconnected,f),this.once(RoomEvent.Connected,f),this.once(RoomEvent.Disconnected,m);return}if(this.state===ConnectionState.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}const a=unpackStreamId(i.id),d=a[0];let c=a[1],l=t.id;if(c&&c.startsWith("TR")&&(l=c),d===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const u=Array.from(this.remoteParticipants.values()).find(f=>f.sid===d);if(!u){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(d),this.logContext);return}let p;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?p=this.options.adaptiveStream:p={}),u.addSubscribedMediaTrack(t,l,i,s,p)}handleDisconnect(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,i=arguments.length>1?arguments[1]:void 0;var s;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.state!==ConnectionState.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(a=>{a.trackPublications.forEach(d=>{a.unpublishTrack(d.trackSid)})}),this.localParticipant.trackPublications.forEach(a=>{var d,c,l;a.track&&this.localParticipant.unpublishTrack(a.track,t),t?((d=a.track)===null||d===void 0||d.detach(),(c=a.track)===null||c===void 0||c.stop()):(l=a.track)===null||l===void 0||l.stopMonitor()}),this.localParticipant.off(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).off(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).off(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).off(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).off(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).off(ParticipantEvent.AudioStreamAcquired,this.startAudio).off(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).off(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),isWeb()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(s=navigator.mediaDevices)===null||s===void 0||s.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(ConnectionState.Disconnected),this.emit(RoomEvent.Disconnected,i)}}}handleParticipantDisconnected(t,i){var s;this.remoteParticipants.delete(t),i&&(i.trackPublications.forEach(a=>{i.unpublishTrack(a.trackSid,!0)}),this.emit(RoomEvent.ParticipantDisconnected,i),(s=this.localParticipant)===null||s===void 0||s.handleParticipantDisconnected(i.identity))}handleStreamHeader(t,i){return __awaiter$1(this,void 0,void 0,function*(){var s;if(t.contentHeader.case==="byteHeader"){const a=this.byteStreamHandlers.get(t.topic);if(!a){this.log.debug("ignoring incoming byte stream due to no handler for topic",t.topic);return}let d;const c={id:t.streamId,name:(s=t.contentHeader.value.name)!==null&&s!==void 0?s:"unknown",mimeType:t.mimeType,size:t.totalLength?Number(t.totalLength):void 0,topic:t.topic,timestamp:bigIntToNumber(t.timestamp),attributes:t.attributes},l=new ReadableStream({start:u=>{d=u,this.byteStreamControllers.set(t.streamId,{info:c,controller:d,startTime:Date.now()})}});a(new ByteStreamReader(c,l,bigIntToNumber(t.totalLength)),{identity:i})}else if(t.contentHeader.case==="textHeader"){const a=this.textStreamHandlers.get(t.topic);if(!a){this.log.debug("ignoring incoming text stream due to no handler for topic",t.topic);return}let d;const c={id:t.streamId,mimeType:t.mimeType,size:t.totalLength?Number(t.totalLength):void 0,topic:t.topic,timestamp:Number(t.timestamp),attributes:t.attributes},l=new ReadableStream({start:u=>{d=u,this.textStreamControllers.set(t.streamId,{info:c,controller:d,startTime:Date.now()})}});a(new TextStreamReader(c,l,bigIntToNumber(t.totalLength)),{identity:i})}})}handleStreamChunk(t){const i=this.byteStreamControllers.get(t.streamId);i&&t.content.length>0&&i.controller.enqueue(t);const s=this.textStreamControllers.get(t.streamId);s&&t.content.length>0&&s.controller.enqueue(t)}handleStreamTrailer(t){const i=this.textStreamControllers.get(t.streamId);i&&(i.info.attributes=Object.assign(Object.assign({},i.info.attributes),t.attributes),i.controller.close(),this.byteStreamControllers.delete(t.streamId));const s=this.byteStreamControllers.get(t.streamId);s&&(s.info.attributes=Object.assign(Object.assign({},s.info.attributes),t.attributes),s.controller.close(),this.byteStreamControllers.delete(t.streamId))}acquireAudioContext(){return __awaiter$1(this,void 0,void 0,function*(){var t,i;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(t=getNewAudioContext())!==null&&t!==void 0?t:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(a=>a.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),sleep$1(200)])}catch(a){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:a}))}const s=((i=this.audioContext)===null||i===void 0?void 0:i.state)==="running";s!==this.canPlaybackAudio&&(this.audioEnabled=s,this.emit(RoomEvent.AudioPlaybackStatusChanged,s))})}createParticipant(t,i){var s;let a;return i?a=RemoteParticipant.fromParticipantInfo(this.engine.client,i,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):a=new RemoteParticipant(this.engine.client,"",t,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&a.setAudioContext(this.audioContext),!((s=this.options.audioOutput)===null||s===void 0)&&s.deviceId&&a.setAudioOutput(this.options.audioOutput).catch(d=>this.log.warn("Could not set audio output: ".concat(d.message),this.logContext)),a}getOrCreateParticipant(t,i){if(this.remoteParticipants.has(t)){const a=this.remoteParticipants.get(t);return i&&a.updateInfo(i)&&this.sidToIdentity.set(i.sid,i.identity),a}const s=this.createParticipant(t,i);return this.remoteParticipants.set(t,s),this.sidToIdentity.set(i.sid,i.identity),this.emitWhenConnected(RoomEvent.ParticipantConnected,s),s.on(ParticipantEvent.TrackPublished,a=>{this.emitWhenConnected(RoomEvent.TrackPublished,a,s)}).on(ParticipantEvent.TrackSubscribed,(a,d)=>{a.kind===Track.Kind.Audio?(a.on(TrackEvent.AudioPlaybackStarted,this.handleAudioPlaybackStarted),a.on(TrackEvent.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):a.kind===Track.Kind.Video&&(a.on(TrackEvent.VideoPlaybackFailed,this.handleVideoPlaybackFailed),a.on(TrackEvent.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(RoomEvent.TrackSubscribed,a,d,s)}).on(ParticipantEvent.TrackUnpublished,a=>{this.emit(RoomEvent.TrackUnpublished,a,s)}).on(ParticipantEvent.TrackUnsubscribed,(a,d)=>{this.emit(RoomEvent.TrackUnsubscribed,a,d,s)}).on(ParticipantEvent.TrackMuted,a=>{this.emitWhenConnected(RoomEvent.TrackMuted,a,s)}).on(ParticipantEvent.TrackUnmuted,a=>{this.emitWhenConnected(RoomEvent.TrackUnmuted,a,s)}).on(ParticipantEvent.ParticipantMetadataChanged,a=>{this.emitWhenConnected(RoomEvent.ParticipantMetadataChanged,a,s)}).on(ParticipantEvent.ParticipantNameChanged,a=>{this.emitWhenConnected(RoomEvent.ParticipantNameChanged,a,s)}).on(ParticipantEvent.AttributesChanged,a=>{this.emitWhenConnected(RoomEvent.ParticipantAttributesChanged,a,s)}).on(ParticipantEvent.ConnectionQualityChanged,a=>{this.emitWhenConnected(RoomEvent.ConnectionQualityChanged,a,s)}).on(ParticipantEvent.ParticipantPermissionsChanged,a=>{this.emitWhenConnected(RoomEvent.ParticipantPermissionsChanged,a,s)}).on(ParticipantEvent.TrackSubscriptionStatusChanged,(a,d)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionStatusChanged,a,d,s)}).on(ParticipantEvent.TrackSubscriptionFailed,(a,d)=>{this.emit(RoomEvent.TrackSubscriptionFailed,a,s,d)}).on(ParticipantEvent.TrackSubscriptionPermissionChanged,(a,d)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionPermissionChanged,a,d,s)}),i&&s.updateInfo(i),s}sendSyncState(){const t=Array.from(this.remoteParticipants.values()).reduce((s,a)=>(s.push(...a.getTrackPublications()),s),[]),i=this.localParticipant.getTrackPublications();this.engine.sendSyncState(t,i)}updateSubscriptions(){for(const t of this.remoteParticipants.values())for(const i of t.videoTrackPublications.values())i.isSubscribed&&isRemotePub(i)&&i.emitTrackUpdate()}getRemoteParticipantBySid(t){const i=this.sidToIdentity.get(t);if(i)return this.remoteParticipants.get(i)}registerConnectionReconcile(){this.clearConnectionReconcile();let t=0;this.connectionReconcileInterval=CriticalTimers.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(t++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:t,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),t>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,DisconnectReason.STATE_MISMATCH))):t=0},connectionReconcileFrequency)}clearConnectionReconcile(){this.connectionReconcileInterval&&CriticalTimers.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(t){return t===this.state?!1:(this.state=t,this.emit(RoomEvent.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(t=>{let[i,s]=t;this.emit(i,...s)}),this.bufferedEvents=[]}emitWhenConnected(t){for(var i=arguments.length,s=new Array(i>1?i-1:0),a=1;a<i;a++)s[a-1]=arguments[a];if(this.state===ConnectionState.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([t,s]);else if(this.state===ConnectionState.Connected)return this.emit(t,...s);return!1}simulateParticipants(t){return __awaiter$1(this,void 0,void 0,function*(){var i,s;const a=Object.assign({audio:!0,video:!0,useRealTracks:!1},t.publish),d=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},t.participants);if(this.handleDisconnect(),this.roomInfo=new Room$1({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:protoInt64.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ParticipantInfo({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected),this.emit(RoomEvent.Connected),this.setAndEmitConnectionState(ConnectionState.Connected),a.video){const c=new LocalTrackPublication(Track.Kind.Video,new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO,name:"video-dummy"}),new LocalVideoTrack(a.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:createDummyVideoStreamTrack(160*((i=d.aspectRatios[0])!==null&&i!==void 0?i:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,c)}if(a.audio){const c=new LocalTrackPublication(Track.Kind.Audio,new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO}),new LocalAudioTrack(a.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:getEmptyAudioStreamTrack(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,c)}for(let c=0;c<d.count-1;c+=1){let l=new ParticipantInfo({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(c),state:ParticipantInfo_State.ACTIVE,tracks:[],joinedAt:protoInt64.parse(Date.now())});const u=this.getOrCreateParticipant(l.identity,l);if(d.video){const p=createDummyVideoStreamTrack(160*((s=d.aspectRatios[c%d.aspectRatios.length])!==null&&s!==void 0?s:1),160,!1,!0),f=new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});u.addSubscribedMediaTrack(p,f.sid,new MediaStream([p]),new RTCRtpReceiver),l.tracks=[...l.tracks,f]}if(d.audio){const p=getEmptyAudioStreamTrack(),f=new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});u.addSubscribedMediaTrack(p,f.sid,new MediaStream([p]),new RTCRtpReceiver),l.tracks=[...l.tracks,f]}u.updateInfo(l)}})}emit(t){for(var i=arguments.length,s=new Array(i>1?i-1:0),a=1;a<i;a++)s[a-1]=arguments[a];if(t!==RoomEvent.ActiveSpeakersChanged){const d=mapArgs(s).filter(c=>c!==void 0);this.log.debug("room event ".concat(t),Object.assign(Object.assign({},this.logContext),{event:t,args:d}))}return super.emit(t,...s)}}Room.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(n=>{n()});function mapArgs(n){return n.map(t=>{if(t)return Array.isArray(t)?mapArgs(t):typeof t=="object"?"logContext"in t?t.logContext:void 0:t})}var CheckStatus;(function(n){n[n.IDLE=0]="IDLE",n[n.RUNNING=1]="RUNNING",n[n.SKIPPED=2]="SKIPPED",n[n.SUCCESS=3]="SUCCESS",n[n.FAILED=4]="FAILED"})(CheckStatus||(CheckStatus={}));class Checker extends eventsExports.EventEmitter{constructor(t,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=CheckStatus.IDLE,this.logs=[],this.errorsAsWarnings=!1,this.url=t,this.token=i,this.name=this.constructor.name,this.room=new Room(s.roomOptions),this.connectOptions=s.connectOptions,s.errorsAsWarnings&&(this.errorsAsWarnings=s.errorsAsWarnings)}run(t){return __awaiter$1(this,void 0,void 0,function*(){if(this.status!==CheckStatus.IDLE)throw Error("check is running already");this.setStatus(CheckStatus.RUNNING);try{yield this.perform()}catch(i){i instanceof Error&&(this.errorsAsWarnings?this.appendWarning(i.message):this.appendError(i.message))}return yield this.disconnect(),yield new Promise(i=>setTimeout(i,500)),this.status!==CheckStatus.SKIPPED&&this.setStatus(this.isSuccess()?CheckStatus.SUCCESS:CheckStatus.FAILED),t&&t(),this.getInfo()})}isSuccess(){return!this.logs.some(t=>t.level==="error")}connect(){return __awaiter$1(this,void 0,void 0,function*(){return this.room.state===ConnectionState.Connected?this.room:(yield this.room.connect(this.url,this.token,this.connectOptions),this.room)})}disconnect(){return __awaiter$1(this,void 0,void 0,function*(){this.room&&this.room.state!==ConnectionState.Disconnected&&(yield this.room.disconnect(),yield new Promise(t=>setTimeout(t,500)))})}skip(){this.setStatus(CheckStatus.SKIPPED)}appendMessage(t){this.logs.push({level:"info",message:t}),this.emit("update",this.getInfo())}appendWarning(t){this.logs.push({level:"warning",message:t}),this.emit("update",this.getInfo())}appendError(t){this.logs.push({level:"error",message:t}),this.emit("update",this.getInfo())}setStatus(t){this.status=t,this.emit("update",this.getInfo())}get engine(){var t;return(t=this.room)===null||t===void 0?void 0:t.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}function createLocalTracks(n){return __awaiter$1(this,void 0,void 0,function*(){var t,i;n??(n={}),(t=n.audio)!==null&&t!==void 0||(n.audio={deviceId:"default"}),(i=n.video)!==null&&i!==void 0||(n.video={deviceId:"default"});const{audioProcessor:s,videoProcessor:a}=extractProcessorsFromOptions(n),d=mergeDefaultOptions(n,audioDefaults,videoDefaults),c=constraintsForOptions(d),l=navigator.mediaDevices.getUserMedia(c);n.audio&&(DeviceManager.userMediaPromiseMap.set("audioinput",l),l.catch(()=>DeviceManager.userMediaPromiseMap.delete("audioinput"))),n.video&&(DeviceManager.userMediaPromiseMap.set("videoinput",l),l.catch(()=>DeviceManager.userMediaPromiseMap.delete("videoinput")));const u=yield l;return Promise.all(u.getTracks().map(p=>__awaiter$1(this,void 0,void 0,function*(){const f=p.kind==="audio";f?d.audio:d.video;let m;const g=f?c.audio:c.video;typeof g!="boolean"&&(m=g),m?m.deviceId=p.getSettings().deviceId:m={deviceId:p.getSettings().deviceId};const v=mediaTrackToLocalTrack(p,m);return v.kind===Track.Kind.Video?v.source=Track.Source.Camera:v.kind===Track.Kind.Audio&&(v.source=Track.Source.Microphone),v.mediaStream=u,isAudioTrack(v)&&s?yield v.setProcessor(s):isVideoTrack(v)&&a&&(yield v.setProcessor(a)),v})))})}function createLocalVideoTrack(n){return __awaiter$1(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:!1,video:n}))[0]})}function createLocalAudioTrack(n){return __awaiter$1(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:n,video:!1}))[0]})}class PublishAudioCheck extends Checker{get description(){return"Can publish audio"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var t;const i=yield this.connect(),s=yield createLocalAudioTrack();i.localParticipant.publishTrack(s),yield new Promise(c=>setTimeout(c,3e3));const a=yield(t=s.sender)===null||t===void 0?void 0:t.getStats();if(!a)throw new Error("Could not get RTCStats");let d=0;if(a.forEach(c=>{c.type==="outbound-rtp"&&(c.kind==="audio"||!c.kind&&c.mediaType==="audio")&&(d=c.packetsSent)}),d===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(d," audio packets"))})}}class PublishVideoCheck extends Checker{get description(){return"Can publish video"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var t;const i=yield this.connect(),s=yield createLocalVideoTrack();i.localParticipant.publishTrack(s),yield new Promise(c=>setTimeout(c,5e3));const a=yield(t=s.sender)===null||t===void 0?void 0:t.getStats();if(!a)throw new Error("Could not get RTCStats");let d=0;if(a.forEach(c=>{c.type==="outbound-rtp"&&(c.kind==="video"||!c.kind&&c.mediaType==="video")&&(d+=c.packetsSent)}),d===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(d," video packets"))})}}class ReconnectCheck extends Checker{get description(){return"Resuming connection after interruption"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var t;const i=yield this.connect();let s=!1,a=!1,d;const c=new Promise(p=>{setTimeout(p,5e3),d=p}),l=()=>{s=!0};i.on(RoomEvent.SignalReconnecting,l).on(RoomEvent.Reconnecting,l).on(RoomEvent.Reconnected,()=>{a=!0,d(!0)}),(t=i.engine.client.ws)===null||t===void 0||t.close();const u=i.engine.client.onClose;if(u&&u(""),yield c,s){if(!a||i.state!==ConnectionState.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class TURNCheck extends Checker{get description(){return"Can connect via TURN"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var t,i;const s=new SignalClient,a=yield s.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let d=!1,c=!1,l=!1;for(let u of a.iceServers)for(let p of u.urls)p.startsWith("turn:")?(c=!0,l=!0):p.startsWith("turns:")&&(c=!0,l=!0,d=!0),p.startsWith("stun:")&&(l=!0);l?c&&!d&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield s.close(),!((i=(t=this.connectOptions)===null||t===void 0?void 0:t.rtcConfig)===null||i===void 0)&&i.iceServers||c?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(u=>setTimeout(u,0)))})}}class WebRTCCheck extends Checker{get description(){return"Establishing WebRTC connection"}perform(){return __awaiter$1(this,void 0,void 0,function*(){let t=!1,i=!1;this.room.on(RoomEvent.SignalConnected,()=>{const s=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(a,d)=>{if(a.candidate){const c=new RTCIceCandidate(a);let l="".concat(c.protocol," ").concat(c.address,":").concat(c.port," ").concat(c.type);c.address&&(isIPPrivate(c.address)?l+=" (private)":c.protocol==="tcp"&&c.tcpType==="passive"?(t=!0,l+=" (passive)"):c.protocol==="udp"&&(i=!0)),this.appendMessage(l)}s&&s(a,d)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=a=>{a instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(a.errorCode," ").concat(a.errorText," ").concat(a.url))})});try{yield this.connect(),livekitLogger.info("now the room is connected")}catch(s){throw this.appendWarning("ports need to be open on firewall in order to connect."),s}t||this.appendWarning("Server is not configured for ICE/TCP"),i||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function isIPPrivate(n){const t=n.split(".");if(t.length===4){if(t[0]==="10")return!0;if(t[0]==="192"&&t[1]==="168")return!0;if(t[0]==="172"){const i=parseInt(t[1],10);if(i>=16&&i<=31)return!0}}return!1}class WebSocketCheck extends Checker{get description(){return"Connecting to signal connection via WebSocket"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var t,i,s;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let a=new SignalClient;const d=yield a.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(d.serverVersion,".")),((t=d.serverInfo)===null||t===void 0?void 0:t.edition)===ServerInfo_Edition.Cloud&&(!((i=d.serverInfo)===null||i===void 0)&&i.region)&&this.appendMessage("LiveKit Cloud: ".concat((s=d.serverInfo)===null||s===void 0?void 0:s.region)),yield a.close()})}}class ConnectionCheck extends eventsExports.EventEmitter{constructor(t,i){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=t,this.token=i,this.options=s}getNextCheckId(){const t=this.checkResults.size;return this.checkResults.set(t,{logs:[],status:CheckStatus.IDLE,name:"",description:""}),t}updateCheck(t,i){this.checkResults.set(t,i),this.emit("checkUpdate",t,i)}isSuccess(){return Array.from(this.checkResults.values()).every(t=>t.status!==CheckStatus.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(t){return __awaiter$1(this,void 0,void 0,function*(){const i=this.getNextCheckId(),s=new t(this.url,this.token,this.options),a=c=>{this.updateCheck(i,c)};s.on("update",a);const d=yield s.run();return s.off("update",a),d})}checkWebsocket(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(WebSocketCheck)})}checkWebRTC(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(WebRTCCheck)})}checkTURN(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(TURNCheck)})}checkReconnect(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(ReconnectCheck)})}checkPublishAudio(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishAudioCheck)})}checkPublishVideo(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishVideoCheck)})}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var src={exports:{}},indexLight={exports:{}},indexMinimal={},minimal={},aspromise=asPromise$1;function asPromise$1(n,t){for(var i=new Array(arguments.length-1),s=0,a=2,d=!0;a<arguments.length;)i[s++]=arguments[a++];return new Promise(function(l,u){i[s]=function(f){if(d)if(d=!1,f)u(f);else{for(var m=new Array(arguments.length-1),g=0;g<m.length;)m[g++]=arguments[g];l.apply(null,m)}};try{n.apply(t||null,i)}catch(p){d&&(d=!1,u(p))}})}var base64$1={};(function(n){var t=n;t.length=function(l){var u=l.length;if(!u)return 0;for(var p=0;--u%4>1&&l.charAt(u)==="=";)++p;return Math.ceil(l.length*3)/4-p};for(var i=new Array(64),s=new Array(123),a=0;a<64;)s[i[a]=a<26?a+65:a<52?a+71:a<62?a-4:a-59|43]=a++;t.encode=function(l,u,p){for(var f=null,m=[],g=0,v=0,y;u<p;){var k=l[u++];switch(v){case 0:m[g++]=i[k>>2],y=(k&3)<<4,v=1;break;case 1:m[g++]=i[y|k>>4],y=(k&15)<<2,v=2;break;case 2:m[g++]=i[y|k>>6],m[g++]=i[k&63],v=0;break}g>8191&&((f||(f=[])).push(String.fromCharCode.apply(String,m)),g=0)}return v&&(m[g++]=i[y],m[g++]=61,v===1&&(m[g++]=61)),f?(g&&f.push(String.fromCharCode.apply(String,m.slice(0,g))),f.join("")):String.fromCharCode.apply(String,m.slice(0,g))};var d="invalid encoding";t.decode=function(l,u,p){for(var f=p,m=0,g,v=0;v<l.length;){var y=l.charCodeAt(v++);if(y===61&&m>1)break;if((y=s[y])===void 0)throw Error(d);switch(m){case 0:g=y,m=1;break;case 1:u[p++]=g<<2|(y&48)>>4,g=y,m=2;break;case 2:u[p++]=(g&15)<<4|(y&60)>>2,g=y,m=3;break;case 3:u[p++]=(g&3)<<6|y,m=0;break}}if(m===1)throw Error(d);return p-f},t.test=function(l){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(l)}})(base64$1);var eventemitter=EventEmitter;function EventEmitter(){this._listeners={}}EventEmitter.prototype.on=function(t,i,s){return(this._listeners[t]||(this._listeners[t]=[])).push({fn:i,ctx:s||this}),this},EventEmitter.prototype.off=function(t,i){if(t===void 0)this._listeners={};else if(i===void 0)this._listeners[t]=[];else for(var s=this._listeners[t],a=0;a<s.length;)s[a].fn===i?s.splice(a,1):++a;return this},EventEmitter.prototype.emit=function(t){var i=this._listeners[t];if(i){for(var s=[],a=1;a<arguments.length;)s.push(arguments[a++]);for(a=0;a<i.length;)i[a].fn.apply(i[a++].ctx,s)}return this};var float=factory(factory);function factory(n){return typeof Float32Array<"u"?function(){var t=new Float32Array([-0]),i=new Uint8Array(t.buffer),s=i[3]===128;function a(u,p,f){t[0]=u,p[f]=i[0],p[f+1]=i[1],p[f+2]=i[2],p[f+3]=i[3]}function d(u,p,f){t[0]=u,p[f]=i[3],p[f+1]=i[2],p[f+2]=i[1],p[f+3]=i[0]}n.writeFloatLE=s?a:d,n.writeFloatBE=s?d:a;function c(u,p){return i[0]=u[p],i[1]=u[p+1],i[2]=u[p+2],i[3]=u[p+3],t[0]}function l(u,p){return i[3]=u[p],i[2]=u[p+1],i[1]=u[p+2],i[0]=u[p+3],t[0]}n.readFloatLE=s?c:l,n.readFloatBE=s?l:c}():function(){function t(s,a,d,c){var l=a<0?1:0;if(l&&(a=-a),a===0)s(1/a>0?0:2147483648,d,c);else if(isNaN(a))s(2143289344,d,c);else if(a>34028234663852886e22)s((l<<31|2139095040)>>>0,d,c);else if(a<11754943508222875e-54)s((l<<31|Math.round(a/1401298464324817e-60))>>>0,d,c);else{var u=Math.floor(Math.log(a)/Math.LN2),p=Math.round(a*Math.pow(2,-u)*8388608)&8388607;s((l<<31|u+127<<23|p)>>>0,d,c)}}n.writeFloatLE=t.bind(null,writeUintLE),n.writeFloatBE=t.bind(null,writeUintBE);function i(s,a,d){var c=s(a,d),l=(c>>31)*2+1,u=c>>>23&255,p=c&8388607;return u===255?p?NaN:l*(1/0):u===0?l*1401298464324817e-60*p:l*Math.pow(2,u-150)*(p+8388608)}n.readFloatLE=i.bind(null,readUintLE),n.readFloatBE=i.bind(null,readUintBE)}(),typeof Float64Array<"u"?function(){var t=new Float64Array([-0]),i=new Uint8Array(t.buffer),s=i[7]===128;function a(u,p,f){t[0]=u,p[f]=i[0],p[f+1]=i[1],p[f+2]=i[2],p[f+3]=i[3],p[f+4]=i[4],p[f+5]=i[5],p[f+6]=i[6],p[f+7]=i[7]}function d(u,p,f){t[0]=u,p[f]=i[7],p[f+1]=i[6],p[f+2]=i[5],p[f+3]=i[4],p[f+4]=i[3],p[f+5]=i[2],p[f+6]=i[1],p[f+7]=i[0]}n.writeDoubleLE=s?a:d,n.writeDoubleBE=s?d:a;function c(u,p){return i[0]=u[p],i[1]=u[p+1],i[2]=u[p+2],i[3]=u[p+3],i[4]=u[p+4],i[5]=u[p+5],i[6]=u[p+6],i[7]=u[p+7],t[0]}function l(u,p){return i[7]=u[p],i[6]=u[p+1],i[5]=u[p+2],i[4]=u[p+3],i[3]=u[p+4],i[2]=u[p+5],i[1]=u[p+6],i[0]=u[p+7],t[0]}n.readDoubleLE=s?c:l,n.readDoubleBE=s?l:c}():function(){function t(s,a,d,c,l,u){var p=c<0?1:0;if(p&&(c=-c),c===0)s(0,l,u+a),s(1/c>0?0:2147483648,l,u+d);else if(isNaN(c))s(0,l,u+a),s(2146959360,l,u+d);else if(c>17976931348623157e292)s(0,l,u+a),s((p<<31|2146435072)>>>0,l,u+d);else{var f;if(c<22250738585072014e-324)f=c/5e-324,s(f>>>0,l,u+a),s((p<<31|f/4294967296)>>>0,l,u+d);else{var m=Math.floor(Math.log(c)/Math.LN2);m===1024&&(m=1023),f=c*Math.pow(2,-m),s(f*4503599627370496>>>0,l,u+a),s((p<<31|m+1023<<20|f*1048576&1048575)>>>0,l,u+d)}}}n.writeDoubleLE=t.bind(null,writeUintLE,0,4),n.writeDoubleBE=t.bind(null,writeUintBE,4,0);function i(s,a,d,c,l){var u=s(c,l+a),p=s(c,l+d),f=(p>>31)*2+1,m=p>>>20&2047,g=4294967296*(p&1048575)+u;return m===2047?g?NaN:f*(1/0):m===0?f*5e-324*g:f*Math.pow(2,m-1075)*(g+4503599627370496)}n.readDoubleLE=i.bind(null,readUintLE,0,4),n.readDoubleBE=i.bind(null,readUintBE,4,0)}(),n}function writeUintLE(n,t,i){t[i]=n&255,t[i+1]=n>>>8&255,t[i+2]=n>>>16&255,t[i+3]=n>>>24}function writeUintBE(n,t,i){t[i]=n>>>24,t[i+1]=n>>>16&255,t[i+2]=n>>>8&255,t[i+3]=n&255}function readUintLE(n,t){return(n[t]|n[t+1]<<8|n[t+2]<<16|n[t+3]<<24)>>>0}function readUintBE(n,t){return(n[t]<<24|n[t+1]<<16|n[t+2]<<8|n[t+3])>>>0}var inquire_1=inquire$1;function inquire$1(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(n){}return null}var utf8$2={};(function(n){var t=n;t.length=function(s){for(var a=0,d=0,c=0;c<s.length;++c)d=s.charCodeAt(c),d<128?a+=1:d<2048?a+=2:(d&64512)===55296&&(s.charCodeAt(c+1)&64512)===56320?(++c,a+=4):a+=3;return a},t.read=function(s,a,d){var c=d-a;if(c<1)return"";for(var l=null,u=[],p=0,f;a<d;)f=s[a++],f<128?u[p++]=f:f>191&&f<224?u[p++]=(f&31)<<6|s[a++]&63:f>239&&f<365?(f=((f&7)<<18|(s[a++]&63)<<12|(s[a++]&63)<<6|s[a++]&63)-65536,u[p++]=55296+(f>>10),u[p++]=56320+(f&1023)):u[p++]=(f&15)<<12|(s[a++]&63)<<6|s[a++]&63,p>8191&&((l||(l=[])).push(String.fromCharCode.apply(String,u)),p=0);return l?(p&&l.push(String.fromCharCode.apply(String,u.slice(0,p))),l.join("")):String.fromCharCode.apply(String,u.slice(0,p))},t.write=function(s,a,d){for(var c=d,l,u,p=0;p<s.length;++p)l=s.charCodeAt(p),l<128?a[d++]=l:l<2048?(a[d++]=l>>6|192,a[d++]=l&63|128):(l&64512)===55296&&((u=s.charCodeAt(p+1))&64512)===56320?(l=65536+((l&1023)<<10)+(u&1023),++p,a[d++]=l>>18|240,a[d++]=l>>12&63|128,a[d++]=l>>6&63|128,a[d++]=l&63|128):(a[d++]=l>>12|224,a[d++]=l>>6&63|128,a[d++]=l&63|128);return d-c}})(utf8$2);var pool_1=pool;function pool(n,t,i){var s=i||8192,a=s>>>1,d=null,c=s;return function(u){if(u<1||u>a)return n(u);c+u>s&&(d=n(s),c=0);var p=t.call(d,c,c+=u);return c&7&&(c=(c|7)+1),p}}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=t;var n=requireMinimal();function t(d,c){this.lo=d>>>0,this.hi=c>>>0}var i=t.zero=new t(0,0);i.toNumber=function(){return 0},i.zzEncode=i.zzDecode=function(){return this},i.length=function(){return 1};var s=t.zeroHash="\0\0\0\0\0\0\0\0";t.fromNumber=function(c){if(c===0)return i;var l=c<0;l&&(c=-c);var u=c>>>0,p=(c-u)/4294967296>>>0;return l&&(p=~p>>>0,u=~u>>>0,++u>4294967295&&(u=0,++p>4294967295&&(p=0))),new t(u,p)},t.from=function(c){if(typeof c=="number")return t.fromNumber(c);if(n.isString(c))if(n.Long)c=n.Long.fromString(c);else return t.fromNumber(parseInt(c,10));return c.low||c.high?new t(c.low>>>0,c.high>>>0):i},t.prototype.toNumber=function(c){if(!c&&this.hi>>>31){var l=~this.lo+1>>>0,u=~this.hi>>>0;return l||(u=u+1>>>0),-(l+u*4294967296)}return this.lo+this.hi*4294967296},t.prototype.toLong=function(c){return n.Long?new n.Long(this.lo|0,this.hi|0,!!c):{low:this.lo|0,high:this.hi|0,unsigned:!!c}};var a=String.prototype.charCodeAt;return t.fromHash=function(c){return c===s?i:new t((a.call(c,0)|a.call(c,1)<<8|a.call(c,2)<<16|a.call(c,3)<<24)>>>0,(a.call(c,4)|a.call(c,5)<<8|a.call(c,6)<<16|a.call(c,7)<<24)>>>0)},t.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},t.prototype.zzEncode=function(){var c=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^c)>>>0,this.lo=(this.lo<<1^c)>>>0,this},t.prototype.zzDecode=function(){var c=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^c)>>>0,this.hi=(this.hi>>>1^c)>>>0,this},t.prototype.length=function(){var c=this.lo,l=(this.lo>>>28|this.hi<<4)>>>0,u=this.hi>>>24;return u===0?l===0?c<16384?c<128?1:2:c<2097152?3:4:l<16384?l<128?5:6:l<2097152?7:8:u<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,function(n){var t=n;t.asPromise=aspromise,t.base64=base64$1,t.EventEmitter=eventemitter,t.float=float,t.inquire=inquire_1,t.utf8=utf8$2,t.pool=pool_1,t.LongBits=requireLongbits(),t.isNode=!!(typeof commonjsGlobal<"u"&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),t.global=t.isNode&&commonjsGlobal||typeof window<"u"&&window||typeof self<"u"&&self||commonjsGlobal,t.emptyArray=Object.freeze?Object.freeze([]):[],t.emptyObject=Object.freeze?Object.freeze({}):{},t.isInteger=Number.isInteger||function(d){return typeof d=="number"&&isFinite(d)&&Math.floor(d)===d},t.isString=function(d){return typeof d=="string"||d instanceof String},t.isObject=function(d){return d&&typeof d=="object"},t.isset=t.isSet=function(d,c){var l=d[c];return l!=null&&d.hasOwnProperty(c)?typeof l!="object"||(Array.isArray(l)?l.length:Object.keys(l).length)>0:!1},t.Buffer=function(){try{var a=t.inquire("buffer").Buffer;return a.prototype.utf8Write?a:null}catch{return null}}(),t._Buffer_from=null,t._Buffer_allocUnsafe=null,t.newBuffer=function(d){return typeof d=="number"?t.Buffer?t._Buffer_allocUnsafe(d):new t.Array(d):t.Buffer?t._Buffer_from(d):typeof Uint8Array>"u"?d:new Uint8Array(d)},t.Array=typeof Uint8Array<"u"?Uint8Array:Array,t.Long=t.global.dcodeIO&&t.global.dcodeIO.Long||t.global.Long||t.inquire("long"),t.key2Re=/^true|false|0|1$/,t.key32Re=/^-?(?:0|[1-9][0-9]*)$/,t.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,t.longToHash=function(d){return d?t.LongBits.from(d).toHash():t.LongBits.zeroHash},t.longFromHash=function(d,c){var l=t.LongBits.fromHash(d);return t.Long?t.Long.fromBits(l.lo,l.hi,c):l.toNumber(!!c)};function i(a,d,c){for(var l=Object.keys(d),u=0;u<l.length;++u)(a[l[u]]===void 0||!c)&&(a[l[u]]=d[l[u]]);return a}t.merge=i,t.lcFirst=function(d){return d.charAt(0).toLowerCase()+d.substring(1)};function s(a){function d(c,l){if(!(this instanceof d))return new d(c,l);Object.defineProperty(this,"message",{get:function(){return c}}),Error.captureStackTrace?Error.captureStackTrace(this,d):Object.defineProperty(this,"stack",{value:new Error().stack||""}),l&&i(this,l)}return d.prototype=Object.create(Error.prototype,{constructor:{value:d,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return a},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),d}t.newError=s,t.ProtocolError=s("ProtocolError"),t.oneOfGetter=function(d){for(var c={},l=0;l<d.length;++l)c[d[l]]=1;return function(){for(var u=Object.keys(this),p=u.length-1;p>-1;--p)if(c[u[p]]===1&&this[u[p]]!==void 0&&this[u[p]]!==null)return u[p]}},t.oneOfSetter=function(d){return function(c){for(var l=0;l<d.length;++l)d[l]!==c&&delete this[d[l]]}},t.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},t._configure=function(){var a=t.Buffer;if(!a){t._Buffer_from=t._Buffer_allocUnsafe=null;return}t._Buffer_from=a.from!==Uint8Array.from&&a.from||function(c,l){return new a(c,l)},t._Buffer_allocUnsafe=a.allocUnsafe||function(c){return new a(c)}}}(minimal)),minimal}var writer=Writer$1,util$7=requireMinimal(),BufferWriter$1,LongBits$1=util$7.LongBits,base64=util$7.base64,utf8$1=util$7.utf8;function Op(n,t,i){this.fn=n,this.len=t,this.next=void 0,this.val=i}function noop(){}function State(n){this.head=n.head,this.tail=n.tail,this.len=n.len,this.next=n.states}function Writer$1(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create$1=function n(){return util$7.Buffer?function(){return(Writer$1.create=function(){return new BufferWriter$1})()}:function(){return new Writer$1}};Writer$1.create=create$1(),Writer$1.alloc=function n(t){return new util$7.Array(t)},util$7.Array!==Array&&(Writer$1.alloc=util$7.pool(Writer$1.alloc,util$7.Array.prototype.subarray)),Writer$1.prototype._push=function n(t,i,s){return this.tail=this.tail.next=new Op(t,i,s),this.len+=i,this};function writeByte(n,t,i){t[i]=n&255}function writeVarint32(n,t,i){for(;n>127;)t[i++]=n&127|128,n>>>=7;t[i]=n}function VarintOp(n,t){this.len=n,this.next=void 0,this.val=t}VarintOp.prototype=Object.create(Op.prototype),VarintOp.prototype.fn=writeVarint32,Writer$1.prototype.uint32=function n(t){return this.len+=(this.tail=this.tail.next=new VarintOp((t=t>>>0)<128?1:t<16384?2:t<2097152?3:t<268435456?4:5,t)).len,this},Writer$1.prototype.int32=function n(t){return t<0?this._push(writeVarint64,10,LongBits$1.fromNumber(t)):this.uint32(t)},Writer$1.prototype.sint32=function n(t){return this.uint32((t<<1^t>>31)>>>0)};function writeVarint64(n,t,i){for(;n.hi;)t[i++]=n.lo&127|128,n.lo=(n.lo>>>7|n.hi<<25)>>>0,n.hi>>>=7;for(;n.lo>127;)t[i++]=n.lo&127|128,n.lo=n.lo>>>7;t[i++]=n.lo}Writer$1.prototype.uint64=function n(t){var i=LongBits$1.from(t);return this._push(writeVarint64,i.length(),i)},Writer$1.prototype.int64=Writer$1.prototype.uint64,Writer$1.prototype.sint64=function n(t){var i=LongBits$1.from(t).zzEncode();return this._push(writeVarint64,i.length(),i)},Writer$1.prototype.bool=function n(t){return this._push(writeByte,1,t?1:0)};function writeFixed32(n,t,i){t[i]=n&255,t[i+1]=n>>>8&255,t[i+2]=n>>>16&255,t[i+3]=n>>>24}Writer$1.prototype.fixed32=function n(t){return this._push(writeFixed32,4,t>>>0)},Writer$1.prototype.sfixed32=Writer$1.prototype.fixed32,Writer$1.prototype.fixed64=function n(t){var i=LongBits$1.from(t);return this._push(writeFixed32,4,i.lo)._push(writeFixed32,4,i.hi)},Writer$1.prototype.sfixed64=Writer$1.prototype.fixed64,Writer$1.prototype.float=function n(t){return this._push(util$7.float.writeFloatLE,4,t)},Writer$1.prototype.double=function n(t){return this._push(util$7.float.writeDoubleLE,8,t)};var writeBytes=util$7.Array.prototype.set?function n(t,i,s){i.set(t,s)}:function n(t,i,s){for(var a=0;a<t.length;++a)i[s+a]=t[a]};Writer$1.prototype.bytes=function n(t){var i=t.length>>>0;if(!i)return this._push(writeByte,1,0);if(util$7.isString(t)){var s=Writer$1.alloc(i=base64.length(t));base64.decode(t,s,0),t=s}return this.uint32(i)._push(writeBytes,i,t)},Writer$1.prototype.string=function n(t){var i=utf8$1.length(t);return i?this.uint32(i)._push(utf8$1.write,i,t):this._push(writeByte,1,0)},Writer$1.prototype.fork=function n(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this},Writer$1.prototype.reset=function n(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this},Writer$1.prototype.ldelim=function n(){var t=this.head,i=this.tail,s=this.len;return this.reset().uint32(s),s&&(this.tail.next=t.next,this.tail=i,this.len+=s),this},Writer$1.prototype.finish=function n(){for(var t=this.head.next,i=this.constructor.alloc(this.len),s=0;t;)t.fn(t.val,i,s),s+=t.len,t=t.next;return i},Writer$1._configure=function(n){BufferWriter$1=n,Writer$1.create=create$1(),BufferWriter$1._configure()};var writer_buffer=BufferWriter,Writer=writer;(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util$6=requireMinimal();function BufferWriter(){Writer.call(this)}BufferWriter._configure=function(){BufferWriter.alloc=util$6._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util$6.Buffer&&util$6.Buffer.prototype instanceof Uint8Array&&util$6.Buffer.prototype.set.name==="set"?function(t,i,s){i.set(t,s)}:function(t,i,s){if(t.copy)t.copy(i,s,0,t.length);else for(var a=0;a<t.length;)i[s++]=t[a++]}},BufferWriter.prototype.bytes=function n(t){util$6.isString(t)&&(t=util$6._Buffer_from(t,"base64"));var i=t.length>>>0;return this.uint32(i),i&&this._push(BufferWriter.writeBytesBuffer,i,t),this};function writeStringBuffer(n,t,i){n.length<40?util$6.utf8.write(n,t,i):t.utf8Write?t.utf8Write(n,i):t.write(n,i)}BufferWriter.prototype.string=function n(t){var i=util$6.Buffer.byteLength(t);return this.uint32(i),i&&this._push(writeStringBuffer,i,t),this},BufferWriter._configure();var reader=Reader$1,util$5=requireMinimal(),BufferReader$1,LongBits=util$5.LongBits,utf8=util$5.utf8;function indexOutOfRange(n,t){return RangeError("index out of range: "+n.pos+" + "+(t||1)+" > "+n.len)}function Reader$1(n){this.buf=n,this.pos=0,this.len=n.length}var create_array=typeof Uint8Array<"u"?function n(t){if(t instanceof Uint8Array||Array.isArray(t))return new Reader$1(t);throw Error("illegal buffer")}:function n(t){if(Array.isArray(t))return new Reader$1(t);throw Error("illegal buffer")},create=function n(){return util$5.Buffer?function(i){return(Reader$1.create=function(a){return util$5.Buffer.isBuffer(a)?new BufferReader$1(a):create_array(a)})(i)}:create_array};Reader$1.create=create(),Reader$1.prototype._slice=util$5.Array.prototype.subarray||util$5.Array.prototype.slice,Reader$1.prototype.uint32=function n(){var t=4294967295;return function(){if(t=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(t=(t|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(t=(t|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return t;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return t}}(),Reader$1.prototype.int32=function n(){return this.uint32()|0},Reader$1.prototype.sint32=function n(){var t=this.uint32();return t>>>1^-(t&1)|0};function readLongVarint(){var n=new LongBits(0,0),t=0;if(this.len-this.pos>4){for(;t<4;++t)if(n.lo=(n.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return n;if(n.lo=(n.lo|(this.buf[this.pos]&127)<<28)>>>0,n.hi=(n.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return n;t=0}else{for(;t<3;++t){if(this.pos>=this.len)throw indexOutOfRange(this);if(n.lo=(n.lo|(this.buf[this.pos]&127)<<t*7)>>>0,this.buf[this.pos++]<128)return n}return n.lo=(n.lo|(this.buf[this.pos++]&127)<<t*7)>>>0,n}if(this.len-this.pos>4){for(;t<5;++t)if(n.hi=(n.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return n}else for(;t<5;++t){if(this.pos>=this.len)throw indexOutOfRange(this);if(n.hi=(n.hi|(this.buf[this.pos]&127)<<t*7+3)>>>0,this.buf[this.pos++]<128)return n}throw Error("invalid varint encoding")}Reader$1.prototype.bool=function n(){return this.uint32()!==0};function readFixed32_end(n,t){return(n[t-4]|n[t-3]<<8|n[t-2]<<16|n[t-1]<<24)>>>0}Reader$1.prototype.fixed32=function n(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)},Reader$1.prototype.sfixed32=function n(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)|0};function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader$1.prototype.float=function n(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var t=util$5.float.readFloatLE(this.buf,this.pos);return this.pos+=4,t},Reader$1.prototype.double=function n(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var t=util$5.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,t},Reader$1.prototype.bytes=function n(){var t=this.uint32(),i=this.pos,s=this.pos+t;if(s>this.len)throw indexOutOfRange(this,t);if(this.pos+=t,Array.isArray(this.buf))return this.buf.slice(i,s);if(i===s){var a=util$5.Buffer;return a?a.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,i,s)},Reader$1.prototype.string=function n(){var t=this.bytes();return utf8.read(t,0,t.length)},Reader$1.prototype.skip=function n(t){if(typeof t=="number"){if(this.pos+t>this.len)throw indexOutOfRange(this,t);this.pos+=t}else do if(this.pos>=this.len)throw indexOutOfRange(this);while(this.buf[this.pos++]&128);return this},Reader$1.prototype.skipType=function(n){switch(n){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(n=this.uint32()&7)!==4;)this.skipType(n);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+n+" at offset "+this.pos)}return this},Reader$1._configure=function(n){BufferReader$1=n,Reader$1.create=create(),BufferReader$1._configure();var t=util$5.Long?"toLong":"toNumber";util$5.merge(Reader$1.prototype,{int64:function(){return readLongVarint.call(this)[t](!1)},uint64:function(){return readLongVarint.call(this)[t](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[t](!1)},fixed64:function(){return readFixed64.call(this)[t](!0)},sfixed64:function(){return readFixed64.call(this)[t](!1)}})};var reader_buffer=BufferReader,Reader=reader;(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util$4=requireMinimal();function BufferReader(n){Reader.call(this,n)}BufferReader._configure=function(){util$4.Buffer&&(BufferReader.prototype._slice=util$4.Buffer.prototype.slice)},BufferReader.prototype.string=function n(){var t=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+t,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+t,this.len))},BufferReader._configure();var rpc={},service$1=Service$1,util$3=requireMinimal();(Service$1.prototype=Object.create(util$3.EventEmitter.prototype)).constructor=Service$1;function Service$1(n,t,i){if(typeof n!="function")throw TypeError("rpcImpl must be a function");util$3.EventEmitter.call(this),this.rpcImpl=n,this.requestDelimited=!!t,this.responseDelimited=!!i}Service$1.prototype.rpcCall=function n(t,i,s,a,d){if(!a)throw TypeError("request must be specified");var c=this;if(!d)return util$3.asPromise(n,c,t,i,s,a);if(!c.rpcImpl){setTimeout(function(){d(Error("already ended"))},0);return}try{return c.rpcImpl(t,i[c.requestDelimited?"encodeDelimited":"encode"](a).finish(),function(u,p){if(u)return c.emit("error",u,t),d(u);if(p===null){c.end(!0);return}if(!(p instanceof s))try{p=s[c.responseDelimited?"decodeDelimited":"decode"](p)}catch(f){return c.emit("error",f,t),d(f)}return c.emit("data",p,t),d(null,p)})}catch(l){c.emit("error",l,t),setTimeout(function(){d(l)},0);return}},Service$1.prototype.end=function n(t){return this.rpcImpl&&(t||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},function(n){var t=n;t.Service=service$1}(rpc);var roots={};(function(n){var t=n;t.build="minimal",t.Writer=writer,t.BufferWriter=writer_buffer,t.Reader=reader,t.BufferReader=reader_buffer,t.util=requireMinimal(),t.rpc=rpc,t.roots=roots,t.configure=i;function i(){t.util._configure(),t.Writer._configure(t.BufferWriter),t.Reader._configure(t.BufferReader)}i()})(indexMinimal);var util$2={exports:{}},codegen_1=codegen;function codegen(n,t){typeof n=="string"&&(t=n,n=void 0);var i=[];function s(d){if(typeof d!="string"){var c=a();if(codegen.verbose&&console.log("codegen: "+c),c="return "+c,d){for(var l=Object.keys(d),u=new Array(l.length+1),p=new Array(l.length),f=0;f<l.length;)u[f]=l[f],p[f]=d[l[f++]];return u[f]=c,Function.apply(null,u).apply(null,p)}return Function(c)()}for(var m=new Array(arguments.length-1),g=0;g<m.length;)m[g]=arguments[++g];if(g=0,d=d.replace(/%([%dfijs])/g,function(y,k){var E=m[g++];switch(k){case"d":case"f":return String(Number(E));case"i":return String(Math.floor(E));case"j":return JSON.stringify(E);case"s":return String(E)}return"%"}),g!==m.length)throw Error("parameter count mismatch");return i.push(d),s}function a(d){return"function "+(d||t||"")+"("+(n&&n.join(",")||"")+`){
  `+i.join(`
  `)+`
}`}return s.toString=a,s}codegen.verbose=!1;var fetch_1=fetch$1,asPromise=aspromise,inquire=inquire_1,fs=inquire("fs");function fetch$1(n,t,i){return typeof t=="function"?(i=t,t={}):t||(t={}),i?!t.xhr&&fs&&fs.readFile?fs.readFile(n,function(a,d){return a&&typeof XMLHttpRequest<"u"?fetch$1.xhr(n,t,i):a?i(a):i(null,t.binary?d:d.toString("utf8"))}):fetch$1.xhr(n,t,i):asPromise(fetch$1,this,n,t)}fetch$1.xhr=function n(t,i,s){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(a.readyState===4){if(a.status!==0&&a.status!==200)return s(Error("status "+a.status));if(i.binary){var c=a.response;if(!c){c=[];for(var l=0;l<a.responseText.length;++l)c.push(a.responseText.charCodeAt(l)&255)}return s(null,typeof Uint8Array<"u"?new Uint8Array(c):c)}return s(null,a.responseText)}},i.binary&&("overrideMimeType"in a&&a.overrideMimeType("text/plain; charset=x-user-defined"),a.responseType="arraybuffer"),a.open("GET",t),a.send()};var path={};(function(n){var t=n,i=t.isAbsolute=function(d){return/^(?:\/|\w+:)/.test(d)},s=t.normalize=function(d){d=d.replace(/\\/g,"/").replace(/\/{2,}/g,"/");var c=d.split("/"),l=i(d),u="";l&&(u=c.shift()+"/");for(var p=0;p<c.length;)c[p]===".."?p>0&&c[p-1]!==".."?c.splice(--p,2):l?c.splice(p,1):++p:c[p]==="."?c.splice(p,1):++p;return u+c.join("/")};t.resolve=function(d,c,l){return l||(c=s(c)),i(c)?c:(l||(d=s(d)),(d=d.replace(/(?:\/|^)[^/]+$/,"")).length?s(d+"/"+c):c)}})(path);var types$1={},hasRequiredTypes;function requireTypes(){return hasRequiredTypes||(hasRequiredTypes=1,function(n){var t=n,i=requireUtil(),s=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function a(d,c){var l=0,u={};for(c|=0;l<d.length;)u[s[l+c]]=d[l++];return u}t.basic=a([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),t.defaults=a([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",i.emptyArray,null]),t.long=a([0,0,0,1,1],7),t.mapKey=a([0,0,0,5,5,0,0,0,1,1,0,2],2),t.packed=a([1,5,0,0,0,5,5,0,0,0,1,1,0])}(types$1)),types$1}var field,hasRequiredField;function requireField(){if(hasRequiredField)return field;hasRequiredField=1,field=c;var n=requireObject();((c.prototype=Object.create(n.prototype)).constructor=c).className="Field";var t=require_enum(),i=requireTypes(),s=requireUtil(),a,d=/^required|optional|repeated$/;c.fromJSON=function(u,p){return new c(u,p.id,p.type,p.rule,p.extend,p.options,p.comment)};function c(l,u,p,f,m,g,v){if(s.isObject(f)?(v=m,g=f,f=m=void 0):s.isObject(m)&&(v=g,g=m,m=void 0),n.call(this,l,g),!s.isInteger(u)||u<0)throw TypeError("id must be a non-negative integer");if(!s.isString(p))throw TypeError("type must be a string");if(f!==void 0&&!d.test(f=f.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(m!==void 0&&!s.isString(m))throw TypeError("extend must be a string");f==="proto3_optional"&&(f="optional"),this.rule=f&&f!=="optional"?f:void 0,this.type=p,this.id=u,this.extend=m||void 0,this.required=f==="required",this.optional=!this.required,this.repeated=f==="repeated",this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=s.Long?i.long[p]!==void 0:!1,this.bytes=p==="bytes",this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=v}return Object.defineProperty(c.prototype,"packed",{get:function(){return this._packed===null&&(this._packed=this.getOption("packed")!==!1),this._packed}}),c.prototype.setOption=function(u,p,f){return u==="packed"&&(this._packed=null),n.prototype.setOption.call(this,u,p,f)},c.prototype.toJSON=function(u){var p=u?!!u.keepComments:!1;return s.toObject(["rule",this.rule!=="optional"&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",p?this.comment:void 0])},c.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=i.defaults[this.type])===void 0?(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof a?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&this.options.default!=null&&(this.typeDefault=this.options.default,this.resolvedType instanceof t&&typeof this.typeDefault=="string"&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&((this.options.packed===!0||this.options.packed!==void 0&&this.resolvedType&&!(this.resolvedType instanceof t))&&delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=s.Long.fromNumber(this.typeDefault,this.type.charAt(0)==="u"),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&typeof this.typeDefault=="string"){var u;s.base64.test(this.typeDefault)?s.base64.decode(this.typeDefault,u=s.newBuffer(s.base64.length(this.typeDefault)),0):s.utf8.write(this.typeDefault,u=s.newBuffer(s.utf8.length(this.typeDefault)),0),this.typeDefault=u}return this.map?this.defaultValue=s.emptyObject:this.repeated?this.defaultValue=s.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof a&&(this.parent.ctor.prototype[this.name]=this.defaultValue),n.prototype.resolve.call(this)},c.d=function(u,p,f,m){return typeof p=="function"?p=s.decorateType(p).name:p&&typeof p=="object"&&(p=s.decorateEnum(p).name),function(v,y){s.decorateType(v.constructor).add(new c(y,u,p,f,{default:m}))}},c._configure=function(u){a=u},field}var oneof,hasRequiredOneof;function requireOneof(){if(hasRequiredOneof)return oneof;hasRequiredOneof=1,oneof=s;var n=requireObject();((s.prototype=Object.create(n.prototype)).constructor=s).className="OneOf";var t=requireField(),i=requireUtil();function s(d,c,l,u){if(Array.isArray(c)||(l=c,c=void 0),n.call(this,d,l),!(c===void 0||Array.isArray(c)))throw TypeError("fieldNames must be an Array");this.oneof=c||[],this.fieldsArray=[],this.comment=u}s.fromJSON=function(c,l){return new s(c,l.oneof,l.options,l.comment)},s.prototype.toJSON=function(c){var l=c?!!c.keepComments:!1;return i.toObject(["options",this.options,"oneof",this.oneof,"comment",l?this.comment:void 0])};function a(d){if(d.parent)for(var c=0;c<d.fieldsArray.length;++c)d.fieldsArray[c].parent||d.parent.add(d.fieldsArray[c])}return s.prototype.add=function(c){if(!(c instanceof t))throw TypeError("field must be a Field");return c.parent&&c.parent!==this.parent&&c.parent.remove(c),this.oneof.push(c.name),this.fieldsArray.push(c),c.partOf=this,a(this),this},s.prototype.remove=function(c){if(!(c instanceof t))throw TypeError("field must be a Field");var l=this.fieldsArray.indexOf(c);if(l<0)throw Error(c+" is not a member of "+this);return this.fieldsArray.splice(l,1),l=this.oneof.indexOf(c.name),l>-1&&this.oneof.splice(l,1),c.partOf=null,this},s.prototype.onAdd=function(c){n.prototype.onAdd.call(this,c);for(var l=this,u=0;u<this.oneof.length;++u){var p=c.get(this.oneof[u]);p&&!p.partOf&&(p.partOf=l,l.fieldsArray.push(p))}a(this)},s.prototype.onRemove=function(c){for(var l=0,u;l<this.fieldsArray.length;++l)(u=this.fieldsArray[l]).parent&&u.parent.remove(u);n.prototype.onRemove.call(this,c)},s.d=function(){for(var c=new Array(arguments.length),l=0;l<arguments.length;)c[l]=arguments[l++];return function(p,f){i.decorateType(p.constructor).add(new s(f,c)),Object.defineProperty(p,f,{get:i.oneOfGetter(c),set:i.oneOfSetter(c)})}},oneof}var namespace,hasRequiredNamespace;function requireNamespace(){if(hasRequiredNamespace)return namespace;hasRequiredNamespace=1,namespace=u;var n=requireObject();((u.prototype=Object.create(n.prototype)).constructor=u).className="Namespace";var t=requireField(),i=requireUtil(),s=requireOneof(),a,d,c;u.fromJSON=function(m,g){return new u(m,g.options).addJSON(g.nested)};function l(f,m){if(f&&f.length){for(var g={},v=0;v<f.length;++v)g[f[v].name]=f[v].toJSON(m);return g}}u.arrayToJSON=l,u.isReservedId=function(m,g){if(m){for(var v=0;v<m.length;++v)if(typeof m[v]!="string"&&m[v][0]<=g&&m[v][1]>g)return!0}return!1},u.isReservedName=function(m,g){if(m){for(var v=0;v<m.length;++v)if(m[v]===g)return!0}return!1};function u(f,m){n.call(this,f,m),this.nested=void 0,this._nestedArray=null}function p(f){return f._nestedArray=null,f}return Object.defineProperty(u.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=i.toArray(this.nested))}}),u.prototype.toJSON=function(m){return i.toObject(["options",this.options,"nested",l(this.nestedArray,m)])},u.prototype.addJSON=function(m){var g=this;if(m)for(var v=Object.keys(m),y=0,k;y<v.length;++y)k=m[v[y]],g.add((k.fields!==void 0?a.fromJSON:k.values!==void 0?c.fromJSON:k.methods!==void 0?d.fromJSON:k.id!==void 0?t.fromJSON:u.fromJSON)(v[y],k));return this},u.prototype.get=function(m){return this.nested&&this.nested[m]||null},u.prototype.getEnum=function(m){if(this.nested&&this.nested[m]instanceof c)return this.nested[m].values;throw Error("no such enum: "+m)},u.prototype.add=function(m){if(!(m instanceof t&&m.extend!==void 0||m instanceof a||m instanceof s||m instanceof c||m instanceof d||m instanceof u))throw TypeError("object must be a valid nested object");if(!this.nested)this.nested={};else{var g=this.get(m.name);if(g)if(g instanceof u&&m instanceof u&&!(g instanceof a||g instanceof d)){for(var v=g.nestedArray,y=0;y<v.length;++y)m.add(v[y]);this.remove(g),this.nested||(this.nested={}),m.setOptions(g.options,!0)}else throw Error("duplicate name '"+m.name+"' in "+this)}return this.nested[m.name]=m,m.onAdd(this),p(this)},u.prototype.remove=function(m){if(!(m instanceof n))throw TypeError("object must be a ReflectionObject");if(m.parent!==this)throw Error(m+" is not a member of "+this);return delete this.nested[m.name],Object.keys(this.nested).length||(this.nested=void 0),m.onRemove(this),p(this)},u.prototype.define=function(m,g){if(i.isString(m))m=m.split(".");else if(!Array.isArray(m))throw TypeError("illegal path");if(m&&m.length&&m[0]==="")throw Error("path must be relative");for(var v=this;m.length>0;){var y=m.shift();if(v.nested&&v.nested[y]){if(v=v.nested[y],!(v instanceof u))throw Error("path conflicts with non-namespace objects")}else v.add(v=new u(y))}return g&&v.addJSON(g),v},u.prototype.resolveAll=function(){for(var m=this.nestedArray,g=0;g<m.length;)m[g]instanceof u?m[g++].resolveAll():m[g++].resolve();return this.resolve()},u.prototype.lookup=function(m,g,v){if(typeof g=="boolean"?(v=g,g=void 0):g&&!Array.isArray(g)&&(g=[g]),i.isString(m)&&m.length){if(m===".")return this.root;m=m.split(".")}else if(!m.length)return this;if(m[0]==="")return this.root.lookup(m.slice(1),g);var y=this.get(m[0]);if(y){if(m.length===1){if(!g||g.indexOf(y.constructor)>-1)return y}else if(y instanceof u&&(y=y.lookup(m.slice(1),g,!0)))return y}else for(var k=0;k<this.nestedArray.length;++k)if(this._nestedArray[k]instanceof u&&(y=this._nestedArray[k].lookup(m,g,!0)))return y;return this.parent===null||v?null:this.parent.lookup(m,g)},u.prototype.lookupType=function(m){var g=this.lookup(m,[a]);if(!g)throw Error("no such type: "+m);return g},u.prototype.lookupEnum=function(m){var g=this.lookup(m,[c]);if(!g)throw Error("no such Enum '"+m+"' in "+this);return g},u.prototype.lookupTypeOrEnum=function(m){var g=this.lookup(m,[a,c]);if(!g)throw Error("no such Type or Enum '"+m+"' in "+this);return g},u.prototype.lookupService=function(m){var g=this.lookup(m,[d]);if(!g)throw Error("no such Service '"+m+"' in "+this);return g},u._configure=function(f,m,g){a=f,d=m,c=g},namespace}var mapfield,hasRequiredMapfield;function requireMapfield(){if(hasRequiredMapfield)return mapfield;hasRequiredMapfield=1,mapfield=s;var n=requireField();((s.prototype=Object.create(n.prototype)).constructor=s).className="MapField";var t=requireTypes(),i=requireUtil();function s(a,d,c,l,u,p){if(n.call(this,a,d,l,void 0,void 0,u,p),!i.isString(c))throw TypeError("keyType must be a string");this.keyType=c,this.resolvedKeyType=null,this.map=!0}return s.fromJSON=function(d,c){return new s(d,c.id,c.keyType,c.type,c.options,c.comment)},s.prototype.toJSON=function(d){var c=d?!!d.keepComments:!1;return i.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",c?this.comment:void 0])},s.prototype.resolve=function(){if(this.resolved)return this;if(t.mapKey[this.keyType]===void 0)throw Error("invalid key type: "+this.keyType);return n.prototype.resolve.call(this)},s.d=function(d,c,l){return typeof l=="function"?l=i.decorateType(l).name:l&&typeof l=="object"&&(l=i.decorateEnum(l).name),function(p,f){i.decorateType(p.constructor).add(new s(f,d,c,l))}},mapfield}var method,hasRequiredMethod;function requireMethod(){if(hasRequiredMethod)return method;hasRequiredMethod=1,method=i;var n=requireObject();((i.prototype=Object.create(n.prototype)).constructor=i).className="Method";var t=requireUtil();function i(s,a,d,c,l,u,p,f,m){if(t.isObject(l)?(p=l,l=u=void 0):t.isObject(u)&&(p=u,u=void 0),!(a===void 0||t.isString(a)))throw TypeError("type must be a string");if(!t.isString(d))throw TypeError("requestType must be a string");if(!t.isString(c))throw TypeError("responseType must be a string");n.call(this,s,p),this.type=a||"rpc",this.requestType=d,this.requestStream=l?!0:void 0,this.responseType=c,this.responseStream=u?!0:void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=f,this.parsedOptions=m}return i.fromJSON=function(a,d){return new i(a,d.type,d.requestType,d.responseType,d.requestStream,d.responseStream,d.options,d.comment,d.parsedOptions)},i.prototype.toJSON=function(a){var d=a?!!a.keepComments:!1;return t.toObject(["type",this.type!=="rpc"&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",d?this.comment:void 0,"parsedOptions",this.parsedOptions])},i.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),n.prototype.resolve.call(this))},method}var service,hasRequiredService;function requireService(){if(hasRequiredService)return service;hasRequiredService=1,service=a;var n=requireNamespace();((a.prototype=Object.create(n.prototype)).constructor=a).className="Service";var t=requireMethod(),i=requireUtil(),s=rpc;function a(c,l){n.call(this,c,l),this.methods={},this._methodsArray=null}a.fromJSON=function(l,u){var p=new a(l,u.options);if(u.methods)for(var f=Object.keys(u.methods),m=0;m<f.length;++m)p.add(t.fromJSON(f[m],u.methods[f[m]]));return u.nested&&p.addJSON(u.nested),p.comment=u.comment,p},a.prototype.toJSON=function(l){var u=n.prototype.toJSON.call(this,l),p=l?!!l.keepComments:!1;return i.toObject(["options",u&&u.options||void 0,"methods",n.arrayToJSON(this.methodsArray,l)||{},"nested",u&&u.nested||void 0,"comment",p?this.comment:void 0])},Object.defineProperty(a.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=i.toArray(this.methods))}});function d(c){return c._methodsArray=null,c}return a.prototype.get=function(l){return this.methods[l]||n.prototype.get.call(this,l)},a.prototype.resolveAll=function(){for(var l=this.methodsArray,u=0;u<l.length;++u)l[u].resolve();return n.prototype.resolve.call(this)},a.prototype.add=function(l){if(this.get(l.name))throw Error("duplicate name '"+l.name+"' in "+this);return l instanceof t?(this.methods[l.name]=l,l.parent=this,d(this)):n.prototype.add.call(this,l)},a.prototype.remove=function(l){if(l instanceof t){if(this.methods[l.name]!==l)throw Error(l+" is not a member of "+this);return delete this.methods[l.name],l.parent=null,d(this)}return n.prototype.remove.call(this,l)},a.prototype.create=function(l,u,p){for(var f=new s.Service(l,u,p),m=0,g;m<this.methodsArray.length;++m){var v=i.lcFirst((g=this._methodsArray[m]).resolve().name).replace(/[^$\w_]/g,"");f[v]=i.codegen(["r","c"],i.isReserved(v)?v+"_":v)("return this.rpcCall(m,q,s,r,c)")({m:g,q:g.resolvedRequestType.ctor,s:g.resolvedResponseType.ctor})}return f},service}var message=Message,util$1=requireMinimal();function Message(n){if(n)for(var t=Object.keys(n),i=0;i<t.length;++i)this[t[i]]=n[t[i]]}Message.create=function n(t){return this.$type.create(t)},Message.encode=function n(t,i){return this.$type.encode(t,i)},Message.encodeDelimited=function n(t,i){return this.$type.encodeDelimited(t,i)},Message.decode=function n(t){return this.$type.decode(t)},Message.decodeDelimited=function n(t){return this.$type.decodeDelimited(t)},Message.verify=function n(t){return this.$type.verify(t)},Message.fromObject=function n(t){return this.$type.fromObject(t)},Message.toObject=function n(t,i){return this.$type.toObject(t,i)},Message.prototype.toJSON=function n(){return this.$type.toObject(this,util$1.toJSONOptions)};var decoder_1,hasRequiredDecoder;function requireDecoder(){if(hasRequiredDecoder)return decoder_1;hasRequiredDecoder=1,decoder_1=a;var n=require_enum(),t=requireTypes(),i=requireUtil();function s(d){return"missing required '"+d.name+"'"}function a(d){var c=i.codegen(["r","l"],d.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(d.fieldsArray.filter(function(g){return g.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");d.group&&c("if((t&7)===4)")("break"),c("switch(t>>>3){");for(var l=0;l<d.fieldsArray.length;++l){var u=d._fieldsArray[l].resolve(),p=u.resolvedType instanceof n?"int32":u.type,f="m"+i.safeProp(u.name);c("case %i: {",u.id),u.map?(c("if(%s===util.emptyObject)",f)("%s={}",f)("var c2 = r.uint32()+r.pos"),t.defaults[u.keyType]!==void 0?c("k=%j",t.defaults[u.keyType]):c("k=null"),t.defaults[p]!==void 0?c("value=%j",t.defaults[p]):c("value=null"),c("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",u.keyType)("case 2:"),t.basic[p]===void 0?c("value=types[%i].decode(r,r.uint32())",l):c("value=r.%s()",p),c("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),t.long[u.keyType]!==void 0?c('%s[typeof k==="object"?util.longToHash(k):k]=value',f):c("%s[k]=value",f)):u.repeated?(c("if(!(%s&&%s.length))",f,f)("%s=[]",f),t.packed[p]!==void 0&&c("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",f,p)("}else"),t.basic[p]===void 0?c(u.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",f,l):c("%s.push(r.%s())",f,p)):t.basic[p]===void 0?c(u.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",f,l):c("%s=r.%s()",f,p),c("break")("}")}for(c("default:")("r.skipType(t&7)")("break")("}")("}"),l=0;l<d._fieldsArray.length;++l){var m=d._fieldsArray[l];m.required&&c("if(!m.hasOwnProperty(%j))",m.name)("throw util.ProtocolError(%j,{instance:m})",s(m))}return c("return m")}return decoder_1}var verifier_1,hasRequiredVerifier;function requireVerifier(){if(hasRequiredVerifier)return verifier_1;hasRequiredVerifier=1,verifier_1=d;var n=require_enum(),t=requireUtil();function i(c,l){return c.name+": "+l+(c.repeated&&l!=="array"?"[]":c.map&&l!=="object"?"{k:"+c.keyType+"}":"")+" expected"}function s(c,l,u,p){if(l.resolvedType)if(l.resolvedType instanceof n){c("switch(%s){",p)("default:")("return%j",i(l,"enum value"));for(var f=Object.keys(l.resolvedType.values),m=0;m<f.length;++m)c("case %i:",l.resolvedType.values[f[m]]);c("break")("}")}else c("{")("var e=types[%i].verify(%s);",u,p)("if(e)")("return%j+e",l.name+".")("}");else switch(l.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":c("if(!util.isInteger(%s))",p)("return%j",i(l,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":c("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",p,p,p,p)("return%j",i(l,"integer|Long"));break;case"float":case"double":c('if(typeof %s!=="number")',p)("return%j",i(l,"number"));break;case"bool":c('if(typeof %s!=="boolean")',p)("return%j",i(l,"boolean"));break;case"string":c("if(!util.isString(%s))",p)("return%j",i(l,"string"));break;case"bytes":c('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',p,p,p)("return%j",i(l,"buffer"));break}return c}function a(c,l,u){switch(l.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":c("if(!util.key32Re.test(%s))",u)("return%j",i(l,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":c("if(!util.key64Re.test(%s))",u)("return%j",i(l,"integer|Long key"));break;case"bool":c("if(!util.key2Re.test(%s))",u)("return%j",i(l,"boolean key"));break}return c}function d(c){var l=t.codegen(["m"],c.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),u=c.oneofsArray,p={};u.length&&l("var p={}");for(var f=0;f<c.fieldsArray.length;++f){var m=c._fieldsArray[f].resolve(),g="m"+t.safeProp(m.name);if(m.optional&&l("if(%s!=null&&m.hasOwnProperty(%j)){",g,m.name),m.map)l("if(!util.isObject(%s))",g)("return%j",i(m,"object"))("var k=Object.keys(%s)",g)("for(var i=0;i<k.length;++i){"),a(l,m,"k[i]"),s(l,m,f,g+"[k[i]]")("}");else if(m.repeated)l("if(!Array.isArray(%s))",g)("return%j",i(m,"array"))("for(var i=0;i<%s.length;++i){",g),s(l,m,f,g+"[i]")("}");else{if(m.partOf){var v=t.safeProp(m.partOf.name);p[m.partOf.name]===1&&l("if(p%s===1)",v)("return%j",m.partOf.name+": multiple values"),p[m.partOf.name]=1,l("p%s=1",v)}s(l,m,f,g)}m.optional&&l("}")}return l("return null")}return verifier_1}var converter={},hasRequiredConverter;function requireConverter(){return hasRequiredConverter||(hasRequiredConverter=1,function(n){var t=n,i=require_enum(),s=requireUtil();function a(c,l,u,p){var f=!1;if(l.resolvedType)if(l.resolvedType instanceof i){c("switch(d%s){",p);for(var m=l.resolvedType.values,g=Object.keys(m),v=0;v<g.length;++v)m[g[v]]===l.typeDefault&&!f&&(c("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',p,p,p),l.repeated||c("break"),f=!0),c("case%j:",g[v])("case %i:",m[g[v]])("m%s=%j",p,m[g[v]])("break");c("}")}else c('if(typeof d%s!=="object")',p)("throw TypeError(%j)",l.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",p,u,p);else{var y=!1;switch(l.type){case"double":case"float":c("m%s=Number(d%s)",p,p);break;case"uint32":case"fixed32":c("m%s=d%s>>>0",p,p);break;case"int32":case"sint32":case"sfixed32":c("m%s=d%s|0",p,p);break;case"uint64":y=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":c("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",p,p,y)('else if(typeof d%s==="string")',p)("m%s=parseInt(d%s,10)",p,p)('else if(typeof d%s==="number")',p)("m%s=d%s",p,p)('else if(typeof d%s==="object")',p)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",p,p,p,y?"true":"");break;case"bytes":c('if(typeof d%s==="string")',p)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",p,p,p)("else if(d%s.length >= 0)",p)("m%s=d%s",p,p);break;case"string":c("m%s=String(d%s)",p,p);break;case"bool":c("m%s=Boolean(d%s)",p,p);break}}return c}t.fromObject=function(l){var u=l.fieldsArray,p=s.codegen(["d"],l.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!u.length)return p("return new this.ctor");p("var m=new this.ctor");for(var f=0;f<u.length;++f){var m=u[f].resolve(),g=s.safeProp(m.name);m.map?(p("if(d%s){",g)('if(typeof d%s!=="object")',g)("throw TypeError(%j)",m.fullName+": object expected")("m%s={}",g)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",g),a(p,m,f,g+"[ks[i]]")("}")("}")):m.repeated?(p("if(d%s){",g)("if(!Array.isArray(d%s))",g)("throw TypeError(%j)",m.fullName+": array expected")("m%s=[]",g)("for(var i=0;i<d%s.length;++i){",g),a(p,m,f,g+"[i]")("}")("}")):(m.resolvedType instanceof i||p("if(d%s!=null){",g),a(p,m,f,g),m.resolvedType instanceof i||p("}"))}return p("return m")};function d(c,l,u,p){if(l.resolvedType)l.resolvedType instanceof i?c("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",p,u,p,p,u,p,p):c("d%s=types[%i].toObject(m%s,o)",p,u,p);else{var f=!1;switch(l.type){case"double":case"float":c("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",p,p,p,p);break;case"uint64":f=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":c('if(typeof m%s==="number")',p)("d%s=o.longs===String?String(m%s):m%s",p,p,p)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",p,p,p,p,f?"true":"",p);break;case"bytes":c("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",p,p,p,p,p);break;default:c("d%s=m%s",p,p);break}}return c}t.toObject=function(l){var u=l.fieldsArray.slice().sort(s.compareFieldsById);if(!u.length)return s.codegen()("return {}");for(var p=s.codegen(["m","o"],l.name+"$toObject")("if(!o)")("o={}")("var d={}"),f=[],m=[],g=[],v=0;v<u.length;++v)u[v].partOf||(u[v].resolve().repeated?f:u[v].map?m:g).push(u[v]);if(f.length){for(p("if(o.arrays||o.defaults){"),v=0;v<f.length;++v)p("d%s=[]",s.safeProp(f[v].name));p("}")}if(m.length){for(p("if(o.objects||o.defaults){"),v=0;v<m.length;++v)p("d%s={}",s.safeProp(m[v].name));p("}")}if(g.length){for(p("if(o.defaults){"),v=0;v<g.length;++v){var y=g[v],k=s.safeProp(y.name);if(y.resolvedType instanceof i)p("d%s=o.enums===String?%j:%j",k,y.resolvedType.valuesById[y.typeDefault],y.typeDefault);else if(y.long)p("if(util.Long){")("var n=new util.Long(%i,%i,%j)",y.typeDefault.low,y.typeDefault.high,y.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",k)("}else")("d%s=o.longs===String?%j:%i",k,y.typeDefault.toString(),y.typeDefault.toNumber());else if(y.bytes){var E="["+Array.prototype.slice.call(y.typeDefault).join(",")+"]";p("if(o.bytes===String)d%s=%j",k,String.fromCharCode.apply(String,y.typeDefault))("else{")("d%s=%s",k,E)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",k,k)("}")}else p("d%s=%j",k,y.typeDefault)}p("}")}var C=!1;for(v=0;v<u.length;++v){var y=u[v],T=l._fieldsArray.indexOf(y),k=s.safeProp(y.name);y.map?(C||(C=!0,p("var ks2")),p("if(m%s&&(ks2=Object.keys(m%s)).length){",k,k)("d%s={}",k)("for(var j=0;j<ks2.length;++j){"),d(p,y,T,k+"[ks2[j]]")("}")):y.repeated?(p("if(m%s&&m%s.length){",k,k)("d%s=[]",k)("for(var j=0;j<m%s.length;++j){",k),d(p,y,T,k+"[j]")("}")):(p("if(m%s!=null&&m.hasOwnProperty(%j)){",k,y.name),d(p,y,T,k),y.partOf&&p("if(o.oneofs)")("d%s=%j",s.safeProp(y.partOf.name),y.name)),p("}")}return p("return d")}}(converter)),converter}var wrappers={};(function(n){var t=n,i=message;t[".google.protobuf.Any"]={fromObject:function(s){if(s&&s["@type"]){var a=s["@type"].substring(s["@type"].lastIndexOf("/")+1),d=this.lookup(a);if(d){var c=s["@type"].charAt(0)==="."?s["@type"].slice(1):s["@type"];return c.indexOf("/")===-1&&(c="/"+c),this.create({type_url:c,value:d.encode(d.fromObject(s)).finish()})}}return this.fromObject(s)},toObject:function(s,a){var d="type.googleapis.com/",c="",l="";if(a&&a.json&&s.type_url&&s.value){l=s.type_url.substring(s.type_url.lastIndexOf("/")+1),c=s.type_url.substring(0,s.type_url.lastIndexOf("/")+1);var u=this.lookup(l);u&&(s=u.decode(s.value))}if(!(s instanceof this.ctor)&&s instanceof i){var p=s.$type.toObject(s,a),f=s.$type.fullName[0]==="."?s.$type.fullName.slice(1):s.$type.fullName;return c===""&&(c=d),l=c+f,p["@type"]=l,p}return this.toObject(s,a)}}})(wrappers);var type,hasRequiredType;function requireType(){if(hasRequiredType)return type;hasRequiredType=1,type=k;var n=requireNamespace();((k.prototype=Object.create(n.prototype)).constructor=k).className="Type";var t=require_enum(),i=requireOneof(),s=requireField(),a=requireMapfield(),d=requireService(),c=message,l=reader,u=writer,p=requireUtil(),f=requireEncoder(),m=requireDecoder(),g=requireVerifier(),v=requireConverter(),y=wrappers;function k(C,T){n.call(this,C,T),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}Object.defineProperties(k.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var C=Object.keys(this.fields),T=0;T<C.length;++T){var w=this.fields[C[T]],b=w.id;if(this._fieldsById[b])throw Error("duplicate id "+b+" in "+this);this._fieldsById[b]=w}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=p.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=p.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=k.generateConstructor(this)())},set:function(C){var T=C.prototype;T instanceof c||((C.prototype=new c).constructor=C,p.merge(C.prototype,T)),C.$type=C.prototype.$type=this,p.merge(C,c,!0),this._ctor=C;for(var w=0;w<this.fieldsArray.length;++w)this._fieldsArray[w].resolve();var b={};for(w=0;w<this.oneofsArray.length;++w)b[this._oneofsArray[w].resolve().name]={get:p.oneOfGetter(this._oneofsArray[w].oneof),set:p.oneOfSetter(this._oneofsArray[w].oneof)};w&&Object.defineProperties(C.prototype,b)}}}),k.generateConstructor=function(T){for(var w=p.codegen(["p"],T.name),b=0,S;b<T.fieldsArray.length;++b)(S=T._fieldsArray[b]).map?w("this%s={}",p.safeProp(S.name)):S.repeated&&w("this%s=[]",p.safeProp(S.name));return w("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")};function E(C){return C._fieldsById=C._fieldsArray=C._oneofsArray=null,delete C.encode,delete C.decode,delete C.verify,C}return k.fromJSON=function(T,w){var b=new k(T,w.options);b.extensions=w.extensions,b.reserved=w.reserved;for(var S=Object.keys(w.fields),R=0;R<S.length;++R)b.add((typeof w.fields[S[R]].keyType<"u"?a.fromJSON:s.fromJSON)(S[R],w.fields[S[R]]));if(w.oneofs)for(S=Object.keys(w.oneofs),R=0;R<S.length;++R)b.add(i.fromJSON(S[R],w.oneofs[S[R]]));if(w.nested)for(S=Object.keys(w.nested),R=0;R<S.length;++R){var O=w.nested[S[R]];b.add((O.id!==void 0?s.fromJSON:O.fields!==void 0?k.fromJSON:O.values!==void 0?t.fromJSON:O.methods!==void 0?d.fromJSON:n.fromJSON)(S[R],O))}return w.extensions&&w.extensions.length&&(b.extensions=w.extensions),w.reserved&&w.reserved.length&&(b.reserved=w.reserved),w.group&&(b.group=!0),w.comment&&(b.comment=w.comment),b},k.prototype.toJSON=function(T){var w=n.prototype.toJSON.call(this,T),b=T?!!T.keepComments:!1;return p.toObject(["options",w&&w.options||void 0,"oneofs",n.arrayToJSON(this.oneofsArray,T),"fields",n.arrayToJSON(this.fieldsArray.filter(function(S){return!S.declaringField}),T)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",w&&w.nested||void 0,"comment",b?this.comment:void 0])},k.prototype.resolveAll=function(){for(var T=this.fieldsArray,w=0;w<T.length;)T[w++].resolve();var b=this.oneofsArray;for(w=0;w<b.length;)b[w++].resolve();return n.prototype.resolveAll.call(this)},k.prototype.get=function(T){return this.fields[T]||this.oneofs&&this.oneofs[T]||this.nested&&this.nested[T]||null},k.prototype.add=function(T){if(this.get(T.name))throw Error("duplicate name '"+T.name+"' in "+this);if(T instanceof s&&T.extend===void 0){if(this._fieldsById?this._fieldsById[T.id]:this.fieldsById[T.id])throw Error("duplicate id "+T.id+" in "+this);if(this.isReservedId(T.id))throw Error("id "+T.id+" is reserved in "+this);if(this.isReservedName(T.name))throw Error("name '"+T.name+"' is reserved in "+this);return T.parent&&T.parent.remove(T),this.fields[T.name]=T,T.message=this,T.onAdd(this),E(this)}return T instanceof i?(this.oneofs||(this.oneofs={}),this.oneofs[T.name]=T,T.onAdd(this),E(this)):n.prototype.add.call(this,T)},k.prototype.remove=function(T){if(T instanceof s&&T.extend===void 0){if(!this.fields||this.fields[T.name]!==T)throw Error(T+" is not a member of "+this);return delete this.fields[T.name],T.parent=null,T.onRemove(this),E(this)}if(T instanceof i){if(!this.oneofs||this.oneofs[T.name]!==T)throw Error(T+" is not a member of "+this);return delete this.oneofs[T.name],T.parent=null,T.onRemove(this),E(this)}return n.prototype.remove.call(this,T)},k.prototype.isReservedId=function(T){return n.isReservedId(this.reserved,T)},k.prototype.isReservedName=function(T){return n.isReservedName(this.reserved,T)},k.prototype.create=function(T){return new this.ctor(T)},k.prototype.setup=function(){for(var T=this.fullName,w=[],b=0;b<this.fieldsArray.length;++b)w.push(this._fieldsArray[b].resolve().resolvedType);this.encode=f(this)({Writer:u,types:w,util:p}),this.decode=m(this)({Reader:l,types:w,util:p}),this.verify=g(this)({types:w,util:p}),this.fromObject=v.fromObject(this)({types:w,util:p}),this.toObject=v.toObject(this)({types:w,util:p});var S=y[T];if(S){var R=Object.create(this);R.fromObject=this.fromObject,this.fromObject=S.fromObject.bind(R),R.toObject=this.toObject,this.toObject=S.toObject.bind(R)}return this},k.prototype.encode=function(T,w){return this.setup().encode(T,w)},k.prototype.encodeDelimited=function(T,w){return this.encode(T,w&&w.len?w.fork():w).ldelim()},k.prototype.decode=function(T,w){return this.setup().decode(T,w)},k.prototype.decodeDelimited=function(T){return T instanceof l||(T=l.create(T)),this.decode(T,T.uint32())},k.prototype.verify=function(T){return this.setup().verify(T)},k.prototype.fromObject=function(T){return this.setup().fromObject(T)},k.prototype.toObject=function(T,w){return this.setup().toObject(T,w)},k.d=function(T){return function(b){p.decorateType(b,T)}},type}var root,hasRequiredRoot;function requireRoot(){if(hasRequiredRoot)return root;hasRequiredRoot=1,root=u;var n=requireNamespace();((u.prototype=Object.create(n.prototype)).constructor=u).className="Root";var t=requireField(),i=require_enum(),s=requireOneof(),a=requireUtil(),d,c,l;function u(g){n.call(this,"",g),this.deferred=[],this.files=[]}u.fromJSON=function(v,y){return y||(y=new u),v.options&&y.setOptions(v.options),y.addJSON(v.nested)},u.prototype.resolvePath=a.path.resolve,u.prototype.fetch=a.fetch;function p(){}u.prototype.load=function g(v,y,k){typeof y=="function"&&(k=y,y=void 0);var E=this;if(!k)return a.asPromise(g,E,v,y);var C=k===p;function T(D,x){if(k){if(C)throw D;var M=k;k=null,M(D,x)}}function w(D){var x=D.lastIndexOf("google/protobuf/");if(x>-1){var M=D.substring(x);if(M in l)return M}return null}function b(D,x){try{if(a.isString(x)&&x.charAt(0)==="{"&&(x=JSON.parse(x)),!a.isString(x))E.setOptions(x.options).addJSON(x.nested);else{c.filename=D;var M=c(x,E,y),F,V=0;if(M.imports)for(;V<M.imports.length;++V)(F=w(M.imports[V])||E.resolvePath(D,M.imports[V]))&&S(F);if(M.weakImports)for(V=0;V<M.weakImports.length;++V)(F=w(M.weakImports[V])||E.resolvePath(D,M.weakImports[V]))&&S(F,!0)}}catch(q){T(q)}!C&&!R&&T(null,E)}function S(D,x){if(D=w(D)||D,!(E.files.indexOf(D)>-1)){if(E.files.push(D),D in l){C?b(D,l[D]):(++R,setTimeout(function(){--R,b(D,l[D])}));return}if(C){var M;try{M=a.fs.readFileSync(D).toString("utf8")}catch(F){x||T(F);return}b(D,M)}else++R,E.fetch(D,function(F,V){if(--R,!!k){if(F){x?R||T(null,E):T(F);return}b(D,V)}})}}var R=0;a.isString(v)&&(v=[v]);for(var O=0,L;O<v.length;++O)(L=E.resolvePath("",v[O]))&&S(L);if(C)return E;R||T(null,E)},u.prototype.loadSync=function(v,y){if(!a.isNode)throw Error("not supported");return this.load(v,y,p)},u.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(v){return"'extend "+v.extend+"' in "+v.parent.fullName}).join(", "));return n.prototype.resolveAll.call(this)};var f=/^[A-Z]/;function m(g,v){var y=v.parent.lookup(v.extend);if(y){var k=new t(v.fullName,v.id,v.type,v.rule,void 0,v.options);return y.get(k.name)||(k.declaringField=v,v.extensionField=k,y.add(k)),!0}return!1}return u.prototype._handleAdd=function(v){if(v instanceof t)v.extend!==void 0&&!v.extensionField&&(m(this,v)||this.deferred.push(v));else if(v instanceof i)f.test(v.name)&&(v.parent[v.name]=v.values);else if(!(v instanceof s)){if(v instanceof d)for(var y=0;y<this.deferred.length;)m(this,this.deferred[y])?this.deferred.splice(y,1):++y;for(var k=0;k<v.nestedArray.length;++k)this._handleAdd(v._nestedArray[k]);f.test(v.name)&&(v.parent[v.name]=v)}},u.prototype._handleRemove=function(v){if(v instanceof t){if(v.extend!==void 0)if(v.extensionField)v.extensionField.parent.remove(v.extensionField),v.extensionField=null;else{var y=this.deferred.indexOf(v);y>-1&&this.deferred.splice(y,1)}}else if(v instanceof i)f.test(v.name)&&delete v.parent[v.name];else if(v instanceof n){for(var k=0;k<v.nestedArray.length;++k)this._handleRemove(v._nestedArray[k]);f.test(v.name)&&delete v.parent[v.name]}},u._configure=function(g,v,y){d=g,c=v,l=y},root}var hasRequiredUtil;function requireUtil(){if(hasRequiredUtil)return util$2.exports;hasRequiredUtil=1;var n=util$2.exports=requireMinimal(),t=roots,i,s;n.codegen=codegen_1,n.fetch=fetch_1,n.path=path,n.fs=n.inquire("fs"),n.toArray=function(p){if(p){for(var f=Object.keys(p),m=new Array(f.length),g=0;g<f.length;)m[g]=p[f[g++]];return m}return[]},n.toObject=function(p){for(var f={},m=0;m<p.length;){var g=p[m++],v=p[m++];v!==void 0&&(f[g]=v)}return f};var a=/\\/g,d=/"/g;n.isReserved=function(p){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(p)},n.safeProp=function(p){return!/^[$\w_]+$/.test(p)||n.isReserved(p)?'["'+p.replace(a,"\\\\").replace(d,'\\"')+'"]':"."+p},n.ucFirst=function(p){return p.charAt(0).toUpperCase()+p.substring(1)};var c=/_([a-z])/g;n.camelCase=function(p){return p.substring(0,1)+p.substring(1).replace(c,function(f,m){return m.toUpperCase()})},n.compareFieldsById=function(p,f){return p.id-f.id},n.decorateType=function(p,f){if(p.$type)return f&&p.$type.name!==f&&(n.decorateRoot.remove(p.$type),p.$type.name=f,n.decorateRoot.add(p.$type)),p.$type;i||(i=requireType());var m=new i(f||p.name);return n.decorateRoot.add(m),m.ctor=p,Object.defineProperty(p,"$type",{value:m,enumerable:!1}),Object.defineProperty(p.prototype,"$type",{value:m,enumerable:!1}),m};var l=0;return n.decorateEnum=function(p){if(p.$type)return p.$type;s||(s=require_enum());var f=new s("Enum"+l++,p);return n.decorateRoot.add(f),Object.defineProperty(p,"$type",{value:f,enumerable:!1}),f},n.setProperty=function(p,f,m){function g(v,y,k){var E=y.shift();if(E==="__proto__"||E==="prototype")return v;if(y.length>0)v[E]=g(v[E]||{},y,k);else{var C=v[E];C&&(k=[].concat(C).concat(k)),v[E]=k}return v}if(typeof p!="object")throw TypeError("dst must be an object");if(!f)throw TypeError("path must be specified");return f=f.split("."),g(p,f,m)},Object.defineProperty(n,"decorateRoot",{get:function(){return t.decorated||(t.decorated=new(requireRoot()))}}),util$2.exports}var object,hasRequiredObject;function requireObject(){if(hasRequiredObject)return object;hasRequiredObject=1,object=i,i.className="ReflectionObject";var n=requireUtil(),t;function i(s,a){if(!n.isString(s))throw TypeError("name must be a string");if(a&&!n.isObject(a))throw TypeError("options must be an object");this.options=a,this.parsedOptions=null,this.name=s,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}return Object.defineProperties(i.prototype,{root:{get:function(){for(var s=this;s.parent!==null;)s=s.parent;return s}},fullName:{get:function(){for(var s=[this.name],a=this.parent;a;)s.unshift(a.name),a=a.parent;return s.join(".")}}}),i.prototype.toJSON=function(){throw Error()},i.prototype.onAdd=function(a){this.parent&&this.parent!==a&&this.parent.remove(this),this.parent=a,this.resolved=!1;var d=a.root;d instanceof t&&d._handleAdd(this)},i.prototype.onRemove=function(a){var d=a.root;d instanceof t&&d._handleRemove(this),this.parent=null,this.resolved=!1},i.prototype.resolve=function(){return this.resolved?this:(this.root instanceof t&&(this.resolved=!0),this)},i.prototype.getOption=function(a){if(this.options)return this.options[a]},i.prototype.setOption=function(a,d,c){return(!c||!this.options||this.options[a]===void 0)&&((this.options||(this.options={}))[a]=d),this},i.prototype.setParsedOption=function(a,d,c){this.parsedOptions||(this.parsedOptions=[]);var l=this.parsedOptions;if(c){var u=l.find(function(m){return Object.prototype.hasOwnProperty.call(m,a)});if(u){var p=u[a];n.setProperty(p,c,d)}else u={},u[a]=n.setProperty({},c,d),l.push(u)}else{var f={};f[a]=d,l.push(f)}return this},i.prototype.setOptions=function(a,d){if(a)for(var c=Object.keys(a),l=0;l<c.length;++l)this.setOption(c[l],a[c[l]],d);return this},i.prototype.toString=function(){var a=this.constructor.className,d=this.fullName;return d.length?a+" "+d:a},i._configure=function(s){t=s},object}var _enum,hasRequired_enum;function require_enum(){if(hasRequired_enum)return _enum;hasRequired_enum=1,_enum=s;var n=requireObject();((s.prototype=Object.create(n.prototype)).constructor=s).className="Enum";var t=requireNamespace(),i=requireUtil();function s(a,d,c,l,u,p){if(n.call(this,a,c),d&&typeof d!="object")throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=l,this.comments=u||{},this.valuesOptions=p,this.reserved=void 0,d)for(var f=Object.keys(d),m=0;m<f.length;++m)typeof d[f[m]]=="number"&&(this.valuesById[this.values[f[m]]=d[f[m]]]=f[m])}return s.fromJSON=function(d,c){var l=new s(d,c.values,c.options,c.comment,c.comments);return l.reserved=c.reserved,l},s.prototype.toJSON=function(d){var c=d?!!d.keepComments:!1;return i.toObject(["options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",c?this.comment:void 0,"comments",c?this.comments:void 0])},s.prototype.add=function(d,c,l,u){if(!i.isString(d))throw TypeError("name must be a string");if(!i.isInteger(c))throw TypeError("id must be an integer");if(this.values[d]!==void 0)throw Error("duplicate name '"+d+"' in "+this);if(this.isReservedId(c))throw Error("id "+c+" is reserved in "+this);if(this.isReservedName(d))throw Error("name '"+d+"' is reserved in "+this);if(this.valuesById[c]!==void 0){if(!(this.options&&this.options.allow_alias))throw Error("duplicate id "+c+" in "+this);this.values[d]=c}else this.valuesById[this.values[d]=c]=d;return u&&(this.valuesOptions===void 0&&(this.valuesOptions={}),this.valuesOptions[d]=u||null),this.comments[d]=l||null,this},s.prototype.remove=function(d){if(!i.isString(d))throw TypeError("name must be a string");var c=this.values[d];if(c==null)throw Error("name '"+d+"' does not exist in "+this);return delete this.valuesById[c],delete this.values[d],delete this.comments[d],this.valuesOptions&&delete this.valuesOptions[d],this},s.prototype.isReservedId=function(d){return t.isReservedId(this.reserved,d)},s.prototype.isReservedName=function(d){return t.isReservedName(this.reserved,d)},_enum}var encoder_1,hasRequiredEncoder;function requireEncoder(){if(hasRequiredEncoder)return encoder_1;hasRequiredEncoder=1,encoder_1=a;var n=require_enum(),t=requireTypes(),i=requireUtil();function s(d,c,l,u){return c.resolvedType.group?d("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",l,u,(c.id<<3|3)>>>0,(c.id<<3|4)>>>0):d("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",l,u,(c.id<<3|2)>>>0)}function a(d){for(var c=i.codegen(["m","w"],d.name+"$encode")("if(!w)")("w=Writer.create()"),l,u,p=d.fieldsArray.slice().sort(i.compareFieldsById),l=0;l<p.length;++l){var f=p[l].resolve(),m=d._fieldsArray.indexOf(f),g=f.resolvedType instanceof n?"int32":f.type,v=t.basic[g];u="m"+i.safeProp(f.name),f.map?(c("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",u,f.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",u)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(f.id<<3|2)>>>0,8|t.mapKey[f.keyType],f.keyType),v===void 0?c("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",m,u):c(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|v,g,u),c("}")("}")):f.repeated?(c("if(%s!=null&&%s.length){",u,u),f.packed&&t.packed[g]!==void 0?c("w.uint32(%i).fork()",(f.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",u)("w.%s(%s[i])",g,u)("w.ldelim()"):(c("for(var i=0;i<%s.length;++i)",u),v===void 0?s(c,f,m,u+"[i]"):c("w.uint32(%i).%s(%s[i])",(f.id<<3|v)>>>0,g,u)),c("}")):(f.optional&&c("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",u,f.name),v===void 0?s(c,f,m,u):c("w.uint32(%i).%s(%s)",(f.id<<3|v)>>>0,g,u))}return c("return w")}return encoder_1}var protobuf$2=indexLight.exports=indexMinimal;protobuf$2.build="light";function load(n,t,i){return typeof t=="function"?(i=t,t=new protobuf$2.Root):t||(t=new protobuf$2.Root),t.load(n,i)}protobuf$2.load=load;function loadSync(n,t){return t||(t=new protobuf$2.Root),t.loadSync(n)}protobuf$2.loadSync=loadSync,protobuf$2.encoder=requireEncoder(),protobuf$2.decoder=requireDecoder(),protobuf$2.verifier=requireVerifier(),protobuf$2.converter=requireConverter(),protobuf$2.ReflectionObject=requireObject(),protobuf$2.Namespace=requireNamespace(),protobuf$2.Root=requireRoot(),protobuf$2.Enum=require_enum(),protobuf$2.Type=requireType(),protobuf$2.Field=requireField(),protobuf$2.OneOf=requireOneof(),protobuf$2.MapField=requireMapfield(),protobuf$2.Service=requireService(),protobuf$2.Method=requireMethod(),protobuf$2.Message=message,protobuf$2.wrappers=wrappers,protobuf$2.types=requireTypes(),protobuf$2.util=requireUtil(),protobuf$2.ReflectionObject._configure(protobuf$2.Root),protobuf$2.Namespace._configure(protobuf$2.Type,protobuf$2.Service,protobuf$2.Enum),protobuf$2.Root._configure(protobuf$2.Type),protobuf$2.Field._configure(protobuf$2.Type);var indexLightExports=indexLight.exports,tokenize_1=tokenize$1,delimRe=/[\s{}=;:[\],'"()<>]/g,stringDoubleRe=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,stringSingleRe=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,setCommentRe=/^ *[*/]+ */,setCommentAltRe=/^\s*\*?\/*/,setCommentSplitRe=/\n/g,whitespaceRe=/\s/,unescapeRe=/\\(.?)/g,unescapeMap={0:"\0",r:"\r",n:`
`,t:"	"};function unescape(n){return n.replace(unescapeRe,function(t,i){switch(i){case"\\":case"":return i;default:return unescapeMap[i]||""}})}tokenize$1.unescape=unescape;function tokenize$1(n,t){n=n.toString();var i=0,s=n.length,a=1,d=0,c={},l=[],u=null;function p(b){return Error("illegal "+b+" (line "+a+")")}function f(){var b=u==="'"?stringSingleRe:stringDoubleRe;b.lastIndex=i-1;var S=b.exec(n);if(!S)throw p("string");return i=b.lastIndex,E(u),u=null,unescape(S[1])}function m(b){return n.charAt(b)}function g(b,S,R){var O={type:n.charAt(b++),lineEmpty:!1,leading:R},L;t?L=2:L=3;var D=b-L,x;do if(--D<0||(x=n.charAt(D))===`
`){O.lineEmpty=!0;break}while(x===" "||x==="	");for(var M=n.substring(b,S).split(setCommentSplitRe),F=0;F<M.length;++F)M[F]=M[F].replace(t?setCommentAltRe:setCommentRe,"").trim();O.text=M.join(`
`).trim(),c[a]=O,d=a}function v(b){var S=y(b),R=n.substring(b,S),O=/^\s*\/\//.test(R);return O}function y(b){for(var S=b;S<s&&m(S)!==`
`;)S++;return S}function k(){if(l.length>0)return l.shift();if(u)return f();var b,S,R,O,L,D=i===0;do{if(i===s)return null;for(b=!1;whitespaceRe.test(R=m(i));)if(R===`
`&&(D=!0,++a),++i===s)return null;if(m(i)==="/"){if(++i===s)throw p("comment");if(m(i)==="/")if(t){if(O=i,L=!1,v(i-1)){L=!0;do if(i=y(i),i===s||(i++,!D))break;while(v(i))}else i=Math.min(s,y(i)+1);L&&(g(O,i,D),D=!0),a++,b=!0}else{for(L=m(O=i+1)==="/";m(++i)!==`
`;)if(i===s)return null;++i,L&&(g(O,i-1,D),D=!0),++a,b=!0}else if((R=m(i))==="*"){O=i+1,L=t||m(O)==="*";do{if(R===`
`&&++a,++i===s)throw p("comment");S=R,R=m(i)}while(S!=="*"||R!=="/");++i,L&&(g(O,i-2,D),D=!0),b=!0}else return"/"}}while(b);var x=i;delimRe.lastIndex=0;var M=delimRe.test(m(x++));if(!M)for(;x<s&&!delimRe.test(m(x));)++x;var F=n.substring(i,i=x);return(F==='"'||F==="'")&&(u=F),F}function E(b){l.push(b)}function C(){if(!l.length){var b=k();if(b===null)return null;E(b)}return l[0]}function T(b,S){var R=C(),O=R===b;if(O)return k(),!0;if(!S)throw p("token '"+R+"', '"+b+"' expected");return!1}function w(b){var S=null,R;return b===void 0?(R=c[a-1],delete c[a-1],R&&(t||R.type==="*"||R.lineEmpty)&&(S=R.leading?R.text:null)):(d<b&&C(),R=c[b],delete c[b],R&&!R.lineEmpty&&(t||R.type==="/")&&(S=R.leading?null:R.text)),S}return Object.defineProperty({next:k,peek:C,push:E,skip:T,cmnt:w},"line",{get:function(){return a}})}var parse_1=parse;parse.filename=null,parse.defaults={keepCase:!1};var tokenize=tokenize_1,Root=requireRoot(),Type=requireType(),Field=requireField(),MapField=requireMapfield(),OneOf=requireOneof(),Enum=require_enum(),Service=requireService(),Method=requireMethod(),types=requireTypes(),util=requireUtil(),base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/,fqTypeRefRe=/^(?:\.[a-zA-Z_][a-zA-Z_0-9]*)+$/;function parse(n,t,i){t instanceof Root||(i=t,t=new Root),i||(i=parse.defaults);var s=i.preferTrailingComment||!1,a=tokenize(n,i.alternateCommentMode||!1),d=a.next,c=a.push,l=a.peek,u=a.skip,p=a.cmnt,f=!0,m,g,v,y,k=!1,E=t,C=i.keepCase?function(I){return I}:util.camelCase;function T(I,P,A){var U=parse.filename;return A||(parse.filename=null),Error("illegal "+(P||"token")+" '"+I+"' ("+(U?U+", ":"")+"line "+a.line+")")}function w(){var I=[],P;do{if((P=d())!=='"'&&P!=="'")throw T(P);I.push(d()),u(P),P=l()}while(P==='"'||P==="'");return I.join("")}function b(I){var P=d();switch(P){case"'":case'"':return c(P),w();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return R(P,!0)}catch{if(typeRefRe.test(P))return P;throw T(P,"value")}}function S(I,P){var A,U;do P&&((A=l())==='"'||A==="'")?I.push(w()):I.push([U=O(d()),u("to",!0)?O(d()):U]);while(u(",",!0));var N={options:void 0};N.setOption=function(B,$){this.options===void 0&&(this.options={}),this.options[B]=$},F(N,function($){if($==="option")K(N,$),u(";");else throw T($)},function(){J(N)})}function R(I,P){var A=1;switch(I.charAt(0)==="-"&&(A=-1,I=I.substring(1)),I){case"inf":case"INF":case"Inf":return A*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test(I))return A*parseInt(I,10);if(base16Re.test(I))return A*parseInt(I,16);if(base8Re.test(I))return A*parseInt(I,8);if(numberRe.test(I))return A*parseFloat(I);throw T(I,"number",P)}function O(I,P){switch(I){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!P&&I.charAt(0)==="-")throw T(I,"id");if(base10NegRe.test(I))return parseInt(I,10);if(base16NegRe.test(I))return parseInt(I,16);if(base8NegRe.test(I))return parseInt(I,8);throw T(I,"id")}function L(){if(m!==void 0)throw T("package");if(m=d(),!typeRefRe.test(m))throw T(m,"name");E=E.define(m),u(";")}function D(){var I=l(),P;switch(I){case"weak":P=v||(v=[]),d();break;case"public":d();default:P=g||(g=[]);break}I=w(),u(";"),P.push(I)}function x(){if(u("="),y=w(),k=y==="proto3",!k&&y!=="proto2")throw T(y,"syntax");t.setOption("syntax",y),u(";")}function M(I,P){switch(P){case"option":return K(I,P),u(";"),!0;case"message":return V(I,P),!0;case"enum":return X(I,P),!0;case"service":return re(I,P),!0;case"extend":return ae(I,P),!0}return!1}function F(I,P,A){var U=a.line;if(I&&(typeof I.comment!="string"&&(I.comment=p()),I.filename=parse.filename),u("{",!0)){for(var N;(N=d())!=="}";)P(N);u(";",!0)}else A&&A(),u(";"),I&&(typeof I.comment!="string"||s)&&(I.comment=p(U)||I.comment)}function V(I,P){if(!nameRe.test(P=d()))throw T(P,"type name");var A=new Type(P);F(A,function(N){if(!M(A,N))switch(N){case"map":ee(A);break;case"required":case"repeated":q(A,N);break;case"optional":k?q(A,"proto3_optional"):q(A,"optional");break;case"oneof":te(A,N);break;case"extensions":S(A.extensions||(A.extensions=[]));break;case"reserved":S(A.reserved||(A.reserved=[]),!0);break;default:if(!k||!typeRefRe.test(N))throw T(N);c(N),q(A,"optional");break}}),I.add(A)}function q(I,P,A){var U=d();if(U==="group"){H(I,P);return}for(;U.endsWith(".")||l().startsWith(".");)U+=d();if(!typeRefRe.test(U))throw T(U,"type");var N=d();if(!nameRe.test(N))throw T(N,"name");N=C(N),u("=");var B=new Field(N,O(d()),U,P,A);if(F(B,function(W){if(W==="option")K(B,W),u(";");else throw T(W)},function(){J(B)}),P==="proto3_optional"){var $=new OneOf("_"+N);B.setOption("proto3_optional",!0),$.add(B),I.add($)}else I.add(B);!k&&B.repeated&&(types.packed[U]!==void 0||types.basic[U]===void 0)&&B.setOption("packed",!1,!0)}function H(I,P){var A=d();if(!nameRe.test(A))throw T(A,"name");var U=util.lcFirst(A);A===U&&(A=util.ucFirst(A)),u("=");var N=O(d()),B=new Type(A);B.group=!0;var $=new Field(U,N,A,P);$.filename=parse.filename,F(B,function(W){switch(W){case"option":K(B,W),u(";");break;case"required":case"repeated":q(B,W);break;case"optional":k?q(B,"proto3_optional"):q(B,"optional");break;case"message":V(B,W);break;case"enum":X(B,W);break;default:throw T(W)}}),I.add(B).add($)}function ee(I){u("<");var P=d();if(types.mapKey[P]===void 0)throw T(P,"type");u(",");var A=d();if(!typeRefRe.test(A))throw T(A,"type");u(">");var U=d();if(!nameRe.test(U))throw T(U,"name");u("=");var N=new MapField(C(U),O(d()),P,A);F(N,function($){if($==="option")K(N,$),u(";");else throw T($)},function(){J(N)}),I.add(N)}function te(I,P){if(!nameRe.test(P=d()))throw T(P,"name");var A=new OneOf(C(P));F(A,function(N){N==="option"?(K(A,N),u(";")):(c(N),q(A,"optional"))}),I.add(A)}function X(I,P){if(!nameRe.test(P=d()))throw T(P,"name");var A=new Enum(P);F(A,function(N){switch(N){case"option":K(A,N),u(";");break;case"reserved":S(A.reserved||(A.reserved=[]),!0);break;default:ie(A,N)}}),I.add(A)}function ie(I,P){if(!nameRe.test(P))throw T(P,"name");u("=");var A=O(d(),!0),U={options:void 0};U.setOption=function(N,B){this.options===void 0&&(this.options={}),this.options[N]=B},F(U,function(B){if(B==="option")K(U,B),u(";");else throw T(B)},function(){J(U)}),I.add(P,A,U.comment,U.options)}function K(I,P){var A=u("(",!0);if(!typeRefRe.test(P=d()))throw T(P,"name");var U=P,N=U,B;A&&(u(")"),U="("+U+")",N=U,P=l(),fqTypeRefRe.test(P)&&(B=P.slice(1),U+=P,d())),u("=");var $=Z(I,U);ne(I,N,$,B)}function Z(I,P){if(u("{",!0)){for(var A={};!u("}",!0);){if(!nameRe.test(j=d()))throw T(j,"name");if(j===null)throw T(j,"end of input");var U,N=j;if(u(":",!0),l()==="{")U=Z(I,P+"."+j);else if(l()==="["){U=[];var B;if(u("[",!0)){do B=b(),U.push(B);while(u(",",!0));u("]"),typeof B<"u"&&Q(I,P+"."+j,B)}}else U=b(),Q(I,P+"."+j,U);var $=A[N];$&&(U=[].concat($).concat(U)),A[N]=U,u(",",!0),u(";",!0)}return A}var G=b();return Q(I,P,G),G}function Q(I,P,A){I.setOption&&I.setOption(P,A)}function ne(I,P,A,U){I.setParsedOption&&I.setParsedOption(P,A,U)}function J(I){if(u("[",!0)){do K(I,"option");while(u(",",!0));u("]")}return I}function re(I,P){if(!nameRe.test(P=d()))throw T(P,"service name");var A=new Service(P);F(A,function(N){if(!M(A,N))if(N==="rpc")se(A,N);else throw T(N)}),I.add(A)}function se(I,P){var A=p(),U=P;if(!nameRe.test(P=d()))throw T(P,"name");var N=P,B,$,G,W;if(u("("),u("stream",!0)&&($=!0),!typeRefRe.test(P=d())||(B=P,u(")"),u("returns"),u("("),u("stream",!0)&&(W=!0),!typeRefRe.test(P=d())))throw T(P);G=P,u(")");var z=new Method(N,U,B,G,$,W);z.comment=A,F(z,function(Y){if(Y==="option")K(z,Y),u(";");else throw T(Y)}),I.add(z)}function ae(I,P){if(!typeRefRe.test(P=d()))throw T(P,"reference");var A=P;F(null,function(N){switch(N){case"required":case"repeated":q(I,N,A);break;case"optional":k?q(I,"proto3_optional",A):q(I,"optional",A);break;default:if(!k||!typeRefRe.test(N))throw T(N);c(N),q(I,"optional",A);break}})}for(var j;(j=d())!==null;)switch(j){case"package":if(!f)throw T(j);L();break;case"import":if(!f)throw T(j);D();break;case"syntax":if(!f)throw T(j);x();break;case"option":K(E,j),u(";");break;default:if(M(E,j)){f=!1;continue}throw T(j)}return parse.filename=null,{package:m,imports:g,weakImports:v,syntax:y,root:t}}var common_1=common,commonRe=/\/|\./;function common(n,t){commonRe.test(n)||(n="google/protobuf/"+n+".proto",t={nested:{google:{nested:{protobuf:{nested:t}}}}}),common[n]=t}common("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}});var timeType;common("duration",{Duration:timeType={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),common("timestamp",{Timestamp:timeType}),common("empty",{Empty:{fields:{}}}),common("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),common("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),common("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),common.get=function n(t){return common[t]||null};var protobuf$1=src.exports=indexLightExports;protobuf$1.build="full",protobuf$1.tokenize=tokenize_1,protobuf$1.parse=parse_1,protobuf$1.common=common_1,protobuf$1.Root._configure(protobuf$1.Type,protobuf$1.parse,protobuf$1.common);var srcExports=src.exports,protobufjs=srcExports;const protobuf=getDefaultExportFromCjs(protobufjs);var extendStatics=function(n,t){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(i,s){i.__proto__=s}||function(i,s){for(var a in s)Object.prototype.hasOwnProperty.call(s,a)&&(i[a]=s[a])},extendStatics(n,t)};function __extends(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");extendStatics(n,t);function i(){this.constructor=n}n.prototype=t===null?Object.create(t):(i.prototype=t.prototype,new i)}function __awaiter(n,t,i,s){function a(d){return d instanceof i?d:new i(function(c){c(d)})}return new(i||(i=Promise))(function(d,c){function l(f){try{p(s.next(f))}catch(m){c(m)}}function u(f){try{p(s.throw(f))}catch(m){c(m)}}function p(f){f.done?d(f.value):a(f.value).then(l,u)}p((s=s.apply(n,t||[])).next())})}function __generator(n,t){var i={label:0,sent:function(){if(d[0]&1)throw d[1];return d[1]},trys:[],ops:[]},s,a,d,c;return c={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function l(p){return function(f){return u([p,f])}}function u(p){if(s)throw new TypeError("Generator is already executing.");for(;c&&(c=0,p[0]&&(i=0)),i;)try{if(s=1,a&&(d=p[0]&2?a.return:p[0]?a.throw||((d=a.return)&&d.call(a),0):a.next)&&!(d=d.call(a,p[1])).done)return d;switch(a=0,d&&(p=[p[0]&2,d.value]),p[0]){case 0:case 1:d=p;break;case 4:return i.label++,{value:p[1],done:!1};case 5:i.label++,a=p[1],p=[0];continue;case 7:p=i.ops.pop(),i.trys.pop();continue;default:if(d=i.trys,!(d=d.length>0&&d[d.length-1])&&(p[0]===6||p[0]===2)){i=0;continue}if(p[0]===3&&(!d||p[1]>d[0]&&p[1]<d[3])){i.label=p[1];break}if(p[0]===6&&i.label<d[1]){i.label=d[1],d=p;break}if(d&&i.label<d[2]){i.label=d[2],i.ops.push(p);break}d[2]&&i.ops.pop(),i.trys.pop();continue}p=t.call(n,i)}catch(f){p=[6,f],a=0}finally{s=d=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}typeof SuppressedError=="function"&&SuppressedError;function sleep(n){return new Promise(function(t){return setTimeout(t,n)})}function convertFloat32ToS16PCM(n){for(var t=new Int16Array(n.length),i=0;i<n.length;i++){var s=Math.max(-1,Math.min(1,n[i]));t[i]=s<0?s*32768:s*32767}return t}var options={syntax:"proto3"},nested={pipecat:{nested:{TextFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3}}},AudioRawFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},audio:{type:"bytes",id:3},sampleRate:{type:"uint32",id:4},numChannels:{type:"uint32",id:5}}},TranscriptionFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3},userId:{type:"string",id:4},timestamp:{type:"string",id:5}}},Frame:{oneofs:{frame:{oneof:["text","audio","transcription"]}},fields:{text:{type:"TextFrame",id:1},audio:{type:"AudioRawFrame",id:2},transcription:{type:"TranscriptionFrame",id:3}}}}}},jsonDescriptor={options,nested},AvatarQuality;(function(n){n.Low="low",n.Medium="medium",n.High="high"})(AvatarQuality||(AvatarQuality={}));var VoiceEmotion;(function(n){n.EXCITED="excited",n.SERIOUS="serious",n.FRIENDLY="friendly",n.SOOTHING="soothing",n.BROADCASTER="broadcaster"})(VoiceEmotion||(VoiceEmotion={}));var TaskType;(function(n){n.TALK="talk",n.REPEAT="repeat"})(TaskType||(TaskType={}));var TaskMode;(function(n){n.SYNC="sync",n.ASYNC="async"})(TaskMode||(TaskMode={}));var StreamingEvents;(function(n){n.AVATAR_START_TALKING="avatar_start_talking",n.AVATAR_STOP_TALKING="avatar_stop_talking",n.AVATAR_TALKING_MESSAGE="avatar_talking_message",n.AVATAR_END_MESSAGE="avatar_end_message",n.USER_TALKING_MESSAGE="user_talking_message",n.USER_END_MESSAGE="user_end_message",n.USER_START="user_start",n.USER_STOP="user_stop",n.USER_SILENCE="user_silence",n.STREAM_READY="stream_ready",n.STREAM_DISCONNECTED="stream_disconnected"})(StreamingEvents||(StreamingEvents={}));var APIError=function(n){__extends(t,n);function t(i,s,a){var d=n.call(this,i)||this;return d.name="APIError",d.status=s,d.responseText=a,d}return t}(Error),StreamingAvatar=function(){function n(t){var i=t.token,s=t.basePath,a=s===void 0?"https://api.heygen.com":s;this.room=null,this.mediaStream=null,this.eventTarget=new EventTarget,this.audioContext=null,this.webSocket=null,this.scriptProcessor=null,this.mediaStreamAudioSource=null,this.mediaDevicesStream=null,this.sessionId=null,this.token=i,this.basePath=a}return n.prototype.createStartAvatar=function(t){return __awaiter(this,void 0,void 0,function(){var i,s,a,d=this;return __generator(this,function(c){switch(c.label){case 0:return[4,this.newSession(t)];case 1:i=c.sent(),this.sessionId=i.session_id,this.language=t.language,s=new Room({adaptiveStream:!0,dynacast:!0,videoCaptureDefaults:{resolution:VideoPresets.h720.resolution}}),this.room=s,this.mediaStream=null,s.on(RoomEvent.DataReceived,function(l){var u=null;try{var p=new TextDecoder().decode(l);u=JSON.parse(p)}catch(f){console.error(f)}u&&d.emit(u.type,u)}),a=new MediaStream,s.on(RoomEvent.TrackSubscribed,function(l){if(l.kind==="video"||l.kind==="audio"){a.addTrack(l.mediaStreamTrack);var u=a.getVideoTracks().length>0,p=a.getAudioTracks().length>0;u&&p&&!d.mediaStream&&(d.mediaStream=a,d.emit(StreamingEvents.STREAM_READY,d.mediaStream))}}),s.on(RoomEvent.TrackUnsubscribed,function(l){var u=l.mediaStreamTrack;u&&a.removeTrack(u)}),s.on(RoomEvent.Disconnected,function(l){d.emit(StreamingEvents.STREAM_DISCONNECTED,l)}),c.label=2;case 2:return c.trys.push([2,4,,5]),[4,s.prepareConnection(i.url,i.access_token)];case 3:return c.sent(),[3,5];case 4:return c.sent(),[3,5];case 5:return[4,this.startSession()];case 6:return c.sent(),[4,s.connect(i.url,i.access_token)];case 7:return c.sent(),[2,i]}})})},n.prototype.startVoiceChat=function(){return __awaiter(this,arguments,void 0,function(t){var i,s,a=this,d,c,l;return t===void 0&&(t={}),__generator(this,function(u){switch(u.label){case 0:if(t.useSilencePrompt=t.useSilencePrompt||!1,!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return[2];u.label=1;case 1:return u.trys.push([1,6,,7]),[4,this.loadAudioRawFrame()];case 2:return u.sent(),[4,this.connectWebSocket({useSilencePrompt:t.useSilencePrompt})];case 3:return u.sent(),this.audioContext=new window.AudioContext({latencyHint:"interactive",sampleRate:16e3}),[4,navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}})];case 4:return i=u.sent(),this.mediaDevicesStream=i,this.mediaStreamAudioSource=(d=this.audioContext)===null||d===void 0?void 0:d.createMediaStreamSource(i),this.scriptProcessor=(c=this.audioContext)===null||c===void 0?void 0:c.createScriptProcessor(512,1,1),this.mediaStreamAudioSource.connect(this.scriptProcessor),this.scriptProcessor.connect((l=this.audioContext)===null||l===void 0?void 0:l.destination),this.scriptProcessor.onaudioprocess=function(p){var f,m,g;if(a.webSocket){var v=p.inputBuffer.getChannelData(0),y=convertFloat32ToS16PCM(v),k=new Uint8Array(y.buffer),E=(f=a.audioRawFrame)===null||f===void 0?void 0:f.create({audio:{audio:Array.from(k),sampleRate:16e3,numChannels:1}}),C=new Uint8Array((m=a.audioRawFrame)===null||m===void 0?void 0:m.encode(E).finish());(g=a.webSocket)===null||g===void 0||g.send(C)}},[4,sleep(2e3)];case 5:return u.sent(),[3,7];case 6:throw s=u.sent(),console.error(s),s;case 7:return[2]}})})},n.prototype.closeVoiceChat=function(){var t,i;try{this.audioContext&&(this.audioContext=null),this.scriptProcessor&&(this.scriptProcessor.disconnect(),this.scriptProcessor=null),this.mediaStreamAudioSource&&(this.mediaStreamAudioSource.disconnect(),this.mediaStreamAudioSource=null),this.mediaDevicesStream&&((i=(t=this.mediaDevicesStream)===null||t===void 0?void 0:t.getTracks())===null||i===void 0||i.forEach(function(s){return s.stop()}),this.mediaDevicesStream=null),this.webSocket&&this.webSocket.close()}catch{}},n.prototype.newSession=function(t){return __awaiter(this,void 0,void 0,function(){var i,s,a,d;return __generator(this,function(c){return[2,this.request("/v1/streaming.new",{avatar_name:t.avatarName,quality:t.quality,knowledge_base_id:t.knowledgeId,knowledge_base:t.knowledgeBase,voice:{voice_id:(i=t.voice)===null||i===void 0?void 0:i.voiceId,rate:(s=t.voice)===null||s===void 0?void 0:s.rate,emotion:(a=t.voice)===null||a===void 0?void 0:a.emotion,elevenlabs_settings:(d=t==null?void 0:t.voice)===null||d===void 0?void 0:d.elevenlabsSettings},language:t.language,version:"v2",video_encoding:"H264",source:"sdk",disable_idle_timeout:t.disableIdleTimeout})]})})},n.prototype.startSession=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.request("/v1/streaming.start",{session_id:this.sessionId})]})})},n.prototype.speak=function(t){return __awaiter(this,void 0,void 0,function(){var i,s,a,d,c;return __generator(this,function(l){return t.taskType=t.taskType||t.task_type||TaskType.TALK,t.taskMode=t.taskMode||TaskMode.ASYNC,this.webSocket&&this.audioRawFrame&&t.task_type===TaskType.TALK&&t.taskMode!==TaskMode.SYNC?(i=(a=this.audioRawFrame)===null||a===void 0?void 0:a.create({text:{text:t.text}}),s=new Uint8Array((d=this.audioRawFrame)===null||d===void 0?void 0:d.encode(i).finish()),(c=this.webSocket)===null||c===void 0||c.send(s),[2]):[2,this.request("/v1/streaming.task",{text:t.text,session_id:this.sessionId,task_mode:t.taskMode,task_type:t.taskType})]})})},n.prototype.startListening=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.request("/v1/streaming.start_listening",{session_id:this.sessionId})]})})},n.prototype.stopListening=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.request("/v1/streaming.stop_listening",{session_id:this.sessionId})]})})},n.prototype.interrupt=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return[2,this.request("/v1/streaming.interrupt",{session_id:this.sessionId})]})})},n.prototype.stopAvatar=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return this.closeVoiceChat(),[2,this.request("/v1/streaming.stop",{session_id:this.sessionId})]})})},n.prototype.on=function(t,i){return this.eventTarget.addEventListener(t,i),this},n.prototype.off=function(t,i){return this.eventTarget.removeEventListener(t,i),this},n.prototype.request=function(t,i,s){return __awaiter(this,void 0,void 0,function(){var a,d,c,l;return __generator(this,function(u){switch(u.label){case 0:return u.trys.push([0,5,,6]),[4,fetch(this.getRequestUrl(t),{method:"POST",headers:{Authorization:"Bearer ".concat(this.token),"Content-Type":"application/json"},body:JSON.stringify(i)})];case 1:return a=u.sent(),a.ok?[3,3]:[4,a.text()];case 2:throw d=u.sent(),new APIError("API request failed with status ".concat(a.status),a.status,d);case 3:return[4,a.json()];case 4:return c=u.sent(),[2,c.data];case 5:throw l=u.sent(),l;case 6:return[2]}})})},n.prototype.emit=function(t,i){var s=new CustomEvent(t,{detail:i});this.eventTarget.dispatchEvent(s)},n.prototype.getRequestUrl=function(t){return"".concat(this.basePath).concat(t)},n.prototype.connectWebSocket=function(t){return __awaiter(this,void 0,void 0,function(){var i,s=this;return __generator(this,function(a){return i="wss://".concat(new URL(this.basePath).hostname,"/v1/ws/streaming.chat?session_id=").concat(this.sessionId,"&session_token=").concat(this.token,"&silence_response=").concat(t.useSilencePrompt),this.language&&(i+="&stt_language=".concat(this.language)),this.webSocket=new WebSocket(i),this.webSocket.addEventListener("message",function(d){var c=null;try{c=JSON.parse(d.data)}catch(l){console.error(l);return}s.emit(c.event_type,c)}),this.webSocket.addEventListener("close",function(d){s.webSocket=null}),[2,new Promise(function(d,c){var l,u;(l=s.webSocket)===null||l===void 0||l.addEventListener("error",function(p){s.webSocket=null,c(p)}),(u=s.webSocket)===null||u===void 0||u.addEventListener("open",function(){d(!0)})})]})})},n.prototype.loadAudioRawFrame=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(i){return this.audioRawFrame||(t=protobuf.Root.fromJSON(jsonDescriptor),this.audioRawFrame=t==null?void 0:t.lookupType("pipecat.Frame")),[2]})})},n}();function debugLog(n){try{console.log(n);return}catch(t){console.error("Error logging debug message:",t,n)}}debugLog("Hello from HeyGen plugin"),console.log("Libraries imported successfully");const videoElement=document.getElementById("avatarVideo"),startButton=document.getElementById("startSession");document.getElementById("speakButton");const userInput=document.getElementById("userInput"),animation=document.getElementById("animation");let avatar=null,sessionData=null,isSessionActive=!1,talkMode=TaskType.REPEAT;async function fetchAccessToken(){return await(await window.authenticatedFetch("/heygen/tempkey")).text()}function setLoading(n){}async function initializeAvatarSession(){const n=await fetchAccessToken();avatar=new StreamingAvatar({token:n});const i=await(await window.authenticatedFetch(`/heygen/avatarsettings/${window.persona}`)).json();console.log("retrieved avatar settings for persona",window.persona),console.log({avatarSettings:i}),window.avatar=avatar,console.log("Avatar instance created"),console.log({avatarSettings:i}),console.log("hello"),console.log({avatarSettings:i}),avatar.on(StreamingEvents.STREAM_READY,handleStreamReady),avatar.on(StreamingEvents.STREAM_DISCONNECTED,handleStreamDisconnected),sessionData=await avatar.createStartAvatar(i),console.log("Session data:",sessionData),isSessionActive=!0,startButton.textContent="End Session",startButton.classList.add("active"),videoElement.style.display="block"}function hideLoadingAndStartPlaying(){try{console.log("Trying to start playing"),videoElement.style.display="block",videoElement.play().catch(console.error),animation.style.display="none"}catch(n){console.warn("Could not start video (maybe already playing)",n)}}function handleStreamReady(n){console.log("Stream ready"),console.log(n),n.detail&&videoElement?(videoElement.srcObject=n.detail,window.avatarSource=n.detail,videoElement.onloadedmetadata=hideLoadingAndStartPlaying,videoElement.readyState>=2?hideLoadingAndStartPlaying():console.log("Video not ready yet, not waiting for loadedmetadata event")):console.error("Stream is not available!!!!!")}function handleStreamDisconnected(){console.log("Stream disconnected"),videoElement&&(videoElement.srcObject=null,videoElement.style.display="none"),isSessionActive=!1,startButton.textContent="Load Avatar",startButton.classList.remove("active")}async function terminateAvatarSession(){try{if(!avatar||!sessionData){console.warn("No active avatar session to terminate so not stopping avatar");return}await avatar.stopAvatar(),console.log({avatar})}catch(n){console.error("Error stopping avatar",n)}avatar.off(StreamingEvents.STREAM_READY,handleStreamReady),avatar.off(StreamingEvents.STREAM_DISCONNECTED,handleStreamDisconnected),videoElement.srcObject=null,avatar=null}async function handleSpeak(n){console.log("%c handleSpeak","color: yellow; background-color: blue","!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1"),console.log("handleSpeak",n),debugLog("handleSpeak...............................");let t=n||userInput.value;n&&(userInput.value=n),debugLog("2"),avatar&&t&&(console.log("%c would send this text: ","color: yellow; background-color: blue",t),debugLog("3"),await avatar.speak({text:t,task_type:talkMode}),debugLog("4"),userInput.value="")}async function shutUp(){if(avatar)try{await avatar.interrupt()}catch{}}window.shutUp=shutUp,window.handleSpeak=handleSpeak;async function toggleSession(){isSessionActive?(console.log("Terminating session..."),await terminateAvatarSession()):await initializeAvatarSession()}let addedSay=!1;startButton.addEventListener("click",()=>{if(toggleSession(),addedSay){console.log("added say handler already");return}console.log("registering commands: wait_for_user_reply"),addedSay=!0,window.registerCommandHandler("wait_for_user_reply",async n=>{if(console.log("wait_for_user_reply()",n),n.event=="running")try{debugLog("handleSpeak..............................."),debugLog(n.args.text),await window.avatar.speak({text:n.args.text,task_type:TaskType.REPEAT}),debugLog("sent text to avatar")}catch(t){console.error("Error speaking",t),debugLog("Error speaking "+JSON.stringify(t))}})})})();
